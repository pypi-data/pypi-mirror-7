description: 'Count reads using htseq-count'
path:
  - /ddn1/vol1/leuven_groups/lts_00002/software/samtools/current
run_when: '"{{fullpath}}" -nt "{{ output }}"'
defaults:
  pbs_mem: 4gb
  pbs_group: lp_symbiosys
  pbs_queue: qreg
  pbs_walltime: '23:59:58'
  htseq_stranded: "no"
  htseq_minqual: 5
  genome_gtf_file: "/ddn1/vol1/leuven_groups/lts_00002/lcb/resources/mouse/{{genome_build}}/{{genome_build}}.gtf"
  htseq_idattr: gene_name
  htseq_mode: union
  htseq_feature_type: exon
  output: '{{ sample_name }}.counts'
  readsortout: '{{ sample_name }}.readname.sorted'
output_files:
  - '{{ output }}'
  - '{{ readsortout }}.bam'
command: |
  if [ ! -f  "{{ readsortout }}.bam" ];
  then
    samtools sort -n -m 2G \
        "{{ fullpath }}" \
        "{{ readsortout }}" && \
    mad set status temp "{{ readsortout }}.bam";
  fi;

  samtools view -h "{{ readsortout }}.bam" \
    | htseq-count \
      --format=sam \
      --order=name \
      --idattr={{ htseq_idattr }} \
      --stranded={{ htseq_stranded }} \
      --mode={{ htseq_mode }} \
      --type={{ htseq_feature_type }} \
      - \
      "{{ genome_gtf_file }}" \
      > "{{ output }}"
