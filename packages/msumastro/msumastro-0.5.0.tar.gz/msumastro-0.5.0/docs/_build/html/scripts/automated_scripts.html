

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Automated header processing &mdash; MSUMastro toolbox 0.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../',
        VERSION:'0.1',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="MSUMastro toolbox 0.1 documentation" href="../index.html"/>
        <link rel="next" title="Command-line scripts" href="scripts.html"/>
        <link rel="prev" title="Installation" href="../installation.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> MSUMastro toolbox</a>
        <form class="wy-form" action="../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#automated-header-processing">Automated header processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#manual-header-or-image-manipulation">Manual header or image manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview.html#building-your-own-tools">Building your own tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#this-software">This software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#dependencies">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Automated header processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#intended-workflow">Intended workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-intended-workflow-will-not-work-when">The intended workflow will not work when...</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fixes-for-cases-that-require-intervention">Fixes for cases that require intervention</a></li>
<li class="toctree-l2"><a class="reference internal" href="#detailed-list-of-keywords-changed">Detailed list of keywords changed</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reference-api">Reference/API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="manual_processing.html">Manual header processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="manual_processing.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="manual_processing.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../image_management.html">Image Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../image_management.html#working-with-a-directory-of-images">Working with a directory of images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../image_management.html#module-msumastro.table_tree">Turning an image collection into a tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../image_management.html#module-msumastro.image">Image class that includes WCS information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../header_processing/index.html">Header processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../header_processing/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../header_processing/index.html#reference-api">Reference/API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reduction/index.html">Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xref.html">Index</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">MSUMastro toolbox</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../index.html">Docs</a> &raquo;</li>
  <li><a href="">Automated header processing</a></li>
  
</ul>
<hr/>

          
  <div class="section" id="automated-header-processing">
<span id="automated-scripts"></span><h1>Automated header processing<a class="headerlink" href="#automated-header-processing" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The scripts described here are intended primarily to be run in an automated way
whenever new images are uploaded to the physics server. Each can also be run
manually, either from the command line or from python.</p>
<p>Both these ways of invoking the script (from the command line or from python)
is are wrappers around the python functions that do the real work. References
to those functions, which provide more control over what you can do at the
expense of taking more effort to understand, are provided below where
appropriate.</p>
<p>The purpose of the header processing is to:</p>
<ul class="simple">
<li>Modify or add keywords to the FITS header to make working with other software
easier:<ul>
<li>Standardize names instead using the MaxIm DL defaults (e.g. <tt class="docutils literal"><span class="pre">RA</span></tt> and
<tt class="docutils literal"><span class="pre">Dec</span></tt> instead of <tt class="docutils literal"><span class="pre">OBJCTRA</span></tt> and <tt class="docutils literal"><span class="pre">OBJCTDEC</span></tt>)</li>
<li>Set <tt class="docutils literal"><span class="pre">IMAGETYP</span></tt> to IRAF default, <em>i.e.</em> &#8220;BIAS&#8221;, &#8220;DARK&#8221;, &#8220;FLAT&#8221; or &#8220;LIGHT&#8221;</li>
<li>Add convenient keywords that MaxImDL does not always include (e.g.
<tt class="docutils literal"><span class="pre">AIRMASS</span></tt>, <tt class="docutils literal"><span class="pre">HA</span></tt>, <tt class="docutils literal"><span class="pre">LST</span></tt>)</li>
<li>Add keywords indicating the overscan region, if any, in the image.</li>
</ul>
</li>
<li>Add astrometry to the FITS header so that RA/Dec can be extracted/displayed
for sources in the image.</li>
<li>Add object names to the HEADER where possible.</li>
<li>Identify images that need manual action to add any of the information above.</li>
<li>Create a table of images in each directory with columns for several FITS
header keywords to facilitate indexing of images taken at Feder.</li>
</ul>
</div>
<div class="section" id="intended-workflow">
<h2>Intended workflow<a class="headerlink" href="#intended-workflow" title="Permalink to this headline">¶</a></h2>
<p>The three primary scripts are, in the order in which they are intended (though
not <em>required</em>, necessarily) to run:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">run_patch</span></tt> to do a first round of header
patching that puts site information, LST, airmass (where
appropriate) and RA/Dec information (where appropriate) into the files. See
<a class="reference internal" href="scripts.html#header-patching"><em>Header patching: run_patch.py</em></a> for details.</li>
<li><tt class="docutils literal"><span class="pre">run_triage</span></tt> (details at <a class="reference internal" href="scripts.html#summary-table"><em>Find problems and create summary: run_triage.py</em></a>) to:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>generate a table summarizing properties of images in a directory. Each
image is one row in the table and the columns are keywords from the FITS
headers.</li>
<li>create files with lists of images missing key information.</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>Fix any problems identified by <tt class="docutils literal"><span class="pre">run_triage</span></tt>. The script
<tt class="docutils literal"><span class="pre">quick_add_keys_to_file</span></tt> may be useful for this; it is an easy way to
add/modify the values of keywords in FITS headers from the command line; see
details at <a class="reference internal" href="scripts.html#header-quick-fix"><em>Manual intervention: quick_add_keys_to_file.py</em></a>. After fixing these problems you may need
to re-run patch, particularly if you have added pointing information or
changed the <tt class="docutils literal"><span class="pre">IMAGETYP</span></tt> of any of the images.</li>
<li><tt class="docutils literal"><span class="pre">run_astrometry</span></tt> to use <a class="reference external" href="http://astrometry.net">astrometry.net</a> to add
WCS (astrometry) information to the file. See <a class="reference internal" href="scripts.html#apply-astrometry"><em>Adding astrometry: run_astromtery.py</em></a> for
details. <strong>Note that this requires a local installation</strong> of
<a class="reference external" href="http://astrometry.net">astrometry.net</a>.</li>
<li>If desired, <tt class="docutils literal"><span class="pre">run_triage</span></tt> again to regenerate the table of image information.</li>
</ul>
</div>
<div class="section" id="the-intended-workflow-will-not-work-when">
<h2>The intended workflow will not work when...<a class="headerlink" href="#the-intended-workflow-will-not-work-when" title="Permalink to this headline">¶</a></h2>
<p>The workflow above works great when the images that come off the telescope contain pointing information (i.e. RA/Dec), filter information and the image type in the header matches the actual image type.</p>
<p>Manual intervention will be required in any of these circumstances:</p>
<ul class="simple">
<li><strong>There is no pointing information in the files.</strong> In files that are produced at
Feder Observatory the pointing information is contained in the FITS keywords
<tt class="docutils literal"><span class="pre">OBJCTRA</span></tt> and <tt class="docutils literal"><span class="pre">OBJCTDEC</span></tt>. If there is no pointing information, astrometry
will not be added to the image headers. <a class="reference external" href="http://astrometry.net">astrometry.net</a> can actually do blind astrometry, but it is fairly
time consuming. Alternatives are suggested below.<ul>
<li><strong>How to identify this case</strong>: There are two ways this problem may be noted.
If <a class="reference internal" href="scripts.html#module-msumastro.scripts.run_triage" title="msumastro.scripts.run_triage"><tt class="xref py py-mod docutils literal"><span class="pre">run_triage</span></tt></a> has been run (and it <em>is</em> run in
the standard workflow) then a file called  &#8220;NEEDS_POINTING_INFO.txt&#8221; will
be created that lists all of the light files missing pointing information.
In addition, one file with suffix <cite>.blind</cite> will be created for each light
file which contains no pointing information.</li>
</ul>
</li>
<li><strong>Filter information is missing for light or flat images.</strong> All of the data
preparation will occur if the <tt class="docutils literal"><span class="pre">FILTER</span></tt> keyword is missing   from the headers
for light or flat images, but the filter needs to be added to   make the images
<em>useful</em>.<ul>
<li><strong>How to identify this case</strong>: A file called &#8220;NEEDS_FILTER.txt&#8221; will be
created as part of the standard workflow that lists each file that needs
filter information.</li>
</ul>
</li>
<li><strong>Incorrect image type set for image.</strong> If the incorrect image type is set it
can prevent some data preparation steps to be omitted that should actually occur
or cause steps to be attempted that   shouldn&#8217;t be. For example, if an image is
really a <tt class="docutils literal"><span class="pre">LIGHT</span></tt> image but is   labeled in the header as a <tt class="docutils literal"><span class="pre">FLAT</span></tt>, then no
attempt will be made to calculate   an apparent position (Alt/Az) for the frame
or to add astrometry. If the   mistake is reversed, with a <tt class="docutils literal"><span class="pre">FLAT</span></tt> image
labeled as <tt class="docutils literal"><span class="pre">LIGHT</span></tt> an attempt   will be made to add astrometry which will
fail.<ul>
<li><strong>How to identify this case</strong>: Manual inspection of affected images is the
only reliable way to do this. A good place to start looking is at light
files for which adding astrometry failed, file names whose name implies a
different type than its <tt class="docutils literal"><span class="pre">IMAGETYP</span></tt> in the FITS header (e.g. a file with
<tt class="docutils literal"><span class="pre">IMAGETYP</span> <span class="pre">=</span> <span class="pre">LIGHT</span></tt> whose name is <tt class="docutils literal"><span class="pre">flat-001R.fit</span></tt>)</li>
</ul>
</li>
<li><strong>The object being observed is not in the master object list.</strong> The standard
workflow has run but object names have not been add to all of the
light files. This occurs when the object of the image was not in the list of
objects used by <tt class="docutils literal"><span class="pre">run_patch.py</span></tt> or the object&#8217;s RA/Dec was too far from the
center of the image to be matched.<ul>
<li><strong>How to identify this case</strong>: The script <tt class="docutils literal"><span class="pre">run_triage.py</span></tt>, part of the
standard workflow, will produce a file called &#8220;NEEDS_OBJECT.txt&#8221; with a
list of light files for which there is no object.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="fixes-for-cases-that-require-intervention">
<span id="how-to-fix"></span><h2>Fixes for cases that require intervention<a class="headerlink" href="#fixes-for-cases-that-require-intervention" title="Permalink to this headline">¶</a></h2>
<p>The discussion below is deliberately broad. For some concrete examples see
<a class="reference internal" href="manual_processing.html#manual-processing"><em>Manual header processing</em></a></p>
<ul>
<li><p class="first"><strong>Adding pointing information</strong>: There are a few options here:</p>
<blockquote>
<div><ul class="simple">
<li>Use <a class="reference internal" href="scripts.html#module-msumastro.scripts.quick_add_keys_to_file" title="msumastro.scripts.quick_add_keys_to_file"><tt class="xref py py-mod docutils literal"><span class="pre">quick_add_keys_to_file</span></tt></a> to add the <tt class="docutils literal"><span class="pre">OBJECT</span></tt>
keyword to the header, then
<tt class="xref py py-func docutils literal"><span class="pre">add_ra_dec_from_object_name()</span></tt> to
add pointing information, then <a class="reference internal" href="scripts.html#module-msumastro.scripts.run_astrometry" title="msumastro.scripts.run_astrometry"><tt class="xref py py-mod docutils literal"><span class="pre">run_astrometry</span></tt></a> to
add astrometry to the images.</li>
<li>Use <a class="reference internal" href="scripts.html#module-msumastro.scripts.quick_add_keys_to_file" title="msumastro.scripts.quick_add_keys_to_file"><tt class="xref py py-mod docutils literal"><span class="pre">quick_add_keys_to_file</span></tt></a> to add the
<tt class="docutils literal"><span class="pre">OBJECT</span></tt>, <tt class="docutils literal"><span class="pre">RA</span></tt>, <tt class="docutils literal"><span class="pre">DEC</span></tt>, <tt class="docutils literal"><span class="pre">OBJCTRA</span></tt> and <tt class="docutils literal"><span class="pre">OBJCTDEC</span></tt> to the headers, then
<a class="reference internal" href="scripts.html#module-msumastro.scripts.run_astrometry" title="msumastro.scripts.run_astrometry"><tt class="xref py py-mod docutils literal"><span class="pre">run_astrometry</span></tt></a> to       add astrometry to the images.
This route is <strong>not recommended</strong> because it is easy to use a format for RA/Dec
that isn&#8217;t understood (or is misinterpreted) by the code that adds astrometry.</li>
<li>Do blind astrometry to add pointing information, then use
<tt class="xref py py-func docutils literal"><span class="pre">add_object_info()</span></tt> to add object
names. There are no inherent with with this approach, though it may be
simpler to add the astrometry then re-run the standard processing workflow
to add any missing keywords than it is to manually use
<tt class="xref py py-func docutils literal"><span class="pre">add_object_info()</span></tt></li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><strong>Adding filter information</strong>: The hard part here is not adding the filter
keyword, it is figuring out what filter was used when the image was taken.
You are on your own in figuring out that piece. Once you know what the
filter should be, use <a class="reference internal" href="scripts.html#module-msumastro.scripts.quick_add_keys_to_file" title="msumastro.scripts.quick_add_keys_to_file"><tt class="xref py py-mod docutils literal"><span class="pre">quick_add_keys_to_file</span></tt></a> to
add the keyword <tt class="docutils literal"><span class="pre">FILTER</span></tt> to the relevant files.</p>
</li>
<li><p class="first"><strong>Adding filter information</strong>: As with adding filter information, the hard
part is figuring out what the image type <em>should</em> be. In practice most cases
of this are light images misidentified as flat and <em>vice versa</em> and it ought
to be easy to determine which of those an image is at a glance (arguably, if
you can&#8217;t tell at a glance then the image is probably useful as neither a
light nor a flat image). Once you know what the image type should be, use
<a class="reference internal" href="scripts.html#module-msumastro.scripts.quick_add_keys_to_file" title="msumastro.scripts.quick_add_keys_to_file"><tt class="xref py py-mod docutils literal"><span class="pre">quick_add_keys_to_file</span></tt></a> to set the keyword
<tt class="docutils literal"><span class="pre">IMAGETYP</span></tt> to the appropriate value in the relevant files. Allowed values
for <tt class="docutils literal"><span class="pre">IMAGETYP</span></tt> are &#8220;BIAS&#8221;, &#8220;DARK&#8221;, &#8220;FLAT&#8221; or &#8220;LIGHT&#8221;.</p>
</li>
<li><p class="first"><strong>Adding object information</strong>: Assuming pointing information is already in the
header for the images that need object information this is fairly
straightforward. One way to do it is to add the object to the master object list
and run <tt class="xref py py-func docutils literal"><span class="pre">add_object_info()</span></tt> (or even
just re-run <a class="reference internal" href="scripts.html#module-msumastro.scripts.run_patch" title="msumastro.scripts.run_patch"><tt class="xref py py-mod docutils literal"><span class="pre">run_patch</span></tt></a>, which will end up re-doing some
of the keyword-patching work). Another way to approach is to use
<a class="reference internal" href="scripts.html#module-msumastro.scripts.quick_add_keys_to_file" title="msumastro.scripts.quick_add_keys_to_file"><tt class="xref py py-mod docutils literal"><span class="pre">quick_add_keys_to_file</span></tt></a> to set the <tt class="docutils literal"><span class="pre">OBJECT</span></tt> keyword
directly. <strong>Either way you are encouraged to upadte the master object list.</strong></p>
</li>
</ul>
</div>
<div class="section" id="detailed-list-of-keywords-changed">
<h2>Detailed list of keywords changed<a class="headerlink" href="#detailed-list-of-keywords-changed" title="Permalink to this headline">¶</a></h2>
<div class="section" id="keywords-purged-before-further-processing">
<span id="header-patch-detail"></span><h3>Keywords purged before further processing<a class="headerlink" href="#keywords-purged-before-further-processing" title="Permalink to this headline">¶</a></h3>
<p>Some <strong>keywords are purged</strong> from the original headers because I don&#8217;t trust
the values that MaxImDL v5 puts in:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">OBJECT</span>
<span class="n">JD</span>
<span class="n">JD</span><span class="o">-</span><span class="n">HELIO</span>
<span class="n">OBJCTALT</span>
<span class="n">OBJCTAZ</span>
<span class="n">OBJCTHA</span>
<span class="n">AIRMASS</span>
</pre></div>
</div>
</div>
<div class="section" id="keywords-modified-for-all-files">
<h3>Keywords modified for all files<a class="headerlink" href="#keywords-modified-for-all-files" title="Permalink to this headline">¶</a></h3>
<p>The keywords that are currently added/modified by <tt class="docutils literal"><span class="pre">patch_headers</span></tt> for
<strong>all files</strong> are:</p>
<div class="highlight-python"><div class="highlight"><pre>IMAGETYP: Type of image
LATITUDE: [degrees] Observatory latitude
LONGITUD: [degrees east] Observatory longitude
ALTITUDE: [meters] Observatory altitude
LST: Local Sidereal Time at start of observation
JD-OBS: Julian Date at start of observation
MJD-OBS: Modified Julian date at start of observation
OSCAN: True if image has overscan region
OSCANAX: Overscan axis, 1 is NAXIS1, 2 is NAXIS 2
OSCANST: Starting pixel of overscan region
</pre></div>
</div>
</div>
<div class="section" id="keywords-modified-only-for-light-files">
<h3>Keywords modified only for light files<a class="headerlink" href="#keywords-modified-only-for-light-files" title="Permalink to this headline">¶</a></h3>
<p>The keywords that are currently added/modified by <tt class="docutils literal"><span class="pre">patch_header</span></tt> for
<strong>light files only</strong> are:</p>
<div class="highlight-python"><div class="highlight"><pre>RA: Approximate RA at EQUINOX
DEC: Approximate DEC at EQUINOX
OBJECT: Target of the observations
HA: Hour angle
AIRMASS: Airmass (Sec(Z)) at start of observation
ALT-OBJ: [degrees] Altitude of object, no refraction
AZ-OBJ: [degrees] Azimuth of object, no refraction
</pre></div>
</div>
</div>
</div>
<div class="section" id="reference-api">
<h2>Reference/API<a class="headerlink" href="#reference-api" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="scripts.html">Command-line scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#running-the-complete-standard-workflow-run-standard-header-process-py">Running the complete standard workflow: <tt class="docutils literal"><span class="pre">run_standard_header_process.py</span></tt></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#header-patching-run-patch-py">Header patching: <tt class="docutils literal"><span class="pre">run_patch.py</span></tt></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#adding-astrometry-run-astromtery-py">Adding astrometry: <tt class="docutils literal"><span class="pre">run_astromtery.py</span></tt></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#find-problems-and-create-summary-run-triage-py">Find problems and create summary: <tt class="docutils literal"><span class="pre">run_triage.py</span></tt></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#manual-intervention-quick-add-keys-to-file-py">Manual intervention: <tt class="docutils literal"><span class="pre">quick_add_keys_to_file.py</span></tt></a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts.html#sorting-files-based-on-image-properties">Sorting files based on image properties</a></li>
</ul>
</li>
</ul>
</div>
</div>
</div>


          <footer>
  
    <div class="rst-footer-buttons">
      
        <a href="scripts.html" class="btn btn-neutral float-right" title="Command-line scripts"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../installation.html" class="btn btn-neutral" title="Installation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <p>
      &copy; Copyright 2011-2013, Matt Craig.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>