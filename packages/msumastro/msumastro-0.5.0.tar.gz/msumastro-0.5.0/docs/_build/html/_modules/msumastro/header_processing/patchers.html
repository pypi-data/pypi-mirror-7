

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>msumastro.header_processing.patchers &mdash; MSUMastro toolbox 0.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../../../',
        VERSION:'0.1',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
      };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
    <link rel="top" title="MSUMastro toolbox 0.1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="icon icon-home"> MSUMastro toolbox</a>
        <form class="wy-form" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search docs" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../overview.html#automated-header-processing">Automated header processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../overview.html#manual-header-or-image-manipulation">Manual header or image manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../overview.html#building-your-own-tools">Building your own tools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#this-software">This software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../installation.html#dependencies">Dependencies</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/automated_scripts.html">Automated header processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/automated_scripts.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/automated_scripts.html#intended-workflow">Intended workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/automated_scripts.html#the-intended-workflow-will-not-work-when">The intended workflow will not work when...</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/automated_scripts.html#fixes-for-cases-that-require-intervention">Fixes for cases that require intervention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/automated_scripts.html#detailed-list-of-keywords-changed">Detailed list of keywords changed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/automated_scripts.html#reference-api">Reference/API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/manual_processing.html">Manual header processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/manual_processing.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../scripts/manual_processing.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../image_management.html">Image Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../image_management.html#working-with-a-directory-of-images">Working with a directory of images</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../image_management.html#module-msumastro.table_tree">Turning an image collection into a tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../image_management.html#module-msumastro.image">Image class that includes WCS information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../header_processing/index.html">Header processing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../header_processing/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../header_processing/index.html#reference-api">Reference/API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reduction/index.html">Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xref.html">Index</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="/">MSUMastro toolbox</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <ul class="wy-breadcrumbs">
  <li><a href="../../../index.html">Docs</a> &raquo;</li>
  <li><a href="">msumastro.header_processing.patchers</a></li>
  
</ul>
<hr/>

          
  <h1>Source code for msumastro.header_processing.patchers</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">socket</span> <span class="kn">import</span> <span class="n">timeout</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="kn">as</span> <span class="nn">fits</span>
<span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">FK5</span><span class="p">,</span> <span class="n">name_resolve</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="kn">from</span> <span class="nn">feder</span> <span class="kn">import</span> <span class="n">Feder</span>
<span class="kn">from</span> <span class="nn">..image_collection</span> <span class="kn">import</span> <span class="n">ImageFileCollection</span>
<span class="kn">from</span> <span class="nn">fitskeyword</span> <span class="kn">import</span> <span class="n">FITSKeyword</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">feder</span> <span class="o">=</span> <span class="n">Feder</span><span class="p">()</span>

<span class="c">#__all__ = [&#39;patch_headers&#39;, &#39;add_object_info&#39;, &#39;add_ra_dec_from_object_name&#39;]</span>


<div class="viewcode-block" id="IRAF_image_type"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.IRAF_image_type.html#msumastro.header_processing.patchers.IRAF_image_type">[docs]</a><span class="k">def</span> <span class="nf">IRAF_image_type</span><span class="p">(</span><span class="n">image_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert MaximDL default image type names to IRAF</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    image_type : str</span>
<span class="sd">        Value of the FITS header keyword IMAGETYP; acceptable values are</span>
<span class="sd">        below in Notes.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        IRAF image type (one of &#39;BIAS&#39;, &#39;DARK&#39;, &#39;FLAT&#39; or &#39;LIGHT&#39;)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The MaximDL default is, e.g. &#39;Bias Frame&#39;, which IRAF calls</span>
<span class="sd">    &#39;BIAS&#39;. Can safely be called with an IRAF-style image_type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">image_type</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="add_time_info"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.add_time_info.html#msumastro.header_processing.patchers.add_time_info">[docs]</a><span class="k">def</span> <span class="nf">add_time_info</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add JD, MJD, LST to FITS header</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : astropy..io.fits.Header</span>
<span class="sd">        FITS header to be modified.</span>
<span class="sd">    history : bool</span>
<span class="sd">        If `True`, write history for each keyword changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dateobs</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;date-obs&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="s">&#39;utc&#39;</span><span class="p">)</span>
    <span class="n">feder</span><span class="o">.</span><span class="n">JD_OBS</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">jd</span>
    <span class="n">feder</span><span class="o">.</span><span class="n">MJD_OBS</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">dateobs</span><span class="o">.</span><span class="n">mjd</span>

    <span class="c"># setting currentobsjd makes calls following it use that time</span>
    <span class="c"># for calculations</span>

    <span class="n">feder</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">currentobsjd</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">JD_OBS</span><span class="o">.</span><span class="n">value</span>
    <span class="n">LST_tmp</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">feder</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localSiderialTime</span><span class="p">(),</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">feder</span><span class="o">.</span><span class="n">LST</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">LST_tmp</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                        <span class="n">pad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">feder</span><span class="o">.</span><span class="n">keywords_for_all_files</span><span class="p">:</span>
        <span class="n">keyword</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">history_comment</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="add_object_pos_airmass"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.add_object_pos_airmass.html#msumastro.header_processing.patchers.add_object_pos_airmass">[docs]</a><span class="k">def</span> <span class="nf">add_object_pos_airmass</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add object information, such as RA/Dec and airmass.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : astropy..io.fits.Header</span>
<span class="sd">        FITS header to be modified.</span>
<span class="sd">    history : bool</span>
<span class="sd">        If `True`, write history for each keyword changed.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Has side effect of setting feder site JD to JD-OBS, which means it</span>
<span class="sd">    also assume JD.value has been set.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># not sure why coverage is not picking up both branches, but it is not, so</span>
    <span class="c"># marking it no cover</span>
    <span class="k">if</span> <span class="n">feder</span><span class="o">.</span><span class="n">JD_OBS</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">feder</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">currentobsjd</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">JD_OBS</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Need to set JD_OBS.value before calling.&#39;</span><span class="p">)</span>  <span class="c"># pragma: no cover</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">feder</span><span class="o">.</span><span class="n">RA</span><span class="o">.</span><span class="n">set_value_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No RA is present.&quot;</span><span class="p">)</span>

    <span class="n">feder</span><span class="o">.</span><span class="n">DEC</span><span class="o">.</span><span class="n">set_value_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="n">feder</span><span class="o">.</span><span class="n">RA</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">RA</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">feder</span><span class="o">.</span><span class="n">DEC</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">DEC</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;:&#39;</span><span class="p">)</span>

    <span class="n">obj_coord2</span> <span class="o">=</span> <span class="n">FK5</span><span class="p">(</span><span class="n">feder</span><span class="o">.</span><span class="n">RA</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">feder</span><span class="o">.</span><span class="n">DEC</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                     <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">))</span>

    <span class="c"># monkeypatch obj_coord2 so it looks like an astropysics coord</span>
    <span class="n">obj_coord2</span><span class="o">.</span><span class="n">raerr</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">obj_coord2</span><span class="o">.</span><span class="n">decerr</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># and, for astropy 0.3, monkeypatch an hours method and a radians method:</span>
    <span class="n">obj_coord2</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hours</span> <span class="o">=</span> <span class="n">obj_coord2</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hour</span>
    <span class="n">obj_coord2</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">radians</span> <span class="o">=</span> <span class="n">obj_coord2</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">radian</span>

    <span class="n">alt_az</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">apparentCoordinates</span><span class="p">(</span><span class="n">obj_coord2</span><span class="p">,</span> <span class="n">refraction</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">feder</span><span class="o">.</span><span class="n">ALT_OBJ</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">alt_az</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">feder</span><span class="o">.</span><span class="n">AZ_OBJ</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">alt_az</span><span class="o">.</span><span class="n">az</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">feder</span><span class="o">.</span><span class="n">AIRMASS</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">alt_az</span><span class="o">.</span><span class="n">alt</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">HA</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">localSiderialTime</span><span class="p">()</span> <span class="o">-</span> <span class="n">obj_coord2</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">hours</span>
    <span class="n">HA</span> <span class="o">=</span> <span class="n">Angle</span><span class="p">(</span><span class="n">HA</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>

    <span class="n">feder</span><span class="o">.</span><span class="n">HA</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">HA</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">feder</span><span class="o">.</span><span class="n">keywords_for_light_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keyword</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">keyword</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">history_comment</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="get_software_name"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.get_software_name.html#msumastro.header_processing.patchers.get_software_name">[docs]</a><span class="k">def</span> <span class="nf">get_software_name</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_observatory</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the name of the software that created FITIS header</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    header : astropy.io.fits Header</span>
<span class="sd">        Header from a FITS extension/hdu</span>

<span class="sd">    file_name : str, optional</span>
<span class="sd">        Name of the file containing this header; used to add information to</span>
<span class="sd">        error/warning messages.</span>

<span class="sd">    use_observatory : msumastro.Feder instance, optional</span>
<span class="sd">        Object that contains names of FITS keywords that might be present and</span>
<span class="sd">        contain name of the software that made this header. The default value</span>
<span class="sd">        is the instance defined at the beginning of this module</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    msumastro.feder.Software object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fits_file</span> <span class="o">=</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
    <span class="n">observatory</span> <span class="o">=</span> <span class="n">use_observatory</span> <span class="ow">or</span> <span class="n">feder</span>

    <span class="n">known_software_keywords</span> <span class="o">=</span> <span class="n">observatory</span><span class="o">.</span><span class="n">software_FITS_keywords</span>

    <span class="n">software_name_in_header</span> <span class="o">=</span> <span class="n">FITSKeyword</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">known_software_keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">synonyms</span><span class="o">=</span><span class="n">known_software_keywords</span><span class="p">)</span>
    <span class="n">software_name_in_header</span><span class="o">.</span><span class="n">set_value_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">software</span> <span class="o">=</span> <span class="n">observatory</span><span class="o">.</span><span class="n">software</span><span class="p">[</span><span class="n">software_name_in_header</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;Software named {0} not recognized in header &#39;</span>
                       <span class="s">&#39;for file {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">software_name_in_header</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                             <span class="n">fits_file</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">software</span>

</div>
<div class="viewcode-block" id="purge_bad_keywords"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.purge_bad_keywords.html#msumastro.header_processing.patchers.purge_bad_keywords">[docs]</a><span class="k">def</span> <span class="nf">purge_bad_keywords</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove keywords from FITS header that may be incorrect</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : astropy.io.fits.Header</span>
<span class="sd">        Header from which the bad keywords (as defined by the software that</span>
<span class="sd">        recorded the image) should be purged.</span>

<span class="sd">    history : bool</span>
<span class="sd">        If `True` write detailed history for each keyword removed.</span>

<span class="sd">    force : bool</span>
<span class="sd">        If `True`, force keywords to be purged even if the FITS header</span>
<span class="sd">        indicates it has already been purged.</span>

<span class="sd">    file_name : str, optional</span>
<span class="sd">        Name of file containing the header; if provided it is used to generate</span>
<span class="sd">        more informative log messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">software</span> <span class="o">=</span> <span class="n">get_software_name</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">purged</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">software</span><span class="o">.</span><span class="n">purged_flag_keyword</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">purged</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">purged</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">warn_msg</span> <span class="o">=</span> <span class="s">&#39;Not removing headers from {0} again, &#39;</span>
        <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s">&#39;set force=True to force removal.&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warn_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">software</span><span class="o">.</span><span class="n">bad_keywords</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Deleted keyword &#39;</span> <span class="o">+</span> <span class="n">keyword</span> <span class="o">+</span>
                       <span class="s">&#39; with value &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">keyword</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">header</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

    <span class="n">header</span><span class="p">[</span><span class="n">software</span><span class="o">.</span><span class="n">purged_flag_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span>
                                            <span class="s">&#39;Have bad keywords been removed?&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="change_imagetype_to_IRAF"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.change_imagetype_to_IRAF.html#msumastro.header_processing.patchers.change_imagetype_to_IRAF">[docs]</a><span class="k">def</span> <span class="nf">change_imagetype_to_IRAF</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Change IMAGETYP to default used by IRAF</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : astropy.io.fits.Header</span>
<span class="sd">        Header object in which image type is to be changed.</span>

<span class="sd">    history : bool, optional</span>
<span class="sd">        If `True`, add history of keyword modification to `header`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imagetype</span> <span class="o">=</span> <span class="s">&#39;imagetyp&#39;</span>  <span class="c"># FITS keyword name is truncated at 8 chars</span>
    <span class="n">current_type</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="n">imagetype</span><span class="p">]</span>
    <span class="n">IRAF_type</span> <span class="o">=</span> <span class="n">IRAF_image_type</span><span class="p">(</span><span class="n">current_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">current_type</span> <span class="o">!=</span> <span class="n">IRAF_type</span><span class="p">:</span>
        <span class="n">header</span><span class="p">[</span><span class="n">imagetype</span><span class="p">]</span> <span class="o">=</span> <span class="n">IRAF_type</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="s">&#39;Changed {0} from {1} to {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imagetype</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                                       <span class="n">current_type</span><span class="p">,</span>
                                                       <span class="n">IRAF_type</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">history</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="read_object_list"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.read_object_list.html#msumastro.header_processing.patchers.read_object_list">[docs]</a><span class="k">def</span> <span class="nf">read_object_list</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">input_list</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a list of objects from a text file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir : str</span>
<span class="sd">        Directory containing the file. Default is the current directory, ``.``</span>

<span class="sd">    input_list : str, optional</span>
<span class="sd">        Name of the file. Default value is ``obsinfo.txt``</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    There are two file formats; one contains just a list of objects, the</span>
<span class="sd">    other has an RA and Dec for each object.</span>

<span class="sd">    In both types any lines that start with ``#`` are ignored and treated</span>
<span class="sd">    as comments.</span>

<span class="sd">    **File with list of objects only:**</span>
<span class="sd">        + Object coordinates are determined by lookup with</span>
<span class="sd">          `Simbad &lt;http://simbad.u-strasbg.fr/simbad/&gt;`_. You should make sure</span>
<span class="sd">          the object names you use are known to simbad.</span>
<span class="sd">        + The first non-comment line MUST be the word ``object`` and only</span>
<span class="sd">          the word ``object``. It is case sensitive; ``Object`` or ``OBJECT``</span>
<span class="sd">          will not work.</span>
<span class="sd">        + Remaining line(s) are name(s) of object(s), one per line. Case does</span>
<span class="sd">          **not** matter for object name.</span>
<span class="sd">        + Example::</span>

<span class="sd">            # my list is below</span>
<span class="sd">            object</span>
<span class="sd">            m101</span>
<span class="sd">            sz lyn</span>
<span class="sd">            # the next object is after this comment</span>
<span class="sd">            RR LYR</span>

<span class="sd">    **File with object name and position:**</span>
<span class="sd">        + RA and Dec **must be J2000**.</span>
<span class="sd">        + RA **must be given in hours**, though it can be either sexagesimal</span>
<span class="sd">          (e.g. ``19:25:27.9``) or decimal (e.g. ``19.423861``).</span>
<span class="sd">        + Dec **must be given in degrees**, though it can be either sexagesimal</span>
<span class="sd">          (e.g. ``42:47:3.69``) or decimal (e.g. ``42.7843583``)</span>
<span class="sd">        + The first non-comment line MUST be these words: ``object,RA,Dec``.</span>
<span class="sd">          These are column headings for your file. It is **not** case</span>
<span class="sd">          sensitive; for example, using ``DEC`` instead of ``Dec`` will work.</span>
<span class="sd">        + Each remaining line should be an object name, object RA and Dec.</span>
<span class="sd">          Case does **not** matter for object name.</span>
<span class="sd">        + Example::</span>

<span class="sd">            # my list with RA and Dec</span>
<span class="sd">            # RA and Dec are assumed to be J2000</span>
<span class="sd">            # RA MUST BE IN HOURS</span>
<span class="sd">            # DEC MUST BE IN DEGREES</span>
<span class="sd">            object,RA,Dec</span>
<span class="sd">            m101,14:03:12.583, +54:20:55.50</span>
<span class="sd">            # note that the leading sign for the Dec is optional if Dec is</span>
<span class="sd">            # positive</span>
<span class="sd">            sz lyn,08:09:35.748, 44:28:17.61</span>
<span class="sd">            # You can mix sexagesimal and decimal RA/Dec.</span>
<span class="sd">            RR Lyr, 19.423861,42.7843583</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">normalize_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find any column in table whose name matches, aside from case, key</span>
<span class="sd">        and change the name of the column to key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contains_col</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span>
                                                          <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">contains_col</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="s">&#39;Keyword {0} not found in table&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">column</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="n">column</span><span class="p">)):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="nb">dir</span> <span class="o">=</span> <span class="nb">dir</span> <span class="ow">or</span> <span class="s">&#39;.&#39;</span>
    <span class="nb">list</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_list</span> <span class="k">if</span> <span class="n">input_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&#39;obsinfo.txt&#39;</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
                         <span class="n">format</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span>
                         <span class="n">comment</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">,</span>
                         <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">normalize_column_name</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="n">objects</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span>
              <span class="s">&#39;No column named object found in file {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">normalize_column_name</span><span class="p">(</span><span class="s">&#39;RA&#39;</span><span class="p">,</span> <span class="n">objects</span><span class="p">)</span>
        <span class="n">normalize_column_name</span><span class="p">(</span><span class="s">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">objects</span><span class="p">)</span>
        <span class="n">RA</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="s">&#39;RA&#39;</span><span class="p">]</span>
        <span class="n">Dec</span> <span class="o">=</span> <span class="n">objects</span><span class="p">[</span><span class="s">&#39;Dec&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">RA</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">Dec</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">objects</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">],</span> <span class="n">RA</span><span class="p">,</span> <span class="n">Dec</span>

</div>
<div class="viewcode-block" id="history"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.history.html#msumastro.header_processing.patchers.history">[docs]</a><span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct nicely formatted start/end markers in FITS history.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    function : func</span>
<span class="sd">        Function calling `history`</span>
<span class="sd">    mode : str, &#39;begin&#39; or &#39;end&#39;</span>
<span class="sd">        A different string is produced for the beginning and the end. Default</span>
<span class="sd">        is &#39;begin&#39;.</span>
<span class="sd">    time : datetime</span>
<span class="sd">        If not set, defaults to current date/time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="ow">or</span> <span class="s">&#39;begin&#39;</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;begin&#39;</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;end&#39;</span><span class="p">:</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;mode must be &quot;begin&quot; or &quot;end&quot;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="n">marker</span> <span class="o">*=</span> <span class="mi">5</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> history on </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                          <span class="n">function</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span>
                                          <span class="n">marker</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="patch_headers"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.patch_headers.html#msumastro.header_processing.patchers.patch_headers">[docs]</a><span class="k">def</span> <span class="nf">patch_headers</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">new_file_ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">save_location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">purge_bad</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">add_time</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">add_apparent_pos</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">add_overscan</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">fix_imagetype</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add minimal information to Feder FITS headers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir : str, optional</span>
<span class="sd">        Directory containing the files to be patched. Default is the current</span>
<span class="sd">        directory, ``.``</span>

<span class="sd">    new_file_ext : str, optional</span>
<span class="sd">        Name added to the FITS files with updated header information. It is</span>
<span class="sd">        added to the base name of the input file, between the old file name</span>
<span class="sd">        and the `.fit` or `.fits` extension. Default is &#39;new&#39;.</span>

<span class="sd">    save_location : str, optional</span>
<span class="sd">        Directory to which the patched files should be written, if not `dir`.</span>

<span class="sd">    overwrite : bool, optional</span>
<span class="sd">        Set to `True` to replace the original files.</span>

<span class="sd">    purge_bad : bool, optional</span>
<span class="sd">        Remove &quot;bad&quot; keywords form header before any other processing. See</span>
<span class="sd">        :func:`purge_bad_keywords` for details.</span>

<span class="sd">    add_time : bool, optional</span>
<span class="sd">        If ``True``, add time information (e.g. JD, LST); see</span>
<span class="sd">        :func:`add_time_info` for details.</span>

<span class="sd">    add_apparent_pos : bool, optional</span>
<span class="sd">        If ``True``, add apparent position (e.g. alt/az) to headers. See</span>
<span class="sd">        :func:`add_object_pos_airmass` for details.</span>

<span class="sd">    add_overscan : bool, optional</span>
<span class="sd">        If ``True``, add overscan keywords to the headers. See</span>
<span class="sd">        :func:`add_overscan_header` for details.</span>

<span class="sd">    fix_imagetype : bool, optional</span>
<span class="sd">        If ``True``, change image types to IRAF-style. See</span>
<span class="sd">        :func:`change_imagetype_to_IRAF` for details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">dir</span> <span class="o">=</span> <span class="nb">dir</span> <span class="ow">or</span> <span class="s">&#39;.&#39;</span>
    <span class="k">if</span> <span class="n">new_file_ext</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_file_ext</span> <span class="o">=</span> <span class="s">&#39;new&#39;</span>

    <span class="n">images</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span> <span class="n">keywords</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;imagetyp&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">headers</span><span class="p">(</span><span class="n">save_with_name</span><span class="o">=</span><span class="n">new_file_ext</span><span class="p">,</span>
                                        <span class="n">save_location</span><span class="o">=</span><span class="n">save_location</span><span class="p">,</span>
                                        <span class="n">clobber</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                                        <span class="n">do_not_scale_image_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">return_fname</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">run_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;START PATCHING FILE: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

        <span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">history</span><span class="p">(</span><span class="n">patch_headers</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;begin&#39;</span><span class="p">,</span>
                                   <span class="n">time</span><span class="o">=</span><span class="n">run_time</span><span class="p">))</span>
        <span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="s">&#39;patch_headers.py modified this file on </span><span class="si">%s</span><span class="s">&#39;</span>
                           <span class="o">%</span> <span class="n">run_time</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># each of the next 3 lines checks for presences of something</span>
            <span class="n">get_software_name</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>  <span class="c"># is there some software?</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;instrume&#39;</span><span class="p">]</span>  <span class="c"># is there an instrument?</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;imagetyp&#39;</span><span class="p">]</span>  <span class="c"># is there an image type?</span>

            <span class="k">if</span> <span class="n">purge_bad</span><span class="p">:</span>
                <span class="n">purge_bad_keywords</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">fname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fix_imagetype</span><span class="p">:</span>
                <span class="n">change_imagetype_to_IRAF</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">add_time</span><span class="p">:</span>
                <span class="n">add_time_info</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">add_apparent_pos</span> <span class="ow">and</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;imagetyp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;LIGHT&#39;</span><span class="p">):</span>
                <span class="n">add_object_pos_airmass</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>
                                       <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_overscan</span><span class="p">:</span>
                <span class="n">add_overscan_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warning_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;********* FILE NOT PATCHED *********</span><span class="se">\n</span><span class="s">&#39;</span>
                           <span class="s">&#39;Stopped patching header of {0} because of &#39;</span>
                           <span class="s">&#39;{1}: {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
            <span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">header</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">history</span><span class="p">(</span><span class="n">patch_headers</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;end&#39;</span><span class="p">,</span>
                               <span class="n">time</span><span class="o">=</span><span class="n">run_time</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;END PATCHING FILE: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="add_overscan_header"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.add_overscan_header.html#msumastro.header_processing.patchers.add_overscan_header">[docs]</a><span class="k">def</span> <span class="nf">add_overscan_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add overscan information to a FITS header.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    header : astropy.io.fits.Header</span>
<span class="sd">        Header object to which overscan is to be added.</span>

<span class="sd">    history : bool, optional</span>
<span class="sd">        If `True`, add history of keyword modification to `header`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of str</span>
<span class="sd">        List of the keywords added to the header by this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;naxis1&#39;</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;naxis2&#39;</span><span class="p">]]</span>
    <span class="n">instrument</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">instruments</span><span class="p">[</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;instrume&#39;</span><span class="p">]]</span>
    <span class="n">overscan_present</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">OSCAN</span>
    <span class="n">overscan_present</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">has_overscan</span><span class="p">(</span><span class="n">image_dim</span><span class="p">)</span>
    <span class="n">overscan_present</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
    <span class="n">modified_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">overscan_present</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">overscan_present</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">overscan_axis</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">OSCANAX</span>
        <span class="n">overscan_start</span> <span class="o">=</span> <span class="n">feder</span><span class="o">.</span><span class="n">OSCANST</span>
        <span class="n">overscan_axis</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">overscan_axis</span>
        <span class="n">overscan_start</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">overscan_start</span>
        <span class="n">overscan_axis</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
        <span class="n">overscan_start</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>
        <span class="n">modified_keywords</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">overscan_axis</span><span class="p">,</span> <span class="n">overscan_start</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">modified_keywords</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">history_comment</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">modified_keywords</span>

</div>
<div class="viewcode-block" id="add_object_info"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.add_object_info.html#msumastro.header_processing.patchers.add_object_info">[docs]</a><span class="k">def</span> <span class="nf">add_object_info</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">object_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">object_list_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">match_radius</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">new_file_ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">save_location</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">detailed_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add object information to FITS files that contain pointing information</span>
<span class="sd">    given a list of objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory : str</span>
<span class="sd">        Directory containing the FITS files to be fixed. Default is the</span>
<span class="sd">        current directory, ``.``.</span>

<span class="sd">    object_list : str, optional</span>
<span class="sd">        Name of file containing list of objects. Default is set by</span>
<span class="sd">        :func:`read_object_list` which also explains the format of this file.</span>

<span class="sd">    object_list_dir : str, optional</span>
<span class="sd">        Directory in which the `object_list` is contained. Default is</span>
<span class="sd">        `directory`.</span>

<span class="sd">    match_radius : float, optional</span>
<span class="sd">        Maximum distance, in arcmin, between the RA/Dec of the image and a</span>
<span class="sd">        particular object for the image to be considered an image of that</span>
<span class="sd">        object.</span>

<span class="sd">    new_file_ext : str, optional</span>
<span class="sd">        Name added to the FITS files with updated header information. It is</span>
<span class="sd">        added to the base name of the input file, between the old file name</span>
<span class="sd">        and the `.fit` or `.fits` extension. Default is &#39;new&#39;.</span>

<span class="sd">    save_location : str, optional</span>
<span class="sd">        Directory to which the patched files should be written, if not `dir`.</span>

<span class="sd">    overwrite : bool, optional</span>
<span class="sd">        Set to `True` to replace the original files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="ow">or</span> <span class="s">&#39;.&#39;</span>
    <span class="k">if</span> <span class="n">new_file_ext</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_file_ext</span> <span class="o">=</span> <span class="s">&#39;new&#39;</span>

    <span class="n">images</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span>
                                 <span class="n">keywords</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;imagetyp&#39;</span><span class="p">,</span> <span class="s">&#39;RA&#39;</span><span class="p">,</span>
                                           <span class="s">&#39;Dec&#39;</span><span class="p">,</span> <span class="s">&#39;object&#39;</span><span class="p">])</span>
    <span class="n">im_table</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">summary_info</span>

    <span class="n">object_dir</span> <span class="o">=</span> <span class="n">directory</span> <span class="k">if</span> <span class="n">object_list_dir</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">object_list_dir</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;About to read object list&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">object_names</span><span class="p">,</span> <span class="n">RAs</span><span class="p">,</span> <span class="n">Decs</span> <span class="o">=</span> <span class="n">read_object_list</span><span class="p">(</span><span class="n">object_dir</span><span class="p">,</span>
                                                   <span class="n">input_list</span><span class="o">=</span><span class="n">object_list</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">warn_msg</span> <span class="o">=</span> <span class="s">&#39;No object list in directory {0}, skipping.&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warn_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">object_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">object_names</span><span class="p">)</span>
    <span class="n">ra_dec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">default_angle_units</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">RAs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Decs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="n">ra_dec</span> <span class="o">=</span> <span class="n">FK5</span><span class="p">(</span><span class="n">RAs</span><span class="p">,</span> <span class="n">Decs</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">default_angle_units</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ra_dec</span> <span class="o">=</span> <span class="p">[</span><span class="n">FK5</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">object_names</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">name_resolve</span><span class="o">.</span><span class="n">NameResolveError</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Unable to do lookup of object positions&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a_coord</span> <span class="ow">in</span> <span class="n">ra_dec</span><span class="p">:</span>
            <span class="n">ra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_coord</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>
            <span class="n">dec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_coord</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>
        <span class="n">ra_dec</span> <span class="o">=</span> <span class="n">FK5</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="p">))</span>
    <span class="c"># sanity check object list--the objects should not be so close together</span>
    <span class="c"># that any pair is within match radius of each other.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Testing object list for self-consistency&#39;</span><span class="p">)</span>

    <span class="c"># need 2nd neighbor below or objects will match themselves</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">matches</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">d3d</span> <span class="o">=</span> <span class="n">ra_dec</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">ra_dec</span><span class="p">,</span>
                                                        <span class="n">nthneighbor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">bad_object_list</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2d</span><span class="o">.</span><span class="n">arcmin</span> <span class="o">&lt;</span> <span class="n">match_radius</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="c"># There was only one item in the table...so no object can</span>
        <span class="c"># be duplicated, so make a fake distance that doesn&#39;t match</span>
        <span class="n">bad_object_list</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">bad_object_list</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Object list {} in directory {} contains at least one &#39;</span>
                   <span class="s">&#39;pair of objects that &#39;</span>
                   <span class="s">&#39;are closer together than &#39;</span>
                   <span class="s">&#39;match radius {} arcmin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">object_list</span><span class="p">,</span>
                                                    <span class="n">object_list_dir</span><span class="p">,</span>
                                                    <span class="n">match_radius</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="c"># I want rows which...</span>
    <span class="c">#</span>
    <span class="c"># ...have no OBJECT...</span>
    <span class="n">needs_object</span> <span class="o">=</span> <span class="n">im_table</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span>
    <span class="c"># ...and have coordinates.</span>
    <span class="n">needs_object</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="p">(</span><span class="n">im_table</span><span class="p">[</span><span class="s">&#39;RA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">|</span> <span class="n">im_table</span><span class="p">[</span><span class="s">&#39;Dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>

    <span class="c"># Qualifying rows need a search for a match.</span>
    <span class="c"># the search returns a match for every row provided, but some matches</span>
    <span class="c"># may be farther away than desired, so...</span>
    <span class="c">#</span>
    <span class="c"># ...`and` the previous index mask with those that matched, and</span>
    <span class="c"># ...construct list of object names for those images.</span>

    <span class="n">img_pos</span> <span class="o">=</span> <span class="n">FK5</span><span class="p">(</span><span class="n">im_table</span><span class="p">[</span><span class="s">&#39;RA&#39;</span><span class="p">][</span><span class="n">needs_object</span><span class="p">],</span> <span class="n">im_table</span><span class="p">[</span><span class="s">&#39;Dec&#39;</span><span class="p">][</span><span class="n">needs_object</span><span class="p">],</span>
                  <span class="n">unit</span><span class="o">=</span><span class="n">default_angle_units</span><span class="p">)</span>
    <span class="n">match_idx</span><span class="p">,</span> <span class="n">d2d</span><span class="p">,</span> <span class="n">d3d</span> <span class="o">=</span> <span class="n">img_pos</span><span class="o">.</span><span class="n">match_to_catalog_sky</span><span class="p">(</span><span class="n">ra_dec</span><span class="p">)</span>
    <span class="n">good_match</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2d</span><span class="o">.</span><span class="n">arcmin</span> <span class="o">&lt;=</span> <span class="n">match_radius</span><span class="p">)</span>
    <span class="n">found_object</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">needs_object</span><span class="p">)</span>
    <span class="n">found_object</span><span class="p">[</span><span class="n">needs_object</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_match</span>
    <span class="n">matched_object_name</span> <span class="o">=</span> <span class="n">object_names</span><span class="p">[</span><span class="n">match_idx</span><span class="p">][</span><span class="n">good_match</span><span class="p">]</span>

    <span class="n">no_match_found</span> <span class="o">=</span> <span class="n">needs_object</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">found_object</span>
    <span class="k">if</span> <span class="n">no_match_found</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">files</span><span class="p">)[</span><span class="n">no_match_found</span><span class="p">]:</span>
            <span class="n">warn_msg</span> <span class="o">=</span> <span class="s">&quot;No object found for image {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_object</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;NO OBJECTS MATCHED TO IMAGES IN: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="n">im_table</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">found_object</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">headers</span><span class="p">(</span><span class="n">save_with_name</span><span class="o">=</span><span class="n">new_file_ext</span><span class="p">,</span>
                                          <span class="n">clobber</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                                          <span class="n">save_location</span><span class="o">=</span><span class="n">save_location</span><span class="p">,</span>
                                          <span class="n">return_fname</span><span class="o">=</span><span class="bp">True</span><span class="p">)):</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;START ATTEMPTING TO ADD OBJECT to: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

        <span class="n">object_name</span> <span class="o">=</span> <span class="n">matched_object_name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Found matching object named </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">object_name</span><span class="p">)</span>
        <span class="n">obj_keyword</span> <span class="o">=</span> <span class="n">FITSKeyword</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">object_name</span><span class="p">)</span>
        <span class="n">obj_keyword</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">obj_keyword</span><span class="o">.</span><span class="n">history_comment</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;END ATTEMPTING TO ADD OBJECT to: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="add_ra_dec_from_object_name"><a class="viewcode-back" href="../../../api/msumastro.header_processing.patchers.add_ra_dec_from_object_name.html#msumastro.header_processing.patchers.add_ra_dec_from_object_name">[docs]</a><span class="k">def</span> <span class="nf">add_ra_dec_from_object_name</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_file_ext</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add RA/Dec to FITS file that has object name but no pointing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir : str, optional</span>
<span class="sd">        Directory containing the files to be patched. Default is the current</span>
<span class="sd">        directory, ``.``</span>

<span class="sd">    new_file_ext : str, optional</span>
<span class="sd">        Name added to the FITS files with updated header information. It is</span>
<span class="sd">        added to the base name of the input file, between the old file name</span>
<span class="sd">        and the `.fit` or `.fits` extension. Default is &#39;new&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span> <span class="ow">or</span> <span class="s">&#39;.&#39;</span>
    <span class="k">if</span> <span class="n">new_file_ext</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">new_file_ext</span> <span class="o">=</span> <span class="s">&#39;new&#39;</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">ImageFileCollection</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span>
                                 <span class="n">keywords</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;imagetyp&#39;</span><span class="p">,</span> <span class="s">&#39;RA&#39;</span><span class="p">,</span>
                                           <span class="s">&#39;Dec&#39;</span><span class="p">,</span> <span class="s">&#39;object&#39;</span><span class="p">])</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">summary_info</span>
    <span class="n">missing_dec</span> <span class="o">=</span> <span class="n">summary</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s">&#39;RA&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s">&#39;Dec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                          <span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s">&#39;imagetyp&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;LIGHT&#39;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_dec</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">missing_dec</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">])</span>
    <span class="c"># checks prior to this mean this loop always happens at least once,</span>
    <span class="c"># which confuses coverage</span>
    <span class="k">for</span> <span class="n">object_name</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>  <span class="c"># pragma: nobranch</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">object_coords</span> <span class="o">=</span> <span class="n">FK5</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">name_resolve</span><span class="o">.</span><span class="n">NameResolveError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Unable to lookup position for </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">object_name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">common_format_keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sep&#39;</span><span class="p">:</span> <span class="s">&#39;:&#39;</span><span class="p">,</span>
                                  <span class="s">&#39;precision&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                  <span class="s">&#39;pad&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
        <span class="n">feder</span><span class="o">.</span><span class="n">RA</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">object_coords</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">common_format_keywords</span><span class="p">)</span>
        <span class="n">feder</span><span class="o">.</span><span class="n">DEC</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">object_coords</span><span class="o">.</span><span class="n">dec</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>
                                                      <span class="n">alwayssign</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                      <span class="o">**</span><span class="n">common_format_keywords</span><span class="p">)</span>
        <span class="n">these_files</span> <span class="o">=</span> <span class="n">missing_dec</span><span class="p">[</span><span class="n">missing_dec</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">object_name</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">these_files</span><span class="p">:</span>
            <span class="n">full_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">image</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">])</span>
            <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span> <span class="n">do_not_scale_image_data</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">hdulist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">feder</span><span class="o">.</span><span class="n">RA</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">feder</span><span class="o">.</span><span class="n">DEC</span><span class="o">.</span><span class="n">add_to_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_file_ext</span><span class="p">:</span>
                <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
                <span class="n">new_file_name</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">new_file_ext</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_file_name</span> <span class="o">=</span> <span class="n">full_name</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">hdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">new_file_name</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
</pre></div>

          <footer>
  

  <hr/>

  <p>
      &copy; Copyright 2011-2013, Matt Craig.
  </p>

  <a href="https://www.github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="http://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  

</body>
</html>