<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Example app &mdash; peewee 2.2.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="peewee 2.2.3 documentation" href="../index.html" />
    <link rel="next" title="Peewee Cookbook" href="cookbook.html" />
    <link rel="prev" title="Quickstart" href="quickstart.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="cookbook.html" title="Peewee Cookbook"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="quickstart.html" title="Quickstart"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">peewee 2.2.3 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="example-app">
<span id="id1"></span><h1>Example app<a class="headerlink" href="#example-app" title="Permalink to this headline">¶</a></h1>
<p>We&#8217;ll be building a simple &#8220;twitter&#8221;-like site.  The source code for the example
can be found in the <tt class="docutils literal"><span class="pre">examples/twitter</span></tt> directory.  You can also <a class="reference external" href="https://github.com/coleifer/peewee/tree/master/examples/twitter">browse the source-code</a>
on github.</p>
<p>The example app uses the <a class="reference external" href="http://flask.pocoo.org/">flask</a> web framework which is
very easy to get started with.  If you don&#8217;t have flask already, you will need to
install it to run the example:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">pip install flask</span>
</pre></div>
</div>
<div class="section" id="running-the-example">
<h2>Running the example<a class="headerlink" href="#running-the-example" title="Permalink to this headline">¶</a></h2>
<img alt="../_images/tweepee.jpg" src="../_images/tweepee.jpg" />
<p>After ensuring that flask is installed, <tt class="docutils literal"><span class="pre">cd</span></tt> into the twitter example directory and
execute the <tt class="docutils literal"><span class="pre">run_example.py</span></tt> script:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">python run_example.py</span>
</pre></div>
</div>
<p>The example app will be accessible at <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a></p>
</div>
<div class="section" id="diving-into-the-code">
<h2>Diving into the code<a class="headerlink" href="#diving-into-the-code" title="Permalink to this headline">¶</a></h2>
<p>For simplicity all example code is contained within a single module, <tt class="docutils literal"><span class="pre">examples/twitter/app.py</span></tt>.</p>
<div class="section" id="models">
<h3>Models<a class="headerlink" href="#models" title="Permalink to this headline">¶</a></h3>
<p>In the spirit of the ur-python web framework, django, peewee uses declarative model
definitions.  If you&#8217;re not familiar with django, the idea is that you declare
a class with some members which map directly to the database schema.  For the
twitter clone, there are just three models:</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">User</span></tt>:</dt>
<dd>represents a user account and stores the username and password, an email
address for generating avatars using <em>gravatar</em>, and a datetime field
indicating when that account was created</dd>
<dt><tt class="docutils literal"><span class="pre">Relationship</span></tt>:</dt>
<dd>this is a &#8220;utility model&#8221; that contains two foreign-keys to
the <tt class="docutils literal"><span class="pre">User</span></tt> model and represents <em>&#8220;following&#8221;</em>.</dd>
<dt><tt class="docutils literal"><span class="pre">Message</span></tt>:</dt>
<dd>analagous to a tweet. this model stores the text content of
the message, when it was created, and who posted it (foreign key to User).</dd>
</dl>
<p>If you like UML, this is basically what it looks like:</p>
<img alt="../_images/schema.jpg" src="../_images/schema.jpg" />
<p>Here is what the &#8220;bare-bones&#8221; model definitions look like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># create a peewee database instance -- our models will use this database to</span>
<span class="c"># persist information</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">)</span>

<span class="c"># model definitions -- the standard &quot;pattern&quot; is to define a base model class</span>
<span class="c"># that specifies which database to use.  then, any subclasses will automatically</span>
<span class="c"># use the correct storage.</span>
<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

<span class="c"># the user model specifies its fields (or columns) declaratively, like django</span>
<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">join_date</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,)</span>

<span class="c"># this model contains two foreign keys to user -- it essentially allows us to</span>
<span class="c"># model a &quot;many-to-many&quot; relationship between users.  by querying and joining</span>
<span class="c"># on different columns we can expose who a user is &quot;related to&quot; and who is</span>
<span class="c"># &quot;related to&quot; a given user</span>
<span class="k">class</span> <span class="nc">Relationship</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">from_user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;relationships&#39;</span><span class="p">)</span>
    <span class="n">to_user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;related_to&#39;</span><span class="p">)</span>


<span class="c"># a dead simple one-to-many relationship: one user has 0..n messages, exposed by</span>
<span class="c"># the foreign key.  because we didn&#39;t specify, a users messages will be accessible</span>
<span class="c"># as a special attribute, User.message_set</span>
<span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">()</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;-pub_date&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that we create a &#8220;BaseModel&#8221; class that simply defines what database
we would like to use.  All other models then extend this class and will also
use the correct database connection.</p>
</div>
<p>peewee supports <a class="reference internal" href="models.html#fields"><em>a number of field types</em></a> which map to different
column types commonly supported by database engines.  Conversion between python
types and those used in the database is handled transparently, including things like:</p>
<ul class="simple">
<li>boolean values</li>
<li>datetimes</li>
<li>decimal values</li>
<li><tt class="docutils literal"><span class="pre">NULL</span></tt> and <tt class="docutils literal"><span class="pre">None</span></tt></li>
</ul>
</div>
<div class="section" id="creating-the-initial-tables">
<h3>Creating the initial tables<a class="headerlink" href="#creating-the-initial-tables" title="Permalink to this headline">¶</a></h3>
<p>In order to start using the models, its necessary to create the tables.  This is
a one-time operation and can be done quickly using the interactive interpreter.
I created a small function in the app module to create the tables.  It looks like
this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create_tables</span><span class="p">():</span>
    <span class="n">User</span><span class="o">.</span><span class="n">create_table</span><span class="p">()</span>
    <span class="n">Relationship</span><span class="o">.</span><span class="n">create_table</span><span class="p">()</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">create_table</span><span class="p">()</span>
</pre></div>
</div>
<p>Open a python shell in the directory alongside the example app and execute the
following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">create_tables</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you encounter an <tt class="docutils literal"><span class="pre">ImportError</span></tt> it means that either &#8220;flask&#8221; or &#8220;peewee&#8221;
was not found on your pythonpath and may not be installed correctly.  Check
the <a class="reference internal" href="installation.html#installation"><em>Installing peewee</em></a> docs on how to install peewee.</p>
</div>
<p>Every model has a <a class="reference internal" href="api.html#Model.create_table" title="Model.create_table"><tt class="xref py py-meth docutils literal"><span class="pre">create_table()</span></tt></a> classmethod which runs a <tt class="docutils literal"><span class="pre">CREATE</span> <span class="pre">TABLE</span></tt>
statement in the database.  It will create the table, including all columns, foreign-key
constaints, and indexes.  Usually this is something you&#8217;ll only do once, whenever a new
model is added.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Adding fields after the table has been created will required you to
either drop the table and re-create it or manually add the columns using <tt class="docutils literal"><span class="pre">ALTER</span> <span class="pre">TABLE</span></tt>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you want, you can use instead write <tt class="docutils literal"><span class="pre">User.create_table(True)</span></tt> and it will
fail silently if the table already exists.</p>
</div>
</div>
<div class="section" id="establishing-a-database-connection">
<h3>Establishing a database connection<a class="headerlink" href="#establishing-a-database-connection" title="Permalink to this headline">¶</a></h3>
<p>You may have noticed in the above model code that there is a class defined on the
base model named <tt class="docutils literal"><span class="pre">Meta</span></tt> that sets the <tt class="docutils literal"><span class="pre">database</span></tt> attribute.  peewee
allows every model to specify which database it uses.</p>
<p>This is a peewee idiom:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># config</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s">&#39;tweepee.db&#39;</span>

<span class="c"># create a database instance that will manage the connection and execute queries</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="n">DATABASE</span><span class="p">)</span> <span class="c"># tell our models to use &quot;tweepee.db&quot;</span>
</pre></div>
</div>
<p>Because sqlite likes to have a separate connection per-thread, we will tell
flask that during the request/response cycle we need to create a connection to
the database.  Flask provides some handy decorators to make this a snap:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@app.before_request</span>
<span class="k">def</span> <span class="nf">before_request</span><span class="p">():</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">database</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

<span class="nd">@app.after_request</span>
<span class="k">def</span> <span class="nf">after_request</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We&#8217;re storing the db on the magical variable <tt class="docutils literal"><span class="pre">g</span></tt> - that&#8217;s a
flask-ism and can be ignored as an implementation detail.  The meat of this code
is in the idea that we connect to our db every request and close that connection
every response.  Django does the <a class="reference external" href="http://code.djangoproject.com/browser/django/tags/releases/1.2.3/django/db/__init__.py#L80">exact same thing</a>.</p>
</div>
</div>
<div class="section" id="making-queries">
<h3>Making queries<a class="headerlink" href="#making-queries" title="Permalink to this headline">¶</a></h3>
<p>In the <tt class="docutils literal"><span class="pre">User</span></tt> model there are a few instance methods that encapsulate some
user-specific functionality, i.e.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">following()</span></tt>: who is this user following?</li>
<li><tt class="docutils literal"><span class="pre">followers()</span></tt>: who is following this user?</li>
</ul>
<p>These methods are rather similar in their implementation but with one key
difference:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">following</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># query other users through the &quot;relationship&quot; table</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">Relationship</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">Relationship</span><span class="o">.</span><span class="n">to_user</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">from_user</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">followers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">Relationship</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">Relationship</span><span class="o">.</span><span class="n">from_user</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Relationship</span><span class="o">.</span><span class="n">to_user</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>The queries end up looking like:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="o">#</span> <span class="n">following</span><span class="p">:</span>
<span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;password&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;join_date&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;user&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;relationship&quot;</span> <span class="k">AS</span> <span class="n">t2</span>
    <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;to_user_id&quot;</span>  <span class="o">#</span> <span class="o">&lt;</span><span class="c1">-- joining on to_user_id</span>
<span class="k">WHERE</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;from_user_id&quot;</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;username&quot;</span> <span class="k">ASC</span>

<span class="o">#</span> <span class="n">followers</span>
<span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;username&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;password&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;email&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;join_date&quot;</span>
<span class="k">FROM</span> <span class="k">user</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">relationship</span> <span class="k">AS</span> <span class="n">t2</span>
    <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;from_user_id&quot;</span>  <span class="o">#</span> <span class="o">&lt;</span><span class="c1">-- joining on from_user_id</span>
<span class="k">WHERE</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;to_user_id&quot;</span> <span class="o">=</span> <span class="o">?</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;username&quot;</span> <span class="k">ASC</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-new-objects">
<h3>Creating new objects<a class="headerlink" href="#creating-new-objects" title="Permalink to this headline">¶</a></h3>
<p>So what happens when a new user wants to join the site?  Looking at the
business end of the <tt class="docutils literal"><span class="pre">join()</span></tt> view, we can that it does a quick check to see
if the username is taken, and if not executes a <a class="reference internal" href="api.html#Model.create" title="Model.create"><tt class="xref py py-meth docutils literal"><span class="pre">create()</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="c"># use the .get() method to quickly see if a user with that name exists</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">&#39;That username is already taken&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
    <span class="c"># if not, create the user and store the form data on the new model</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">],</span>
        <span class="n">password</span><span class="o">=</span><span class="n">md5</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
        <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">],</span>
        <span class="n">join_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c"># mark the user as being &#39;authenticated&#39; by setting the session vars</span>
    <span class="n">auth_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;homepage&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Much like the <a class="reference internal" href="api.html#Model.create" title="Model.create"><tt class="xref py py-meth docutils literal"><span class="pre">create()</span></tt></a> method, all models come with a built-in method called
<a class="reference internal" href="api.html#Model.get_or_create" title="Model.get_or_create"><tt class="xref py py-meth docutils literal"><span class="pre">get_or_create()</span></tt></a> which is used when one user follows another:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Relationship</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span>
    <span class="n">from_user</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">],</span> <span class="c"># &lt;-- the logged-in user</span>
    <span class="n">to_user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="c"># &lt;-- the user they want to follow</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="doing-subqueries">
<h3>Doing subqueries<a class="headerlink" href="#doing-subqueries" title="Permalink to this headline">¶</a></h3>
<p>If you are logged-in and visit the twitter homepage, you will see tweets from
the users that you follow.  In order to implement this, it is necessary to do
a subquery:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># python code</span>
<span class="n">messages</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">Message</span><span class="o">.</span><span class="n">user</span> <span class="o">&lt;&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Results in the following SQL query:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;content&quot;</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;pub_date&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;message&quot;</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;user_id&quot;</span> <span class="k">IN</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
    <span class="k">FROM</span> <span class="ss">&quot;user&quot;</span> <span class="k">AS</span> <span class="n">t2</span>
    <span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;relationship&quot;</span> <span class="k">AS</span> <span class="n">t3</span>
        <span class="k">ON</span> <span class="n">t2</span><span class="p">.</span><span class="ss">&quot;id&quot;</span> <span class="o">=</span> <span class="n">t3</span><span class="p">.</span><span class="ss">&quot;to_user_id&quot;</span>
    <span class="k">WHERE</span> <span class="n">t3</span><span class="p">.</span><span class="ss">&quot;from_user_id&quot;</span> <span class="o">=</span> <span class="o">?</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t1</span><span class="p">.</span><span class="ss">&quot;username&quot;</span> <span class="k">ASC</span>
<span class="p">)</span>
</pre></div>
</div>
<p>peewee supports doing subqueries on any <a class="reference internal" href="api.html#ForeignKeyField" title="ForeignKeyField"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKeyField</span></tt></a> or <a class="reference internal" href="api.html#PrimaryKeyField" title="PrimaryKeyField"><tt class="xref py py-class docutils literal"><span class="pre">PrimaryKeyField</span></tt></a>.</p>
</div>
<div class="section" id="what-else-is-of-interest-here">
<h3>What else is of interest here?<a class="headerlink" href="#what-else-is-of-interest-here" title="Permalink to this headline">¶</a></h3>
<p>There are a couple other neat things going on in the example app that are worth
mentioning briefly.</p>
<ul>
<li><p class="first">Support for paginating lists of results is implemented in a simple function called
<tt class="docutils literal"><span class="pre">object_list</span></tt> (after it&#8217;s corollary in Django).  This function is used by all
the views that return lists of objects.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">object_list</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s">&#39;object_list&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">page</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="n">pages</span><span class="o">=</span><span class="n">qr</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">/</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;page&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Simple authentication system with a <tt class="docutils literal"><span class="pre">login_required</span></tt> decorator.  The first
function simply adds user data into the current session when a user successfully
logs in.  The decorator <tt class="docutils literal"><span class="pre">login_required</span></tt> can be used to wrap view functions,
checking for whether the session is authenticated and if not redirecting to the
login page.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">auth_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;logged_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
    <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">&#39;You are logged in as </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">login_required</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logged_in&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner</span>
</pre></div>
</div>
</li>
<li><p class="first">Return a 404 response instead of throwing exceptions when an object is not
found in the database.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_object_or_404</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Like these snippets and interested in more?  Check out <a class="reference external" href="https://github.com/coleifer/flask-peewee">flask-peewee</a> -
a flask plugin that provides a django-like Admin interface, RESTful API, Authentication and
more for your peewee models.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Example app</a><ul>
<li><a class="reference internal" href="#running-the-example">Running the example</a></li>
<li><a class="reference internal" href="#diving-into-the-code">Diving into the code</a><ul>
<li><a class="reference internal" href="#models">Models</a></li>
<li><a class="reference internal" href="#creating-the-initial-tables">Creating the initial tables</a></li>
<li><a class="reference internal" href="#establishing-a-database-connection">Establishing a database connection</a></li>
<li><a class="reference internal" href="#making-queries">Making queries</a></li>
<li><a class="reference internal" href="#creating-new-objects">Creating new objects</a></li>
<li><a class="reference internal" href="#doing-subqueries">Doing subqueries</a></li>
<li><a class="reference internal" href="#what-else-is-of-interest-here">What else is of interest here?</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="quickstart.html"
                        title="previous chapter">Quickstart</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="cookbook.html"
                        title="next chapter">Peewee Cookbook</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/peewee/example.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="cookbook.html" title="Peewee Cookbook"
             >next</a> |</li>
        <li class="right" >
          <a href="quickstart.html" title="Quickstart"
             >previous</a> |</li>
        <li><a href="../index.html">peewee 2.2.3 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright charles leifer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>