<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Querying &mdash; peewee 2.2.3 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="peewee 2.2.3 documentation" href="../index.html" />
    <link rel="next" title="Databases" href="database.html" />
    <link rel="prev" title="Model and Fields" href="models.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="database.html" title="Databases"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Model and Fields"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">peewee 2.2.3 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="querying">
<span id="id1"></span><h1>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¶</a></h1>
<div class="section" id="expressions">
<span id="id2"></span><h2>Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline">¶</a></h2>
<p>Peewee was designed to provide a simple, expressive, and pythonic way of executing
queries.  This section will provide a quick overview of some common types of expressions.</p>
<p>There are two primary types of objects that can be composed to create expressions:</p>
<ul class="simple">
<li><a class="reference internal" href="api.html#Field" title="Field"><tt class="xref py py-class docutils literal"><span class="pre">Field</span></tt></a> instances</li>
<li>SQL aggregations and functions using <a class="reference internal" href="api.html#fn" title="fn"><tt class="xref py py-class docutils literal"><span class="pre">fn</span></tt></a></li>
</ul>
<p>We will assume a simple &#8220;User&#8221; model with fields for username and other things.
It looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">last_login</span> <span class="o">=</span> <span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">login_count</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">failed_logins</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
</pre></div>
</div>
<p>Comparisons use the <a class="reference internal" href="#column-lookups"><em>Column lookups</em></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># username is equal to &#39;charlie&#39;</span>
<span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span>

<span class="c"># user has logged in less than 5 times</span>
<span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">&lt;</span> <span class="mi">5</span>
</pre></div>
</div>
<p>Comparisons can be combined using bitwise &#8220;and&#8221; and &#8220;or&#8221;.  Operator precedence
is controlled by python and comparisons can be nested to an arbitrary depth:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># user is both and admin and has logged in today</span>
<span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">last_login</span> <span class="o">&gt;=</span> <span class="n">today</span><span class="p">)</span>

<span class="c"># user&#39;s username is either charlie or charles</span>
<span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charles&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Comparisons can be used with functions as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># user&#39;s username starts with a &#39;g&#39; or a &#39;G&#39;:</span>
<span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s">&#39;g&#39;</span>
</pre></div>
</div>
<p>We can do some fairly interesting things, as expressions can be compared against
other expressions.  Expressions also support arithmetic operations:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># users who entered the incorrect more than half the time and have logged</span>
<span class="c"># in at least 10 times</span>
<span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">failed_logins</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Expressions allow us to do atomic updates:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># when a user logs in we want to increment their login count:</span>
<span class="n">User</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">login_count</span><span class="o">=</span><span class="n">User</span><span class="o">.</span><span class="n">login_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>
</pre></div>
</div>
<p>Expressions can be used in all parts of a query, so experiment!</p>
</div>
<div class="section" id="constructing-queries">
<h2>Constructing queries<a class="headerlink" href="#constructing-queries" title="Permalink to this headline">¶</a></h2>
<p>Queries in peewee are constructed one piece at a time.</p>
<p>The &#8220;pieces&#8221; of a peewee query are generally representative of clauses you might
find in a SQL query.  Most methods are chainable, so you build your query up
one clause at a time.  This way, rather complex queries are possible.</p>
<p>Here is a barebones select query:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user_q</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span> <span class="c"># &lt;-- query is not executed</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_q</span>
<span class="go">&lt;peewee.SelectQuery object at 0x7f6b0810c610&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">username</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">user_q</span><span class="p">]</span> <span class="c"># &lt;-- query is evaluated here</span>
<span class="go">[u&#39;admin&#39;, u&#39;staff&#39;, u&#39;editor&#39;]</span>
</pre></div>
</div>
<p>We can build up the query by adding some clauses to it:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">user_q</span> <span class="o">=</span> <span class="n">user_q</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="s">&#39;admin&#39;</span><span class="p">,</span> <span class="s">&#39;editor&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_q</span> <span class="o">=</span> <span class="n">user_q</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">username</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">user_q</span><span class="p">]</span> <span class="c"># &lt;-- query is re-evaluated here</span>
<span class="go">[u&#39;editor&#39;, u&#39;admin&#39;]</span>
</pre></div>
</div>
<div class="section" id="peewee-and-sql-injection">
<h3>Peewee and SQL Injection<a class="headerlink" href="#peewee-and-sql-injection" title="Permalink to this headline">¶</a></h3>
<p>Because peewee uses parameterized queries, values passed in are automatically
escaped and cannot be used for SQL injection attacks. If you are writing SQL
via either <a class="reference internal" href="api.html#RawQuery" title="RawQuery"><tt class="xref py py-class docutils literal"><span class="pre">RawQuery</span></tt></a> or <a class="reference internal" href="api.html#Database.execute_sql" title="Database.execute_sql"><tt class="xref py py-meth docutils literal"><span class="pre">execute_sql()</span></tt></a> simply be
sure that you pass any untrusted values in as parameters to the query.</p>
</div>
<div class="section" id="looking-at-some-simple-queries">
<span id="query-compare"></span><h3>Looking at some simple queries<a class="headerlink" href="#looking-at-some-simple-queries" title="Permalink to this headline">¶</a></h3>
<p>Get active users:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Get users who are either staff or superusers:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>Get tweets by user named &#8220;charlie&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="s">&#39;charlie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Get tweets by staff or superusers (assumes FK relationship):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="where-clause">
<span id="id3"></span><h2>Where clause<a class="headerlink" href="#where-clause" title="Permalink to this headline">¶</a></h2>
<p>All queries except <a class="reference internal" href="api.html#InsertQuery" title="InsertQuery"><tt class="xref py py-class docutils literal"><span class="pre">InsertQuery</span></tt></a> and <a class="reference internal" href="api.html#RawQuery" title="RawQuery"><tt class="xref py py-class docutils literal"><span class="pre">RawQuery</span></tt></a> support the
<a class="reference internal" href="api.html#Query.where" title="Query.where"><tt class="xref py py-meth docutils literal"><span class="pre">where()</span></tt></a> method.  If you are familiar with Django&#8217;s ORM, it is
analagous to the <tt class="docutils literal"><span class="pre">filter()</span></tt> method.  Inside the where clause, you will place
one or more <a class="reference internal" href="#expressions"><em>Expressions</em></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><tt class="docutils literal"><span class="pre">User.select()</span></tt> is equivalent to <tt class="docutils literal"><span class="pre">SelectQuery(User)</span></tt>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Multiple calls to <a class="reference internal" href="api.html#Query.where" title="Query.where"><tt class="xref py py-meth docutils literal"><span class="pre">where()</span></tt></a> will be <tt class="docutils literal"><span class="pre">AND</span></tt>-ed together. To
dynamically connect clauses with <tt class="docutils literal"><span class="pre">OR</span></tt>:</p>
<div class="last highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">operator</span>
<span class="n">or_clauses</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">clauses</span><span class="p">)</span>  <span class="c"># OR together all clauses</span>
</pre></div>
</div>
</div>
<div class="section" id="column-lookups">
<span id="id4"></span><h3>Column lookups<a class="headerlink" href="#column-lookups" title="Permalink to this headline">¶</a></h3>
<p>The following types of comparisons are supported by peewee:</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Comparison</th>
<th class="head">Meaning</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">==</span></tt></td>
<td>x equals y</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&lt;</span></tt></td>
<td>x is less than y</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&lt;=</span></tt></td>
<td>x is less than or equal to y</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&gt;</span></tt></td>
<td>x is greater than y</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&gt;=</span></tt></td>
<td>x is greater than or equal to y</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">!=</span></tt></td>
<td>x is not equal to y</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">&lt;&lt;</span></tt></td>
<td>x IN y, where y is a list or query</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">&gt;&gt;</span></tt></td>
<td>x IS y, where y is None/NULL</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">%</span></tt></td>
<td>x LIKE y where y may contain wildcards</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">**</span></tt></td>
<td>x ILIKE y where y may contain wildcards</td>
</tr>
</tbody>
</table>
<p>You can also perform &#8220;BETWEEN&#8221; lookups by calling the <tt class="docutils literal"><span class="pre">between</span></tt> method on
a field object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Employee</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">50000</span><span class="p">,</span> <span class="mi">60000</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because SQLite&#8217;s <tt class="docutils literal"><span class="pre">LIKE</span></tt> operation is case-insensitive by default,
peewee will use the SQLite <tt class="docutils literal"><span class="pre">GLOB</span></tt> operation for case-sensitive searches.
The glob operation uses asterisks for wildcards as opposed to the usual
percent-sign.  <strong>If you are using SQLite and want case-sensitive partial
string matching, remember to use asterisks for the wildcard (``*``).</strong></p>
</div>
</div>
<div class="section" id="adding-user-defined-operators">
<span id="custom-lookups"></span><h3>Adding user-defined operators<a class="headerlink" href="#adding-user-defined-operators" title="Permalink to this headline">¶</a></h3>
<p>Because I ran out of python operators to overload, there are some missing
operators in peewee, for instance <a class="reference external" href="https://github.com/coleifer/peewee/issues/177">modulo</a>.
If you find that you need to support an operator that is not in the table
above, it is very easy to add your own.</p>
<p>Here is how you might add support for <tt class="docutils literal"><span class="pre">modulo</span></tt> and <tt class="docutils literal"><span class="pre">regexp</span></tt> in SQLite:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="n">Expression</span> <span class="c"># the building block for expressions</span>

<span class="n">OP_MOD</span> <span class="o">=</span> <span class="s">&#39;mod&#39;</span>
<span class="n">OP_REGEXP</span> <span class="o">=</span> <span class="s">&#39;regexp&#39;</span>

<span class="k">def</span> <span class="nf">mod</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">OP_MOD</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">regexp</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Expression</span><span class="p">(</span><span class="n">lhs</span><span class="p">,</span> <span class="n">OP_REGEXP</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>

<span class="n">SqliteDatabase</span><span class="o">.</span><span class="n">register_ops</span><span class="p">({</span><span class="n">OP_MOD</span><span class="p">:</span> <span class="s">&#39;%&#39;</span><span class="p">,</span> <span class="n">OP_REGEXP</span><span class="p">:</span> <span class="s">&#39;REGEXP&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Now you can use these custom operators to build richer queries:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># users with even ids</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mod</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

<span class="c"># users whose username starts with a number</span>
<span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">regexp</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;[0-9].*&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>For more examples check out the source to the <tt class="docutils literal"><span class="pre">playhouse.postgresql_ext</span></tt>
module, as it contains numerous operators specific to postgresql&#8217;s hstore.</p>
</div>
</div>
<div class="section" id="joining-tables">
<h2>Joining Tables<a class="headerlink" href="#joining-tables" title="Permalink to this headline">¶</a></h2>
<p>You can join on tables related to one another by <a class="reference internal" href="api.html#ForeignKeyField" title="ForeignKeyField"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKeyField</span></tt></a>.  The <a class="reference internal" href="api.html#Query.join" title="Query.join"><tt class="xref py py-meth docutils literal"><span class="pre">join()</span></tt></a>
method acts on the <a class="reference internal" href="api.html#Model" title="Model"><tt class="xref py py-class docutils literal"><span class="pre">Model</span></tt></a> that is the current &#8220;query context&#8221;.
This is either:</p>
<ul class="simple">
<li>the model the query class was initialized with</li>
<li>the model most recently JOINed on</li>
</ul>
<p>There are three types of joins by default:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">JOIN_INNER</span></tt> (default)</li>
<li><tt class="docutils literal"><span class="pre">JOIN_LEFT_OUTER</span></tt></li>
<li><tt class="docutils literal"><span class="pre">JOIN_FULL</span></tt></li>
</ul>
<p>Here are some examples:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Blog</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LIVE</span><span class="p">))</span>
</pre></div>
</div>
<p>The above query grabs all staff users who have a blog that is &#8220;LIVE&#8221;.  This next does the
inverse: grabs all the blogs that are live whose author is a staffer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LIVE</span><span class="p">))</span>
</pre></div>
</div>
<p>Another way to write the above query would be to use a subquery:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">staff</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">Blog</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LIVE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Blog</span><span class="o">.</span><span class="n">user</span> <span class="o">&lt;&lt;</span> <span class="n">staff</span><span class="p">))</span>
</pre></div>
</div>
<p>The above bears a little bit of explanation.  First off the SQL generated will
not perform any explicit <tt class="docutils literal"><span class="pre">JOIN</span></tt> - it will rather use a subquery in the <tt class="docutils literal"><span class="pre">WHERE</span></tt>
clause:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- translates roughly to --</span>
<span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">blog</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="p">(</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="k">user</span> <span class="k">AS</span> <span class="n">t2</span> <span class="k">WHERE</span> <span class="n">t2</span><span class="p">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="o">?</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Here is what the SQL looks like if we use the <tt class="docutils literal"><span class="pre">join</span></tt> method:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- and here it would be if using joins --</span>
<span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">blog</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="k">user</span> <span class="k">AS</span> <span class="n">t2</span>
    <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span>
    <span class="n">t1</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">?</span> <span class="k">AND</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="o">?</span>
</pre></div>
</div>
<div class="section" id="self-joins">
<span id="id5"></span><h3>Self-joins<a class="headerlink" href="#self-joins" title="Permalink to this headline">¶</a></h3>
<p>Suppose you have some models organized in a self-referential hierarchy:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">ForeignKeyField</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to do a self-join you will need to use the <a class="reference internal" href="api.html#Model.alias" title="Model.alias"><tt class="xref py py-meth docutils literal"><span class="pre">Model.alias()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">Parent</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="c"># select all categories where the parent is named &quot;Parent Category&quot;</span>
<span class="n">Category</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Parent</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">Category</span><span class="o">.</span><span class="n">parent</span> <span class="o">==</span> <span class="n">Parent</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">Parent</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Parent Category&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You must explicitly specify how to construct the join when doing a self-join</p>
</div>
</div>
<div class="section" id="joining-on-unrelated-models-or-conditions-other-than-equality">
<span id="non-fk-joins"></span><h3>Joining on Unrelated Models or Conditions other than Equality<a class="headerlink" href="#joining-on-unrelated-models-or-conditions-other-than-equality" title="Permalink to this headline">¶</a></h3>
<p>It is possible to use peewee&#8217;s rich expressions to specify join conditions.  This
can also be used to create joins on models not related by <a class="reference internal" href="api.html#ForeignKeyField" title="ForeignKeyField"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKeyField</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># No explicit foreign key between these models.</span>
<span class="n">OutboundShipment</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">InboundShipment</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span>
    <span class="n">OutboundShipment</span><span class="o">.</span><span class="n">barcode</span> <span class="o">==</span> <span class="n">InboundShipment</span><span class="o">.</span><span class="n">barcode</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="performing-advanced-queries">
<h2>Performing advanced queries<a class="headerlink" href="#performing-advanced-queries" title="Permalink to this headline">¶</a></h2>
<p>To create arbitrarily complex queries, simply use python&#8217;s bitwise &#8220;and&#8221;
and &#8220;or&#8221; operators:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sq</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">WHERE</span></tt> clause will look something like:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">WHERE</span> <span class="p">(</span><span class="n">is_staff</span> <span class="o">=</span> <span class="o">?</span> <span class="k">OR</span> <span class="n">is_superuser</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to negate an expression, use the bitwise &#8220;invert&#8221; operator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">staff_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="o">~</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">user</span> <span class="o">&lt;&lt;</span> <span class="n">staff_users</span><span class="p">))</span>
</pre></div>
</div>
<p>This query generates roughly the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="n">blog</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span>
    <span class="k">NOT</span> <span class="n">t1</span><span class="p">.</span><span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span>
        <span class="k">SELECT</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="k">user</span> <span class="k">AS</span> <span class="n">t2</span> <span class="k">WHERE</span> <span class="n">t2</span><span class="p">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span>
</pre></div>
</div>
<p>Rather complex lookups are possible:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sq</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="p">((</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">==</span> <span class="bp">True</span><span class="p">))</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">join_date</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>This generates roughly the following SQL:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="k">user</span>
<span class="k">WHERE</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">is_staff</span> <span class="o">=</span> <span class="o">?</span> <span class="k">OR</span> <span class="n">is_superuser</span> <span class="o">=</span> <span class="o">?</span><span class="p">)</span> <span class="k">AND</span>
    <span class="p">(</span><span class="n">join_date</span> <span class="o">&gt;=</span> <span class="o">?</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="other-types-of-comparisons">
<h3>Other types of comparisons<a class="headerlink" href="#other-types-of-comparisons" title="Permalink to this headline">¶</a></h3>
<p>Suppose you have a model that looks like the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">WorkerProfiles</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">salary</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">desired</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">tenure</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
</pre></div>
</div>
<p>What if we want to query <tt class="docutils literal"><span class="pre">WorkerProfiles</span></tt> to find all the rows where &#8220;salary&#8221; is greater
than &#8220;desired&#8221; (maybe you want to find out who may be looking for a raise)?</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">WorkerProfile</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">WorkerProfile</span><span class="o">.</span><span class="n">salary</span> <span class="o">&lt;</span> <span class="n">WorkerProfile</span><span class="o">.</span><span class="n">desired</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also create expressions, like to find employees who might not be getting
paid enough based on their tenure:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">WorkerProfile</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">WorkerProfile</span><span class="o">.</span><span class="n">salary</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">WorkerProfile</span><span class="o">.</span><span class="n">tenure</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">40000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="atomic-updates">
<h3>Atomic updates<a class="headerlink" href="#atomic-updates" title="Permalink to this headline">¶</a></h3>
<p>The techniques shown above also work for updating data.  Suppose you
are counting pageviews in a special table:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">PageView</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">PageView</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">PageView</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-fn-helper">
<h3>The &#8220;fn&#8221; helper<a class="headerlink" href="#the-fn-helper" title="Permalink to this headline">¶</a></h3>
<p>SQL provides a number of helper functions as a part of the language.  These functions
can be used to calculate counts and sums over rows, perform string manipulations,
do complex math, and more.  There are a lot of functions.</p>
<p>To express functions in peewee, use the <a class="reference internal" href="api.html#fn" title="fn"><tt class="xref py py-class docutils literal"><span class="pre">fn</span></tt></a> object.  The way it works is
anything to the right of the &#8220;dot&#8221; operator will be treated as a function.  You can
pass that function arbitrary parameters which can be other valid expressions.</p>
<p>For example:</p>
<table border="1" class="docutils" id="fn-examples">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Peewee expression</th>
<th class="head">Equivalent SQL</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">fn.Count(Tweet.id).alias('count')</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Count(t1.&quot;id&quot;)</span> <span class="pre">AS</span> <span class="pre">count</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">fn.Lower(fn.Substr(User.username,</span> <span class="pre">1,</span> <span class="pre">1))</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Lower(Substr(t1.&quot;username&quot;,</span> <span class="pre">1,</span> <span class="pre">1))</span></tt></td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">fn.Rand().alias('random')</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Rand()</span> <span class="pre">AS</span> <span class="pre">random</span></tt></td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">fn.Stddev(Employee.salary).alias('sdv')</span></tt></td>
<td><tt class="docutils literal"><span class="pre">Stddev(t1.&quot;salary&quot;)</span> <span class="pre">AS</span> <span class="pre">sdv</span></tt></td>
</tr>
</tbody>
</table>
<p>Functions can be used as any part of a query:</p>
<ul class="simple">
<li>select</li>
<li>where</li>
<li>group_by</li>
<li>order_by</li>
<li>having</li>
<li>update query</li>
<li>insert query</li>
</ul>
<p>View API documentation on <a class="reference internal" href="api.html#fn" title="fn"><tt class="xref py py-class docutils literal"><span class="pre">fn</span></tt></a></p>
</div>
<div class="section" id="aggregating-records">
<h3>Aggregating records<a class="headerlink" href="#aggregating-records" title="Permalink to this headline">¶</a></h3>
<p>Suppose you have some users and want to get a list of them along with the count
of tweets each has made.  First I will show you the shortcut:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span>
</pre></div>
</div>
<p>This is equivalent to the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">User</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;count&#39;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
</pre></div>
</div>
<p>The resulting query will return <tt class="docutils literal"><span class="pre">User</span></tt> objects with all their normal attributes
plus an additional attribute &#8216;count&#8217; which will contain the number of tweets.
By default it uses an inner join, which means users without tweets won&#8217;t appear
in the list.  To remedy this, manually specify the type of join to include users
with 0 tweets:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">JOIN_LEFT_OUTER</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also specify a custom aggregator.  In the following query we will annotate
the users with the date of their most recent tweet:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">query</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">Tweet</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;latest&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Conversely, sometimes you want to perform an aggregate query that returns a
scalar value, like the &#8220;max id&#8221;.  Queries like this can be executed by using
the <a class="reference internal" href="api.html#SelectQuery.aggregate" title="SelectQuery.aggregate"><tt class="xref py py-meth docutils literal"><span class="pre">aggregate()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">most_recent_tweet</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Max</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="sql-functions">
<h3>SQL Functions<a class="headerlink" href="#sql-functions" title="Permalink to this headline">¶</a></h3>
<p>Arbitrary SQL functions can be expressed using the <a class="reference internal" href="api.html#fn" title="fn"><tt class="xref py py-class docutils literal"><span class="pre">fn</span></tt></a> helper.</p>
<p>Selecting users and counts of tweets:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="p">(</span><span class="n">User</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;count&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Tweet</span><span class="p">)</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="p">))</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;posted&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s">&#39;tweets&#39;</span>
</pre></div>
</div>
<p>This functionality can also be used as part of the <tt class="docutils literal"><span class="pre">WHERE</span></tt> or <tt class="docutils literal"><span class="pre">HAVING</span></tt> clauses:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">a_users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">Substr</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">a_users</span><span class="p">:</span>
<span class="gp">... </span>  <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>

<span class="go">alpha</span>
<span class="go">Alton</span>
</pre></div>
</div>
</div>
<div class="section" id="window-functions">
<h3>Window functions<a class="headerlink" href="#window-functions" title="Permalink to this headline">¶</a></h3>
<p>peewee comes with basic support for SQL window functions, which can be created
by calling <a class="reference internal" href="api.html#fn.over" title="fn.over"><tt class="xref py py-meth docutils literal"><span class="pre">fn.over()</span></tt></a> and passing in your partitioning or ordering
parameters.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Get the list of employees and the average salary for their dept.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Employee</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">department</span><span class="p">,</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">,</span>
             <span class="n">fn</span><span class="o">.</span><span class="n">Avg</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
                 <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">Employee</span><span class="o">.</span><span class="n">department</span><span class="p">]))</span>
         <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

<span class="c"># Rank employees by salary.</span>
<span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="n">Employee</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">,</span>
             <span class="n">fn</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span>
                 <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="n">Employee</span><span class="o">.</span><span class="n">salary</span><span class="p">])))</span>
</pre></div>
</div>
<p>For general information on window functions, check
out the <a class="reference external" href="http://www.postgresql.org/docs/9.1/static/tutorial-window.html">postgresql docs</a>.</p>
</div>
<div class="section" id="saving-queries-by-selecting-related-models">
<h3>Saving Queries by Selecting Related Models<a class="headerlink" href="#saving-queries-by-selecting-related-models" title="Permalink to this headline">¶</a></h3>
<p>Returning to my favorite models, <tt class="docutils literal"><span class="pre">User</span></tt> and <tt class="docutils literal"><span class="pre">Tweet</span></tt>, between which there is a
<a class="reference internal" href="api.html#ForeignKeyField" title="ForeignKeyField"><tt class="xref py py-class docutils literal"><span class="pre">ForeignKeyField</span></tt></a>, a common pattern might be to display a list of the
latest 10 tweets with some info about the user that posted them.  We can do
this pretty easily:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">, posted on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>Looking at the query log, though, this will cause 11 queries:</p>
<ul class="simple">
<li>1 query for the tweets</li>
<li>1 query for every related user (10 total)</li>
</ul>
<p>This can be optimized into one query very easily, though:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">tweets</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">, posted on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>Will cause only one query that looks something like this:</p>
<div class="highlight-sql"><div class="highlight"><pre><span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">created_date</span><span class="p">,</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t2</span><span class="p">.</span><span class="n">username</span>
<span class="k">FROM</span> <span class="n">tweet</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="k">user</span> <span class="k">AS</span> <span class="n">t2</span>
    <span class="k">ON</span> <span class="n">t1</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t1</span><span class="p">.</span><span class="n">created_date</span> <span class="k">desc</span>
<span class="k">LIMIT</span> <span class="mi">10</span>
</pre></div>
</div>
<p>peewee will handle constructing the objects and you can access them as you would
normally.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note in the above example the call to <tt class="docutils literal"><span class="pre">.join(User)</span></tt></p>
</div>
<p>This works for following objects &#8220;up&#8221; the chain, i.e. following foreign key relationships.
To accomplish the reverse, i.e. list users and prefetch all related tweets, you will need
to use the <a class="reference internal" href="api.html#prefetch" title="prefetch"><tt class="xref py py-func docutils literal"><span class="pre">prefetch()</span></tt></a> API discussed in the next secion.</p>
</div>
<div class="section" id="pre-fetching-related-instances">
<span id="prefetch"></span><h3>Pre-fetching related instances<a class="headerlink" href="#pre-fetching-related-instances" title="Permalink to this headline">¶</a></h3>
<p>As a corollary to the previous section in which we selected models going &#8220;up&#8221; the
chain, in this section I will show you to select models going &#8220;down&#8221; the chain
in a 1 -&gt; many relationship.  For example, selecting users and all of their tweets.</p>
<p>Assume you want to display a list of users and all of their tweets:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
</pre></div>
</div>
<p>This will generate N queries, however - 1 for the users, and then N for each user&#8217;s
tweets.  Instead of doing N queries, we can do 2 instead:</p>
<ol class="arabic simple">
<li>One for all the users</li>
<li>One for all the tweets for the users selected in (1)</li>
</ol>
<div class="highlight-sql"><div class="highlight"><pre><span class="c1">-- first query --</span>
<span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">username</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">AS</span> <span class="n">t1</span><span class="p">;</span>

<span class="c1">-- second query --</span>
<span class="k">SELECT</span> <span class="n">t1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">t1</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">FROM</span> <span class="n">tweet</span> <span class="k">AS</span> <span class="n">t1</span>
<span class="k">WHERE</span> <span class="n">t1</span><span class="p">.</span><span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">t2</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">AS</span> <span class="n">t2</span><span class="p">)</span>
</pre></div>
</div>
<p>Peewee can evaluate both queries and &#8220;prefetch&#8221; the tweets for each user, storing
them in an attribute on the user model.  To do this, use the <a class="reference internal" href="api.html#prefetch" title="prefetch"><tt class="xref py py-func docutils literal"><span class="pre">prefetch()</span></tt></a>
function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">users_prefetch</span> <span class="o">=</span> <span class="n">prefetch</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">tweets</span><span class="p">)</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_prefetch</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>

    <span class="c"># note we are using a different attr -- it is the &quot;related name&quot; + &quot;_prefetch&quot;</span>
    <span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">tweets_prefetch</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">tweet</span><span class="o">.</span><span class="n">message</span>
</pre></div>
</div>
<p>This will result in 2 queries &#8211; one for the users and one for the tweets.  Either
query can have restrictions, such as a <tt class="docutils literal"><span class="pre">WHERE</span></tt> clause, and the queries can follow
relationships arbitrarily deep:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># let&#39;s say we have users -&gt; photos -&gt; comments / tags</span>
<span class="c"># such that a user posts photos, assigns tags to those photos, and all those</span>
<span class="c"># photos can be commented on</span>

<span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">photos</span> <span class="o">=</span> <span class="n">Photo</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">published</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
<span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Comment</span><span class="o">.</span><span class="n">is_spam</span> <span class="o">==</span> <span class="bp">False</span><span class="p">,</span> <span class="n">Comment</span><span class="o">.</span><span class="n">flags</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>

<span class="c"># this will execute 4 queries, one for each model</span>
<span class="n">users_prefetch</span> <span class="o">=</span> <span class="n">prefetch</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="n">photos</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">comments</span><span class="p">)</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users_prefetch</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">username</span>
    <span class="k">for</span> <span class="n">photo</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">photo_set_prefetch</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;photo: &#39;</span><span class="p">,</span> <span class="n">photo</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">photo</span><span class="o">.</span><span class="n">tag_set_prefetch</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;tagged with:&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">photo</span><span class="o">.</span><span class="n">comment_set_prefetch</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;comment:&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">.</span><span class="n">comment</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Care should be used with prefetch!  It can save you queries, but it can also
use a lot of memory if the number of results returned is large.  To mitigate
this, apply a <tt class="docutils literal"><span class="pre">LIMIT</span></tt> to your outer query.</p>
</div>
</div>
<div class="section" id="speeding-up-simple-select-queries">
<h3>Speeding up simple select queries<a class="headerlink" href="#speeding-up-simple-select-queries" title="Permalink to this headline">¶</a></h3>
<p>Complex select queries can get a performance boost (especially when iterating over large
result sets) by calling <a class="reference internal" href="api.html#SelectQuery.naive" title="SelectQuery.naive"><tt class="xref py py-meth docutils literal"><span class="pre">naive()</span></tt></a>.  This method simply patches all
attributes directly from the cursor onto the model.  For simple queries this will have
no noticeable impact.  The <em>only</em> difference is when multiple tables are queried, as in the
previous example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># above example</span>
<span class="n">tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">tweets</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">, posted on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>And here is how you would do the same if using a naive query:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># very similar query to the above -- main difference is we&#39;re</span>
<span class="c"># aliasing the blog title to &quot;blog_title&quot;</span>
<span class="n">tweets</span> <span class="o">=</span> <span class="n">Tweet</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Tweet</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">username</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">naive</span><span class="p">()</span>
<span class="k">for</span> <span class="n">tweet</span> <span class="ow">in</span> <span class="n">tweets</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Tweet</span><span class="o">.</span><span class="n">created_date</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">, posted on </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tweet</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">tweet</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</pre></div>
</div>
<p>To iterate over raw tuples, use the <a class="reference internal" href="api.html#SelectQuery.tuples" title="SelectQuery.tuples"><tt class="xref py py-meth docutils literal"><span class="pre">tuples()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stats</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">))</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">tuples</span><span class="p">()</span>
<span class="k">for</span> <span class="n">stat_url</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">stat_url</span><span class="p">,</span> <span class="n">count</span>
</pre></div>
</div>
<p>To iterate over dictionaries, use the <a class="reference internal" href="api.html#SelectQuery.dicts" title="SelectQuery.dicts"><tt class="xref py py-meth docutils literal"><span class="pre">dicts()</span></tt></a> method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stats</span> <span class="o">=</span> <span class="n">Stat</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;ct&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Stat</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">dicts</span><span class="p">()</span>
<span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">stat</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">],</span> <span class="n">stat</span><span class="p">[</span><span class="s">&#39;ct&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="query-evaluation">
<h2>Query evaluation<a class="headerlink" href="#query-evaluation" title="Permalink to this headline">¶</a></h2>
<p>In order to execute a query, it is <em>always</em> necessary to call the <tt class="docutils literal"><span class="pre">execute()</span></tt>
method.</p>
<p>To get a better idea of how querying works let&#8217;s look at some example queries
and their return values:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">dq</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span> <span class="c"># &lt;-- returns a DeleteQuery</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dq</span>
<span class="go">&lt;peewee.DeleteQuery object at 0x7fc866ada4d0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dq</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c"># &lt;-- executes the query and returns number of rows deleted</span>
<span class="go">3</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">uq</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">active</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="c"># &lt;-- returns an UpdateQuery</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">uq</span>
<span class="go">&lt;peewee.UpdateQuery object at 0x7fc865beff50&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">uq</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c"># &lt;-- executes the query and returns number of rows updated</span>
<span class="go">2</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">iq</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;new user&#39;</span><span class="p">)</span> <span class="c"># &lt;-- returns an InsertQuery</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">iq</span>
<span class="go">&lt;peewee.InsertQuery object at 0x7fc865beff10&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">iq</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c"># &lt;-- executes query and returns the new row&#39;s PK</span>
<span class="go">8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">sq</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># &lt;-- returns a SelectQuery</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sq</span>
<span class="go">&lt;peewee.SelectQuery object at 0x7fc865b7a510&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span> <span class="o">=</span> <span class="n">sq</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c"># &lt;-- executes query and returns a QueryResultWrapper</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qr</span>
<span class="go">&lt;peewee.QueryResultWrapper object at 0x7fc865b7a6d0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">qr</span><span class="p">]</span>
<span class="go">[1, 2, 3, 4, 7, 8]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">qr</span><span class="p">]</span> <span class="c"># &lt;-- re-iterating over qr does not re-execute query</span>
<span class="go">[1, 2, 3, 4, 7, 8]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">sq</span><span class="p">]</span> <span class="c"># &lt;-- as a shortcut, you can iterate directly over</span>
<span class="gp">&gt;&gt;&gt; </span>                   <span class="c">#     a SelectQuery (which uses a QueryResultWrapper</span>
<span class="gp">&gt;&gt;&gt; </span>                   <span class="c">#     behind-the-scenes)</span>
<span class="go">[1, 2, 3, 4, 7, 8]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Iterating over a <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><tt class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></tt></a> will cause it to be evaluated, but iterating
over it multiple times will not result in the query being executed again.</p>
</div>
</div>
<div class="section" id="queryresultwrapper">
<h2>QueryResultWrapper<a class="headerlink" href="#queryresultwrapper" title="Permalink to this headline">¶</a></h2>
<p>As I hope the previous bit showed, <tt class="docutils literal"><span class="pre">Delete</span></tt>, <tt class="docutils literal"><span class="pre">Insert</span></tt> and <tt class="docutils literal"><span class="pre">Update</span></tt> queries are all
pretty straightforward.  <tt class="docutils literal"><span class="pre">Select</span></tt> queries are a little bit tricky in that they
return a special object called a <tt class="xref py py-class docutils literal"><span class="pre">QueryResultWrapper</span></tt>.  The sole purpose of this
class is to allow the results of a query to be iterated over efficiently.  In
general it should not need to be dealt with explicitly.</p>
<p>The preferred method of iterating over a result set is to iterate directly over
the <a class="reference internal" href="api.html#SelectQuery" title="SelectQuery"><tt class="xref py py-class docutils literal"><span class="pre">SelectQuery</span></tt></a>, allowing it to manage the <tt class="xref py py-class docutils literal"><span class="pre">QueryResultWrapper</span></tt> internally.</p>
</div>
<div class="section" id="writing-queries-by-hand-with-sql">
<span id="using-sql"></span><h2>Writing queries by hand with SQL<a class="headerlink" href="#writing-queries-by-hand-with-sql" title="Permalink to this headline">¶</a></h2>
<p>There are two ways to execute hand-crafted SQL statements with peewee:</p>
<ol class="arabic simple">
<li><a class="reference internal" href="api.html#Database.execute_sql" title="Database.execute_sql"><tt class="xref py py-meth docutils literal"><span class="pre">Database.execute_sql()</span></tt></a> for executing any type of query</li>
<li><a class="reference internal" href="api.html#RawQuery" title="RawQuery"><tt class="xref py py-class docutils literal"><span class="pre">RawQuery</span></tt></a> for executing <tt class="docutils literal"><span class="pre">SELECT</span></tt> queries and <em>returning model instances</em>.</li>
</ol>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s">&#39;:memory:&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>

<span class="c"># let&#39;s pretend we want to do an &quot;upsert&quot;, something that SQLite can</span>
<span class="c"># do, but peewee cannot.</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span> <span class="s">&#39;mickey&#39;</span><span class="p">,</span> <span class="s">&#39;huey&#39;</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="s">&#39;REPLACE INTO person (name) VALUES (?)&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>

<span class="c"># now let&#39;s iterate over the people using our own query.</span>
<span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">Person</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;select * from person&#39;</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>  <span class="c"># .raw() will return model instances.</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Querying</a><ul>
<li><a class="reference internal" href="#expressions">Expressions</a></li>
<li><a class="reference internal" href="#constructing-queries">Constructing queries</a><ul>
<li><a class="reference internal" href="#peewee-and-sql-injection">Peewee and SQL Injection</a></li>
<li><a class="reference internal" href="#looking-at-some-simple-queries">Looking at some simple queries</a></li>
</ul>
</li>
<li><a class="reference internal" href="#where-clause">Where clause</a><ul>
<li><a class="reference internal" href="#column-lookups">Column lookups</a></li>
<li><a class="reference internal" href="#adding-user-defined-operators">Adding user-defined operators</a></li>
</ul>
</li>
<li><a class="reference internal" href="#joining-tables">Joining Tables</a><ul>
<li><a class="reference internal" href="#self-joins">Self-joins</a></li>
<li><a class="reference internal" href="#joining-on-unrelated-models-or-conditions-other-than-equality">Joining on Unrelated Models or Conditions other than Equality</a></li>
</ul>
</li>
<li><a class="reference internal" href="#performing-advanced-queries">Performing advanced queries</a><ul>
<li><a class="reference internal" href="#other-types-of-comparisons">Other types of comparisons</a></li>
<li><a class="reference internal" href="#atomic-updates">Atomic updates</a></li>
<li><a class="reference internal" href="#the-fn-helper">The &#8220;fn&#8221; helper</a></li>
<li><a class="reference internal" href="#aggregating-records">Aggregating records</a></li>
<li><a class="reference internal" href="#sql-functions">SQL Functions</a></li>
<li><a class="reference internal" href="#window-functions">Window functions</a></li>
<li><a class="reference internal" href="#saving-queries-by-selecting-related-models">Saving Queries by Selecting Related Models</a></li>
<li><a class="reference internal" href="#pre-fetching-related-instances">Pre-fetching related instances</a></li>
<li><a class="reference internal" href="#speeding-up-simple-select-queries">Speeding up simple select queries</a></li>
</ul>
</li>
<li><a class="reference internal" href="#query-evaluation">Query evaluation</a></li>
<li><a class="reference internal" href="#queryresultwrapper">QueryResultWrapper</a></li>
<li><a class="reference internal" href="#writing-queries-by-hand-with-sql">Writing queries by hand with SQL</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="models.html"
                        title="previous chapter">Model and Fields</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="database.html"
                        title="next chapter">Databases</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/peewee/querying.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="database.html" title="Databases"
             >next</a> |</li>
        <li class="right" >
          <a href="models.html" title="Model and Fields"
             >previous</a> |</li>
        <li><a href="../index.html">peewee 2.2.3 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright charles leifer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>