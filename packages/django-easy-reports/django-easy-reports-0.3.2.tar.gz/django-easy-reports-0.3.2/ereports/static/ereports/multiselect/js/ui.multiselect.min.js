var defaultDataParser=function(f){if(typeof f=="string"){var e=/^(\s\n\r\t)*\+?$/;var d,b,a=f.split(/\n/);f={};for(var c in a){b=a[c].split("=");if(!e.test(b[0])){d=(b[0].lastIndexOf("+")==b.length-1);if(d){b[0]=b.substr(0,b.length-1)}f[b[0]]={selected:false,value:b[1]||b[0]}}}}else{this._messages($.ui.multiselect.constante.MESSAGE_ERROR,$.ui.multiselect.locale.errorDataFormat);f=false}return f};var defaultNodeComparator=function(b,a){var d=b.text(),c=a.text();return d==c?0:(d<c?-1:1)};(function(b){b.widget("ui.multiselect",{options:{sortable:"left",droppable:"both",searchable:true,searchDelay:400,remoteUrl:null,remoteParams:{},animated:"fast",show:"slideDown",hide:"slideUp",dividerLocation:0.6,dataParser:defaultDataParser,nodeComparator:defaultNodeComparator,nodeInserted:null,hidden:false},_create:function(){if(!this.options.hidden){this.element.hide();this.busy=false;this.container=b('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>').insertAfter(this.element);this.selectedContainer=b('<div class="ui-widget-content list-container selected"></div>').appendTo(this.container);this.availableContainer=b('<div class="ui-widget-content list-container available"></div>').appendTo(this.container);this.selectedActions=b('<div class="actions ui-widget-header ui-helper-clearfix"><span class="count">'+b.tmpl(b.ui.multiselect.locale.itemsCount,{count:0})+'</span><a href="#" class="remove-all">'+b.tmpl(b.ui.multiselect.locale.removeAll)+"</a></div>").appendTo(this.selectedContainer);this.availableActions=b('<div class="actions ui-widget-header ui-helper-clearfix"><span class="busy">'+b.tmpl(b.ui.multiselect.locale.busy)+'</span><input type="text" class="search ui-widget-content ui-corner-all"/><a href="#" class="add-all">'+b.tmpl(b.ui.multiselect.locale.addAll)+"</a></div>").appendTo(this.availableContainer);this.selectedList=b('<ul class="list selected"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.selectedContainer);this.availableList=b('<ul class="list available"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return false}).appendTo(this.availableContainer);var d=this;this.availableList.data("multiselect.cache",{});this.selectedList.data("multiselect.cache",{});if(!this.options.animated){this.options.show="show";this.options.hide="hide"}var c={selected:{sortable:("both"==this.options.sortable||"left"==this.options.sortable),droppable:("both"==this.options.droppable||"left"==this.options.droppable)},available:{sortable:("both"==this.options.sortable||"right"==this.options.sortable),droppable:("both"==this.options.droppable||"right"==this.options.droppable)}};this._prepareLists("selected","available",c);this._prepareLists("available","selected",c);this._registerSearchEvents(this.availableContainer.find("input.search"),true);this._setBusy(false);this.container.find(".remove-all").bind("click.multiselect",function(){d.selectNone();return false});this.container.find(".add-all").bind("click.multiselect",function(){d.selectAll();return false});this.container.width(this.element.width()+1);this._refreshDividerLocation();this.availableActions.find("input").width(Math.max(this.availableActions.width()-this.availableActions.find("a.add-all").width()-30,20));this.selectedList.height(Math.max(this.element.height()-this.selectedActions.height(),1));this.availableList.height(Math.max(this.element.height()-this.availableActions.height(),1));this._populateLists(this.element.find("option"))}},slideToggle:function(){if(this.options.hidden){this.options.hidden=!this.options.hidden;this._create()}else{this.container.slideToggle()}},destroy:function(){this.container.remove();this.element.show();b.widget.prototype.destroy.apply(this,arguments)},isBusy:function(){return !!this.busy},isSelected:function(c){if(this.enabled()){return !!this._findItem(c,this.selectedList)}else{return null}},selectedValues:function(){return b.map(this.element.find("option[selected]"),function(d,c){return b(d).val()})},enabled:function(c,d){if(undefined!==c){if(c){this.container.unblock();this.element.removeAttr("disabled")}else{this.container.block({message:d||null,overlayCSS:{backgroundColor:"#fff",opacity:0.4,cursor:"default"}});this.element.attr("disabled",true)}}return !this.element.attr("disabled")},selectAll:function(){if(this.enabled()){this._batchSelect(this.availableList.children("li.ui-element:visible"),true)}},selectNone:function(){if(this.enabled()){this._batchSelect(this.selectedList.children("li.ui-element:visible"),false)}},select:function(d){if(this.enabled()){var c=this._findItem(d,this.availableList);if(c){this._setSelected(c,true)}}},deselect:function(d){if(this.enabled()){var c=this._findItem(d,this.selectedList);if(c){this._setSelected(c,false)}}},search:function(d){if(!this.busy&&this.enabled()&&this.options.searchable){var c=this.availableActions.children("input:first");c.val(d);c.trigger("keydown.multiselect")}},addOptions:function(e){if(this.enabled()){this._setBusy(true);var d=[];if(e=this.options.dataParser.call(this,e)){for(var c in e){if(this.element.find('option[value="'+c+'"]').size()==0){d.push(b('<option value="'+c+'"/>').text(e[c].value).appendTo(this.element)[0])}}}if(d.length>0){this._populateLists(b(d))}this._filter(this.availableList.children("li.ui-element"));this._setBusy(false);return d.length}else{return false}},_setData:function(c,d){switch(c){case"dividerLocation":this.options.dividerLocation=d;this._refreshDividerLocation();break;case"searchable":this.options.searchable=d;this._registerSearchEvents(this.availableContainer.find("input.search"),false);break;case"droppable":case"sortable":this._messages(b.ui.multiselect.constants.MESSAGE_WARNING,b.ui.multiselect.locale.errorReadonly,{option:c});default:this.options[c]=d;break}},_ui:function(d){var c={sender:this.element};switch(d){case"message":c.type=arguments[1];c.message=arguments[2];break;case"selection":c.option=arguments[1];break}return c},_messages:function(c,e,d){this._trigger("messages",null,this._ui("message",c,b.tmpl(e,d)))},_refreshDividerLocation:function(){this.selectedContainer.width(Math.floor(this.element.width()*this.options.dividerLocation));this.availableContainer.width(Math.floor(this.element.width()*(1-this.options.dividerLocation)))},_prepareLists:function(e,c,h){var g=this;var j=("selected"==e);var i=this[e+"List"];var f=this[c+"List"];var d=h[c].sortable?a:"clone";i.data("multiselect.sortable",h[e].sortable).data("multiselect.droppable",h[e].droppable).data("multiselect.draggable",!h[e].sortable&&(h[c].sortable||h[c].droppable));if(h[e].sortable){i.sortable({appendTo:this.container,connectWith:f,containment:this.container,helper:d,items:"li.ui-element",revert:!(h[c].sortable||h[c].droppable),receive:function(k,m){if(h[c].sortable){var l=m.item.data("multiselect.optionLink");g._applyItemState(m.item.hide(),j);if(f.data("multiselect.cache")[l.val()]){delete f.data("multiselect.cache")[l.val()]}m.item.hide();g._setSelected(m.item,j,true)}else{setTimeout(function(){g._setSelected(m.item,j)},10)}},stop:function(k,l){g._moveOptionNode(l.item)}})}if(!(h[e].sortable&&h[c].sortable)&&(h[e].droppable||h[c].sortable||h[c].droppable)){i.droppable({accept:".ui-multiselect li.ui-element",hoverClass:"ui-state-highlight",revert:!(h[c].sortable||h[c].droppable),greedy:true,drop:function(k,m){if(!m.draggable.data("multiselect.optionLink")){var l=m.helper.data("multiselect.optionLink");m.draggable.data("multiselect.optionLink",l);if(i.data("multiselect.cache")[l.val()]){delete i.data("multiselect.cache")[l.val()]}i.data("multiselect.cache")[l.val()]=m.draggable;g._applyItemState(m.draggable,j)}else{if(!h[e].sortable){setTimeout(function(){m.draggable.hide();g._setSelected(m.draggable,j)},10)}}}})}},_populateLists:function(c){this._setBusy(true);var d=this;setTimeout(function(){b(c.each(function(e){var g=(this.selected?d.selectedList:d.availableList);var f=d._getOptionNode(this).show();d._applyItemState(f,this.selected);f.data("multiselect.idx",e);g.data("multiselect.cache")[f.data("multiselect.optionLink").val()]=f;d._insertToList(f,g)}));d._setBusy(false);d._updateCount()},1)},_insertToList:function(e,f){var d=this;this._setBusy(true);var g=0;var c=function(){var h=(d.options.nodeComparator?d._getSuccessorNode(e,f):null);try{if(h){e.insertBefore(h)}else{f.append(e)}if(f===d.selectedList){d._moveOptionNode(e)}if("function"==typeof d.options.nodeInserted){d.options.nodeInserted(e)}d._setBusy(false)}catch(i){if(g++<10){setTimeout(function(){c()},1)}else{d._messages(b.ui.multiselect.constants.MESSAGE_EXCEPTION,b.ui.multiselect.locale.errorInsertNode,{key:e.data("multiselect.optionLink").val(),value:e.text()});d._setBusy(false)}}};c()},_updateCount:function(){var e=this;if(this.busy){setTimeout(function(){e._updateCount()},100)}var d=this.selectedList.children("li:not(.ui-helper-hidden-accessible,.ui-sortable-placeholder):visible").size();var c=this.availableList.children("li:not(.ui-helper-hidden-accessible,.ui-sortable-placeholder,.shadowed)").size()+d;this.selectedContainer.find("span.count").text(b.tmpl(b.ui.multiselect.locale.itemsCount,{count:d})).attr("title",b.tmpl(b.ui.multiselect.locale.itemsTotal,{count:c}))},_getOptionNode:function(c){c=b(c);var d=b('<li class="ui-state-default ui-element"><span class="ui-icon"/>'+c.text()+'<a href="#" class="ui-state-default action"><span class="ui-corner-all ui-icon"/></a></li>').hide();d.data("multiselect.optionLink",c);return d},_moveOptionNode:function(c){setTimeout(function(){var f=c.data("multiselect.optionLink");if(f){var d=c.prev("li:not(.ui-helper-hidden-accessible,.ui-sortable-placeholder):visible");var e=d.size()?d.data("multiselect.optionLink"):null;if(e){f.insertAfter(e)}else{f.prependTo(f.parent())}}},100)},_findItem:function(e,d){var c=null;d.children("li.ui-element:visible").each(function(f,g){g=b(g);if(g.text().toLowerCase()===e.toLowerCase()){c=g}});if(c&&c.size()){return c}else{return false}},_cloneWithData:function(j,g,c){var e=this;var i=j.data("multiselect.optionLink").val();var d=("selected"==g);var f=(d?this.selectedList:this.availableList);var h=f.data("multiselect.cache")[i];if(!h){h=j.clone().hide();this._applyItemState(h,d);f.data("multiselect.cache")[i]=h;h.data("multiselect.optionLink",j.data("multiselect.optionLink"));h.data("multiselect.idx",j.data("multiselect.idx"));if(c){this._insertToList(h,f)}}else{h.data("multiselect.idx",j.data("multiselect.idx"))}return h},_batchSelect:function(e,d){this._setBusy(true);var c=this;setTimeout(function(){var f={animated:c.options.animated,hide:c.options.hide,show:c.options.show};c.options.animated=null;c.options.hide="hide";c.options.show="show";e.each(function(h,g){c._setSelected(b(g),d)});if(!d){c._filter(c.availableList.find("li.ui-element"))}b.extend(c.options,f);c._updateCount();c._setBusy(false)},10)},_getSuccessorNode:function(g,j){var e=j.find("li.ui-element"),d=this.options.nodeComparator;var h=e.size();if(e.size()==0){return null}var c,f=Math.min(g.data("multiselect.idx"),h-1),k=d(g,b(e[f]));if(k){if(0>k&&0>=f){c=e[0]}else{if(0<k&&h-1<=f){f++;c=null}else{while(f>=0&&f<e.length){k>0?f++:f--;if(f<0){c=g[0]}if(k!=d(g,b(e[f]))){c=e[k>0?f:f+1];break}}}}}else{c=e[f]}g.data("multiselect.idx",f);return c},_setSelected:function(g,e,c){var f=this,d;var h=g.data("multiselect.optionLink");if(e){if(h.attr("selected")){return}h.attr("selected","selected");if(c){d=g}else{d=this._cloneWithData(g,"selected",true).hide();g.addClass("shadowed")[this.options.hide](this.options.animated,function(){f._updateCount()})}d[this.options.show](this.options.animated)}else{if(!h.attr("selected")){return}h.removeAttr("selected");if(c){d=g}else{d=this._cloneWithData(g,"available",true).hide().removeClass("shadowed");g[this.options.hide](this.options.animated,function(){f._updateCount()})}if(!d.is(".filtered")){d[this.options.show](this.options.animated)}}if(!this.busy){if(this.options.animated){d.fadeTo("fast",0.3,function(){b(this).fadeTo("fast",1)})}}this._trigger(e?"selected":"deselected",null,this._ui("selection",h));return d},_setBusy:function(e){var c=this.availableActions.children("input.search");var d=this.availableActions.children(".busy");this.busy=Math.max(e?++this.busy:--this.busy,0);this.container.find("a.remove-all, a.add-all")[this.busy?"hide":"show"]();if(e&&(1==this.busy)){if(this.options.searchable){c.data("multiselect.hadFocus",c.data("multiselect.hasFocus"));c.blur().hide()}d.show()}else{if(!this.busy){if(this.options.searchable){c.show();if(c.data("multiselect.hadFocus")){c.focus()}}d.hide()}}},_applyItemState:function(d,c){if(c){d.children("span").addClass("ui-helper-hidden").removeClass("ui-icon");d.find("a.action span").addClass("ui-icon-minus").removeClass("ui-icon-plus");this._registerRemoveEvents(d.find("a.action"))}else{d.children("span").addClass("ui-helper-hidden").removeClass("ui-icon");d.find("a.action span").addClass("ui-icon-plus").removeClass("ui-icon-minus");this._registerAddEvents(d.find("a.action"))}this._registerHoverEvents(d);return d},_filter:function(e){var c=this.availableActions.children("input.search");var d=b.trim(c.val().toLowerCase());if(!d){e.removeClass("filtered")}else{e.each(function(g,f){f=b(f);f[(f.text().toLowerCase().indexOf(d)>=0?"remove":"add")+"Class"]("filtered")})}return e.not(".filtered, .shadowed").show().end().filter(".filtered, .shadowed").hide().end()},_registerHoverEvents:function(c){c.unbind("mouseover.multiselect").bind("mouseover.multiselect",function(){b(this).find("a").andSelf().addClass("ui-state-hover")}).unbind("mouseout.multiselect").bind("mouseout.multiselect",function(){b(this).find("a").andSelf().removeClass("ui-state-hover")}).find("a").andSelf().removeClass("ui-state-hover")},_registerAddEvents:function(d){var c=this;d.unbind("click.multiselect").bind("click.multiselect",function(){if(!this.busy){c._setSelected(b(this).parent(),true)}return false});if(this.availableList.data("multiselect.draggable")){d.each(function(){b(this).parent().draggable({connectToSortable:c.selectedList,helper:a,appendTo:c.container,containment:c.container,revert:"invalid"})});if(this.selectedList.data("multiselect.sortable")){this.selectedList.sortable("refresh")}}},_registerRemoveEvents:function(d){var c=this;d.unbind("click.multiselect").bind("click.multiselect",function(){if(!c.busy){c._setSelected(b(this).parent(),false)}return false});if(this.selectedList.data("multiselect.draggable")){d.each(function(){b(this).parent().draggable({connectToSortable:c.availableList,helper:a,appendTo:c.container,containment:c.container,revert:"invalid"})});if(this.availableList.data("multiselect.sortable")){this.availableList.sortable("refresh")}}},_registerSearchEvents:function(e,g){var f=this;var d=e.val(),i;var h=function(j){if(f.busy){return}var k=e.val();if((k!=d)||(j)){f._setBusy(true);if(f.options.remoteUrl){var m=b.extend({},f.options.remoteParams);try{b.ajax({url:f.options.remoteUrl,data:b.extend(m,{q:escape(k)}),success:function(n){f.addOptions(n);f._setBusy(false)},error:function(o,n,p){f._messages(b.ui.multiselect.constants.MESSAGE_ERROR,b.ui.multiselect.locale.errorRequest,{status:n});f._setBusy(false)}})}catch(l){f._messages(b.ui.multiselect.constants.MESSAGE_EXCEPTION,l.message);f._setBusy(false)}}else{f._filter(f.availableList.children("li.ui-element"));f._setBusy(false)}d=k}};e.unbind("focus.multiselect blur.multiselect keydown.multiselect keypress.multiselect");if(this.options.searchable){e.bind("focus.multiselect",function(){b(this).addClass("ui-state-active").data("multiselect.hasFocus",true)}).bind("blur.multiselect",function(){b(this).removeClass("ui-state-active").data("multiselect.hasFocus",false)}).bind("keydown.multiselect keypress.multiselect",function(j){if(i){clearTimeout(i)}switch(j.which){case 13:h(true);return false;default:i=setTimeout(function(){h()},Math.max(f.options.searchDelay,1))}}).show()}else{e.val("").hide();this._filter(f.availableList.find("li.ui-element"))}var c=function(){if(f.busy){setTimeout(function(){c()},100)}h(true)};if(g){c()}}});var a=function(d,e){var c=b(d.target);var f=c.clone().width(c.width());f.data("multiselect.optionLink",c.data("multiselect.optionLink")).data("multiselect.list",c.parent()).find("a").remove();return f};b.extend(b.ui.multiselect,{getter:"selectedValues enabled isBusy",locale:{addAll:"Add all",removeAll:"Remove all",itemsCount:"#{count} items selected",itemsTotal:"#{count} items total",busy:"please wait...",errorDataFormat:"Cannot add options, unknown data format",errorInsertNode:"There was a problem trying to add the item:\n\n\t[#{key}] => #{value}\n\nThe operation was aborted.",errorReadonly:"The option #{option} is readonly",errorRequest:"Sorry! There seemed to be a problem with the remote call. (Type: #{status})"},constants:{MESSAGE_WARNING:0,MESSAGE_EXCEPTION:1,MESSAGE_ERROR:2}})})(jQuery);