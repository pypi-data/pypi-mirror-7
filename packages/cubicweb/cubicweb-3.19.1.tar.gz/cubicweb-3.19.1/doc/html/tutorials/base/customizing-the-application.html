
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>1.1.3. Customizing your application &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../../index.html" />
    <link rel="up" title="1. Building a simple blog with CubicWeb" href="index.html" />
    <link rel="next" title="1.1.4. What’s next?" href="conclusion.html" />
    <link rel="prev" title="1.1.2. Discovering the web interface" href="discovering-the-ui.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="conclusion.html" title="1.1.4. What’s next?"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="discovering-the-ui.html" title="1.1.2. Discovering the web interface"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Tutorials</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">1. Building a simple blog with <em>CubicWeb</em></a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">1.1.3. Customizing your application</a><ul>
<li><a class="reference internal" href="#create-your-own-cube">1.1.3.1. Create your own cube</a></li>
<li><a class="reference internal" href="#cube-metadata">1.1.3.2. Cube metadata</a></li>
<li><a class="reference internal" href="#extending-the-data-model">1.1.3.3. Extending the data model</a><ul>
<li><a class="reference internal" href="#defining-our-model">1.1.3.3.1. Defining our model</a></li>
<li><a class="reference internal" href="#applying-changes-to-the-model-into-our-instance">1.1.3.3.2. Applying changes to the model into our instance</a></li>
</ul>
</li>
<li><a class="reference internal" href="#defining-your-views">1.1.3.4. Defining your views</a></li>
<li><a class="reference internal" href="#changing-the-layout-of-the-application">1.1.3.5. Changing the layout of the application</a></li>
<li><a class="reference internal" href="#primary-view-customization">1.1.3.6. Primary view customization</a></li>
<li><a class="reference internal" href="#write-entities-to-add-logic-in-your-data">1.1.3.7. Write entities to add logic in your data</a></li>
<li><a class="reference internal" href="#extending-the-application-by-using-more-cubes">1.1.3.8. Extending the application by using more cubes!</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="discovering-the-ui.html"
                        title="previous chapter">1.1.2. Discovering the web interface</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="conclusion.html"
                        title="next chapter">1.1.4. What&#8217;s next?</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/tutorials/base/customizing-the-application.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="customizing-your-application">
<span id="tutosbasecustomizingtheapplication"></span><h1>1.1.3. Customizing your application<a class="headerlink" href="#customizing-your-application" title="Permalink to this headline">¶</a></h1>
<p>So far so good. The point is that usually, you won&#8217;t get enough by assembling
cubes out-of-the-box. You will want to customize them, have a personal look and
feel, add your own data model and so on. Or maybe start from scratch?</p>
<p>So let&#8217;s get a bit deeper and start coding our own cube. In our case, we want
to customize the blog we created to add more features to it.</p>
<div class="section" id="create-your-own-cube">
<h2>1.1.3.1. Create your own cube<a class="headerlink" href="#create-your-own-cube" title="Permalink to this headline">¶</a></h2>
<p>First, notice that if you&#8217;ve installed <em>CubicWeb</em> using Debian packages, you will
need the additional <tt class="docutils literal"><span class="pre">cubicweb-dev</span></tt> package to get the commands necessary to
<em>CubicWeb</em> development. All <cite>cubicweb-ctl</cite> commands are described in details in
<a class="reference internal" href="../../admin/cubicweb-ctl.html#cubicweb-ctl"><em>cubicweb-ctl tool</em></a>.</p>
<p>Once your <em>CubicWeb</em> development environment is set up, you can create a new
cube:</p>
<div class="highlight-python"><pre>cubicweb-ctl newcube myblog</pre>
</div>
<p>This will create in the cubes directory (<tt class="file docutils literal"><span class="pre">/path/to/forest/cubes</span></tt> for source
installation, <tt class="file docutils literal"><span class="pre">/usr/share/cubicweb/cubes</span></tt> for Debian packages installation)
a directory named <tt class="file docutils literal"><span class="pre">blog</span></tt> reflecting the structure described in
<a class="reference internal" href="../../devrepo/cubes/layout.html#cubelayout"><em>Standard structure for a cube</em></a>.</p>
<p>For packages installation, you can still create new cubes in your home directory
using the following configuration. Let&#8217;s say you want to develop your new cubes
in <cite>~src/cubes</cite>, then set the following environment variables:</p>
<div class="highlight-python"><pre>CW_CUBES_PATH=~/src/cubes</pre>
</div>
<p>and then create your new cube using:</p>
<div class="highlight-python"><pre>cubicweb-ctl newcube --directory=~/src/cubes myblog</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We previously used <cite>myblog</cite> as the name of our <em>instance</em>. We&#8217;re now creating
a <em>cube</em> with the same name. Both are different things. We&#8217;ll now try to
specify when we talk about one or another, but keep in mind this difference.</p>
</div>
</div>
<div class="section" id="cube-metadata">
<h2>1.1.3.2. Cube metadata<a class="headerlink" href="#cube-metadata" title="Permalink to this headline">¶</a></h2>
<p>A simple set of metadata about your cube are stored in the <tt class="file docutils literal"><span class="pre">__pkginfo__.py</span></tt>
file. In our case, we want to extend the blog cube, so we have to tell that our
cube depends on this cube, by modifying the <tt class="docutils literal"><span class="pre">__depends__</span></tt> dictionary in that
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">__depends__</span> <span class="o">=</span>  <span class="p">{</span><span class="s">&#39;cubicweb&#39;</span><span class="p">:</span> <span class="s">&#39;&gt;= 3.10.7&#39;</span><span class="p">,</span>
                <span class="s">&#39;cubicweb-blog&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
</pre></div>
</div>
<p>where the <tt class="docutils literal"><span class="pre">None</span></tt> means we do not depends on a particular version of the cube.</p>
</div>
<div class="section" id="extending-the-data-model">
<span id="tutosbasecustomizingtheapplicationdatamodel"></span><h2>1.1.3.3. Extending the data model<a class="headerlink" href="#extending-the-data-model" title="Permalink to this headline">¶</a></h2>
<p>The data model or schema is the core of your <em>CubicWeb</em> application.  It defines
the type of content your application will handle. It is defined in the file
<tt class="file docutils literal"><span class="pre">schema.py</span></tt> of the cube.</p>
<div class="section" id="defining-our-model">
<h3>1.1.3.3.1. Defining our model<a class="headerlink" href="#defining-our-model" title="Permalink to this headline">¶</a></h3>
<p>For the sake of example, let&#8217;s say we want a new entity type named <cite>Community</cite>
with a name, a description. A <cite>Community</cite> will hold several blogs.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yams.buildobjs</span> <span class="kn">import</span> <span class="n">EntityType</span><span class="p">,</span> <span class="n">RelationDefinition</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">RichString</span>

<span class="k">class</span> <span class="nc">Community</span><span class="p">(</span><span class="n">EntityType</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">RichString</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">community_blog</span><span class="p">(</span><span class="n">RelationDefinition</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&#39;Community&#39;</span>
    <span class="nb">object</span> <span class="o">=</span> <span class="s">&#39;Blog&#39;</span>
    <span class="n">cardinality</span> <span class="o">=</span> <span class="s">&#39;*?&#39;</span>
    <span class="n">composite</span> <span class="o">=</span> <span class="s">&#39;subject&#39;</span>
</pre></div>
</div>
<p>The first step is the import from the <tt class="xref py py-mod docutils literal"><span class="pre">yams</span></tt> package necessary classes to build
the schema.</p>
<p>This file defines the following:</p>
<ul class="simple">
<li>a <cite>Community</cite> has a title and a description as attributes<ul>
<li>the name is a string that is required and can&#8217;t be longer than 50 characters</li>
<li>the description is a string that is not constrained and may contains rich
content such as HTML or Restructured text.</li>
</ul>
</li>
<li>a <cite>Community</cite> may be linked to a <cite>Blog</cite> using the <cite>community_blog</cite> relation<ul>
<li><tt class="docutils literal"><span class="pre">*</span></tt> means a community may be linked to 0 to N blog, <tt class="docutils literal"><span class="pre">?</span></tt> means a blog may
be linked to 0 to 1 community. For completeness, remember that you can also
use <tt class="docutils literal"><span class="pre">+</span></tt> for 1 to N, and <tt class="docutils literal"><span class="pre">1</span></tt> for single, mandatory relation (e.g. one to one);</li>
<li>this is a composite relation where <cite>Community</cite> (e.g. the subject of the
relation) is the composite. That means that if you delete a community, its
blog will be deleted as well.</li>
</ul>
</li>
</ul>
<p>Of course, there are a lot of other data types and things such as constraints,
permissions, etc, that may be defined in the schema, but those won&#8217;t be covered
in this tutorial.</p>
<p>Notice that our schema refers to the <cite>Blog</cite> entity type which is not defined
here.  But we know this type is available since we depend on the <cite>blog</cite> cube
which is defining it.</p>
</div>
<div class="section" id="applying-changes-to-the-model-into-our-instance">
<h3>1.1.3.3.2. Applying changes to the model into our instance<a class="headerlink" href="#applying-changes-to-the-model-into-our-instance" title="Permalink to this headline">¶</a></h3>
<p>Now the problem is that we created an instance using the <cite>blog</cite> cube, not our
<cite>myblog</cite> cube, so if we don&#8217;t do anything there is no way that we&#8217;ll see anything
changing in the instance.</p>
<p>One easy way, as we&#8217;ve no really valuable data in the instance would be to trash and recreated it:</p>
<div class="highlight-python"><pre>cubicweb-ctl stop myblog # or Ctrl-C in the terminal running the server in debug mode
cubicweb-ctl delete myblog
cubicweb-ctl create myblog
cubicweb-ctl start -D myblog</pre>
</div>
<p>Another way is to add our cube to the instance using the cubicweb-ctl shell
facility. It&#8217;s a python shell connected to the instance with some special
commands available to manipulate it (the same as you&#8217;ll have in migration
scripts, which are not covered in this tutorial). In that case, we&#8217;re interested
in the <cite>add_cube</cite> command:</p>
<div class="highlight-python"><pre>$ cubicweb-ctl stop myblog # or Ctrl-C in the terminal running the server in debug mode
$ cubicweb-ctl shell myblog
entering the migration python shell
just type migration commands or arbitrary python code and type ENTER to execute it
type "exit" or Ctrl-D to quit the shell and resume operation
&gt;&gt;&gt; add_cube('myblog')
&gt;&gt;&gt;
$ cubicweb-ctl start -D myblog</pre>
</div>
<p>The <cite>add_cube</cite> command is enough since it automatically updates our
application to the cube&#8217;s schema. There are plenty of other migration
commands of a more finer grain. They are described in <a class="reference internal" href="../../devrepo/migration.html#migration"><em>Migration</em></a></p>
<p>As explained, leave the shell by typing Ctrl-D. If you restart the instance and
take another look at the schema, you&#8217;ll see that changes to the data model have
actually been applied (meaning database schema updates and all necessary stuff
has been done).</p>
<img alt="the instance schema after adding our cube" src="../../_images/tutos-base_myblog-schema_en.png" />
<p>If you follow the &#8216;info&#8217; link in the user pop-up menu, you&#8217;ll also see that the
instance is using blog and myblog cubes.</p>
<img alt="the instance schema after adding our cube" src="../../_images/tutos-base_myblog-siteinfo_en.png" />
<p>You can now add some communities, link them to blog, etc... You&#8217;ll see that the
framework provides default views for this entity type (we have not yet defined any
view for it!), and also that the blog primary view will show the community it&#8217;s
linked to if any. All this thanks to the model driven interface provided by the
framework.</p>
<p>You&#8217;ll then be able to redefine each of them according to your needs
and preferences. We&#8217;ll now see how to do such thing.</p>
</div>
</div>
<div class="section" id="defining-your-views">
<span id="tutosbasecustomizingtheapplicationcustomviews"></span><h2>1.1.3.4. Defining your views<a class="headerlink" href="#defining-your-views" title="Permalink to this headline">¶</a></h2>
<p><em>CubicWeb</em> provides a lot of standard views in directory
<tt class="file docutils literal"><span class="pre">cubicweb/web/views/</span></tt>. We already talked about &#8216;primary&#8217; and &#8216;list&#8217; views,
which are views which apply to one ore more entities.</p>
<p>A view is defined by a python class which includes:</p>
<blockquote>
<div><ul class="simple">
<li>an identifier: all objects used to build the user interface in <em>CubicWeb</em> are
recorded in a registry and this identifier will be used as a key in that
registry. There may be multiple views for the same identifier.</li>
<li>a <em>selector</em>, which is a kind of filter telling how well a view suit to a
particular context. When looking for a particular view (e.g. given an
identifier), <em>CubicWeb</em> computes for each available view with that identifier
a score which is returned by the selector. Then the view with the highest
score is used. The standard library of predicates is in
<tt class="xref py py-mod docutils literal"><span class="pre">cubicweb.predicates</span></tt>.</li>
</ul>
</div></blockquote>
<p>A view has a set of methods inherited from the <a class="reference internal" href="../../devweb/views/views.html#cubicweb.view.View" title="cubicweb.view.View"><tt class="xref py py-class docutils literal"><span class="pre">cubicweb.view.View</span></tt></a> class,
though you usually don&#8217;t derive directly from this class but from one of its more
specific child class.</p>
<p>Last but not least, <em>CubicWeb</em> provides a set of default views accepting any kind
of entities.</p>
<p>Want a proof? Create a community as you&#8217;ve already done for other entity types
through the index page, you&#8217;ll then see something like that:</p>
<img alt="the default primary view for our community entity type" src="../../_images/tutos-base_myblog-community-default-primary_en.png" />
<p>If you notice the weird messages that appear in the page: those are messages
generated for the new data model, which have no translation yet. To fix that,
we&#8217;ll have to use dedicated <cite>cubicweb-ctl</cite> commands:</p>
<p>You&#8217;ll then be able to redefine each of them according to your needs and
preferences. So let&#8217;s see how to do such thing.</p>
</div>
<div class="section" id="changing-the-layout-of-the-application">
<h2>1.1.3.5. Changing the layout of the application<a class="headerlink" href="#changing-the-layout-of-the-application" title="Permalink to this headline">¶</a></h2>
<p>The layout is the general organization of the pages in the site. Views that generate
the layout are sometimes referred to as &#8216;templates&#8217;. They are implemented in the
framework in the module <tt class="xref py py-mod docutils literal"><span class="pre">cubicweb.web.views.basetemplates</span></tt>. By overriding
classes in this module, you can customize whatever part you wish of the default
layout.</p>
<p>But notice that <em>CubicWeb</em> provides many other ways to customize the
interface, thanks to actions and components (which you can individually
(de)activate, control their location, customize their look...) as well as
&#8220;simple&#8221; CSS customization. You should first try to achieve your goal using such
fine grained parametrization rather then overriding a whole template, which usually
embeds customisation access points that you may loose in the process.</p>
<p>But for the sake of example, let&#8217;s say we want to change the generic page
footer...  We can simply add to the module <tt class="docutils literal"><span class="pre">views</span></tt> of our cube,
e.g. <tt class="file docutils literal"><span class="pre">cubes/myblog/views.py</span></tt>, the code below:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.web.views</span> <span class="kn">import</span> <span class="n">basetemplates</span>

<span class="k">class</span> <span class="nc">MyHTMLPageFooter</span><span class="p">(</span><span class="n">basetemplates</span><span class="o">.</span><span class="n">HTMLPageFooter</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">footer_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;This website has been created with &lt;a href=&quot;http://cubicweb.org&quot;&gt;CubicWeb&lt;/a&gt;.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">registration_callback</span><span class="p">(</span><span class="n">vreg</span><span class="p">):</span>
    <span class="n">vreg</span><span class="o">.</span><span class="n">register_all</span><span class="p">(</span><span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">MyHTMLPageFooter</span><span class="p">,))</span>
    <span class="n">vreg</span><span class="o">.</span><span class="n">register_and_replace</span><span class="p">(</span><span class="n">MyHTMLPageFooter</span><span class="p">,</span> <span class="n">basetemplates</span><span class="o">.</span><span class="n">HTMLPageFooter</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Our class inherits from the default page footer to ease getting things right,
but this is not mandatory.</li>
<li>When we want to write something to the output stream, we simply call <cite>self.w</cite>,
with <em>must be passed an unicode string</em>.</li>
<li>The latest function is the most exotic stuff. The point is that without it, you
would get an error at display time because the framework wouldn&#8217;t be able to
choose which footer to use between <tt class="xref py py-class docutils literal"><span class="pre">HTMLPageFooter</span></tt> and
<tt class="xref py py-class docutils literal"><span class="pre">MyHTMLPageFooter</span></tt>, since both have the same selector, hence the same
score...  In this case, we want our footer to replace the default one, so we have
to define a <tt class="xref py py-func docutils literal"><span class="pre">registration_callback()</span></tt> function to control object
registration: the first instruction tells to register everything in the module
but the <tt class="xref py py-class docutils literal"><span class="pre">MyHTMLPageFooter</span></tt> class, then the second to register it instead
of <tt class="xref py py-class docutils literal"><span class="pre">HTMLPageFooter</span></tt>. Without this function, everything in the module is
registered blindly.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When a view is modified while running in debug mode, it is not required to
restart the instance server. Save the Python file and reload the page in your
web browser to view the changes.</p>
</div>
<p>We will now have this simple footer on every page of the site.</p>
</div>
<div class="section" id="primary-view-customization">
<h2>1.1.3.6. Primary view customization<a class="headerlink" href="#primary-view-customization" title="Permalink to this headline">¶</a></h2>
<p>The &#8216;primary&#8217; view (i.e. any view with the identifier set to &#8216;primary&#8217;) is the one used to
display all the information about a single entity. The standard primary view is one
of the most sophisticated views of all. It has several customisation points, but
its power comes with <cite>uicfg</cite>, allowing you to control it without having to
subclass it.</p>
<p>However this is a bit off-topic for this first tutorial. Let&#8217;s say we simply want a
custom primary view for my <cite>Community</cite> entity type, using directly the view
interface without trying to benefit from the default implementation (you should
do that though if you&#8217;re rewriting reusable cubes; everything is described in more
details in <a class="reference internal" href="../../devweb/views/primary.html#primary-view"><em>The Primary View</em></a>).</p>
<p>So... Some code! That we&#8217;ll put again in the module <tt class="docutils literal"><span class="pre">views</span></tt> of our cube.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.predicates</span> <span class="kn">import</span> <span class="n">is_instance</span>
<span class="kn">from</span> <span class="nn">cubicweb.web.views</span> <span class="kn">import</span> <span class="n">primary</span>

<span class="k">class</span> <span class="nc">CommunityPrimaryView</span><span class="p">(</span><span class="n">primary</span><span class="o">.</span><span class="n">PrimaryView</span><span class="p">):</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">is_instance</span><span class="p">(</span><span class="s">&#39;Community&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cell_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cw_rset</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;h1&gt;Welcome to the &quot;</span><span class="si">%s</span><span class="s">&quot; community&lt;/h1&gt;&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="n">printable_value</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;p&gt;</span><span class="si">%s</span><span class="s">&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="n">printable_value</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>What&#8217;s going on here?</p>
<ul class="simple">
<li>Our class inherits from the default primary view, here mainly to get the correct
view identifier, since we don&#8217;t use any of its features.</li>
<li>We set on it a selector telling that it only applies when trying to display
some entity of the <cite>Community</cite> type. This is enough to get an higher score than
the default view for entities of this type.</li>
<li>View applying to entities usually have to define <cite>cell_call</cite> as entry point,
and are given <cite>row</cite> and <cite>col</cite> arguments tell to which entity in the result set
the view is applied. We can then get this entity from the result set
(<cite>self.cw_rset</cite>) by using the <cite>get_entity</cite> method.</li>
<li>To ease thing, we access our entity&#8217;s attribute for display using its
printable_value method, which will handle formatting and escaping when
necessary. As you can see, you can also access attributes by their name on the
entity to get the raw value.</li>
</ul>
<p>You can now reload the page of the community we just created and see the changes.</p>
<img alt="the custom primary view for our community entity type" src="../../_images/tutos-base_myblog-community-custom-primary_en.png" />
<p>We&#8217;ve seen here a lot of thing you&#8217;ll have to deal with to write views in
<em>CubicWeb</em>. The good news is that this is almost everything that is used to
build higher level layers.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As things get complicated and the volume of code in your cube increases, you can
of course still split your views module into a python package with subpackages.</p>
</div>
<p>You can find more details about views and selectors in <a class="reference internal" href="../../devweb/views/views.html#views"><em>Principles</em></a>.</p>
</div>
<div class="section" id="write-entities-to-add-logic-in-your-data">
<h2>1.1.3.7. Write entities to add logic in your data<a class="headerlink" href="#write-entities-to-add-logic-in-your-data" title="Permalink to this headline">¶</a></h2>
<p><em>CubicWeb</em> provides an ORM to easily programmaticaly manipulate
entities (just like the one we have fetched earlier by calling
<cite>get_entity</cite> on a result set). By default, entity
types are instances of the <tt class="xref py py-class docutils literal"><span class="pre">AnyEntity</span></tt> class, which holds a set of
predefined methods as well as property automatically generated for
attributes/relations of the type it represents.</p>
<p>You can redefine each entity to provide additional methods or whatever you want
to help you write your application. Customizing an entity requires that your
entity:</p>
<ul class="simple">
<li>inherits from <tt class="xref py py-class docutils literal"><span class="pre">cubicweb.entities.AnyEntity</span></tt> or any subclass</li>
<li>defines a <tt class="xref py py-attr docutils literal"><span class="pre">__regid__</span></tt> linked to the corresponding data type of your schema</li>
</ul>
<p>You may then want to add your own methods, override default implementation of some
method, etc...</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.entities</span> <span class="kn">import</span> <span class="n">AnyEntity</span><span class="p">,</span> <span class="n">fetch_config</span>


<span class="k">class</span> <span class="nc">Community</span><span class="p">(</span><span class="n">AnyEntity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;customized class for Community entities&quot;&quot;&quot;</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;Community&#39;</span>

    <span class="n">fetch_attrs</span><span class="p">,</span> <span class="n">cw_fetch_order</span> <span class="o">=</span> <span class="n">fetch_config</span><span class="p">([</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">dc_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">display_cw_logo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;CubicWeb&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
</pre></div>
</div>
<p>In this example:</p>
<ul class="simple">
<li>we used convenience <tt class="xref py py-func docutils literal"><span class="pre">fetch_config()</span></tt> function to tell which attributes
should be prefetched by the ORM when looking for some related entities of this
type, and how they should be ordered</li>
<li>we overrode the standard <cite>dc_title</cite> method, used in various place in the interface
to display the entity (though in this case the default implementation would
have had the same result)</li>
<li>we implemented here a method <tt class="xref py py-meth docutils literal"><span class="pre">display_cw_logo()</span></tt> which tests if the blog
entry title contains &#8216;CW&#8217;.  It can then be used when you&#8217;re writing code
involving &#8216;Community&#8217; entities in your views, hooks, etc. For instance, you can
modify your previous views as follows:</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CommunityPrimaryView</span><span class="p">(</span><span class="n">primary</span><span class="o">.</span><span class="n">PrimaryView</span><span class="p">):</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">is_instance</span><span class="p">(</span><span class="s">&#39;Community&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cell_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cw_rset</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;h1&gt;Welcome to the &quot;</span><span class="si">%s</span><span class="s">&quot; community&lt;/h1&gt;&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="n">printable_value</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">display_cw_logo</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;img src=&quot;http://www.cubicweb.org/doc/en/_static/cubicweb.png&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;p&gt;</span><span class="si">%s</span><span class="s">&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="n">printable_value</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Then each community whose description contains &#8216;CW&#8217; is shown with the <em>CubicWeb</em>
logo in front of it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As for view, you don&#8217;t have to restart your instance when modifying some entity
classes while your server is running in debug mode, the code will be
automatically reloaded.</p>
</div>
</div>
<div class="section" id="extending-the-application-by-using-more-cubes">
<h2>1.1.3.8. Extending the application by using more cubes!<a class="headerlink" href="#extending-the-application-by-using-more-cubes" title="Permalink to this headline">¶</a></h2>
<p>One of the goal of the <em>CubicWeb</em> framework was to have truly reusable
components. To do so, they must both behave nicely when plugged into the
application and be easily customisable, from the data model to the user
interface. And I think the result is pretty successful, thanks to system such as
the selection mechanism and the choice to write views as python code which allows
to build our page using true object oriented programming techniques, that no
template language provides.</p>
<p>A library of standard cubes is available from <a class="reference external" href="http://www.cubicweb.org/project">CubicWeb Forge</a>, to address a
lot of common concerns such has manipulating people, files, things to do, etc. In
our community blog case, we could be interested for instance in functionalities
provided by the <cite>comment</cite> and <cite>tag</cite> cubes. The former provides threaded
discussion functionalities, the latter a simple tag mechanism to classify content.
Let&#8217;s say we want to try those. We will first modify our cube&#8217;s <tt class="file docutils literal"><span class="pre">__pkginfo__.py</span></tt>
file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">__depends__</span> <span class="o">=</span>  <span class="p">{</span><span class="s">&#39;cubicweb&#39;</span><span class="p">:</span> <span class="s">&#39;&gt;= 3.10.7&#39;</span><span class="p">,</span>
                <span class="s">&#39;cubicweb-blog&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;cubicweb-comment&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s">&#39;cubicweb-tag&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
</pre></div>
</div>
<p>Now, we&#8217;ll simply tell on which entity types we want to activate the &#8216;comment&#8217;
and &#8216;tag&#8217; facilities by adding respectively the &#8216;comments&#8217; and &#8216;tags&#8217; relations on
them in our schema (<tt class="file docutils literal"><span class="pre">schema.py</span></tt>).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">comments</span><span class="p">(</span><span class="n">RelationDefinition</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&#39;Comment&#39;</span>
    <span class="nb">object</span> <span class="o">=</span> <span class="s">&#39;BlogEntry&#39;</span>
    <span class="n">cardinality</span> <span class="o">=</span> <span class="s">&#39;1*&#39;</span>
    <span class="n">composite</span> <span class="o">=</span> <span class="s">&#39;object&#39;</span>

<span class="k">class</span> <span class="nc">tags</span><span class="p">(</span><span class="n">RelationDefinition</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s">&#39;Tag&#39;</span>
    <span class="nb">object</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Community&#39;</span><span class="p">,</span> <span class="s">&#39;BlogEntry&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>So in the case above we activated comments on <cite>BlogEntry</cite> entities and tags on
both <cite>Community</cite> and <cite>BlogEntry</cite>. Various views from both <cite>comment</cite> and <cite>tag</cite>
cubes will then be automatically displayed when one of those relations is
supported.</p>
<p>Let&#8217;s synchronize the data model as we&#8217;ve done earlier:</p>
<div class="highlight-python"><pre>$ cubicweb-ctl stop myblog
$ cubicweb-ctl shell myblog
entering the migration python shell
just type migration commands or arbitrary python code and type ENTER to execute it
type "exit" or Ctrl-D to quit the shell and resume operation
&gt;&gt;&gt; add_cubes(('comment', 'tag'))
&gt;&gt;&gt;</pre>
</div>
<p>Then restart the instance. Let&#8217;s look at a blog entry:</p>
<img alt="the primary view for a blog entry with comments and tags activated" src="../../_images/tutos-base_myblog-blogentry-taggable-commentable-primary_en.png" />
<p>As you can see, we now have a box displaying tags and a section proposing to add
a comment and displaying existing one below the post. All this without changing
anything in our views, thanks to the design of generic views provided by the
framework. Though if we take a look at a community, we won&#8217;t see the tags box!
That&#8217;s because by default this box try to locate itself in the left column within
the white frame, and this column is handled by the primary view we
hijacked. Let&#8217;s change our view to make it more extensible, by keeping both our
custom rendering but also extension points provided by the default
implementation.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CommunityPrimaryView</span><span class="p">(</span><span class="n">primary</span><span class="o">.</span><span class="n">PrimaryView</span><span class="p">):</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">is_instance</span><span class="p">(</span><span class="s">&#39;Community&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_entity_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;h1&gt;Welcome to the &quot;</span><span class="si">%s</span><span class="s">&quot; community&lt;/h1&gt;&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="n">printable_value</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">render_entity_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">display_cw_logo</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;img src=&quot;http://www.cubicweb.org/doc/en/_static/cubicweb.png&quot;/&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;p&gt;</span><span class="si">%s</span><span class="s">&lt;/p&gt;&#39;</span> <span class="o">%</span> <span class="n">entity</span><span class="o">.</span><span class="n">printable_value</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>It appears now properly:</p>
<img alt="the custom primary view for a community entry with tags activated" src="../../_images/tutos-base_myblog-community-taggable-primary_en.png" />
<p>You can control part of the interface independently from each others, piece by
piece. Really.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="conclusion.html" title="1.1.4. What’s next?"
             >next</a> |</li>
        <li class="right" >
          <a href="discovering-the-ui.html" title="1.1.2. Discovering the web interface"
             >previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Tutorials</a> &raquo;</li>
          <li><a href="index.html" >1. Building a simple blog with <em>CubicWeb</em></a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>