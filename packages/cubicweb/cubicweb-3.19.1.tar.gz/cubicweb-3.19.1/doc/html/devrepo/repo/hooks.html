
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>6.3. Hooks and Operations &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../../index.html" />
    <link rel="up" title="6. Repository customization" href="index.html" />
    <link rel="next" title="6.4. Notifications management" href="notifications.html" />
    <link rel="prev" title="6.1. Sessions" href="sessions.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="notifications.html" title="6.4. Notifications management"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="sessions.html" title="6.1. Sessions"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">6. Repository customization</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.3. Hooks and Operations</a><ul>
<li><a class="reference internal" href="#generalities">6.3.1. Generalities</a><ul>
<li><a class="reference internal" href="#id1">6.3.1.1. Hooks</a></li>
<li><a class="reference internal" href="#operations">6.3.1.2. Operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#events">6.3.2. Events</a><ul>
<li><a class="reference internal" href="#entity-modification-related-events">6.3.2.1. Entity modification related events</a></li>
<li><a class="reference internal" href="#relation-modification-related-events">6.3.2.2. Relation modification related events</a></li>
<li><a class="reference internal" href="#non-data-events">6.3.2.3. Non data events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#api">6.3.3. API</a><ul>
<li><a class="reference internal" href="#hooks-control">6.3.3.1. Hooks control</a></li>
<li><a class="reference internal" href="#hooks-specific-predicates">6.3.3.2. Hooks specific predicates</a></li>
<li><a class="reference internal" href="#hooks-and-operations-classes">6.3.3.3. Hooks and operations classes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-using-dataflow-hooks">6.3.4. Example using dataflow hooks</a></li>
<li><a class="reference internal" href="#inter-instance-communication">6.3.5. Inter-instance communication</a></li>
<li><a class="reference internal" href="#hooks-writing-tips">6.3.6. Hooks writing tips</a><ul>
<li><a class="reference internal" href="#reminder">6.3.6.1. Reminder</a></li>
<li><a class="reference internal" href="#how-to-choose-between-a-before-and-an-after-event">6.3.6.2. How to choose between a before and an after event ?</a></li>
<li><a class="reference internal" href="#validation-errors">6.3.6.3. Validation Errors</a></li>
<li><a class="reference internal" href="#checking-for-object-created-deleted-in-the-current-transaction">6.3.6.4. Checking for object created/deleted in the current transaction</a></li>
<li><a class="reference internal" href="#peculiarities-of-inlined-relations">6.3.6.5. Peculiarities of inlined relations</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="sessions.html"
                        title="previous chapter">6.1. Sessions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="notifications.html"
                        title="next chapter">6.4. Notifications management</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/devrepo/repo/hooks.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="hooks-and-operations">
<span id="hooks"></span><h1>6.3. Hooks and Operations<a class="headerlink" href="#hooks-and-operations" title="Permalink to this headline">¶</a></h1>
<div class="section" id="generalities">
<h2>6.3.1. Generalities<a class="headerlink" href="#generalities" title="Permalink to this headline">¶</a></h2>
<p>Paraphrasing the <a class="reference external" href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Hooks.html">emacs</a> documentation, let us say that hooks are an important
mechanism for customizing an application. A hook is basically a list of
functions to be called on some well-defined occasion (this is called <cite>running
the hook</cite>).</p>
<div class="section" id="id1">
<h3>6.3.1.1. Hooks<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>In <em>CubicWeb</em>, hooks are subclasses of the <a class="reference internal" href="#cubicweb.server.hook.Hook" title="cubicweb.server.hook.Hook"><tt class="xref py py-class docutils literal"><span class="pre">Hook</span></tt></a>
class. They are selected over a set of pre-defined <cite>events</cite> (and possibly more
conditions, hooks being selectable appobjects like views and components).  They
should implement a <tt class="xref py py-meth docutils literal"><span class="pre">__call__()</span></tt> method that will
be called when the hook is triggered.</p>
<p>There are two families of events: data events (before / after any individual
update of an entity / or a relation in the repository) and server events (such
as server startup or shutdown).  In a typical application, most of the hooks are
defined over data events.</p>
<p>Also, some <a class="reference internal" href="#cubicweb.server.hook.Operation" title="cubicweb.server.hook.Operation"><tt class="xref py py-class docutils literal"><span class="pre">Operation</span></tt></a> may be registered by hooks,
which will be fired when the transaction is commited or rolled back.</p>
<p>The purpose of data event hooks is usually to complement the data model as
defined in the schema, which is static by nature and only provide a restricted
builtin set of dynamic constraints, with dynamic or value driven behaviours.
For instance they can serve the following purposes:</p>
<ul class="simple">
<li>enforcing constraints that the static schema cannot express (spanning several
entities/relations, exotic value ranges and cardinalities, etc.)</li>
<li>implement computed attributes</li>
</ul>
<p>It is functionally equivalent to a <a class="reference external" href="http://en.wikipedia.org/wiki/Database_trigger">database trigger</a>, except that database
triggers definition languages are not standardized, hence not portable (for
instance, PL/SQL works with Oracle and PostgreSQL but not SqlServer nor Sqlite).</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">It is a good practice to write unit tests for each hook. See an example in
<a class="reference internal" href="../testing.html#hook-test"><em>Unit test by example</em></a></p>
</div>
</div>
<div class="section" id="operations">
<h3>6.3.1.2. Operations<a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h3>
<p>Operations are subclasses of the <a class="reference internal" href="#cubicweb.server.hook.Operation" title="cubicweb.server.hook.Operation"><tt class="xref py py-class docutils literal"><span class="pre">Operation</span></tt></a> class
that may be created by hooks and scheduled to happen on <cite>precommit</cite>,
<cite>postcommit</cite> or <cite>rollback</cite> event (i.e. respectivly before/after a commit or
before a rollback of a transaction).</p>
<p>Hooks are being fired immediately on data operations, and it is sometime
necessary to delay the actual work down to a time where we can expect all
information to be there, or when all other hooks have run (though take case
since operations may themselves trigger hooks). Also while the order of
execution of hooks is data dependant (and thus hard to predict), it is possible
to force an order on operations.</p>
<p>So, for such case where you may miss some information that may be set later in
the transaction, you should instantiate an operation in the hook.</p>
<p>Operations may be used to:</p>
<ul class="simple">
<li>implements a validation check which needs that all relations be already set on
an entity</li>
<li>process various side effects associated with a transaction such as filesystem
udpates, mail notifications, etc.</li>
</ul>
</div>
</div>
<div class="section" id="events">
<h2>6.3.2. Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h2>
<p>Hooks are mostly defined and used to handle <a class="reference external" href="http://en.wikipedia.org/wiki/Dataflow">dataflow</a> operations. It
means as data gets in (entities added, updated, relations set or
unset), specific events are issued and the Hooks matching these events
are called.</p>
<p>You can get the event that triggered a hook by accessing its <cite>event</cite>
attribute.</p>
<div class="section" id="entity-modification-related-events">
<h3>6.3.2.1. Entity modification related events<a class="headerlink" href="#entity-modification-related-events" title="Permalink to this headline">¶</a></h3>
<p>When called for one of these events, hook will have an <cite>entity</cite> attribute
containing the entity instance.</p>
<ul>
<li><p class="first"><cite>before_add_entity</cite>, <cite>before_update_entity</cite>:</p>
<p>On those events, you can access the modified attributes of the entity using
the <cite>entity.cw_edited</cite> dictionary. The values can be modified and the old
values can be retrieved.</p>
<p>If you modify the <cite>entity.cw_edited</cite> dictionary in the hook, that is before
the database operations take place, you will avoid the need to process a whole
new rql query and the underlying backend query (eg usually sql) will contain
the modified data. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">cw_edited</span><span class="p">[</span><span class="s">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span>
</pre></div>
</div>
<p>will modify the age before it is written to the backend storage.</p>
<p>Similarly, removing an attribute from <cite>cw_edited</cite> will cancel its
modification:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">cw_edited</span><span class="p">[</span><span class="s">&#39;age&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>On a <cite>before_update_entity</cite> event, you can access the old and new values:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">cw_edited</span><span class="o">.</span><span class="n">oldnewvalue</span><span class="p">(</span><span class="s">&#39;age&#39;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first"><cite>after_add_entity</cite>, <cite>after_update_entity</cite></p>
<p>On those events, you can get the list of attributes that were modified using
the <cite>entity.cw_edited</cite> dictionary, but you can not modify it or get the old
value of an attribute.</p>
</li>
<li><p class="first"><cite>before_delete_entity</cite>, <cite>after_delete_entity</cite></p>
<p>On those events, the entity has no <cite>cw_edited</cite> dictionary.</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><cite>self.entity.cw_set(age=42)</cite> will set the <cite>age</cite> attribute to
42. But to do so, it will generate a rql query that will have to be processed,
hence may trigger some hooks, etc. This could lead to infinitely looping hooks.</p>
</div>
</div>
<div class="section" id="relation-modification-related-events">
<h3>6.3.2.2. Relation modification related events<a class="headerlink" href="#relation-modification-related-events" title="Permalink to this headline">¶</a></h3>
<p>When called for one of these events, hook will have <cite>eidfrom</cite>, <cite>rtype</cite>, <cite>eidto</cite>
attributes containing respectively the eid of the subject entity, the relation
type and the eid of the object entity.</p>
<ul>
<li><p class="first"><cite>before_add_relation</cite>, <cite>before_delete_relation</cite></p>
<p>On those events, you can still get the original relation by issuing a rql query.</p>
</li>
<li><p class="first"><cite>after_add_relation</cite>, <cite>after_delete_relation</cite></p>
</li>
</ul>
<p>Specific selectors are shipped for these kinds of events, see in particular
<a class="reference internal" href="#cubicweb.server.hook.match_rtype" title="cubicweb.server.hook.match_rtype"><tt class="xref py py-class docutils literal"><span class="pre">match_rtype</span></tt></a>.</p>
<p>Also note that relations can be added or deleted, but not updated.</p>
</div>
<div class="section" id="non-data-events">
<h3>6.3.2.3. Non data events<a class="headerlink" href="#non-data-events" title="Permalink to this headline">¶</a></h3>
<p>Hooks called on server start/maintenance/stop event (e.g.
<cite>server_startup</cite>, <cite>server_maintenance</cite>, <cite>before_server_shutdown</cite>,
<cite>server_shutdown</cite>) have a <cite>repo</cite> attribute, but <em>their `_cw` attribute
is None</em>.  The <cite>server_startup</cite> is called on regular startup, while
<cite>server_maintenance</cite> is called on cubicweb-ctl upgrade or shell
commands. <cite>server_shutdown</cite> is called anyway but connections to the
native source is impossible; <cite>before_server_shutdown</cite> handles that.</p>
<p>Hooks called on backup/restore event (eg <cite>server_backup</cite>,
<cite>server_restore</cite>) have a <cite>repo</cite> and a <cite>timestamp</cite> attributes, but
<em>their `_cw` attribute is None</em>.</p>
<p>Hooks called on session event (eg <cite>session_open</cite>, <cite>session_close</cite>) have no
special attribute.</p>
</div>
</div>
<div class="section" id="api">
<h2>6.3.3. API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="hooks-control">
<h3>6.3.3.1. Hooks control<a class="headerlink" href="#hooks-control" title="Permalink to this headline">¶</a></h3>
<p>It is sometimes convenient to explicitly enable or disable some hooks. For
instance if you want to disable some integrity checking hook. This can be
controlled more finely through the <cite>category</cite> class attribute, which is a string
giving a category name.  One can then uses the
<a class="reference internal" href="sessions.html#cubicweb.server.session.Session.deny_all_hooks_but" title="cubicweb.server.session.Session.deny_all_hooks_but"><tt class="xref py py-meth docutils literal"><span class="pre">deny_all_hooks_but()</span></tt></a> and
<a class="reference internal" href="sessions.html#cubicweb.server.session.Session.allow_all_hooks_but" title="cubicweb.server.session.Session.allow_all_hooks_but"><tt class="xref py py-meth docutils literal"><span class="pre">allow_all_hooks_but()</span></tt></a> context managers to
explicitly enable or disable some categories.</p>
<p>The existing categories are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">security</span></tt>, security checking hooks</li>
<li><tt class="docutils literal"><span class="pre">worfklow</span></tt>, workflow handling hooks</li>
<li><tt class="docutils literal"><span class="pre">metadata</span></tt>, hooks setting meta-data on newly created entities</li>
<li><tt class="docutils literal"><span class="pre">notification</span></tt>, email notification hooks</li>
<li><tt class="docutils literal"><span class="pre">integrity</span></tt>, data integrity checking hooks</li>
<li><tt class="docutils literal"><span class="pre">activeintegrity</span></tt>, data integrity consistency hooks, that you should <strong>never</strong>
want to disable</li>
<li><tt class="docutils literal"><span class="pre">syncsession</span></tt>, hooks synchronizing existing sessions</li>
<li><tt class="docutils literal"><span class="pre">syncschema</span></tt>, hooks synchronizing instance schema (including the physical database)</li>
<li><tt class="docutils literal"><span class="pre">email</span></tt>, email address handling hooks</li>
<li><tt class="docutils literal"><span class="pre">bookmark</span></tt>, bookmark entities handling hooks</li>
</ul>
<p>Nothing precludes one to invent new categories and use existing mechanisms to
filter them in or out.</p>
</div>
<div class="section" id="hooks-specific-predicates">
<h3>6.3.3.2. Hooks specific predicates<a class="headerlink" href="#hooks-specific-predicates" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="cubicweb.server.hook.match_rtype">
<em class="property">class </em><tt class="descclassname">cubicweb.server.hook.</tt><tt class="descname">match_rtype</tt><big>(</big><em>*expected</em>, <em>**more</em><big>)</big><a class="headerlink" href="#cubicweb.server.hook.match_rtype" title="Permalink to this definition">¶</a></dt>
<dd><p>accept if the relation type is found in expected ones. Optional
named parameters <cite>frometypes</cite> and <cite>toetypes</cite> can be used to restrict
target subject and/or object entity types of the relation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>*expected</strong> &#8211; possible relation types</li>
<li><strong>frometypes</strong> &#8211; candidate entity types as subject of relation</li>
<li><strong>toetypes</strong> &#8211; candidate entity types as object of relation</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="cubicweb.server.hook.match_rtype_sets">
<em class="property">class </em><tt class="descclassname">cubicweb.server.hook.</tt><tt class="descname">match_rtype_sets</tt><big>(</big><em>*expected</em><big>)</big><a class="headerlink" href="#cubicweb.server.hook.match_rtype_sets" title="Permalink to this definition">¶</a></dt>
<dd><p>accept if the relation type is in one of the sets given as initializer
argument. The goal of this predicate is that it keeps reference to original sets,
so modification to thoses sets are considered by the predicate. For instance</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">MYSET</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Hook1</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;hook1&#39;</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">match_rtype_sets</span><span class="p">(</span><span class="n">MYSET</span><span class="p">)</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">Hook2</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;hook2&#39;</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">match_rtype_sets</span><span class="p">(</span><span class="n">MYSET</span><span class="p">)</span>
</pre></div>
</div>
<p>Client code can now change <cite>MYSET</cite>, this will changes the selection criteria
of <tt class="xref py py-class docutils literal"><span class="pre">Hook1</span></tt> and <tt class="xref py py-class docutils literal"><span class="pre">Hook1</span></tt>.</p>
</dd></dl>

</div>
<div class="section" id="hooks-and-operations-classes">
<h3>6.3.3.3. Hooks and operations classes<a class="headerlink" href="#hooks-and-operations-classes" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="cubicweb.server.hook.Hook">
<em class="property">class </em><tt class="descclassname">cubicweb.server.hook.</tt><tt class="descname">Hook</tt><big>(</big><em>req</em>, <em>event</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.hook.Hook" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for hook.</p>
<p>Hooks being appobjects like views, they have a <cite>__regid__</cite> and a <cite>__select__</cite>
class attribute. Like all appobjects, hooks have the <cite>self._cw</cite> attribute which
represents the current session. In entity hooks, a <cite>self.entity</cite> attribute is
also present.</p>
<p>The <cite>events</cite> tuple is used by the base class selector to dispatch the hook
on the right events. It is possible to dispatch on multiple events at once
if needed (though take care as hook attribute may vary as described above).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Do not forget to extend the base class selectors as in:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyHook</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
  <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;whatever&#39;</span>
  <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">is_instance</span><span class="p">(</span><span class="s">&#39;Person&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p class="last">else your hooks will be called madly, whatever the event.</p>
</div>
</dd></dl>

<dl class="class">
<dt id="cubicweb.server.hook.Operation">
<em class="property">class </em><tt class="descclassname">cubicweb.server.hook.</tt><tt class="descname">Operation</tt><big>(</big><em>session</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.hook.Operation" title="Permalink to this definition">¶</a></dt>
<dd><p>Base class for operations.</p>
<p>Operation may be instantiated in the hooks&#8217; <cite>__call__</cite> method. It always
takes a session object as first argument (accessible as <cite>.session</cite> from the
operation instance), and optionally all keyword arguments needed by the
operation. These keyword arguments will be accessible as attributes from the
operation instance.</p>
<p>An operation is triggered on connections set events related to commit /
rollback transations. Possible events are:</p>
<ul>
<li><p class="first"><cite>precommit</cite>:</p>
<p>the transaction is being prepared for commit. You can freely do any heavy
computation, raise an exception if the commit can&#8217;t go. or even add some
new operations during this phase. If you do anything which has to be
reverted if the commit fails afterwards (eg altering the file system for
instance), you&#8217;ll have to support the &#8216;revertprecommit&#8217; event to revert
things by yourself</p>
</li>
<li><p class="first"><cite>revertprecommit</cite>:</p>
<p>if an operation failed while being pre-commited, this event is triggered
for all operations which had their &#8216;precommit&#8217; event already fired to let
them revert things (including the operation which made the commit fail)</p>
</li>
<li><p class="first"><cite>rollback</cite>:</p>
<p>the transaction has been either rolled back either:</p>
<blockquote>
<div><ul class="simple">
<li>intentionaly</li>
<li>a &#8216;precommit&#8217; event failed, in which case all operations are rolled back
once &#8216;revertprecommit&#8217;&#8217; has been called</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><cite>postcommit</cite>:</p>
<p>the transaction is over. All the ORM entities accessed by the earlier
transaction are invalid. If you need to work on the database, you need to
start a new transaction, for instance using a new internal session, which
you will need to commit (and close!).</p>
</li>
</ul>
<p>For an operation to support an event, one has to implement the <cite>&lt;event
name&gt;_event</cite> method with no arguments.</p>
<p>The order of operations may be important, and is controlled according to
the insert_index&#8217;s method output (whose implementation vary according to the
base hook class used).</p>
</dd></dl>

<dl class="class">
<dt id="cubicweb.server.hook.LateOperation">
<em class="property">class </em><tt class="descclassname">cubicweb.server.hook.</tt><tt class="descname">LateOperation</tt><big>(</big><em>session</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.hook.LateOperation" title="Permalink to this definition">¶</a></dt>
<dd><p>special operation which should be called after all possible (ie non late)
operations</p>
</dd></dl>

<dl class="class">
<dt id="cubicweb.server.hook.DataOperationMixIn">
<em class="property">class </em><tt class="descclassname">cubicweb.server.hook.</tt><tt class="descname">DataOperationMixIn</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.hook.DataOperationMixIn" title="Permalink to this definition">¶</a></dt>
<dd><p>Mix-in class to ease applying a single operation on a set of data,
avoiding to create as many as operation as they are individual modification.
The body of the operation must then iterate over the values that have been
stored in a single operation instance.</p>
<p>You should try to use this instead of creating on operation for each
<cite>value</cite>, since handling operations becomes costly on massive data import.</p>
<p>Usage looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyEntityHook</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;my.entity.hook&#39;</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">is_instance</span><span class="p">(</span><span class="s">&#39;MyEntity&#39;</span><span class="p">)</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;after_add_entity&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">MyOperation</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="p">)</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MyOperation</span><span class="p">(</span><span class="n">DataOperationMixIn</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">precommit_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bucket</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">():</span>
            <span class="n">process</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
</pre></div>
</div>
<p>You can modify the <cite>containercls</cite> class attribute, which defines the
container class that should be instantiated to hold payloads. An instance is
created on instantiation, and then the <tt class="xref py py-meth docutils literal"><span class="pre">add_data()</span></tt> method will add the
given data to the existing container. Default to a <cite>set</cite>. Give <cite>list</cite> if you
want to keep arrival ordering. You can also use another kind of container
by redefining <tt class="xref py py-meth docutils literal"><span class="pre">_build_container()</span></tt> and <tt class="xref py py-meth docutils literal"><span class="pre">add_data()</span></tt></p>
<p>More optional parameters can be given to the <cite>get_instance</cite> operation, that
will be given to the operation constructor (for obvious reasons those
parameters should not vary accross different calls to this method for a
given operation).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For sanity reason <cite>get_data</cite> will reset the operation, so that once
the operation has started its treatment, if some hook want to push
additional data to this same operation, a new instance will be created
(else that data has a great chance to be never treated). This implies:</p>
<ul class="last simple">
<li>you should <strong>always</strong> call <cite>get_data</cite> when starting treatment</li>
<li>you should <strong>never</strong> call <cite>get_data</cite> for another reason.</li>
</ul>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="example-using-dataflow-hooks">
<h2>6.3.4. Example using dataflow hooks<a class="headerlink" href="#example-using-dataflow-hooks" title="Permalink to this headline">¶</a></h2>
<p>We will use a very simple example to show hooks usage. Let us start with the
following schema.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">EntityType</span><span class="p">):</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We would like to add a range constraint over a person&#8217;s age. Let&#8217;s write an hook
(supposing yams can not handle this nativly, which is wrong). It shall be placed
into <cite>mycube/hooks.py</cite>. If this file were to grow too much, we can easily have a
<cite>mycube/hooks/... package</cite> containing hooks in various modules.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">cubicweb.predicates</span> <span class="kn">import</span> <span class="n">is_instance</span>
<span class="kn">from</span> <span class="nn">cubicweb.server.hook</span> <span class="kn">import</span> <span class="n">Hook</span>

<span class="k">class</span> <span class="nc">PersonAgeRange</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
     <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;person_age_range&#39;</span>
     <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">is_instance</span><span class="p">(</span><span class="s">&#39;Person&#39;</span><span class="p">)</span>
     <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;before_add_entity&#39;</span><span class="p">,</span> <span class="s">&#39;before_update_entity&#39;</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">if</span> <span class="s">&#39;age&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">cw_edited</span><span class="p">:</span>
             <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">120</span><span class="p">:</span>
                <span class="k">return</span>
             <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;age must be between 0 and 120&#39;</span><span class="p">)</span>
             <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;age&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
</pre></div>
</div>
<p>In our example the base <cite>__select__</cite> is augmented with an <cite>is_instance</cite> selector
matching the desired entity type.</p>
<p>The <cite>events</cite> tuple is used specify that our hook should be called before the
entity is added or updated.</p>
<p>Then in the hook&#8217;s <cite>__call__</cite> method, we:</p>
<ul class="simple">
<li>check if the &#8216;age&#8217; attribute is edited</li>
<li>if so, check the value is in the range</li>
<li>if not, raise a validation error properly</li>
</ul>
<p>Now Let&#8217;s augment our schema with new <cite>Company</cite> entity type with some relation to
<cite>Person</cite> (in &#8216;mycube/schema.py&#8217;).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Company</span><span class="p">(</span><span class="n">EntityType</span><span class="p">):</span>
     <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
     <span class="n">boss</span> <span class="o">=</span> <span class="n">SubjectRelation</span><span class="p">(</span><span class="s">&#39;Person&#39;</span><span class="p">,</span> <span class="n">cardinality</span><span class="o">=</span><span class="s">&#39;1*&#39;</span><span class="p">)</span>
     <span class="n">subsidiary_of</span> <span class="o">=</span> <span class="n">SubjectRelation</span><span class="p">(</span><span class="s">&#39;Company&#39;</span><span class="p">,</span> <span class="n">cardinality</span><span class="o">=</span><span class="s">&#39;*?&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We would like to constrain the company&#8217;s bosses to have a minimum (legal)
age. Let&#8217;s write an hook for this, which will be fired when the <cite>boss</cite> relation
is established (still supposing we could not specify that kind of thing in the
schema).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CompanyBossLegalAge</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
     <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;company_boss_legal_age&#39;</span>
     <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">match_rtype</span><span class="p">(</span><span class="s">&#39;boss&#39;</span><span class="p">)</span>
     <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;before_add_relation&#39;</span><span class="p">,)</span>

     <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">boss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">entity_from_eid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eidto</span><span class="p">)</span>
         <span class="k">if</span> <span class="n">boss</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">:</span>
             <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;the minimum age for a boss is 18&#39;</span><span class="p">)</span>
             <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eidfrom</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;boss&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>We use the <a class="reference internal" href="#cubicweb.server.hook.match_rtype" title="cubicweb.server.hook.match_rtype"><tt class="xref py py-class docutils literal"><span class="pre">match_rtype</span></tt></a> selector to select the
proper relation type.</p>
<p class="last">The essential difference with respect to an entity hook is that there is no
self.entity, but <cite>self.eidfrom</cite> and <cite>self.eidto</cite> hook attributes which
represent the subject and object <strong>eid</strong> of the relation.</p>
</div>
<p>Suppose we want to check that there is no cycle by the <cite>subsidiary_of</cite>
relation. This is best achieved in an operation since all relations are likely to
be set at commit time.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.server.hook</span> <span class="kn">import</span> <span class="n">Hook</span><span class="p">,</span> <span class="n">DataOperationMixIn</span><span class="p">,</span> <span class="n">Operation</span><span class="p">,</span> <span class="n">match_rtype</span>

<span class="k">def</span> <span class="nf">check_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="n">rtype</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s">&#39;subject&#39;</span><span class="p">):</span>
    <span class="n">parents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">eid</span><span class="p">])</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">entity_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">parent</span><span class="o">.</span><span class="n">related</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">related</span><span class="p">(</span><span class="n">rtype</span><span class="p">,</span> <span class="n">role</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">eid</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;detected </span><span class="si">%s</span><span class="s"> cycle&#39;</span> <span class="o">%</span> <span class="n">rtype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="p">{</span><span class="n">rtype</span><span class="p">:</span> <span class="n">msg</span><span class="p">})</span>
        <span class="n">parents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CheckSubsidiaryCycleOp</span><span class="p">(</span><span class="n">Operation</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">precommit_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">check_cycle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eidto</span><span class="p">,</span> <span class="s">&#39;subsidiary_of&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CheckSubsidiaryCycleHook</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;check_no_subsidiary_cycle&#39;</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">match_rtype</span><span class="p">(</span><span class="s">&#39;subsidiary_of&#39;</span><span class="p">)</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;after_add_relation&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">CheckSubsidiaryCycleOp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="p">,</span> <span class="n">eidto</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eidto</span><span class="p">)</span>
</pre></div>
</div>
<p>Like in hooks, <tt class="xref py py-exc docutils literal"><span class="pre">ValidationError</span></tt> can be raised in operations. Other
exceptions are usually programming errors.</p>
<p>In the above example, our hook will instantiate an operation each time the hook
is called, i.e. each time the <cite>subsidiary_of</cite> relation is set. There is an
alternative method to schedule an operation from a hook, using the
<tt class="xref py py-func docutils literal"><span class="pre">get_instance()</span></tt> class method.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.server.hook</span> <span class="kn">import</span> <span class="n">set_operation</span>

<span class="k">class</span> <span class="nc">CheckSubsidiaryCycleHook</span><span class="p">(</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;check_no_subsidiary_cycle&#39;</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;after_add_relation&#39;</span><span class="p">,)</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">Hook</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span> <span class="n">match_rtype</span><span class="p">(</span><span class="s">&#39;subsidiary_of&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">CheckSubsidiaryCycleOp</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="p">)</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eidto</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CheckSubsidiaryCycleOp</span><span class="p">(</span><span class="n">DataOperationMixIn</span><span class="p">,</span> <span class="n">Operation</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">precommit_event</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">():</span>
            <span class="n">check_cycle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rtype</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we call <tt class="xref py py-func docutils literal"><span class="pre">set_operation()</span></tt> so that we will simply accumulate eids of
entities to check at the end in a single <cite>CheckSubsidiaryCycleOp</cite>
operation. Value are stored in a set associated to the
&#8216;subsidiary_cycle_detection&#8217; transaction data key. The set initialization and
operation creation are handled nicely by <tt class="xref py py-func docutils literal"><span class="pre">set_operation()</span></tt>.</p>
<p>A more realistic example can be found in the advanced tutorial chapter
<a class="reference internal" href="../../tutorials/advanced/part02_security.html#adv-tuto-security-propagation"><em>Step 2: security propagation in hooks</em></a>.</p>
</div>
<div class="section" id="inter-instance-communication">
<h2>6.3.5. Inter-instance communication<a class="headerlink" href="#inter-instance-communication" title="Permalink to this headline">¶</a></h2>
<p>If your application consists of several instances, you may need some means to
communicate between them.  Cubicweb provides a publish/subscribe mechanism
using <a class="reference external" href="http://www.zeromq.org/">ØMQ</a>.  In order to use it, use
<tt class="xref py py-meth docutils literal"><span class="pre">add_subscription()</span></tt> on the
<cite>repo.app_instances_bus</cite> object.  The <cite>callback</cite> will get the message (as a
list).  A message can be sent by calling
<tt class="xref py py-meth docutils literal"><span class="pre">publish()</span></tt> on <cite>repo.app_instances_bus</cite>.
The first element of the message is the topic which is used for filtering and
dispatching messages.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FooHook</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;server_startup&#39;</span><span class="p">,)</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;foo_startup&#39;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;received message: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">app_instances_bus</span><span class="o">.</span><span class="n">add_subscription</span><span class="p">(</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">do_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">actually_do_foo</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">app_instances_bus</span><span class="o">.</span><span class="n">publish</span><span class="p">([</span><span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;world&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The <cite>zmq-address-pub</cite> configuration variable contains the address used
by the instance for sending messages, e.g. <cite>tcp://*:1234</cite>.  The
<cite>zmq-address-sub</cite> variable contains a comma-separated list of addresses
to listen on, e.g. <cite>tcp://localhost:1234, tcp://192.168.1.1:2345</cite>.</p>
</div>
<div class="section" id="hooks-writing-tips">
<h2>6.3.6. Hooks writing tips<a class="headerlink" href="#hooks-writing-tips" title="Permalink to this headline">¶</a></h2>
<div class="section" id="reminder">
<h3>6.3.6.1. Reminder<a class="headerlink" href="#reminder" title="Permalink to this headline">¶</a></h3>
<p>You should never use the <cite>entity.foo = 42</cite> notation to update an entity. It will
not do what you expect (updating the database). Instead, use the
<tt class="xref py py-meth docutils literal"><span class="pre">cw_set()</span></tt> method or direct access to entity&#8217;s
<tt class="xref py py-attr docutils literal"><span class="pre">cw_edited</span></tt> attribute if you&#8217;re writing a hook for &#8216;before_add_entity&#8217; or
&#8216;before_update_entity&#8217; event.</p>
</div>
<div class="section" id="how-to-choose-between-a-before-and-an-after-event">
<h3>6.3.6.2. How to choose between a before and an after event ?<a class="headerlink" href="#how-to-choose-between-a-before-and-an-after-event" title="Permalink to this headline">¶</a></h3>
<p><cite>before_*</cite> hooks give you access to the old attribute (or relation)
values. You can also intercept and update edited values in the case of
entity modification before they reach the database.</p>
<p>Else the question is: should I need to do things before or after the actual
modification ? If the answer is &#8220;it doesn&#8217;t matter&#8221;, use an &#8216;after&#8217; event.</p>
</div>
<div class="section" id="validation-errors">
<h3>6.3.6.3. Validation Errors<a class="headerlink" href="#validation-errors" title="Permalink to this headline">¶</a></h3>
<p>When a hook which is responsible to maintain the consistency of the
data model detects an error, it must use a specific exception named
<tt class="xref py py-exc docutils literal"><span class="pre">ValidationError</span></tt>. Raising anything but a (subclass of)
<tt class="xref py py-exc docutils literal"><span class="pre">ValidationError</span></tt> is a programming error. Raising it
entails aborting the current transaction.</p>
<p>This exception is used to convey enough information up to the user
interface. Hence its constructor is different from the default Exception
constructor. It accepts, positionally:</p>
<ul class="simple">
<li>an entity eid (<strong>not the entity itself</strong>),</li>
<li>a dict whose keys represent attribute (or relation) names and values
an end-user facing message (hence properly translated) relating the
problem.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">earth</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;sea_level&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;too high&#39;</span><span class="p">),</span>
                                  <span class="s">&#39;temperature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;too hot&#39;</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="section" id="checking-for-object-created-deleted-in-the-current-transaction">
<h3>6.3.6.4. Checking for object created/deleted in the current transaction<a class="headerlink" href="#checking-for-object-created-deleted-in-the-current-transaction" title="Permalink to this headline">¶</a></h3>
<p>In hooks, you can use the
<a class="reference internal" href="sessions.html#cubicweb.server.session.Session.added_in_transaction" title="cubicweb.server.session.Session.added_in_transaction"><tt class="xref py py-meth docutils literal"><span class="pre">added_in_transaction()</span></tt></a> or
<a class="reference internal" href="sessions.html#cubicweb.server.session.Session.deleted_in_transaction" title="cubicweb.server.session.Session.deleted_in_transaction"><tt class="xref py py-meth docutils literal"><span class="pre">deleted_in_transaction()</span></tt></a> of the session
object to check if an eid has been created or deleted during the hook&#8217;s
transaction.</p>
<p>This is useful to enable or disable some stuff if some entity is being added or
deleted.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">deleted_in_transaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eidto</span><span class="p">):</span>
   <span class="k">return</span>
</pre></div>
</div>
</div>
<div class="section" id="peculiarities-of-inlined-relations">
<h3>6.3.6.5. Peculiarities of inlined relations<a class="headerlink" href="#peculiarities-of-inlined-relations" title="Permalink to this headline">¶</a></h3>
<p>Relations which are defined in the schema as <cite>inlined</cite> (see <a class="reference internal" href="../datamodel/definition.html#relationtype"><em>Relation type</em></a>
for details) are inserted in the database at the same time as entity attributes.</p>
<p>This may have some side effect, for instance when creating an entity
and setting an inlined relation in the same rql query, then at
<cite>before_add_relation</cite> time, the relation will already exist in the
database (it is otherwise not the case).</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="notifications.html" title="6.4. Notifications management"
             >next</a> |</li>
        <li class="right" >
          <a href="sessions.html" title="6.1. Sessions"
             >previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" >6. Repository customization</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>