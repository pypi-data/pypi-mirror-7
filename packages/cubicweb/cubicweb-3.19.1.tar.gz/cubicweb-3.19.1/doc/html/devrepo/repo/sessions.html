
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>6.1. Sessions &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../../index.html" />
    <link rel="up" title="6. Repository customization" href="index.html" />
    <link rel="next" title="6.3. Hooks and Operations" href="hooks.html" />
    <link rel="prev" title="6. Repository customization" href="index.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="hooks.html" title="6.3. Hooks and Operations"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="6. Repository customization"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">6. Repository customization</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.1. Sessions</a></li>
<li><a class="reference internal" href="#connections">6.2. Connections</a><ul>
<li><a class="reference internal" href="#kinds-of-connections">6.2.1. Kinds of connections</a></li>
<li><a class="reference internal" href="#authentication-and-management-of-sessions">6.2.2. Authentication and management of sessions</a></li>
<li><a class="reference internal" href="#writing-authentication-plugins">6.2.3. Writing authentication plugins</a><ul>
<li><a class="reference internal" href="#repository-authentication-plugins">6.2.3.1. Repository authentication plugins</a></li>
<li><a class="reference internal" href="#web-authentication-plugins">6.2.3.2. Web authentication plugins</a></li>
<li><a class="reference internal" href="#full-session-and-connection-api">6.2.3.3. Full Session and Connection API</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">6. Repository customization</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="hooks.html"
                        title="next chapter">6.3. Hooks and Operations</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/devrepo/repo/sessions.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="sessions">
<h1>6.1. Sessions<a class="headerlink" href="#sessions" title="Permalink to this headline">¶</a></h1>
<p>Sessions are objects linked to an authenticated user.  The <cite>Session.new_cnx</cite>
method returns a new Connection linked to that session.</p>
</div>
<div class="section" id="connections">
<h1>6.2. Connections<a class="headerlink" href="#connections" title="Permalink to this headline">¶</a></h1>
<p>Connections provide the <cite>.execute</cite> method to query the data sources.</p>
<div class="section" id="kinds-of-connections">
<h2>6.2.1. Kinds of connections<a class="headerlink" href="#kinds-of-connections" title="Permalink to this headline">¶</a></h2>
<p>There are two kinds of connections.</p>
<ul class="simple">
<li><cite>normal connections</cite> are the most common: they are related to users and
carry security checks coming with user credentials</li>
<li><cite>internal connections</cite> have all the powers; they are also used in only a
few situations where you don&#8217;t already have an adequate session at
hand, like: user authentication, data synchronisation in
multi-source contexts</li>
</ul>
<p>Normal connections are typically named <cite>_cw</cite> in most appobjects or
sometimes just <cite>session</cite>.</p>
<p>Internal connections are available from the <cite>Repository</cite> object and are
to be used like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">internal_cnx</span><span class="p">()</span> <span class="k">as</span> <span class="n">cnx</span><span class="p">:</span>
    <span class="n">do_stuff_with</span><span class="p">(</span><span class="n">cnx</span><span class="p">)</span>
    <span class="n">cnx</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>Connections should always be used as context managers, to avoid leaks.</p>
</div>
<div class="section" id="authentication-and-management-of-sessions">
<h2>6.2.2. Authentication and management of sessions<a class="headerlink" href="#authentication-and-management-of-sessions" title="Permalink to this headline">¶</a></h2>
<p>The authentication process is a ballet involving a few dancers:</p>
<ul class="simple">
<li>through its <cite>get_session</cite> method the top-level application object (the
<cite>CubicWebPublisher</cite>) will open a session whenever a web request
comes in; it asks the <cite>session manager</cite> to open a session (giving
the web request object as context) using <cite>open_session</cite><ul>
<li>the session manager asks its authentication manager (which is a
<cite>component</cite>) to authenticate the request (using <cite>authenticate</cite>)<ul>
<li>the authentication manager asks, in order, to its authentication
information retrievers, a login and an opaque object containing
other credentials elements (calling <cite>authentication_information</cite>),
giving the request object each time<ul>
<li>the default retriever (named <cite>LoginPasswordRetriever</cite>)
will in turn defer login and password fetching to the request
object (which, depending on the authentication mode (<cite>cookie</cite>
or <cite>http</cite>), will do the appropriate things and return a login
and a password)</li>
</ul>
</li>
<li>the authentication manager, on success, asks the <cite>Repository</cite>
object to connect with the found credentials (using <cite>connect</cite>)<ul>
<li>the repository object asks authentication to all of its
sources which support the <cite>CWUser</cite> entity with the given
credentials; when successful it can build the cwuser entity,
from which a regular <cite>Session</cite> object is made; it returns the
session id<ul>
<li>the source in turn will delegate work to an authentifier
class that defines the ultimate <cite>authenticate</cite> method (for
instance the native source will query the database against
the provided credentials)</li>
</ul>
</li>
</ul>
</li>
<li>the authentication manager, on success, will call back _all_
retrievers with <cite>authenticated</cite> and return its authentication
data (on failure, it will try the anonymous login or, if the
configuration forbids it, raise an <cite>AuthenticationError</cite>)</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="writing-authentication-plugins">
<h2>6.2.3. Writing authentication plugins<a class="headerlink" href="#writing-authentication-plugins" title="Permalink to this headline">¶</a></h2>
<p>Sometimes CubicWeb&#8217;s out-of-the-box authentication schemes (cookie and
http) are not sufficient. Nowadays there is a plethora of such schemes
and the framework cannot provide them all, but as the sequence above
shows, it is extensible.</p>
<p>Two levels have to be considered when writing an authentication
plugin: the web client and the repository.</p>
<p>We invented a scenario where it makes sense to have a new plugin in
each side: some middleware will do pre-authentication and under the
right circumstances add a new HTTP <cite>x-foo-user</cite> header to the query
before it reaches the CubicWeb instance. For a concrete example of
this, see the <a class="reference external" href="http://www.cubicweb.org/project/cubicweb-trustedauth">trustedauth</a> cube.</p>
<div class="section" id="repository-authentication-plugins">
<h3>6.2.3.1. Repository authentication plugins<a class="headerlink" href="#repository-authentication-plugins" title="Permalink to this headline">¶</a></h3>
<p>On the repository side, it is possible to register a source
authentifier using the following kind of code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.server.sources</span> <span class="kn">import</span> <span class="n">native</span>

<span class="k">class</span> <span class="nc">FooAuthentifier</span><span class="p">(</span><span class="n">native</span><span class="o">.</span><span class="n">LoginPasswordAuthentifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a source authentifier plugin</span>
<span class="sd">    if &#39;foo&#39; in authentication information, no need to check</span>
<span class="sd">    password</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">auth_rql</span> <span class="o">=</span> <span class="s">&#39;Any X WHERE X is CWUser, X login </span><span class="si">%(login)s</span><span class="s">&#39;</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return CWUser eid for the given login</span>
<span class="sd">        if this account is defined in this source,</span>
<span class="sd">        else raise `AuthenticationError`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;authentication by </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;foo&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">FooAuthentifier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rset</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auth_rql</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;login&#39;</span><span class="p">:</span> <span class="n">login</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">rset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;authentication failure (</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">AuthenticationError</span><span class="p">(</span><span class="s">&#39;foo user is unknown to us&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Since repository authentifiers are not appobjects, we have to register
them through a <cite>server_startup</cite> hook.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ServerStartupHook</span><span class="p">(</span><span class="n">hook</span><span class="o">.</span><span class="n">Hook</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; register the foo authenticator &quot;&quot;&quot;</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;fooauthenticatorregisterer&#39;</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;server_startup&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;registering foo authentifier&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">system_source</span><span class="o">.</span><span class="n">add_authentifier</span><span class="p">(</span><span class="n">FooAuthentifier</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="web-authentication-plugins">
<h3>6.2.3.2. Web authentication plugins<a class="headerlink" href="#web-authentication-plugins" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">XFooUserRetriever</span><span class="p">(</span><span class="n">authentication</span><span class="o">.</span><span class="n">LoginPasswordRetriever</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; authenticate by the x-foo-user http header</span>
<span class="sd">    or just do normal login/password authentication</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;x-foo-user&#39;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">authentication_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;retrieve authentication information from the given request, raise</span>
<span class="sd">        NoAuthInfo if expected information is not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;web authenticator building auth info&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
           <span class="n">login</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_header</span><span class="p">(</span><span class="s">&#39;x-foo-user&#39;</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">login</span><span class="p">:</span>
               <span class="k">return</span> <span class="n">login</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">XFooUserRetriever</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">authentication_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;web authenticator failed (</span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">authentication</span><span class="o">.</span><span class="n">NoAuthInfo</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retriever</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">cnx</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">authinfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;callback when return authentication information have opened a</span>
<span class="sd">        repository connection successfully. Take care req has no session</span>
<span class="sd">        attached yet, hence req.execute isn&#39;t available.</span>

<span class="sd">        Here we set a flag on the request to indicate that the user is</span>
<span class="sd">        foo-authenticated. Can be used by a selector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;web authenticator running post authentication callback&#39;</span><span class="p">)</span>
        <span class="n">cnx</span><span class="o">.</span><span class="n">foo_user</span> <span class="o">=</span> <span class="n">authinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the <cite>authenticated</cite> method we add (in an admitedly slightly hackish
way) an attribute to the connection object. This, in turn, can be used
to build a selector dispatching on the fact that the user was
preauthenticated or not.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@objectify_selector</span>
<span class="k">def</span> <span class="nf">foo_authenticated</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">cnx</span><span class="p">,</span> <span class="s">&#39;foo_user&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">foo_user</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="full-session-and-connection-api">
<h3>6.2.3.3. Full Session and Connection API<a class="headerlink" href="#full-session-and-connection-api" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="cubicweb.server.session.Session">
<em class="property">class </em><tt class="descclassname">cubicweb.server.session.</tt><tt class="descname">Session</tt><big>(</big><em>user</em>, <em>repo</em>, <em>cnxprops=None</em>, <em>_id=None</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session" title="Permalink to this definition">¶</a></dt>
<dd><p>Repository user session</p>
<dl class="docutils">
<dt>This ties all together:</dt>
<dd><ul class="first last simple">
<li>session id,</li>
<li>user,</li>
<li>connections set,</li>
<li>other session data.</li>
</ul>
</dd>
</dl>
<p><strong>About session storage / transactions</strong></p>
<p>Here is a description of internal session attributes. Besides <tt class="xref py py-attr docutils literal"><span class="pre">data</span></tt>
and <tt class="xref py py-attr docutils literal"><span class="pre">transaction_data</span></tt>, you should not have to use attributes
described here but higher level APIs.</p>
<blockquote>
<div><p><tt class="xref py py-attr docutils literal"><span class="pre">data</span></tt> is a dictionary containing shared data, used to communicate
extra information between the client and the repository</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">_cnxs</span></tt> is a dictionary of <tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt> instance, one
for each running connection. The key is the connection id. By default
the connection id is the thread name but it can be otherwise (per dbapi
cursor for instance, or per thread name <em>from another process</em>).</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">__threaddata</span></tt> is a thread local storage whose <cite>cnx</cite> attribute
refers to the proper instance of <tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt> according to the
connection.</p>
</div></blockquote>
<p>You should not have to use neither <tt class="xref py py-attr docutils literal"><span class="pre">_cnx</span></tt> nor <tt class="xref py py-attr docutils literal"><span class="pre">__threaddata</span></tt>,
simply access connection data transparently through the <tt class="xref py py-attr docutils literal"><span class="pre">_cnx</span></tt>
property. Also, you usually don&#8217;t have to access it directly since current
connection&#8217;s data may be accessed/modified through properties / methods:</p>
<blockquote>
<div><tt class="xref py py-attr docutils literal"><span class="pre">connection_data</span></tt>, similarly to <tt class="xref py py-attr docutils literal"><span class="pre">data</span></tt>, is a dictionary
containing some shared data that should be cleared at the end of the
connection. Hooks and operations may put arbitrary data in there, and
this may also be used as a communication channel between the client and
the repository.</div></blockquote>
<dl class="method">
<dt id="cubicweb.server.session.Session.get_shared_data">
<tt class="descname">get_shared_data</tt><big>(</big><em>key</em>, <em>default=None</em>, <em>pop=False</em>, <em>txdata=False</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.get_shared_data" title="Permalink to this definition">¶</a></dt>
<dd><p>return value associated to <cite>key</cite> in session data</p>
</dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.set_shared_data">
<tt class="descname">set_shared_data</tt><big>(</big><em>key</em>, <em>value</em>, <em>txdata=False</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.set_shared_data" title="Permalink to this definition">¶</a></dt>
<dd><p>set value associated to <cite>key</cite> in session data</p>
</dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.added_in_transaction">
<tt class="descname">added_in_transaction</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.added_in_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>return True if the entity of the given eid is being created in the
current transaction</p>
</dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.deleted_in_transaction">
<tt class="descname">deleted_in_transaction</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.deleted_in_transaction" title="Permalink to this definition">¶</a></dt>
<dd><p>return True if the entity of the given eid is being deleted in the
current transaction</p>
</dd></dl>

<p>Connection state information:</p>
<blockquote>
<div><p><tt class="xref py py-attr docutils literal"><span class="pre">running_dbapi_query</span></tt>, boolean flag telling if the executing query
is coming from a dbapi connection or is a query from within the repository</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">cnxset</span></tt>, the connections set to use to execute queries on sources.
During a transaction, the connection set may be freed so that is may be
used by another session as long as no writing is done. This means we can
have multiple sessions with a reasonably low connections set pool size.</p>
<dl class="method">
<dt id="cubicweb.server.session.Session.set_cnxset">
<tt class="descname">set_cnxset</tt><big>(</big><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.set_cnxset" title="Permalink to this definition">¶</a></dt>
<dd><p>the session need a connections set to execute some queries</p>
</dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.free_cnxset">
<tt class="descname">free_cnxset</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.free_cnxset" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p><tt class="xref py py-attr docutils literal"><span class="pre">mode</span></tt>, string telling the connections set handling mode, may be one
of &#8216;read&#8217; (connections set may be freed), &#8216;write&#8217; (some write was done in
the connections set, it can&#8217;t be freed before end of the transaction),
&#8216;transaction&#8217; (we want to keep the connections set during all the
transaction, with or without writing)</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">pending_operations</span></tt>, ordered list of operations to be processed on
commit/rollback</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">commit_state</span></tt>, describing the transaction commit state, may be one
of None (not yet committing), &#8216;precommit&#8217; (calling precommit event on
operations), &#8216;postcommit&#8217; (calling postcommit event on operations),
&#8216;uncommitable&#8217; (some <tt class="xref py py-exc docutils literal"><span class="pre">ValidationError</span></tt> or <tt class="xref py py-exc docutils literal"><span class="pre">Unauthorized</span></tt> error
has been raised during the transaction and so it must be rolled back).</p>
</div></blockquote>
<dl class="method">
<dt id="cubicweb.server.session.Session.commit">
<tt class="descname">commit</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.commit" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.rollback">
<tt class="descname">rollback</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.rollback" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.close">
<tt class="descname">close</tt><big>(</big><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.close" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.closed">
<tt class="descname">closed</tt><big>(</big><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.closed" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Security level Management:</p>
<blockquote>
<div><tt class="xref py py-attr docutils literal"><span class="pre">read_security</span></tt> and <tt class="xref py py-attr docutils literal"><span class="pre">write_security</span></tt>, boolean flags telling if
read/write security is currently activated.</div></blockquote>
<dl class="method">
<dt id="cubicweb.server.session.Session.security_enabled">
<tt class="descname">security_enabled</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.security_enabled" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Hooks Management:</p>
<blockquote>
<div><p><tt class="xref py py-attr docutils literal"><span class="pre">hooks_mode</span></tt>, may be either <cite>HOOKS_ALLOW_ALL</cite> or <cite>HOOKS_DENY_ALL</cite>.</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">enabled_hook_categories</span></tt>, when <tt class="xref py py-attr docutils literal"><span class="pre">hooks_mode</span></tt> is
<cite>HOOKS_DENY_ALL</cite>, this set contains hooks categories that are enabled.</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">disabled_hook_categories</span></tt>, when <tt class="xref py py-attr docutils literal"><span class="pre">hooks_mode</span></tt> is
<cite>HOOKS_ALLOW_ALL</cite>, this set contains hooks categories that are disabled.</p>
</div></blockquote>
<dl class="method">
<dt id="cubicweb.server.session.Session.deny_all_hooks_but">
<tt class="descname">deny_all_hooks_but</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.deny_all_hooks_but" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.allow_all_hooks_but">
<tt class="descname">allow_all_hooks_but</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.allow_all_hooks_but" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.is_hook_category_activated">
<tt class="descname">is_hook_category_activated</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.is_hook_category_activated" title="Permalink to this definition">¶</a></dt>
<dd><p>return a boolean telling if the given category is currently activated
or not</p>
</dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.is_hook_activated">
<tt class="descname">is_hook_activated</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.is_hook_activated" title="Permalink to this definition">¶</a></dt>
<dd><p>return a boolean telling if the given hook class is currently
activated or not</p>
</dd></dl>

<p>Data manipulation:</p>
<dl class="method">
<dt id="cubicweb.server.session.Session.add_relation">
<tt class="descname">add_relation</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.add_relation" title="Permalink to this definition">¶</a></dt>
<dd><p>provide direct access to the repository method to add a relation.</p>
<p>This is equivalent to the following rql query:</p>
<blockquote>
<div>SET X rtype Y WHERE X eid  fromeid, T eid toeid</div></blockquote>
<p>without read security check but also all the burden of rql execution.
You may use this in hooks when you know both eids of the relation you
want to add.</p>
</dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.add_relations">
<tt class="descname">add_relations</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.add_relations" title="Permalink to this definition">¶</a></dt>
<dd><p>set many relation using a shortcut similar to the one in add_relation</p>
<p>relations is a list of 2-uples, the first element of each
2-uple is the rtype, and the second is a list of (fromeid,
toeid) tuples</p>
</dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Session.delete_relation">
<tt class="descname">delete_relation</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.delete_relation" title="Permalink to this definition">¶</a></dt>
<dd><p>provide direct access to the repository method to delete a relation.</p>
<p>This is equivalent to the following rql query:</p>
<blockquote>
<div>DELETE X rtype Y WHERE X eid  fromeid, T eid toeid</div></blockquote>
<p>without read security check but also all the burden of rql execution.
You may use this in hooks when you know both eids of the relation you
want to delete.</p>
</dd></dl>

<p>Other:</p>
<dl class="method">
<dt id="cubicweb.server.session.Session.call_service">
<tt class="descname">call_service</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Session.call_service" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="class">
<dt id="cubicweb.server.session.Connection">
<em class="property">class </em><tt class="descclassname">cubicweb.server.session.</tt><tt class="descname">Connection</tt><big>(</big><em>session</em>, <em>cnxid=None</em>, <em>session_handled=False</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Connection" title="Permalink to this definition">¶</a></dt>
<dd><p>Repository Connection</p>
<p>Holds all connection related data</p>
<p>Database connection resources:</p>
<blockquote>
<div><p><tt class="xref py py-attr docutils literal"><span class="pre">running_dbapi_query</span></tt>, boolean flag telling if the executing query
is coming from a dbapi connection or is a query from within the repository</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">cnxset</span></tt>, the connections set to use to execute queries on sources.
If the transaction is read only, the connection set may be freed between
actual queries. This allows multiple connections with a reasonably low
connection set pool size.  Control mechanism is detailed below.</p>
</div></blockquote>
<dl class="method">
<dt id="cubicweb.server.session.Connection.set_cnxset">
<tt class="descname">set_cnxset</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Connection.set_cnxset" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="method">
<dt id="cubicweb.server.session.Connection.free_cnxset">
<tt class="descname">free_cnxset</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="headerlink" href="#cubicweb.server.session.Connection.free_cnxset" title="Permalink to this definition">¶</a></dt>
<dd><p><tt class="xref py py-attr docutils literal"><span class="pre">mode</span></tt>, string telling the connections set handling mode, may be one
of &#8216;read&#8217; (connections set may be freed), &#8216;write&#8217; (some write was done in
the connections set, it can&#8217;t be freed before end of the transaction),
&#8216;transaction&#8217; (we want to keep the connections set during all the
transaction, with or without writing)</p>
</dd></dl>

<p>Internal transaction data:</p>
<blockquote>
<div><p><tt class="xref py py-attr docutils literal"><span class="pre">data</span></tt> is a dictionary containing some shared data
cleared at the end of the transaction. Hooks and operations may put
arbitrary data in there, and this may also be used as a communication
channel between the client and the repository.</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">pending_operations</span></tt>, ordered list of operations to be processed on
commit/rollback</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">commit_state</span></tt>, describing the transaction commit state, may be one
of None (not yet committing), &#8216;precommit&#8217; (calling precommit event on
operations), &#8216;postcommit&#8217; (calling postcommit event on operations),
&#8216;uncommitable&#8217; (some <tt class="xref py py-exc docutils literal"><span class="pre">ValidationError</span></tt> or <tt class="xref py py-exc docutils literal"><span class="pre">Unauthorized</span></tt> error
has been raised during the transaction and so it must be rolled back).</p>
</div></blockquote>
<p>Hooks controls:</p>
<blockquote>
<div><p><tt class="xref py py-attr docutils literal"><span class="pre">hooks_mode</span></tt>, may be either <cite>HOOKS_ALLOW_ALL</cite> or <cite>HOOKS_DENY_ALL</cite>.</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">enabled_hook_cats</span></tt>, when <tt class="xref py py-attr docutils literal"><span class="pre">hooks_mode</span></tt> is
<cite>HOOKS_DENY_ALL</cite>, this set contains hooks categories that are enabled.</p>
<p><tt class="xref py py-attr docutils literal"><span class="pre">disabled_hook_cats</span></tt>, when <tt class="xref py py-attr docutils literal"><span class="pre">hooks_mode</span></tt> is
<cite>HOOKS_ALLOW_ALL</cite>, this set contains hooks categories that are disabled.</p>
</div></blockquote>
<p>Security level Management:</p>
<blockquote>
<div><tt class="xref py py-attr docutils literal"><span class="pre">read_security</span></tt> and <tt class="xref py py-attr docutils literal"><span class="pre">write_security</span></tt>, boolean flags telling if
read/write security is currently activated.</div></blockquote>
</dd></dl>

</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="hooks.html" title="6.3. Hooks and Operations"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="6. Repository customization"
             >previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" >6. Repository customization</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>