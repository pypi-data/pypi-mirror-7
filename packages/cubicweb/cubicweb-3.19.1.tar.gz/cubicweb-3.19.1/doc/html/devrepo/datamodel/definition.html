
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3.1. Yams schema &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../../index.html" />
    <link rel="up" title="3. Data model" href="index.html" />
    <link rel="next" title="3.3. Metadata" href="metadata.html" />
    <link rel="prev" title="3. Data model" href="index.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="metadata.html" title="3.3. Metadata"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="3. Data model"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">3. Data model</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3.1. Yams <em>schema</em></a><ul>
<li><a class="reference internal" href="#overview">3.1.1. Overview</a></li>
<li><a class="reference internal" href="#entity-type">3.1.2. Entity type</a></li>
<li><a class="reference internal" href="#relation-type">3.1.3. Relation type</a></li>
<li><a class="reference internal" href="#relation-definition">3.1.4. Relation definition</a><ul>
<li><a class="reference internal" href="#properties">3.1.4.1. Properties</a></li>
<li><a class="reference internal" href="#constraints">3.1.4.2. Constraints</a><ul>
<li><a class="reference internal" href="#general-constraints">3.1.4.2.1. General Constraints</a></li>
<li><a class="reference internal" href="#rql-based-constraints">3.1.4.2.2. RQL Based Constraints</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#the-security-model">3.1.5. The security model</a><ul>
<li><a class="reference internal" href="#default-permissions">3.1.5.1. Default permissions</a></li>
<li><a class="reference internal" href="#the-standard-user-groups">3.1.5.2. The standard user groups</a></li>
<li><a class="reference internal" href="#use-of-rql-expression-for-write-permissions">3.1.5.3. Use of RQL expression for write permissions</a></li>
<li><a class="reference internal" href="#use-of-rql-expression-for-reading-rights">3.1.5.4. Use of RQL expression for reading rights</a></li>
<li><a class="reference internal" href="#important-notes-about-write-permissions-checking">3.1.5.5. Important notes about write permissions checking</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#defining-your-schema-using-yams">3.2. Defining your schema using yams</a><ul>
<li><a class="reference internal" href="#entity-type-definition">3.2.1. Entity type definition</a></li>
<li><a class="reference internal" href="#definition-of-relations">3.2.2. Definition of relations</a></li>
<li><a class="reference internal" href="#handling-schema-changes">3.2.3. Handling schema changes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">3. Data model</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="metadata.html"
                        title="next chapter">3.3. Metadata</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/devrepo/datamodel/definition.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <blockquote>
<div></div></blockquote>
<div class="section" id="yams-schema">
<span id="datamodel-definition"></span><h1>3.1. Yams <em>schema</em><a class="headerlink" href="#yams-schema" title="Permalink to this headline">¶</a></h1>
<p>The <strong>schema</strong> is the core piece of a <em>CubicWeb</em> instance as it
defines and handles the data model. It is based on entity types that
are either already defined in <a class="reference external" href="http://www.logilab.org/project/yams">Yams</a> and the <em>CubicWeb</em> standard
library; or more specific types defined in cubes. The schema for a
cube is defined in a <cite>schema</cite> python module or package.</p>
<div class="section" id="overview">
<span id="datamodel-overview"></span><h2>3.1.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The core idea of the yams schema is not far from the classical
<a class="reference external" href="http://en.wikipedia.org/wiki/Entity-relationship_model">Entity-relationship</a> model. But while an E/R model (or <cite>logical
model</cite>) traditionally has to be manually translated to a lower-level
data description language (such as the SQL <cite>create table</cite>
sublanguage), also often described as the <cite>physical model</cite>, no such
step is required with <em>Yams</em> and <em>CubicWeb</em>.</p>
<p>This is because in addition to high-level, logical <em>Yams</em> models, one
uses the <em>RQL</em> data manipulation language to query, insert, update and
delete data. <em>RQL</em> abstracts as much of the underlying SQL database as
a <em>Yams</em> schema abstracts from the physical layout. The vagaries of
SQL are avoided.</p>
<p>As a bonus point, such abstraction make it quite comfortable to build
or use different backends to which <em>RQL</em> queries apply.</p>
<p>So, as in the E/R formalism, the building blocks are <tt class="docutils literal"><span class="pre">entities</span></tt>
(<a class="reference internal" href="#entitytype"><em>Entity type</em></a>), <tt class="docutils literal"><span class="pre">relationships</span></tt> (<a class="reference internal" href="#relationtype"><em>Relation type</em></a>,
<a class="reference internal" href="#relationdefinition"><em>Relation definition</em></a>) and <tt class="docutils literal"><span class="pre">attributes</span></tt> (handled like relation
with <em>Yams</em>).</p>
<p>Let us detail a little the divergences between E/R and <em>Yams</em>:</p>
<ul class="simple">
<li>all relationship are binary which means that to represent a
non-binary relationship, one has to use an entity,</li>
<li>relationships do not support attributes (yet, see:
<a class="reference external" href="http://www.cubicweb.org/ticket/341318">http://www.cubicweb.org/ticket/341318</a>), hence the need to reify it
as an entity if need arises,</li>
<li>all entities have an <cite>eid</cite> attribute (an integer) that is its
primary key (but it is possible to declare uniqueness on other
attributes)</li>
</ul>
<p>Also <em>Yams</em> supports the notions of:</p>
<ul class="simple">
<li>entity inheritance (quite experimental yet, and completely
undocumented),</li>
<li>relation type: that is, relationships can be established over a set
of couple of entity types (henre the distinction made between
<cite>RelationType</cite> and <cite>RelationDefinition</cite> below)</li>
</ul>
<p>Finally <em>Yams</em> has a few concepts of its own:</p>
<ul class="simple">
<li>relationships being oriented and binary, we call the left hand
entity type the <cite>subject</cite> and the right hand entity type the
<cite>object</cite></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <em>Yams</em> schema is available at run time through the .schema
attribute of the <cite>vregistry</cite>.  It&#8217;s an instance of
<tt class="xref py py-class docutils literal"><span class="pre">cubicweb.schema.Schema</span></tt>, which extends
<tt class="xref py py-class docutils literal"><span class="pre">yams.schema.Schema</span></tt>.</p>
</div>
</div>
<div class="section" id="entity-type">
<span id="entitytype"></span><h2>3.1.2. Entity type<a class="headerlink" href="#entity-type" title="Permalink to this headline">¶</a></h2>
<p>An entity type is an instance of <tt class="xref py py-class docutils literal"><span class="pre">yams.schema.EntitySchema</span></tt>. Each entity type has
a set of attributes and relations, and some permissions which define who can add, read,
update or delete entities of this type.</p>
<p>The following built-in types are available: <tt class="docutils literal"><span class="pre">String</span></tt>,
<tt class="docutils literal"><span class="pre">Int</span></tt>, <tt class="docutils literal"><span class="pre">Float</span></tt>, <tt class="docutils literal"><span class="pre">Decimal</span></tt>, <tt class="docutils literal"><span class="pre">Boolean</span></tt>,
<tt class="docutils literal"><span class="pre">Date</span></tt>, <tt class="docutils literal"><span class="pre">Datetime</span></tt>, <tt class="docutils literal"><span class="pre">Time</span></tt>, <tt class="docutils literal"><span class="pre">Interval</span></tt>, <tt class="docutils literal"><span class="pre">Byte</span></tt> and
<tt class="docutils literal"><span class="pre">Password</span></tt>. They can only be used as attributes of an other entity
type.</p>
<p>There is also a <cite>RichString</cite> kindof type:</p>
<blockquote>
<div><dl class="class">
<dt id="yams.buildobjs.RichString">
<em class="property">class </em><tt class="descclassname">yams.buildobjs.</tt><tt class="descname">RichString</tt><a class="headerlink" href="#yams.buildobjs.RichString" title="Permalink to this definition">¶</a></dt>
<dd><p>RichString is a convenience attribute type for attribute containing text
in a format that should be specified in another attribute.</p>
<p>The following declaration:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Card</span><span class="p">(</span><span class="n">EntityType</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">RichString</span><span class="p">(</span><span class="n">fulltextindexed</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">default_format</span><span class="o">=</span><span class="s">&#39;text/rest&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Card</span><span class="p">(</span><span class="n">EntityType</span><span class="p">):</span>
    <span class="n">content_format</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">internationalizable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                            <span class="n">default</span><span class="o">=</span><span class="s">&#39;text/rest&#39;</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">FORMAT_CONSTRAINT</span><span class="p">])</span>
    <span class="n">content</span>  <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">fulltextindexed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div></blockquote>
<p>You can find more base entity types in
<a class="reference internal" href="baseschema.html#pre-defined-entity-types"><em>Pre-defined entities in the library</em></a>.</p>
</div>
<div class="section" id="relation-type">
<span id="relationtype"></span><h2>3.1.3. Relation type<a class="headerlink" href="#relation-type" title="Permalink to this headline">¶</a></h2>
<p>A relation type is an instance of
<tt class="xref py py-class docutils literal"><span class="pre">yams.schema.RelationSchema</span></tt>. A relation type is simply a
semantic definition of a kind of relationship that may occur in an
application.</p>
<p>It may be referenced by zero, one or more relation definitions.</p>
<p>It is important to choose a good name, at least to avoid conflicts
with some semantically different relation defined in other cubes
(since there&#8217;s only a shared name space for these names).</p>
<p>A relation type holds the following properties (which are hence shared
between all relation definitions of that type):</p>
<ul class="simple">
<li><cite>inlined</cite>: boolean handling the physical optimization for archiving
the relation in the subject entity table, instead of creating a specific
table for the relation. This applies to relations where cardinality
of subject-&gt;relation-&gt;object is 0..1 (<cite>?</cite>) or 1..1 (<cite>1</cite>) for <em>all</em> its relation
definitions.</li>
<li><cite>symmetric</cite>: boolean indicating that the relation is symmetrical, which
means that <cite>X relation Y</cite> implies <cite>Y relation X</cite>.</li>
</ul>
</div>
<div class="section" id="relation-definition">
<span id="relationdefinition"></span><h2>3.1.4. Relation definition<a class="headerlink" href="#relation-definition" title="Permalink to this headline">¶</a></h2>
<p>A relation definition is an instance of
<tt class="xref py py-class docutils literal"><span class="pre">yams.schema.RelationDefinition</span></tt>. It is a complete triplet
&#8220;&lt;subject entity type&gt; &lt;relation type&gt; &lt;object entity type&gt;&#8221;.</p>
<p>When creating a new instance of that class, the corresponding
<tt class="xref py py-class docutils literal"><span class="pre">RelationType</span></tt> instance is created on the fly if necessary.</p>
<div class="section" id="properties">
<h3>3.1.4.1. Properties<a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h3>
<p>The available properties for relation definitions are enumerated
here. There are several kind of properties, as some relation
definitions are actually attribute definitions, and other are not.</p>
<p>Some properties may be completely optional, other may have a default
value.</p>
<p>Common properties for attributes and relations:</p>
<ul>
<li><p class="first"><cite>description</cite>: an unicode string describing an attribute or a
relation. By default this string will be used in the editing form of
the entity, which means that it is supposed to help the end-user and
should be flagged by the function <cite>_</cite> to be properly
internationalized.</p>
</li>
<li><p class="first"><cite>constraints</cite>: a list of conditions/constraints that the relation has to
satisfy (c.f. <a class="reference internal" href="#constraints">Constraints</a>)</p>
</li>
<li><p class="first"><cite>cardinality</cite>: a two character string specifying the cardinality of
the relation. The first character defines the cardinality of the
relation on the subject, and the second on the object. When a
relation can have multiple subjects or objects, the cardinality
applies to all, not on a one-to-one basis (so it must be
consistent...). Default value is &#8216;**&#8217;. The possible values are
inspired from regular expression syntax:</p>
<blockquote>
<div><ul class="simple">
<li><cite>1</cite>: 1..1</li>
<li><cite>?</cite>: 0..1</li>
<li><cite>+</cite>: 1..n</li>
<li><cite>*</cite>: 0..n</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>Attributes properties:</p>
<ul class="simple">
<li><cite>unique</cite>: boolean indicating if the value of the attribute has to be
unique or not within all entities of the same type (false by
default)</li>
<li><cite>indexed</cite>: boolean indicating if an index needs to be created for
this attribute in the database (false by default). This is useful
only if you know that you will have to run numerous searches on the
value of this attribute.</li>
<li><cite>default</cite>: default value of the attribute. In case of date types, the values
which could be used correspond to the RQL keywords <cite>TODAY</cite> and <cite>NOW</cite>.</li>
<li><cite>metadata</cite>: Is also accepted as an argument of the attribute contructor. It is
not really an attribute property. see <a class="reference internal" href="#metadata">Metadata</a> for details.</li>
</ul>
<p>Properties for <cite>String</cite> attributes:</p>
<ul class="simple">
<li><cite>fulltextindexed</cite>: boolean indicating if the attribute is part of
the full text index (false by default) (<em>applicable on the type
`Byte` as well</em>)</li>
<li><cite>internationalizable</cite>: boolean indicating if the value of the
attribute is internationalizable (false by default)</li>
</ul>
<p>Relation properties:</p>
<ul class="simple">
<li><cite>composite</cite>: string indicating that the subject (composite ==
&#8216;subject&#8217;) is composed of the objects of the relations. For the
opposite case (when the object is composed of the subjects of the
relation), we just set &#8216;object&#8217; as value. The composition implies
that when the relation is deleted (so when the composite is deleted,
at least), the composed are also deleted.</li>
<li><cite>fulltext_container</cite>: string indicating if the value if the full
text indexation of the entity on one end of the relation should be
used to find the entity on the other end. The possible values are
&#8216;subject&#8217; or &#8216;object&#8217;. For instance the use_email relation has that
property set to &#8216;subject&#8217;, since when performing a full text search
people want to find the entity using an email address, and not the
entity representing the email address.</li>
</ul>
</div>
<div class="section" id="constraints">
<h3>3.1.4.2. Constraints<a class="headerlink" href="#constraints" title="Permalink to this headline">¶</a></h3>
<p>By default, the available constraint types are:</p>
<div class="section" id="general-constraints">
<h4>3.1.4.2.1. General Constraints<a class="headerlink" href="#general-constraints" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><cite>SizeConstraint</cite>: allows to specify a minimum and/or maximum size on
string (generic case of <cite>maxsize</cite>)</li>
<li><cite>BoundaryConstraint</cite>: allows to specify a minimum and/or maximum value
on numeric types and date</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">yams.constraints</span> <span class="kn">import</span> <span class="n">BoundaryConstraint</span><span class="p">,</span> <span class="n">TODAY</span>
<span class="n">BoundaryConstraint</span><span class="p">(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">TODAY</span><span class="p">())</span>
</pre></div>
</div>
<ul class="simple">
<li><cite>IntervalBoundConstraint</cite>: allows to specify an interval with
included values</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">EntityType</span><span class="p">):</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">Float</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">IntervalBoundConstraint</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">+</span><span class="mi">90</span><span class="p">)])</span>
</pre></div>
</div>
<ul class="simple">
<li><cite>UniqueConstraint</cite>: identical to &#8220;unique=True&#8221;</li>
<li><cite>StaticVocabularyConstraint</cite>: identical to &#8220;vocabulary=(...)&#8221;</li>
</ul>
</div>
<div class="section" id="rql-based-constraints">
<h4>3.1.4.2.2. RQL Based Constraints<a class="headerlink" href="#rql-based-constraints" title="Permalink to this headline">¶</a></h4>
<p>RQL based constraints may take three arguments. The first one is the <tt class="docutils literal"><span class="pre">WHERE</span></tt>
clause of a RQL query used by the constraint. The second argument <tt class="docutils literal"><span class="pre">mainvars</span></tt>
is the <tt class="docutils literal"><span class="pre">Any</span></tt> clause of the query. By default this include <cite>S</cite> reserved for the
subject of the relation and <cite>O</cite> for the object. Additional variables could be
specified using <tt class="docutils literal"><span class="pre">mainvars</span></tt>. The argument expects a single string with all
variable&#8217;s name separated by spaces. The last one, <tt class="docutils literal"><span class="pre">msg</span></tt>, is the error message
displayed when the constraint fails. As RQLVocabularyConstraint never fails the
third argument is not available.</p>
<ul class="simple">
<li><cite>RQLConstraint</cite>: allows to specify a RQL query that has to be satisfied
by the subject and/or the object of relation. In this query the variables
<cite>S</cite> and <cite>O</cite> are reserved for the relation subject and object entities.</li>
<li><cite>RQLVocabularyConstraint</cite>: similar to the previous type of constraint except
that it does not express a &#8220;strong&#8221; constraint, which means it is only used to
restrict the values listed in the drop-down menu of editing form, but it does
not prevent another entity to be selected.</li>
<li><cite>RQLUniqueConstraint</cite>: allows to the specify a RQL query that ensure that an
attribute is unique in a specific context. The Query must <strong>never</strong> return more
than a single result to be satisfied. In this query the variables <cite>S</cite> is
reserved for the relation subject entity. The other variables should be
specified with the second constructor argument (mainvars). This constraints
should be used when UniqueConstraint doesn&#8217;t fit. Here is a simple example.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Check that in the same Workflow each state&#39;s name is unique.  Using</span>
<span class="c"># UniqueConstraint (or unique=True) here would prevent states in different</span>
<span class="c"># workflows to have the same name.</span>

<span class="c"># With: State S, Workflow W, String N ; S state_of W, S name N</span>

<span class="n">RQLUniqueConstraint</span><span class="p">(</span><span class="s">&#39;S name N, S state_of WF, Y state_of WF, Y name N&#39;</span><span class="p">,</span>
                    <span class="n">mainvars</span><span class="o">=</span><span class="s">&#39;Y&#39;</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;workflow already has a state of that name&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-security-model">
<span id="securitymodel"></span><h2>3.1.5. The security model<a class="headerlink" href="#the-security-model" title="Permalink to this headline">¶</a></h2>
<p>The security model of <cite>CubicWeb</cite> is based on <cite>Access Control List</cite>.
The main principles are:</p>
<ul class="simple">
<li>users and groups of users</li>
<li>a user belongs to at least one group of user</li>
<li>permissions (read, update, create, delete)</li>
<li>permissions are assigned to groups (and not to users)</li>
</ul>
<p>For <em>CubicWeb</em> in particular:</p>
<ul class="simple">
<li>we associate rights at the entities/relations schema level</li>
<li>the default groups are: <cite>managers</cite>, <cite>users</cite> and <cite>guests</cite></li>
<li>users belong to the <cite>users</cite> group</li>
<li>there is a virtual group called <cite>owners</cite> to which we can associate only
<cite>delete</cite> and <cite>update</cite> permissions<ul>
<li>we can not add users to the <cite>owners</cite> group, they are implicitly added to it
according to the context of the objects they own</li>
<li>the permissions of this group are only checked on <cite>update</cite>/<cite>delete</cite> actions
if all the other groups the user belongs to do not provide those permissions</li>
</ul>
</li>
</ul>
<p>Setting permissions is done with the attribute <cite>__permissions__</cite> of entities and
relation definition. The value of this attribute is a dictionary where the keys
are the access types (action), and the values are the authorized groups or
expressions.</p>
<p>For an entity type, the possible actions are <cite>read</cite>, <cite>add</cite>, <cite>update</cite> and
<cite>delete</cite>.</p>
<p>For a relation, the possible actions are <cite>read</cite>, <cite>add</cite>, and <cite>delete</cite>.</p>
<p>For an attribute, the possible actions are <cite>read</cite>, <cite>add</cite> and <cite>update</cite>,
and they are a refinement of an entity type permission.</p>
<p>For each access type, a tuple indicates the name of the authorized groups and/or
one or multiple RQL expressions to satisfy to grant access. The access is
provided if the user is in one of the listed groups or if one of the RQL condition
is satisfied.</p>
<div class="section" id="default-permissions">
<h3>3.1.5.1. Default permissions<a class="headerlink" href="#default-permissions" title="Permalink to this headline">¶</a></h3>
<p>The default permissions for <tt class="docutils literal"><span class="pre">EntityType</span></tt> are:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">__permissions__</span> <span class="o">=</span> <span class="p">{</span>
     <span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="s">&#39;guests&#39;</span><span class="p">,),</span>
     <span class="s">&#39;update&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;owners&#39;</span><span class="p">,),</span>
     <span class="s">&#39;delete&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;owners&#39;</span><span class="p">),</span>
     <span class="s">&#39;add&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">,)</span>
     <span class="p">}</span>
</pre></div>
</div>
<p>The default permissions for relations are:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">__permissions__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="s">&#39;guests&#39;</span><span class="p">,),</span>
                 <span class="s">&#39;delete&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">),</span>
                 <span class="s">&#39;add&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">,)}</span>
</pre></div>
</div>
<p>The default permissions for attributes are:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">__permissions__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="s">&#39;guests&#39;</span><span class="p">,),</span>
                   <span class="s">&#39;add&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="n">ERQLExpression</span><span class="p">(</span><span class="s">&#39;U has_add_permission X&#39;</span><span class="p">),</span>
                   <span class="s">&#39;update&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="n">ERQLExpression</span><span class="p">(</span><span class="s">&#39;U has_update_permission X&#39;</span><span class="p">)),}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-standard-user-groups">
<h3>3.1.5.2. The standard user groups<a class="headerlink" href="#the-standard-user-groups" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><cite>guests</cite></li>
<li><cite>users</cite></li>
<li><cite>managers</cite></li>
<li><cite>owners</cite>: virtual group corresponding to the entity&#8217;s owner.
This can only be used for the actions <cite>update</cite> and <cite>delete</cite> of an entity
type.</li>
</ul>
<p>It is also possible to use specific groups if they are defined in the precreate
script of the cube (<tt class="docutils literal"><span class="pre">migration/precreate.py</span></tt>). Defining groups in postcreate
script or later makes them unavailable for security purposes (in this case, an
<cite>sync_schema_props_perms</cite> command has to be issued in a CubicWeb shell).</p>
</div>
<div class="section" id="use-of-rql-expression-for-write-permissions">
<h3>3.1.5.3. Use of RQL expression for write permissions<a class="headerlink" href="#use-of-rql-expression-for-write-permissions" title="Permalink to this headline">¶</a></h3>
<p>It is possible to define RQL expression to provide update permission (<cite>add</cite>,
<cite>delete</cite> and <cite>update</cite>) on entity type / relation definitions. An rql expression
is a piece of query (corresponds to the WHERE statement of an RQL query), and the
expression will be considered as satisfied if it returns some results. They can
not be used in <cite>read</cite> permission.</p>
<p>To use RQL expression in entity type permission:</p>
<ul class="simple">
<li>you have to use the class <tt class="xref py py-class docutils literal"><span class="pre">ERQLExpression</span></tt></li>
<li>in this expression, the variables <cite>X</cite> and <cite>U</cite> are pre-defined references
respectively on the current entity (on which the action is verified) and on the
user who send the request</li>
</ul>
<p>For RQL expressions on a relation type, the principles are the same except for
the following:</p>
<ul class="simple">
<li>you have to use the class <tt class="xref py py-class docutils literal"><span class="pre">RRQLExpression</span></tt> instead of
<tt class="xref py py-class docutils literal"><span class="pre">ERQLExpression</span></tt></li>
<li>in the expression, the variables <cite>S</cite>, <cite>O</cite> and <cite>U</cite> are pre-defined references to
respectively the subject and the object of the current relation (on which the
action is being verified) and the user who executed the query</li>
</ul>
<p>To define security for attributes of an entity (non-final relation), you have to
use the class <tt class="xref py py-class docutils literal"><span class="pre">ERQLExpression</span></tt> in which <cite>X</cite> represents
the entity the attribute belongs to.</p>
<p>It is possible to use in those expression a special relation
<cite>has_&lt;ACTION&gt;_permission</cite> where the subject is the user (eg &#8216;U&#8217;) and the object
is any variable representing an entity (usually &#8216;X&#8217; in
<tt class="xref py py-class docutils literal"><span class="pre">ERQLExpression</span></tt>, &#8216;S&#8217; or &#8216;O&#8217; in
<tt class="xref py py-class docutils literal"><span class="pre">RRQLExpression</span></tt>), meaning that the user needs to have
permission to execute the action &lt;ACTION&gt; on the entities represented by this
variable. It&#8217;s recommanded to use this feature whenever possible since it
simplify greatly complex security definition and upgrade.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">my_relation</span><span class="p">(</span><span class="n">RelationDefinition</span><span class="p">):</span>
  <span class="n">__permissions__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">),</span>
                     <span class="s">&#39;add&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="n">RRQLExpression</span><span class="p">(</span><span class="s">&#39;U has_update_permission S&#39;</span><span class="p">)),</span>
                     <span class="s">&#39;delete&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s">&#39;managers&#39;</span><span class="p">,</span> <span class="n">RRQLExpression</span><span class="p">(</span><span class="s">&#39;U has_update_permission S&#39;</span><span class="p">))</span>
                     <span class="p">}</span>
</pre></div>
</div>
<p>In the above example, user will be allowed to add/delete <cite>my_relation</cite> if he has
the <cite>update</cite> permission on the subject of the relation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Potentially, the <cite>use of an RQL expression to add an entity or a relation</cite> can
cause problems for the user interface, because if the expression uses the
entity or the relation to create, we are not able to verify the permissions
before we actually added the entity (please note that this is not a problem for
the RQL server at all, because the permissions checks are done after the
creation). In such case, the permission check methods
(CubicWebEntitySchema.check_perm and has_perm) can indicate that the user is
not allowed to create this entity while it would obtain the permission.  To
compensate this problem, it is usually necessary in such case to use an action
that reflects the schema permissions but which check properly the permissions
so that it would show up only if possible.</p>
</div>
</div>
<div class="section" id="use-of-rql-expression-for-reading-rights">
<h3>3.1.5.4. Use of RQL expression for reading rights<a class="headerlink" href="#use-of-rql-expression-for-reading-rights" title="Permalink to this headline">¶</a></h3>
<p>The principles are the same but with the following restrictions:</p>
<ul class="simple">
<li>you can not use rql expression for the <cite>read</cite> permission of relations and
attributes,</li>
<li>you can not use special <cite>has_&lt;ACTION&gt;_permission</cite> relation in the rql
expression.</li>
</ul>
</div>
<div class="section" id="important-notes-about-write-permissions-checking">
<h3>3.1.5.5. Important notes about write permissions checking<a class="headerlink" href="#important-notes-about-write-permissions-checking" title="Permalink to this headline">¶</a></h3>
<p>Write permissions (e.g. &#8216;add&#8217;, &#8216;update&#8217;, &#8216;delete&#8217;) are checked in core hooks.</p>
<p>When a permission is checked slightly vary according to if it&#8217;s an entity or
relation, and if the relation is an attribute relation or not). It&#8217;s important to
understand that since according to when a permission is checked, values returned
by rql expressions may changes, hence the permission being granted or not.</p>
<p>Here are the current rules:</p>
<ol class="arabic simple">
<li>permission to add/update entity and its attributes are checked on
commit</li>
<li>permission to delete an entity is checked in &#8216;before_delete_entity&#8217; hook</li>
<li>permission to add a relation is checked either:<ul>
<li>in &#8216;before_add_relation&#8217; hook if the relation type is in the
<cite>BEFORE_ADD_RELATIONS</cite> set</li>
<li>else at commit time if the relation type is in the <cite>ON_COMMIT_ADD_RELATIONS</cite>
set</li>
<li>else in &#8216;after_add_relation&#8217; hook (the default)</li>
</ul>
</li>
<li>permission to delete a relation is checked in &#8216;before_delete_relation&#8217; hook</li>
</ol>
<p>Last but not least, remember queries issued from hooks and operation are by
default &#8216;unsafe&#8217;, eg there are no read or write security checks.</p>
<p>See <tt class="xref py py-mod docutils literal"><span class="pre">cubicweb.hooks.security</span></tt> for more details.</p>
</div>
</div>
</div>
<div class="section" id="defining-your-schema-using-yams">
<span id="yams-example"></span><h1>3.2. Defining your schema using yams<a class="headerlink" href="#defining-your-schema-using-yams" title="Permalink to this headline">¶</a></h1>
<div class="section" id="entity-type-definition">
<h2>3.2.1. Entity type definition<a class="headerlink" href="#entity-type-definition" title="Permalink to this headline">¶</a></h2>
<p>An entity type is defined by a Python class which inherits from
<tt class="xref py py-class docutils literal"><span class="pre">yams.buildobjs.EntityType</span></tt>.  The class definition contains the
description of attributes and relations for the defined entity type.
The class name corresponds to the entity type name. It is expected to
be defined in the module <tt class="docutils literal"><span class="pre">mycube.schema</span></tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Note on schema definition:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">The code in <tt class="docutils literal"><span class="pre">mycube.schema</span></tt> is not meant to be executed. The class
EntityType mentioned above is different from the EntitySchema class
described in the previous chapter. EntityType is a helper class to
make Entity definition easier. Yams will process EntityType classes
and create EntitySchema instances from these class definitions. Similar
manipulation happen for relations.</td>
</tr>
</tbody>
</table>
<p>When defining a schema using python files, you may use the following shortcuts:</p>
<ul class="simple">
<li><cite>required</cite>: boolean indicating if the attribute is required, ed subject cardinality is &#8216;1&#8217;</li>
<li><cite>vocabulary</cite>: specify static possible values of an attribute</li>
<li><cite>maxsize</cite>: integer providing the maximum size of a string (no limit by default)</li>
</ul>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">EntityType</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A person with the properties and the relations necessary for my</span>
<span class="sd">  application&quot;&quot;&quot;</span>

  <span class="n">last_name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fulltextindexed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">first_name</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">fulltextindexed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Mr&#39;</span><span class="p">,</span> <span class="s">&#39;Mrs&#39;</span><span class="p">,</span> <span class="s">&#39;Miss&#39;</span><span class="p">))</span>
  <span class="n">date_of_birth</span> <span class="o">=</span> <span class="n">Date</span><span class="p">()</span>
  <span class="n">works_for</span> <span class="o">=</span> <span class="n">SubjectRelation</span><span class="p">(</span><span class="s">&#39;Company&#39;</span><span class="p">,</span> <span class="n">cardinality</span><span class="o">=</span><span class="s">&#39;?*&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The entity described above defines three attributes of type String,
last_name, first_name and title, an attribute of type Date for the date of
birth and a relation that connects a <cite>Person</cite> to another entity of type
<cite>Company</cite> through the semantic <cite>works_for</cite>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Naming convention:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><p class="first">Entity class names must start with an uppercase letter. The common
usage is to use <tt class="docutils literal"><span class="pre">CamelCase</span></tt> names.</p>
<p>Attribute and relation names must start with a lowercase letter. The
common usage is to use <tt class="docutils literal"><span class="pre">underscore_separated_words</span></tt>. Attribute and
relation names starting with a single underscore are permitted, to
denote a somewhat &#8220;protected&#8221; or &#8220;private&#8221; attribute.</p>
<p>In any case, identifiers starting with &#8220;CW&#8221; or &#8220;cw&#8221; are reserved for
internal use by the framework.</p>
<p class="last" id="metadata">Some attribute using the name of another attribute as prefix are considered
metadata.  For example, if an EntityType have both a <tt class="docutils literal"><span class="pre">data</span></tt> and
<tt class="docutils literal"><span class="pre">data_format</span></tt> attribute, <tt class="docutils literal"><span class="pre">data_format</span></tt> is view as the <tt class="docutils literal"><span class="pre">format</span></tt> metadata
of <tt class="docutils literal"><span class="pre">data</span></tt>. Later the <tt class="xref py py-meth docutils literal"><span class="pre">cw_attr_metadata()</span></tt> method will allow you to fetch
metadata related to an attribute. There are only three valid metadata names:
<tt class="docutils literal"><span class="pre">format</span></tt>, <tt class="docutils literal"><span class="pre">encoding</span></tt> and <tt class="docutils literal"><span class="pre">name</span></tt>.</p>
</td>
</tr>
</tbody>
</table>
<p>The name of the Python attribute corresponds to the name of the attribute
or the relation in <em>CubicWeb</em> application.</p>
<p>An attribute is defined in the schema as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">attr_name</span> <span class="o">=</span> <span class="n">AttrType</span><span class="p">(</span><span class="o">*</span><span class="n">properties</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
<p>where</p>
<ul class="simple">
<li><cite>AttrType</cite>: is one of the type listed in <a class="reference internal" href="#entitytype">EntityType</a>,</li>
<li><cite>properties</cite>: is a list of the attribute needs to satisfy (see <a class="reference internal" href="#properties">Properties</a>
for more details),</li>
<li><cite>metadata</cite>: is a dictionary of meta attributes related to <tt class="docutils literal"><span class="pre">attr_name</span></tt>.
Dictionary keys are the name of the meta attribute. Dictionary values
attributes objects (like the content of <tt class="docutils literal"><span class="pre">AttrType</span></tt>). For each entry of the
metadata dictionary a <tt class="docutils literal"><span class="pre">&lt;attr_name&gt;_&lt;key&gt;</span> <span class="pre">=</span> <span class="pre">&lt;value&gt;</span></tt> attribute is
automaticaly added to the EntityType.  see <a class="reference internal" href="#metadata">Metadata</a> section for details
about valid key.</li>
</ul>
<blockquote>
<div>&#8212;</div></blockquote>
<p>While building your schema</p>
<ul class="simple">
<li>it is possible to use the attribute <cite>meta</cite> to flag an entity type as a <cite>meta</cite>
(e.g. used to describe/categorize other entities)</li>
</ul>
<p><em>Note</em>: if you end up with an <cite>if</cite> in the definition of your entity, this probably
means that you need two separate entities that implement the <cite>ITree</cite> interface and
get the result from <cite>.children()</cite> which ever entity is concerned.</p>
</div>
<div class="section" id="definition-of-relations">
<h2>3.2.2. Definition of relations<a class="headerlink" href="#definition-of-relations" title="Permalink to this headline">¶</a></h2>
<p>A relation is defined by a Python class heriting <cite>RelationType</cite>. The name
of the class corresponds to the name of the type. The class then contains
a description of the properties of this type of relation, and could as well
contain a string for the subject and a string for the object. This allows to create
new definition of associated relations, (so that the class can have the
definition properties from the relation) for example</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">locked_by</span><span class="p">(</span><span class="n">RelationType</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;relation on all entities indicating that they are locked&quot;&quot;&quot;</span>
  <span class="n">inlined</span> <span class="o">=</span> <span class="bp">True</span>
  <span class="n">cardinality</span> <span class="o">=</span> <span class="s">&#39;?*&#39;</span>
  <span class="n">subject</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span>
  <span class="nb">object</span> <span class="o">=</span> <span class="s">&#39;CWUser&#39;</span>
</pre></div>
</div>
<p>If provided, the <cite>subject</cite> and <cite>object</cite> attributes denote the subject
and object of the various relation definitions related to the relation
type. Allowed values for these attributes are:</p>
<ul class="simple">
<li>a string corresponding to an entity type</li>
<li>a tuple of string corresponding to multiple entity types</li>
<li>the &#8216;*&#8217; special string, meaning all types of entities</li>
</ul>
<p>When a relation is not inlined and not symmetrical, and it does not require
specific permissions, it can be defined using a <cite>SubjectRelation</cite>
attribute in the EntityType class. The first argument of <cite>SubjectRelation</cite> gives
the entity type for the object of the relation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Naming convention:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">Although this way of defining relations uses a Python class, the
naming convention defined earlier prevails over the PEP8 conventions
used in the framework: relation type class names use
<tt class="docutils literal"><span class="pre">underscore_separated_words</span></tt>.</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Historical note:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body">It has been historically possible to use <cite>ObjectRelation</cite> which
defines a relation in the opposite direction. This feature is
deprecated and therefore should not be used in newly written code.</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Future deprecation note:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body">In an even more remote future, it is quite possible that the
SubjectRelation shortcut will become deprecated, in favor of the
RelationType declaration which offers some advantages in the context
of reusable cubes.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="handling-schema-changes">
<h2>3.2.3. Handling schema changes<a class="headerlink" href="#handling-schema-changes" title="Permalink to this headline">¶</a></h2>
<p>Also, it should be clear that to properly handle data migration, an
instance&#8217;s schema is stored in the database, so the python schema file
used to defined it is only read when the instance is created or
upgraded.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="metadata.html" title="3.3. Metadata"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="3. Data model"
             >previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" >3. Data model</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>