
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3.5. Defining a Workflow &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../../index.html" />
    <link rel="up" title="3. Data model" href="index.html" />
    <link rel="next" title="4. Data as objects" href="../entityclasses/index.html" />
    <link rel="prev" title="3.4. Pre-defined entities in the library" href="baseschema.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../entityclasses/index.html" title="4. Data as objects"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="baseschema.html" title="3.4. Pre-defined entities in the library"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">3. Data model</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3.5. Defining a Workflow</a><ul>
<li><a class="reference internal" href="#general">3.5.1. General</a></li>
<li><a class="reference internal" href="#setting-up-a-workflow">3.5.2. Setting up a workflow</a><ul>
<li><a class="reference internal" href="#creating-states-transitions-and-group-permissions">3.5.2.1. Creating states, transitions and group permissions</a></li>
<li><a class="reference internal" href="#two-bits-of-warning">3.5.2.2. Two bits of warning</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="baseschema.html"
                        title="previous chapter">3.4. Pre-defined entities in the library</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../entityclasses/index.html"
                        title="next chapter">4. Data as objects</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/devrepo/datamodel/define-workflows.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="defining-a-workflow">
<span id="workflow"></span><h1>3.5. Defining a Workflow<a class="headerlink" href="#defining-a-workflow" title="Permalink to this headline">¶</a></h1>
<div class="section" id="general">
<h2>3.5.1. General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h2>
<p>A workflow describes how certain entities have to evolve between different
states. Hence we have a set of states, and a &#8220;transition graph&#8221;, i.e. a set of
possible transitions from one state to another state.</p>
<p>We will define a simple workflow for a blog, with only the following two states:
<cite>submitted</cite> and <cite>published</cite>. You may want to take a look at <a class="reference internal" href="../../tutorials/base/index.html#tutosbase"><em>Building a simple blog with CubicWeb</em></a> if
you want to quickly setup an instance running a blog.</p>
</div>
<div class="section" id="setting-up-a-workflow">
<h2>3.5.2. Setting up a workflow<a class="headerlink" href="#setting-up-a-workflow" title="Permalink to this headline">¶</a></h2>
<p>We want to create a workflow to control the quality of the BlogEntry
submitted on the instance. When a BlogEntry is created by a user
its state should be <cite>submitted</cite>. To be visible to all, it has to
be in the state <cite>published</cite>. To move it from <cite>submitted</cite> to <cite>published</cite>,
we need a transition that we can call <cite>approve_blogentry</cite>.</p>
<p>A BlogEntry state should not be modifiable by every user.
So we have to define a group of users, <cite>moderators</cite>, and
this group will have appropriate permissions to publish a BlogEntry.</p>
<p>There are two ways to create a workflow: from the user interface, or
by defining it in <tt class="docutils literal"><span class="pre">migration/postcreate.py</span></tt>. This script is executed
each time a new <tt class="docutils literal"><span class="pre">cubicweb-ctl</span> <span class="pre">db-init</span></tt> is done.  We strongly
recommend to create the workflow in <tt class="docutils literal"><span class="pre">migration/postcreate.py</span></tt> and we
will now show you how. Read <a class="reference internal" href="#two-bits-of-warning">Two bits of warning</a> to understand why.</p>
<p>The state of an entity is managed by the <cite>in_state</cite> attribute which
can be added to your entity schema by inheriting from
<cite>cubicweb.schema.WorkflowableEntityType</cite>.</p>
<p>About our example of BlogEntry, we must have:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.schema</span> <span class="kn">import</span> <span class="n">WorkflowableEntityType</span>

<span class="k">class</span> <span class="nc">BlogEntry</span><span class="p">(</span><span class="n">WorkflowableEntityType</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="section" id="creating-states-transitions-and-group-permissions">
<h3>3.5.2.1. Creating states, transitions and group permissions<a class="headerlink" href="#creating-states-transitions-and-group-permissions" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="xref py py-mod docutils literal"><span class="pre">postcreate</span></tt> script is executed in a special environment,
adding several <em>CubicWeb</em> primitives that can be used.</p>
<p>They are all defined in the <tt class="xref py py-class docutils literal"><span class="pre">ServerMigrationHelper</span></tt> class.
We will only discuss the methods we use to create a workflow in this example.</p>
<p>A workflow is a collection of entities of type <tt class="docutils literal"><span class="pre">State</span></tt> and of type
<tt class="docutils literal"><span class="pre">Transition</span></tt> which are standard <em>CubicWeb</em> entity types.</p>
<p>To define a workflow for BlogDemo, please add the following lines
to <tt class="docutils literal"><span class="pre">migration/postcreate.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">_</span> <span class="o">=</span> <span class="nb">unicode</span>

<span class="n">moderators</span> <span class="o">=</span> <span class="n">add_entity</span><span class="p">(</span><span class="s">&#39;CWGroup&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">u&quot;moderators&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This adds the <cite>moderators</cite> user group.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wf</span> <span class="o">=</span> <span class="n">add_workflow</span><span class="p">(</span><span class="s">u&#39;blog publication workflow&#39;</span><span class="p">,</span> <span class="s">&#39;BlogEntry&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>At first, instanciate a new workflow object with a gentle description
and the concerned entity types (this one can be a tuple for multiple
value).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">submitted</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;submitted&#39;</span><span class="p">),</span> <span class="n">initial</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">published</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">add_state</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;published&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>This will create two entities of type <tt class="docutils literal"><span class="pre">State</span></tt>, one with name
&#8216;submitted&#8217;, and the other with name &#8216;published&#8217;.</p>
<p><tt class="docutils literal"><span class="pre">add_state</span></tt> expects as first argument the name of the state you want
to create and an optional argument to say if it is supposed to be the
initial state of the entity type.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wf</span><span class="o">.</span><span class="n">add_transition</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;approve_blogentry&#39;</span><span class="p">),</span> <span class="p">(</span><span class="n">submitted</span><span class="p">,),</span> <span class="n">published</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;moderators&#39;</span><span class="p">,</span> <span class="s">&#39;managers&#39;</span><span class="p">),)</span>
</pre></div>
</div>
<p>This will create an entity of type <tt class="docutils literal"><span class="pre">Transition</span></tt> with name
<cite>approve_blogentry</cite> which will be linked to the <tt class="docutils literal"><span class="pre">State</span></tt> entities
created before.</p>
<p><tt class="docutils literal"><span class="pre">add_transition</span></tt> expects</p>
<blockquote>
<div><ul class="simple">
<li>as the first argument: the name of the transition</li>
<li>then the list of states on which the transition can be triggered,</li>
<li>the target state of the transition,</li>
<li>and the permissions
(e.g. a list of user groups who can apply the transition; the user
has to belong to at least one of the listed group to perform the action).</li>
</ul>
</div></blockquote>
<div class="highlight-python"><div class="highlight"><pre><span class="n">checkpoint</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Do not forget to add the <cite>_()</cite> in front of all states and
transitions names while creating a workflow so that they will be
identified by the i18n catalog scripts.</p>
</div>
<p>In addition to the user groups (one of which the user needs to belong
to), we could have added a RQL condition.  In this case, the user can
only perform the action if the two conditions are satisfied.</p>
<p>If we use an RQL condition on a transition, we can use the following variables:</p>
<ul class="simple">
<li><cite>X</cite>, the entity on which we may pass the transition</li>
<li><cite>U</cite>, the user executing that may pass the transition</li>
</ul>
<img alt="../../_images/03-transitions-view_en.png" src="../../_images/03-transitions-view_en.png" />
<p>You can notice that in the action box of a BlogEntry, the state is now
listed as well as the possible transitions for the current state
defined by the workflow.</p>
<p>The transitions will only be displayed for users having the right permissions.
In our example, the transition <cite>approve_blogentry</cite> will only be displayed
for the users belonging to the group <cite>moderators</cite> or <cite>managers</cite>.</p>
</div>
<div class="section" id="two-bits-of-warning">
<h3>3.5.2.2. Two bits of warning<a class="headerlink" href="#two-bits-of-warning" title="Permalink to this headline">¶</a></h3>
<p>We could perfectly use the administration interface to do these
operations. It is a convenient thing to do at times (when doing
development, to quick-check things). But it is not recommended beyond
that because it is a bit complicated to do it right and it will be
only local to your instance (or, said a bit differently, such a
workflow only exists in an instance database). Furthermore, you cannot
write unit tests against deployed instances, and experience shows it
is mandatory to have tests for any mildly complicated workflow
setup.</p>
<p>Indeed, if you create the states and transitions through the user
interface, next time you initialize the database you will have to
re-create all the workflow entities. The user interface should only be
a reference for you to view the states and transitions, but is not the
appropriate interface to define your application workflow.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../entityclasses/index.html" title="4. Data as objects"
             >next</a> |</li>
        <li class="right" >
          <a href="baseschema.html" title="3.4. Pre-defined entities in the library"
             >previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Repository development</a> &raquo;</li>
          <li><a href="index.html" >3. Data model</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>