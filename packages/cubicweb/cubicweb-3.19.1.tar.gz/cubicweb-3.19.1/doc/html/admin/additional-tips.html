
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>12. Backups (mostly with postgresql) &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../index.html" />
    <link rel="up" title="Administration" href="index.html" />
    <link rel="next" title="13. RQL logs" href="rql-logs.html" />
    <link rel="prev" title="11. Migrating cubicweb instances - benefits from a distributed architecture" href="migration.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="rql-logs.html" title="13. RQL logs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="migration.html" title="11. Migrating cubicweb instances - benefits from a distributed architecture"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Administration</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">12. Backups (mostly with postgresql)</a><ul>
<li><a class="reference internal" href="#using-postgresql-and-only-that">12.1. Using postgresql (and only that)</a></li>
<li><a class="reference internal" href="#using-cubicweb-ctl-db-dump">12.2. Using <strong class="command">cubicweb-ctl db-dump</strong></a></li>
<li><a class="reference internal" href="#backup-ninja">12.3. Backup ninja</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="migration.html"
                        title="previous chapter">11. Migrating cubicweb instances - benefits from a distributed architecture</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="rql-logs.html"
                        title="next chapter">13. RQL logs</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/admin/additional-tips.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="backups-mostly-with-postgresql">
<span id="additional-tips"></span><h1>12. Backups (mostly with postgresql)<a class="headerlink" href="#backups-mostly-with-postgresql" title="Permalink to this headline">¶</a></h1>
<p>It is always a good idea to backup. If your system does not do that,
you should set it up. Note that whenever you do an upgrade,
<cite>cubicweb-ctl</cite> offers you to backup your database.  There are a number
of ways for doing backups.</p>
<div class="section" id="using-postgresql-and-only-that">
<h2>12.1. Using postgresql (and only that)<a class="headerlink" href="#using-postgresql-and-only-that" title="Permalink to this headline">¶</a></h2>
<p>Before you
go ahead, make sure the following permissions are correct</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># chgrp postgres /var/lib/cubicweb/backup</span>
<span class="c"># chmod g+ws /var/lib/cubicweb/backup</span>
<span class="c"># chgrp postgres /etc/cubicweb.d/*&lt;instance&gt;*/sources</span>
<span class="c"># chmod g+r /etc/cubicweb.d/*&lt;instance&gt;*/sources</span>
</pre></div>
</div>
<p>Simply use the pg_dump in a cron installed for <cite>postgres</cite> user on the database server:</p>
<div class="highlight-python"><pre># m h  dom mon dow   command
0 2 * * * pg_dump -Fc --username=cubicweb --no-owner &lt;instance&gt; &gt; /var/backups/&lt;instance&gt;-$(date '+%Y-%m-%d_%H:%M:%S').dump</pre>
</div>
</div>
<div class="section" id="using-cubicweb-ctl-db-dump">
<h2>12.2. Using <strong class="command">cubicweb-ctl db-dump</strong><a class="headerlink" href="#using-cubicweb-ctl-db-dump" title="Permalink to this headline">¶</a></h2>
<p>The CubicWeb way is to use the <strong class="command">db-dump</strong> command. For that,
you have to put your passwords in a user-only-readable file at the
home directory of root user.  The file is <cite>.pgpass</cite> (<cite>chmod 0600</cite>), in
this case for a socket run connection to PostgreSQL</p>
<div class="highlight-python"><pre>/var/run/postgresql:5432:&lt;instance&gt;:&lt;database user&gt;:&lt;database password&gt;</pre>
</div>
<p>The postgres documentation for the <cite>.pgpass</cite> format can be found <a class="reference external" href="http://www.postgresql.org/docs/current/static/libpq-pgpass.html">here</a></p>
<p>Then add the following command to the crontab of the user (<cite>crontab -e</cite>):</p>
<div class="highlight-python"><pre># m h  dom mon dow   command
0 2 * * * cubicweb-ctl db-dump &lt;instance&gt;</pre>
</div>
</div>
<div class="section" id="backup-ninja">
<h2>12.3. Backup ninja<a class="headerlink" href="#backup-ninja" title="Permalink to this headline">¶</a></h2>
<p>You can use a combination <a class="reference external" href="https://labs.riseup.net/code/projects/show/backupninja/">backup-ninja</a> (which has a postgres script in the
example directory), <cite>backuppc</cite>)_ (for versionning).</p>
<p>Please note that in the <em>CubicWeb way</em> it adds a second location for your
password which is error-prone.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Remember that these indications will fail you whenever you use
another database backend than postgres. Also it does properly handle
externally managed data such as files (using the Bytes File System
Storage).</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="rql-logs.html" title="13. RQL logs"
             >next</a> |</li>
        <li class="right" >
          <a href="migration.html" title="11. Migrating cubicweb instances - benefits from a distributed architecture"
             >previous</a> |</li>
        <li><a href="../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="index.html" >Administration</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>