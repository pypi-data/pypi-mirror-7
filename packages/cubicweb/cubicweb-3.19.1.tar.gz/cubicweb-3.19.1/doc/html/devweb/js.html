
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Javascript &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../index.html" />
    <link rel="up" title="Web side development" href="index.html" />
    <link rel="next" title="&lt;no title&gt;" href="js_api/index.html" />
    <link rel="prev" title="Ajax" href="ajax.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="js_api/index.html" title="&lt;no title&gt;"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ajax.html" title="Ajax"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Web side development</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Javascript</a><ul>
<li><a class="reference internal" href="#conventions">Conventions</a></li>
<li><a class="reference internal" href="#server-side-javascript-api">Server-side Javascript API</a></li>
<li><a class="reference internal" href="#javascript-events">Javascript events</a></li>
<li><a class="reference internal" href="#important-javascript-ajax-apis">Important javascript AJAX APIS</a></li>
<li><a class="reference internal" href="#a-simple-example-with-asyncremoteexec">A simple example with asyncRemoteExec</a></li>
<li><a class="reference internal" href="#anatomy-of-a-reloadcomponent-call">Anatomy of a reloadComponent call</a></li>
<li><a class="reference internal" href="#a-simple-reloadcomponent-example">A simple reloadComponent example</a></li>
<li><a class="reference internal" href="#anatomy-of-a-loadxhtml-call">Anatomy of a loadxhtml call</a></li>
<li><a class="reference internal" href="#a-simple-example-with-loadxhtml">A simple example with loadxhtml</a></li>
<li><a class="reference internal" href="#a-more-real-life-example">A more real-life example</a></li>
<li><a class="reference internal" href="#python-ajax-dynamic-callbacks">python/ajax dynamic callbacks</a></li>
<li><a class="reference internal" href="#javascript-library-overview">Javascript library: overview</a></li>
<li><a class="reference internal" href="#api">API</a><ul>
</ul>
</li>
<li><a class="reference internal" href="#testing-javascript">Testing javascript</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="ajax.html"
                        title="previous chapter">Ajax</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="js_api/index.html"
                        title="next chapter">&lt;no title&gt;</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/devweb/js.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="javascript">
<h1>Javascript<a class="headerlink" href="#javascript" title="Permalink to this headline">¶</a></h1>
<p><em>CubicWeb</em> uses quite a bit of javascript in its user interface and
ships with jquery (1.3.x) and parts of the jquery UI library, plus a
number of homegrown files and also other third party libraries.</p>
<p>All javascript files are stored in cubicweb/web/data/. There are
around thirty js files there. In a cube it goes to data/.</p>
<p>Obviously one does not want javascript pieces to be loaded all at
once, hence the framework provides a number of mechanisms and
conventions to deal with javascript resources.</p>
<div class="section" id="conventions">
<h2>Conventions<a class="headerlink" href="#conventions" title="Permalink to this headline">¶</a></h2>
<p>It is good practice to name cube specific js files after the name of
the cube, like this : &#8216;cube.mycube.js&#8217;, so as to avoid name clashes.</p>
</div>
<div class="section" id="server-side-javascript-api">
<h2>Server-side Javascript API<a class="headerlink" href="#server-side-javascript-api" title="Permalink to this headline">¶</a></h2>
<p>Javascript resources are typically loaded on demand, from views. The
request object (available as self._cw from most application objects,
for instance views and entities objects) has a few methods to do that:</p>
<ul class="simple">
<li><cite>add_js(self, jsfiles, localfile=True)</cite> which takes a sequence of
javascript files and writes proper entries into the HTML header
section. The localfile parameter allows to declare resources which
are not from web/data (for instance, residing on a content delivery
network).</li>
<li><cite>add_onload(self, jscode)</cite> which adds one raw javascript code
snippet inline in the html headers. This is quite useful for setting
up early jQuery(document).ready(...) initialisations.</li>
</ul>
</div>
<div class="section" id="javascript-events">
<h2>Javascript events<a class="headerlink" href="#javascript-events" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">server-response</span></tt>: this event is triggered on HTTP responses (both
standard and ajax). The two following extra parameters are passed
to callbacks :<ul>
<li><tt class="docutils literal"><span class="pre">ajax</span></tt>: a boolean that says if the reponse was issued by an
ajax request</li>
<li><tt class="docutils literal"><span class="pre">node</span></tt>: the DOM node returned by the server in case of an
ajax request, otherwise the document itself for standard HTTP
requests.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="important-javascript-ajax-apis">
<h2>Important javascript AJAX APIS<a class="headerlink" href="#important-javascript-ajax-apis" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><cite>asyncRemoteExec</cite> and <cite>remoteExec</cite> are the base building blocks for
doing arbitrary async (resp. sync) communications with the server</li>
<li><cite>reloadComponent</cite> is a convenience function to replace a DOM node
with server supplied content coming from a specific registry (this
is quite handy to refresh the content of some boxes for instances)</li>
<li><cite>jQuery.fn.loadxhtml</cite> is an important extension to jQuery which
allows proper loading and in-place DOM update of xhtml views. It is
suitably augmented to trigger necessary events, and process CubicWeb
specific elements such as the facet system, fckeditor, etc.</li>
</ul>
</div>
<div class="section" id="a-simple-example-with-asyncremoteexec">
<h2>A simple example with asyncRemoteExec<a class="headerlink" href="#a-simple-example-with-asyncremoteexec" title="Permalink to this headline">¶</a></h2>
<p>On the python side, we have to define an
<a class="reference internal" href="ajax.html#cubicweb.web.views.ajaxcontroller.AjaxFunction" title="cubicweb.web.views.ajaxcontroller.AjaxFunction"><tt class="xref py py-class docutils literal"><span class="pre">cubicweb.web.views.ajaxcontroller.AjaxFunction</span></tt></a> object. The
simplest way to do that is to use the
<a class="reference internal" href="ajax.html#cubicweb.web.views.ajaxcontroller.ajaxfunc" title="cubicweb.web.views.ajaxcontroller.ajaxfunc"><tt class="xref py py-func docutils literal"><span class="pre">cubicweb.web.views.ajaxcontroller.ajaxfunc()</span></tt></a> decorator (for more
details on this, refer to <a class="reference internal" href="ajax.html#ajax"><em>Ajax</em></a>).</p>
<p>On the javascript side, we do the asynchronous call. Notice how it
creates a <cite>deferred</cite> object. Proper treatment of the return value or
error handling has to be done through the addCallback and addErrback
methods.</p>
</div>
<div class="section" id="anatomy-of-a-reloadcomponent-call">
<h2>Anatomy of a reloadComponent call<a class="headerlink" href="#anatomy-of-a-reloadcomponent-call" title="Permalink to this headline">¶</a></h2>
<p><cite>reloadComponent</cite> allows to dynamically replace some DOM node with new
elements. It has the following signature:</p>
<ul class="simple">
<li><cite>compid</cite> (mandatory) is the name of the component to be reloaded</li>
<li><cite>rql</cite> (optional) will be used to generate a result set given as
argument to the selected component</li>
<li><cite>registry</cite> (optional) defaults to &#8216;components&#8217; but can be any other
valid registry name</li>
<li><cite>nodeid</cite> (optional) defaults to compid + &#8216;Component&#8217; but can be any
explicitly specified DOM node id</li>
<li><cite>extraargs</cite> (optional) should be a dictionary of values that will be
given to the cell_call method of the component</li>
</ul>
</div>
<div class="section" id="a-simple-reloadcomponent-example">
<h2>A simple reloadComponent example<a class="headerlink" href="#a-simple-reloadcomponent-example" title="Permalink to this headline">¶</a></h2>
<p>The server side implementation of <cite>reloadComponent</cite> is the
<tt class="xref py py-func docutils literal"><span class="pre">cubicweb.web.views.ajaxcontroller.component()</span></tt> <em>AjaxFunction</em> appobject.</p>
<p>The following function implements a two-steps method to delete a
standard bookmark and refresh the UI, while keeping the UI responsive.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">removeBookmark</span><span class="p">(</span><span class="nx">beid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d</span> <span class="o">=</span> <span class="nx">asyncRemoteExec</span><span class="p">(</span><span class="s1">&#39;delete_bookmark&#39;</span><span class="p">,</span> <span class="nx">beid</span><span class="p">);</span>
    <span class="nx">d</span><span class="p">.</span><span class="nx">addCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">boxcontent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reloadComponent</span><span class="p">(</span><span class="s1">&#39;bookmarks_box&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;boxes&#39;</span><span class="p">,</span> <span class="s1">&#39;bookmarks_box&#39;</span><span class="p">);</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;#header&#39;</span><span class="p">;</span>
        <span class="nx">updateMessage</span><span class="p">(</span><span class="nx">_</span><span class="p">(</span><span class="s2">&quot;bookmark has been removed&quot;</span><span class="p">));</span>
     <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p><cite>reloadComponent</cite> is called with the id of the bookmark box as
argument, no rql expression (because the bookmarks display is actually
independant of any dataset context), a reference to the &#8216;boxes&#8217;
registry (which hosts all left, right and contextual boxes) and
finally an explicit &#8216;bookmarks_box&#8217; nodeid argument that stipulates
the target DOM node.</p>
</div>
<div class="section" id="anatomy-of-a-loadxhtml-call">
<h2>Anatomy of a loadxhtml call<a class="headerlink" href="#anatomy-of-a-loadxhtml-call" title="Permalink to this headline">¶</a></h2>
<p><cite>jQuery.fn.loadxhtml</cite> is an important extension to jQuery which allows
proper loading and in-place DOM update of xhtml views. The existing
<a class="reference external" href="http://api.jquery.com/load/">jQuery.load</a> function does not handle xhtml, hence the addition. The
API of loadxhtml is roughly similar to that of <a class="reference external" href="http://api.jquery.com/load/">jQuery.load</a>.</p>
<ul class="simple">
<li><cite>url</cite> (mandatory) should be a complete url (typically referencing
the <a class="reference internal" href="ajax.html#cubicweb.web.views.ajaxcontroller.AjaxController" title="cubicweb.web.views.ajaxcontroller.AjaxController"><tt class="xref py py-class docutils literal"><span class="pre">cubicweb.web.views.ajaxcontroller.AjaxController</span></tt></a>,
but this is not strictly mandatory)</li>
<li><cite>data</cite> (optional) is a dictionary of values given to the
controller specified through an <cite>url</cite> argument; some keys may have a
special meaning depending on the choosen controller (such as <cite>fname</cite>
for the JSonController); the <cite>callback</cite> key, if present, must refer
to a function to be called at the end of loadxhtml (more on this
below)</li>
<li><cite>reqtype</cite> (optional) specifies the request method to be used (get or
post); if the argument is &#8216;post&#8217;, then the post method is used,
otherwise the get method is used</li>
<li><cite>mode</cite> (optional) is one of <cite>replace</cite> (the default) which means the
loaded node will replace the current node content, <cite>swap</cite> to replace
the current node with the loaded node, and <cite>append</cite> which will
append the loaded node to the current node content</li>
</ul>
<p>About the <cite>callback</cite> option:</p>
<ul class="simple">
<li>it is called with two parameters: the current node, and a list
containing the loaded (and post-processed node)</li>
<li>whenever it returns another function, this function is called in
turn with the same parameters as above</li>
</ul>
<p>This mechanism allows callback chaining.</p>
</div>
<div class="section" id="a-simple-example-with-loadxhtml">
<h2>A simple example with loadxhtml<a class="headerlink" href="#a-simple-example-with-loadxhtml" title="Permalink to this headline">¶</a></h2>
<p>Here we are concerned with the retrieval of a specific view to be
injected in the live DOM. The view will be of course selected
server-side using an entity eid provided by the client side.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.web.views.ajaxcontroller</span> <span class="kn">import</span> <span class="n">ajaxfunc</span>

<span class="nd">@ajaxfunc</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s">&#39;xhtml&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">frob_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="n">frobname</span><span class="p">):</span>
    <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">entity_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s">&#39;frob&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">frobname</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">updateSomeDiv</span><span class="p">(</span><span class="nx">divid</span><span class="p">,</span> <span class="nx">eid</span><span class="p">,</span> <span class="nx">frobname</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">fname</span><span class="o">:</span><span class="s1">&#39;frob_status&#39;</span><span class="p">,</span> <span class="nx">eid</span><span class="o">:</span> <span class="nx">eid</span><span class="p">,</span> <span class="nx">frobname</span><span class="o">:</span><span class="nx">frobname</span><span class="p">};</span>
    <span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">+</span><span class="nx">divid</span><span class="p">).</span><span class="nx">loadxhtml</span><span class="p">(</span><span class="nx">JSON_BASE_URL</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>In this example, the url argument is the base json url of a cube
instance (it should contain something like
<cite>http://myinstance/ajax?</cite>). The actual AjaxController method name is
encoded in the <cite>params</cite> dictionary using the <cite>fname</cite> key.</p>
</div>
<div class="section" id="a-more-real-life-example">
<h2>A more real-life example<a class="headerlink" href="#a-more-real-life-example" title="Permalink to this headline">¶</a></h2>
<p>A frequent need of Web 2 applications is the delayed (or demand
driven) loading of pieces of the DOM. This is typically achieved using
some preparation of the initial DOM nodes, jQuery event handling and
proper use of loadxhtml.</p>
<p>We present here a skeletal version of the mecanism used in CubicWeb
and available in web/views/tabs.py, in the <cite>LazyViewMixin</cite> class.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">lazyview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vid</span><span class="p">,</span> <span class="n">rql</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; a lazy version of wview &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">add_js</span><span class="p">(</span><span class="s">&#39;cubicweb.lazy.js&#39;</span><span class="p">)</span>
    <span class="n">urlparams</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;vid&#39;</span> <span class="p">:</span> <span class="n">vid</span><span class="p">,</span> <span class="s">&#39;fname&#39;</span> <span class="p">:</span> <span class="s">&#39;view&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">rql</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">urlparams</span><span class="p">[</span><span class="s">&#39;rql&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rql</span>
    <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;div id=&quot;lazy-</span><span class="si">%s</span><span class="s">&quot; cubicweb:loadurl=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">vid</span><span class="p">,</span> <span class="n">xml_escape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="s">&#39;json&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">urlparams</span><span class="p">))))</span>
    <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;/div&gt;&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">add_onload</span><span class="p">(</span><span class="s">u&quot;&quot;&quot;</span>
<span class="s">        jQuery(&#39;#lazy-</span><span class="si">%(vid)s</span><span class="s">&#39;).bind(&#39;</span><span class="si">%(event)s</span><span class="s">&#39;, function() {</span>
<span class="s">               loadNow(&#39;#lazy-</span><span class="si">%(vid)s</span><span class="s">&#39;);});&quot;&quot;&quot;</span>
        <span class="o">%</span> <span class="p">{</span><span class="s">&#39;event&#39;</span><span class="p">:</span> <span class="s">&#39;load_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">,</span> <span class="s">&#39;vid&#39;</span><span class="p">:</span> <span class="n">vid</span><span class="p">})</span>
</pre></div>
</div>
<p>This creates a <cite>div</cite> with a specific event associated to it.</p>
<p>The full version deals with:</p>
<ul class="simple">
<li>optional parameters such as an entity eid, an rset</li>
<li>the ability to further reload the fragment</li>
<li>the ability to display a spinning wheel while the fragment is still
not loaded</li>
<li>handling of browsers that do not support ajax (search engines,
text-based browsers such as lynx, etc.)</li>
</ul>
<p>The javascript side is quite simple, due to loadxhtml awesomeness.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">loadNow</span><span class="p">(</span><span class="nx">eltsel</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lazydiv</span> <span class="o">=</span> <span class="nx">jQuery</span><span class="p">(</span><span class="nx">eltsel</span><span class="p">);</span>
    <span class="nx">lazydiv</span><span class="p">.</span><span class="nx">loadxhtml</span><span class="p">(</span><span class="nx">lazydiv</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;cubicweb:loadurl&#39;</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is all significantly different of the previous <cite>simple example</cite>
(albeit this example actually comes from real-life code).</p>
<p>Notice how the <cite>cubicweb:loadurl</cite> is used to convey the url
information. The base of this url is similar to the global javascript
JSON_BASE_URL. According to the pattern described earlier,
the <cite>fname</cite> parameter refers to the standard <cite>js_view</cite> method of the
JSonController. This method renders an arbitrary view provided a view
id (or <cite>vid</cite>) is provided, and most likely an rql expression yielding
a result set against which a proper view instance will be selected.</p>
<p>The <cite>cubicweb:loadurl</cite> is one of the 29 attributes extensions to XHTML
in a specific cubicweb namespace. It is a means to pass information
without breaking HTML nor XHTML compliance and without resorting to
ungodly hacks.</p>
<p>Given all this, it is easy to add a small nevertheless useful feature
to force the loading of a lazy view (for instance, a very
computation-intensive web page could be scinded into one fast-loading
part and a delayed part).</p>
<p>On the server side, a simple call to a javascript function is
sufficient.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">forceview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;trigger an event that will force immediate loading of the view</span>
<span class="sd">    on dom readyness</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">add_onload</span><span class="p">(</span><span class="s">&quot;triggerLoad(&#39;</span><span class="si">%s</span><span class="s">&#39;);&quot;</span> <span class="o">%</span> <span class="n">vid</span><span class="p">)</span>
</pre></div>
</div>
<p>The browser-side definition follows.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">triggerLoad</span><span class="p">(</span><span class="nx">divid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jQuery</span><span class="p">(</span><span class="s1">&#39;#lazy-&#39;</span> <span class="o">+</span> <span class="nx">divd</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;load_&#39;</span> <span class="o">+</span> <span class="nx">divid</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="python-ajax-dynamic-callbacks">
<h2>python/ajax dynamic callbacks<a class="headerlink" href="#python-ajax-dynamic-callbacks" title="Permalink to this headline">¶</a></h2>
<p>CubicWeb provides a way to dynamically register a function and make it
callable from the javascript side. The typical use case for this is a
situation where you have everything at hand to implement an action
(whether it be performing a RQL query or executing a few python
statements) that you&#8217;d like to defer to a user click in the web
interface.  In other words, generate an HTML <tt class="docutils literal"><span class="pre">&lt;a</span> <span class="pre">href=...</span></tt> link that
would execute your few lines of code.</p>
<p>The trick is to create a python function and store this function in
the user&#8217;s session data. You will then be able to access it later.
While this might sound hard to implement, it&#8217;s actually quite easy
thanks to the <tt class="docutils literal"><span class="pre">_cw.user_callback()</span></tt>. This method takes a function,
registers it and returns a javascript instruction suitable for
<tt class="docutils literal"><span class="pre">href</span></tt> or <tt class="docutils literal"><span class="pre">onclick</span></tt> usage. The call is then performed
asynchronously.</p>
<p>Here&#8217;s a simplified example taken from the <a class="reference external" href="http://www.cubicweb.org/project/cubicweb-vcreview">vcreview</a> cube that will
generate a link to change an entity state directly without the
standard intermediate <em>comment / validate</em> step:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">entity_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
    <span class="c"># [...]</span>
    <span class="k">def</span> <span class="nf">change_state</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">eid</span><span class="p">):</span>
        <span class="n">entity</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">entity_from_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">cw_adapt_to</span><span class="p">(</span><span class="s">&#39;IWorkflowable&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fire_transition</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">user_callback</span><span class="p">(</span><span class="n">change_state</span><span class="p">,</span> <span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">eid</span><span class="p">,))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">(</span><span class="n">tags</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;button&#39;</span><span class="p">,</span> <span class="n">onclick</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;mark as done&#39;</span><span class="p">)))</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">change_state</span></tt> callback function is registered with
<tt class="docutils literal"><span class="pre">self._cw.user_callback()</span></tt> which returns the <tt class="docutils literal"><span class="pre">url</span></tt> value directly
used for the <tt class="docutils literal"><span class="pre">onclick</span></tt> attribute of the button. On the javascript
side, the <tt class="docutils literal"><span class="pre">userCallback()</span></tt> function is used but you most probably
won&#8217;t have to bother with it.</p>
<p>Of course, when dealing with session data, the question of session
cleaning pops up immediately. If you use <tt class="docutils literal"><span class="pre">user_callback()</span></tt>, the
registered function will be deleted automatically at some point
as any other session data. If you want your function to be deleted once
the web page is unloaded or when the user has clicked once on your link, then
<tt class="docutils literal"><span class="pre">_cw.register_onetime_callback()</span></tt> is what you need. It behaves as
<tt class="docutils literal"><span class="pre">_cw.user_callback()</span></tt> but stores the function in page data instead
of global session data.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Be careful when registering functions with closures, keep in mind that
enclosed data will be kept in memory until the session gets cleared. Also,
if you keep entities or any object referecing the current <tt class="docutils literal"><span class="pre">req</span></tt> object, you
might have problems reusing them later because the underlying session
might have been closed at the time the callback gets executed.</p>
</div>
</div>
<div class="section" id="javascript-library-overview">
<h2>Javascript library: overview<a class="headerlink" href="#javascript-library-overview" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>jquery.* : jquery and jquery UI library</li>
<li>cubicweb.ajax.js : concentrates all ajax related facilities (it
extends jQuery with the loahxhtml function, provides a handfull of
high-level ajaxy operations like asyncRemoteExec, reloadComponent,
replacePageChunk, getDomFromResponse)</li>
<li>cubicweb.python.js : adds a number of practical extension to stdanrd
javascript objects (on Date, Array, String, some list and dictionary
operations), and a pythonesque way to build classes. Defines a
CubicWeb namespace.</li>
<li>cubicweb.htmlhelpers.js : a small bag of convenience functions used
in various other cubicweb javascript resources (baseuri, progress
cursor handling, popup login box, html2dom function, etc.)</li>
<li>cubicweb.widgets.js : provides a widget namespace and constructors
and helpers for various widgets (mainly facets and timeline)</li>
<li>cubicweb.edition.js : used by edition forms</li>
<li>cubicweb.preferences.js : used by the preference form</li>
<li>cubicweb.facets.js : used by the facets mechanism</li>
</ul>
<p>There is also javascript support for massmailing, gmap (google maps),
fckcwconfig (fck editor), timeline, calendar, goa (CubicWeb over
AppEngine), flot (charts drawing), tabs and bookmarks.</p>
</div>
<div class="section" id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.html">cubicweb.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.python.html">cubicweb.python.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.htmlhelpers.html">cubicweb.htmlhelpers.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.ajax.html">cubicweb.ajax.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.ajax.box.html">cubicweb.ajax.box.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.facets.html">cubicweb.facets.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.widgets.html">cubicweb.widgets.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.image.html">cubicweb.image.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.flot.html">cubicweb.flot.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.calendar.html">cubicweb.calendar.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.preferences.html">cubicweb.preferences.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.edition.html">cubicweb.edition.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.reledit.html">cubicweb.reledit.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.timeline-ext.html">cubicweb.timeline-ext.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/cubicweb.log.html">cubicweb.log.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/fullcalendar.html">fullcalendar.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/fullcalendar.locale.html">fullcalendar.locale.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/fullcalendar.min.html">fullcalendar.min.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/jquery-migrate.html">jquery-migrate.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/jquery.cookie.html">jquery.cookie.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/jquery.qtip.min.html">jquery.qtip.min.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/jquery.ui.datepicker-de.html">jquery.ui.datepicker-de.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/jquery.ui.datepicker-es.html">jquery.ui.datepicker-es.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="js_api/jquery.ui.datepicker-fr.html">jquery.ui.datepicker-fr.js</a></li>
</ul>
</div>
</div>
<div class="section" id="testing-javascript">
<h2>Testing javascript<a class="headerlink" href="#testing-javascript" title="Permalink to this headline">¶</a></h2>
<p>You with the <tt class="docutils literal"><span class="pre">cubicweb.qunit.QUnitTestCase</span></tt> can include standard Qunit tests
inside the python unittest run . You simply have to define a new class that
inherit from <tt class="docutils literal"><span class="pre">QUnitTestCase</span></tt> and register your javascript test file in the
<tt class="docutils literal"><span class="pre">all_js_tests</span></tt> lclass attribut. This  <tt class="docutils literal"><span class="pre">all_js_tests</span></tt> is a sequence a
3-tuple (&lt;test_file, [&lt;dependencies&gt; ,] [&lt;data_files&gt;]):</p>
<p>The &lt;test_file&gt; should contains the qunit test. &lt;dependencies&gt; defines the list
of javascript file that must be imported before the test script.  Dependencies
are included their definition order. &lt;data_files&gt; are additional files copied in the
test directory. both &lt;dependencies&gt; and &lt;data_files&gt; are optionnal.
<tt class="docutils literal"><span class="pre">jquery.js</span></tt> is preincluded in for all test.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.qunit</span> <span class="kn">import</span> <span class="n">QUnitTestCase</span>

<span class="k">class</span> <span class="nc">MyQUnitTest</span><span class="p">(</span><span class="n">QUnitTestCase</span><span class="p">):</span>

    <span class="n">all_js_tests</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&quot;relative/path/to/my_simple_testcase.js&quot;</span><span class="p">,)</span>
        <span class="p">(</span><span class="s">&quot;relative/path/to/my_qunit_testcase.js&quot;</span><span class="p">,(</span>
            <span class="s">&quot;rel/path/to/dependency_1.js&quot;</span><span class="p">,</span>
            <span class="s">&quot;rel/path/to/dependency_2.js&quot;</span><span class="p">,)),</span>
        <span class="p">(</span><span class="s">&quot;relative/path/to/my_complexe_qunit_testcase.js&quot;</span><span class="p">,(</span>
             <span class="s">&quot;rel/path/to/dependency_1.js&quot;</span><span class="p">,</span>
             <span class="s">&quot;rel/path/to/dependency_2.js&quot;</span><span class="p">,</span>
           <span class="p">),(</span>
             <span class="s">&quot;rel/path/file_dependency.html&quot;</span><span class="p">,</span>
             <span class="s">&quot;path/file_dependency.json&quot;</span><span class="p">)</span>
            <span class="p">),</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="js_api/index.html" title="&lt;no title&gt;"
             >next</a> |</li>
        <li class="right" >
          <a href="ajax.html" title="Ajax"
             >previous</a> |</li>
        <li><a href="../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="index.html" >Web side development</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>