
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dissection of an entity form &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../../index.html" />
    <link rel="up" title="Edition control" href="index.html" />
    <link rel="next" title="The edit controller" href="editcontroller.html" />
    <link rel="prev" title="HTML form construction" href="form.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="editcontroller.html" title="The edit controller"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="form.html" title="HTML form construction"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Web side development</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Edition control</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Dissection of an entity form</a><ul>
<li><a class="reference internal" href="#populating-the-database">Populating the database</a></li>
<li><a class="reference internal" href="#looking-at-the-html-output">Looking at the html output</a><ul>
<li><a class="reference internal" href="#the-form-enveloppe">The form enveloppe</a></li>
<li><a class="reference internal" href="#the-attributes-section">The attributes section</a></li>
<li><a class="reference internal" href="#the-relations-section">The relations section</a></li>
<li><a class="reference internal" href="#the-buttons-zone">The buttons zone</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#the-form-validation-process">The form validation process</a><ul>
<li><a class="reference internal" href="#preparation">Preparation</a></li>
<li><a class="reference internal" href="#validation-loop">Validation loop</a></li>
<li><a class="reference internal" href="#explanation">Explanation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="form.html"
                        title="previous chapter">HTML form construction</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="editcontroller.html"
                        title="next chapter">The <cite>edit controller</cite></a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/devweb/edition/dissection.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="dissection-of-an-entity-form">
<span id="form-dissection"></span><h1>Dissection of an entity form<a class="headerlink" href="#dissection-of-an-entity-form" title="Permalink to this headline">¶</a></h1>
<p>This is done (again) with a vanilla instance of the <a class="reference external" href="http://www.cubicweb.org/project/cubicweb-tracker">tracker</a>
cube. We will populate the database with a bunch of entities and see
what kind of job the automatic entity form does.</p>
<div class="section" id="populating-the-database">
<h2>Populating the database<a class="headerlink" href="#populating-the-database" title="Permalink to this headline">¶</a></h2>
<p>We should start by setting up a bit of context: a project with two
unpublished versions, and a ticket linked to the project and the first
version.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">rql</span><span class="p">(</span><span class="s">&#39;INSERT Project P: P name &quot;cubicweb&quot;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;0.1.0&#39;</span><span class="p">,</span> <span class="s">&#39;0.2.0&#39;</span><span class="p">):</span>
<span class="gp">... </span> <span class="n">rql</span><span class="p">(</span><span class="s">&#39;INSERT Version V: V num &quot;</span><span class="si">%s</span><span class="s">&quot;, V version_of P WHERE P eid </span><span class="si">%%</span><span class="s">(p)s&#39;</span> <span class="o">%</span> <span class="n">num</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>
<span class="gp">...</span>
<span class="go">&lt;resultset &#39;INSERT Version V: V num &quot;0.1.0&quot;, V version_of P WHERE P eid %(p)s&#39; (1 rows): [765L] ((&#39;Version&#39;,))&gt;</span>
<span class="go">&lt;resultset &#39;INSERT Version V: V num &quot;0.2.0&quot;, V version_of P WHERE P eid %(p)s&#39; (1 rows): [766L] ((&#39;Version&#39;,))&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">rql</span><span class="p">(</span><span class="s">&#39;INSERT Ticket T: T title &quot;let us write more doc&quot;, T done_in V, &#39;</span>
<span class="go">            &#39;T concerns P WHERE V num &quot;0.1.0&quot;&#39;, P eid %(p)s&#39;, {&#39;p&#39;: p[0][0]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
<p>Now let&#8217;s see what the edition form builds for us.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">cnx</span><span class="o">.</span><span class="n">use_web_compatible_requests</span><span class="p">(</span><span class="s">&#39;http://fakeurl.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">req</span> <span class="o">=</span> <span class="n">cnx</span><span class="o">.</span><span class="n">request</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">form</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">vreg</span><span class="p">[</span><span class="s">&#39;forms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;edition&#39;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">rset</span><span class="o">=</span><span class="n">rql</span><span class="p">(</span><span class="s">&#39;Ticket T&#39;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">html</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In order to play interactively with web side application objects, we have to
cheat a bit to have request object that will looks like HTTP request object, by
calling <tt class="xref py py-meth docutils literal"><span class="pre">use_web_compatible_requests()</span></tt> on the connection.</p>
</div>
<p>This creates an automatic entity form. The <tt class="docutils literal"><span class="pre">.render()</span></tt> call yields
an html (unicode) string. The html output is shown below (with
internal fieldset omitted).</p>
</div>
<div class="section" id="looking-at-the-html-output">
<h2>Looking at the html output<a class="headerlink" href="#looking-at-the-html-output" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-form-enveloppe">
<h3>The form enveloppe<a class="headerlink" href="#the-form-enveloppe" title="Permalink to this headline">¶</a></h3>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;iformTitle&quot;</span><span class="nt">&gt;&lt;span&gt;</span>main informations<span class="nt">&lt;/span&gt;&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;formBody&quot;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;http://crater:9999/validateform&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">enctype=</span><span class="s">&quot;application/x-www-form-urlencoded&quot;</span>
       <span class="na">id=</span><span class="s">&quot;entityForm&quot;</span> <span class="na">onsubmit=</span><span class="s">&quot;return freezeFormButtons(&amp;#39;entityForm&amp;#39;);&quot;</span>
       <span class="na">class=</span><span class="s">&quot;entityForm&quot;</span> <span class="na">cubicweb:target=</span><span class="s">&quot;eformframe&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;progress&quot;</span><span class="nt">&gt;</span>validating...<span class="nt">&lt;/div&gt;</span>
   <span class="nt">&lt;fieldset&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;__form_id&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;edition&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;__errorurl&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;http://perdu.com#entityForm&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;__domid&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;entityForm&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;__type:763&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;Ticket&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;eid&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;763&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;__maineid&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;763&quot;</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_cw_edited_fields:763&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span>
            <span class="na">value=</span><span class="s">&quot;concerns-subject,done_in-subject,priority-subject,type-subject,title-subject,description-subject,__type,_cw_generic_field&quot;</span> <span class="nt">/&gt;</span>
     ...
   <span class="nt">&lt;/fieldset&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>The main fieldset encloses a set of hidden fields containing various
metadata, that will be used by the <cite>edit controller</cite> to process it
back correctly.</p>
<p>The <cite>freezeFormButtons(...)</cite> javascript callback defined on the
<tt class="docutils literal"><span class="pre">onlick</span></tt> event of the form element prevents accidental multiple
clicks in a row.</p>
<p>The <tt class="docutils literal"><span class="pre">action</span></tt> of the form is mapped to the <tt class="docutils literal"><span class="pre">validateform</span></tt> controller
(situated in <tt class="xref py py-mod docutils literal"><span class="pre">cubicweb.web.views.basecontrollers</span></tt>).</p>
<p>A full explanation of the validation loop is given in
<a class="reference internal" href="#validation-process"><em>The form validation process</em></a>.</p>
</div>
<div class="section" id="the-attributes-section">
<span id="attributes-section"></span><h3>The attributes section<a class="headerlink" href="#the-attributes-section" title="Permalink to this headline">¶</a></h3>
<p>We can have a look at some of the inner nodes of the form. Some fields
are omitted as they are redundant for our purposes.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;fieldset</span> <span class="na">class=</span><span class="s">&quot;default&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;attributeForm&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">&quot;title_subject_row&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;labelCol&quot;</span><span class="nt">&gt;&lt;label</span> <span class="na">class=</span><span class="s">&quot;required&quot;</span> <span class="na">for=</span><span class="s">&quot;title-subject:763&quot;</span><span class="nt">&gt;</span>title<span class="nt">&lt;/label&gt;&lt;/th&gt;</span>
      <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;title-subject:763&quot;</span> <span class="na">maxlength=</span><span class="s">&quot;128&quot;</span> <span class="na">name=</span><span class="s">&quot;title-subject:763&quot;</span> <span class="na">size=</span><span class="s">&quot;45&quot;</span>
               <span class="na">tabindex=</span><span class="s">&quot;1&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;let us write more doc&quot;</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    ... (description field omitted) ...
    <span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">&quot;priority_subject_row&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;labelCol&quot;</span><span class="nt">&gt;&lt;label</span> <span class="na">class=</span><span class="s">&quot;required&quot;</span> <span class="na">for=</span><span class="s">&quot;priority-subject:763&quot;</span><span class="nt">&gt;</span>priority<span class="nt">&lt;/label&gt;&lt;/th&gt;</span>
      <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;priority-subject:763&quot;</span> <span class="na">name=</span><span class="s">&quot;priority-subject:763&quot;</span> <span class="na">size=</span><span class="s">&quot;1&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;4&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;important&quot;</span><span class="nt">&gt;</span>important<span class="nt">&lt;/option&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">selected=</span><span class="s">&quot;selected&quot;</span> <span class="na">value=</span><span class="s">&quot;normal&quot;</span><span class="nt">&gt;</span>normal<span class="nt">&lt;/option&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;minor&quot;</span><span class="nt">&gt;</span>minor<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;helper&quot;</span><span class="nt">&gt;</span>importance<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    ... (type field omitted) ...
    <span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">&quot;concerns_subject_row&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;labelCol&quot;</span><span class="nt">&gt;&lt;label</span> <span class="na">class=</span><span class="s">&quot;required&quot;</span> <span class="na">for=</span><span class="s">&quot;concerns-subject:763&quot;</span><span class="nt">&gt;</span>concerns<span class="nt">&lt;/label&gt;&lt;/th&gt;</span>
      <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;concerns-subject:763&quot;</span> <span class="na">name=</span><span class="s">&quot;concerns-subject:763&quot;</span> <span class="na">size=</span><span class="s">&quot;1&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;6&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">selected=</span><span class="s">&quot;selected&quot;</span> <span class="na">value=</span><span class="s">&quot;760&quot;</span><span class="nt">&gt;</span>Foo<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;/select&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">&quot;done_in_subject_row&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;labelCol&quot;</span><span class="nt">&gt;&lt;label</span> <span class="na">for=</span><span class="s">&quot;done_in-subject:763&quot;</span><span class="nt">&gt;</span>done in<span class="nt">&lt;/label&gt;&lt;/th&gt;</span>
      <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;done_in-subject:763&quot;</span> <span class="na">name=</span><span class="s">&quot;done_in-subject:763&quot;</span> <span class="na">size=</span><span class="s">&quot;1&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;7&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;__cubicweb_internal_field__&quot;</span><span class="nt">&gt;&lt;/option&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">selected=</span><span class="s">&quot;selected&quot;</span> <span class="na">value=</span><span class="s">&quot;761&quot;</span><span class="nt">&gt;</span>Foo 0.1.0<span class="nt">&lt;/option&gt;</span>
          <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;762&quot;</span><span class="nt">&gt;</span>Foo 0.2.0<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;/select&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;helper&quot;</span><span class="nt">&gt;</span>version in which this ticket will be / has been  done<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/fieldset&gt;</span>
</pre></div>
</div>
<p>Note that the whole form layout has been computed by the form
renderer. It is the renderer which produces the table
structure. Otherwise, the fields html structure is emitted by their
associated widget.</p>
<p>While it is called the <cite>attributes</cite> section of the form, it actually
contains attributes and <em>mandatory relations</em>. For each field, we
observe:</p>
<ul class="simple">
<li>a dedicated row with a specific class, such as <tt class="docutils literal"><span class="pre">title_subject_row</span></tt>
(responsability of the form renderer)</li>
<li>an html widget (input, select, ...) with:<ul>
<li>an id built from the <tt class="docutils literal"><span class="pre">rtype-role:eid</span></tt> pattern</li>
<li>a name built from the same pattern</li>
<li>possible values or preselected options</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="the-relations-section">
<h3>The relations section<a class="headerlink" href="#the-relations-section" title="Permalink to this headline">¶</a></h3>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;fieldset</span> <span class="na">class=</span><span class="s">&quot;This ticket :&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;legend&gt;</span>This ticket :<span class="nt">&lt;/legend&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;attributeForm&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr</span> <span class="na">class=</span><span class="s">&quot;_cw_generic_field_None_row&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">colspan=</span><span class="s">&quot;2&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;table</span> <span class="na">id=</span><span class="s">&quot;relatedEntities&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;tr&gt;&lt;th&gt;</span><span class="ni">&amp;#160;</span><span class="nt">&lt;/th&gt;&lt;td&gt;</span><span class="ni">&amp;#160;</span><span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
          <span class="nt">&lt;tr</span> <span class="na">id=</span><span class="s">&quot;relationSelectorRow_763&quot;</span> <span class="na">class=</span><span class="s">&quot;separator&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;th</span> <span class="na">class=</span><span class="s">&quot;labelCol&quot;</span><span class="nt">&gt;</span>
              <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;relationSelector_763&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;8&quot;</span>
                      <span class="na">onchange=</span><span class="s">&quot;javascript:showMatchingSelect(this.options[this.selectedIndex].value,763);&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>select a relation<span class="nt">&lt;/option&gt;</span>
                <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;appeared_in_subject&quot;</span><span class="nt">&gt;</span>appeared in<span class="nt">&lt;/option&gt;</span>
                <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;custom_workflow_subject&quot;</span><span class="nt">&gt;</span>custom workflow<span class="nt">&lt;/option&gt;</span>
                <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;depends_on_object&quot;</span><span class="nt">&gt;</span>dependency of<span class="nt">&lt;/option&gt;</span>
                <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;depends_on_subject&quot;</span><span class="nt">&gt;</span>depends on<span class="nt">&lt;/option&gt;</span>
                <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;identical_to_subject&quot;</span><span class="nt">&gt;</span>identical to<span class="nt">&lt;/option&gt;</span>
                <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">&quot;see_also_subject&quot;</span><span class="nt">&gt;</span>see also<span class="nt">&lt;/option&gt;</span>
              <span class="nt">&lt;/select&gt;</span>
            <span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;td</span> <span class="na">id=</span><span class="s">&quot;unrelatedDivs_763&quot;</span><span class="nt">&gt;&lt;/td&gt;</span>
          <span class="nt">&lt;/tr&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/fieldset&gt;</span>
</pre></div>
</div>
<p>The optional relations are grouped into a drop-down combo
box. Selection of an item triggers a javascript function which will:</p>
<ul class="simple">
<li>show already related entities in the div of id <cite>relatedentities</cite>
using a two-colown layout, with an action to allow deletion of
individual relations (there are none in this example)</li>
<li>provide a relation selector in the div of id <cite>relationSelector_EID</cite>
to allow the user to set up relations and trigger dynamic action on
the last div</li>
<li>fill the div of id <cite>unrelatedDivs_EID</cite> with a dynamically computed
selection widget allowing direct selection of an unrelated (but
relatable) entity or a switch towards the <cite>search mode</cite> of
<em>CubicWeb</em> which allows full browsing and selection of an entity
using a dedicated action situated in the left column boxes.</li>
</ul>
</div>
<div class="section" id="the-buttons-zone">
<h3>The buttons zone<a class="headerlink" href="#the-buttons-zone" title="Permalink to this headline">¶</a></h3>
<p>Finally comes the buttons zone.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tbody&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">align=</span><span class="s">&quot;center&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;validateButton&quot;</span> <span class="na">tabindex=</span><span class="s">&quot;9&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;validate&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;img</span> <span class="na">alt=</span><span class="s">&quot;OK_ICON&quot;</span> <span class="na">src=</span><span class="s">&quot;http://myapp/datafd8b5d92771209ede1018a8d5da46a37/ok.png&quot;</span> <span class="nt">/&gt;</span>
          validate
        <span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">style=</span><span class="s">&quot;align: right; width: 50%;&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;validateButton&quot;</span>
                <span class="na">onclick=</span><span class="s">&quot;postForm(&amp;#39;__action_apply&amp;#39;, &amp;#39;button_apply&amp;#39;, &amp;#39;entityForm&amp;#39;)&quot;</span>
                <span class="na">tabindex=</span><span class="s">&quot;10&quot;</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">value=</span><span class="s">&quot;apply&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;img</span> <span class="na">alt=</span><span class="s">&quot;APPLY_ICON&quot;</span> <span class="na">src=</span><span class="s">&quot;http://myapp/datafd8b5d92771209ede1018a8d5da46a37/plus.png&quot;</span> <span class="nt">/&gt;</span>
          apply
        <span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">&quot;validateButton&quot;</span>
                <span class="na">onclick=</span><span class="s">&quot;postForm(&amp;#39;__action_cancel&amp;#39;, &amp;#39;button_cancel&amp;#39;, &amp;#39;entityForm&amp;#39;)&quot;</span>
                <span class="na">tabindex=</span><span class="s">&quot;11&quot;</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">value=</span><span class="s">&quot;cancel&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;img</span> <span class="na">alt=</span><span class="s">&quot;CANCEL_ICON&quot;</span> <span class="na">src=</span><span class="s">&quot;http://myapp/datafd8b5d92771209ede1018a8d5da46a37/cancel.png&quot;</span> <span class="nt">/&gt;</span>
          cancel
        <span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div>
<p>The most notable artifacts here are the <tt class="docutils literal"><span class="pre">postForm(...)</span></tt> calls
defined on click events on these buttons. This function basically
submits the form.</p>
</div>
</div>
</div>
<div class="section" id="the-form-validation-process">
<span id="validation-process"></span><h1>The form validation process<a class="headerlink" href="#the-form-validation-process" title="Permalink to this headline">¶</a></h1>
<div class="section" id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>After the (html) document is loaded, the <tt class="docutils literal"><span class="pre">setFormsTarget</span></tt> javascript
function dynamically transforms the DOM as follows. For all forms of
the DOM, it:</p>
<ul class="simple">
<li>sets the <tt class="docutils literal"><span class="pre">target</span></tt> attribute where there is a <tt class="docutils literal"><span class="pre">cubicweb:target</span></tt>
attribute (with the same value)</li>
<li>appends an empty <cite>IFRAME</cite> element at the end</li>
</ul>
<p>Let us have a look again at the form element. We have omitted some
irrelevant attributes.</p>
</div>
<div class="section" id="validation-loop">
<h2>Validation loop<a class="headerlink" href="#validation-loop" title="Permalink to this headline">¶</a></h2>
<p>On form submission, the form.action is invoked. Basically, the
<tt class="docutils literal"><span class="pre">validateform</span></tt> controller is called and its output lands in the
specified <tt class="docutils literal"><span class="pre">target</span></tt>, the iframe that was previously prepared.</p>
<p>Hence, the main page is not replaced, only the iframe contents. The
<tt class="docutils literal"><span class="pre">validateform</span></tt> controller only outputs a tiny javascript fragment
which is then immediately executed.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;iframe</span> <span class="na">width=</span><span class="s">&quot;0px&quot;</span> <span class="na">height=</span><span class="s">&quot;0px&quot;</span> <span class="na">name=</span><span class="s">&quot;eformframe&quot;</span> <span class="na">id=</span><span class="s">&quot;eformframe&quot;</span> <span class="na">src=</span><span class="s">&quot;javascript: void(0)&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">handleFormValidationResponse</span><span class="p">(</span><span class="s1">&#39;entityForm&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                                               <span class="p">[</span><span class="kc">false</span><span class="p">,</span> <span class="p">[</span><span class="mi">2164</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name-subject&quot;</span><span class="o">:</span> <span class="s2">&quot;required field&quot;</span><span class="p">}],</span> <span class="kc">null</span><span class="p">],</span>
                                               <span class="kc">null</span><span class="p">);</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/iframe&gt;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">window.parent</span></tt> part ensures the javascript function is called
on the right context (that is: the form element). We will describe its
parameters:</p>
<ul class="simple">
<li>first comes the form id (<cite>entityForm</cite>)</li>
<li>then two optional callbacks for the success and failure case</li>
<li>an array containing:<ul>
<li>a boolean which indicates status (success or failure), and then, on error:<ul>
<li>an array structured as <tt class="docutils literal"><span class="pre">[eid,</span> <span class="pre">{'rtype-role':</span> <span class="pre">'error</span> <span class="pre">msg'},</span> <span class="pre">...]</span></tt></li>
</ul>
</li>
<li>on success:<ul>
<li>an url (string) representing the next thing to jump to</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Given the array structure described above, it is quite simple to
manipulate the DOM to show the errors at appropriate places.</p>
</div>
<div class="section" id="explanation">
<h2>Explanation<a class="headerlink" href="#explanation" title="Permalink to this headline">¶</a></h2>
<p>This mecanism may seem a bit overcomplicated but we have to deal with
two realities:</p>
<ul class="simple">
<li>in the (strict) XHTML world, there are no iframes (hence the dynamic
inclusion, tolerated by Firefox)</li>
<li>no (or not all) browser(s) support file input field handling through
ajax.</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="editcontroller.html" title="The edit controller"
             >next</a> |</li>
        <li class="right" >
          <a href="form.html" title="HTML form construction"
             >previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Web side development</a> &raquo;</li>
          <li><a href="index.html" >Edition control</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>