
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Examples &mdash; CubicWeb 3.18.3</title>
    
    <link rel="stylesheet" href="../../_static/lglb-sphinx-doc.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.18.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="CubicWeb 3.18.3" href="../../index.html" />
    <link rel="up" title="Edition control" href="index.html" />
    <link rel="next" title="The facets system" href="../facets.html" />
    <link rel="prev" title="The edit controller" href="editcontroller.html" /> 
  </head>
  <body>
<div class="header">
 <a href="http://www.cubicweb.org">
  <img alt="cubicweb logo" src="../../_static/cubicweb.png"/>
 </a>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../facets.html" title="The facets system"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="editcontroller.html" title="The edit controller"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Web side development</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Edition control</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Examples</a><ul>
<li><a class="reference internal" href="#automatic-entity-form">(Automatic) Entity form</a></li>
<li><a class="reference internal" href="#ad-hoc-fields-form">Ad-hoc fields form</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="editcontroller.html"
                        title="previous chapter">The <cite>edit controller</cite></a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../facets.html"
                        title="next chapter">The facets system</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/devweb/edition/examples.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h1>
<div class="section" id="automatic-entity-form">
<h2>(Automatic) Entity form<a class="headerlink" href="#automatic-entity-form" title="Permalink to this headline">¶</a></h2>
<p>Looking at some cubes available on the <a class="reference external" href="http://www.cubicweb.org/view?rql=Any+P+ORDERBY+N+WHERE+P+name+LIKE+%22cubicweb-%25%22%2C+P+is+Project%2C+P+name+N">cubicweb forge</a> we find some
with form manipulation. The following example comes from the the
<a class="reference external" href="http://www.cubicweb.org/project/cubicweb-conference">conference</a> cube. It extends the change state form for the case
where a <tt class="docutils literal"><span class="pre">Talk</span></tt> entity is getting into <tt class="docutils literal"><span class="pre">submitted</span></tt> state. The goal
is to select reviewers for the submitted talk.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cubicweb.web</span> <span class="kn">import</span> <span class="n">formfields</span> <span class="k">as</span> <span class="n">ff</span><span class="p">,</span> <span class="n">formwidgets</span> <span class="k">as</span> <span class="n">fwdgs</span>
<span class="k">class</span> <span class="nc">SendToReviewerStatusChangeView</span><span class="p">(</span><span class="n">ChangeStateFormView</span><span class="p">):</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="p">(</span><span class="n">ChangeStateFormView</span><span class="o">.</span><span class="n">__select__</span> <span class="o">&amp;</span>
                  <span class="n">is_instance</span><span class="p">(</span><span class="s">&#39;Talk&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="n">rql_condition</span><span class="p">(</span><span class="s">&#39;X in_state S, S name &quot;submitted&quot;&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SendToReviewerStatusChangeView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_form</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">relation</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">RelationField</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;reviews&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s">&#39;object&#39;</span><span class="p">,</span>
                                    <span class="n">eidparam</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;select reviewers&#39;</span><span class="p">),</span>
                                    <span class="n">widget</span><span class="o">=</span><span class="n">fwdgs</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">multiple</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">form</span><span class="o">.</span><span class="n">append_field</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">form</span>
</pre></div>
</div>
<p>Simple extension of a form can be done from within the <cite>FormView</cite>
wrapping the form. FormView instances have a handy <tt class="docutils literal"><span class="pre">get_form</span></tt> method
that returns the form to be rendered. Here we add a <tt class="docutils literal"><span class="pre">RelationField</span></tt>
to the base state change form.</p>
<p>One notable point is the <tt class="docutils literal"><span class="pre">eidparam</span></tt> argument: it tells both the
field and the <tt class="docutils literal"><span class="pre">edit</span> <span class="pre">controller</span></tt> that the field is linked to a
specific entity.</p>
<p>It is hence entirely possible to add ad-hoc fields that will be
processed by some specialized instance of the edit controller.</p>
</div>
<div class="section" id="ad-hoc-fields-form">
<h2>Ad-hoc fields form<a class="headerlink" href="#ad-hoc-fields-form" title="Permalink to this headline">¶</a></h2>
<p>We want to define a form doing something else than editing an entity. The idea is
to propose a form to send an email to entities in a resultset which implements
<tt class="xref py py-class docutils literal"><span class="pre">IEmailable</span></tt>.  Let&#8217;s take a simplified version of what you&#8217;ll find in
<tt class="xref py py-mod docutils literal"><span class="pre">cubicweb.web.views.massmailing</span></tt>.</p>
<p>Here is the source code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sender_value</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">dc_title</span><span class="p">(),</span> <span class="n">form</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_email</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">recipient_choices</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">e</span><span class="o">.</span><span class="n">get_email</span><span class="p">(),</span> <span class="n">e</span><span class="o">.</span><span class="n">eid</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cw_rset</span><span class="o">.</span><span class="n">entities</span><span class="p">()</span>
             <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get_email</span><span class="p">()]</span>

<span class="k">def</span> <span class="nf">recipient_value</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">eid</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">cw_rset</span><span class="o">.</span><span class="n">entities</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get_email</span><span class="p">()]</span>

<span class="k">class</span> <span class="nc">MassMailingForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">FieldsForm</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;massmailing&#39;</span>

    <span class="n">needs_js</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;cubicweb.widgets.js&#39;</span><span class="p">,)</span>
    <span class="n">domid</span> <span class="o">=</span> <span class="s">&#39;sendmail&#39;</span>
    <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;sendmail&#39;</span>

    <span class="n">sender</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">TextInput</span><span class="p">({</span><span class="s">&#39;disabled&#39;</span><span class="p">:</span> <span class="s">&#39;disabled&#39;</span><span class="p">}),</span>
                            <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;From:&#39;</span><span class="p">),</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">sender_value</span><span class="p">)</span>

    <span class="n">recipient</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">CheckBox</span><span class="p">(),</span>
                               <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Recipients:&#39;</span><span class="p">),</span>
                               <span class="n">choices</span><span class="o">=</span><span class="n">recipient_choices</span><span class="p">,</span>
                               <span class="n">value</span><span class="o">=</span><span class="n">recipients_value</span><span class="p">)</span>

    <span class="n">subject</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Subject:&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>

    <span class="n">mailbody</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">StringField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">AjaxWidget</span><span class="p">(</span><span class="n">wdgtype</span><span class="o">=</span><span class="s">&#39;TemplateTextField&#39;</span><span class="p">,</span>
                                                <span class="n">inputid</span><span class="o">=</span><span class="s">&#39;mailbody&#39;</span><span class="p">))</span>

    <span class="n">form_buttons</span> <span class="o">=</span> <span class="p">[</span><span class="n">ImgButton</span><span class="p">(</span><span class="s">&#39;sendbutton&#39;</span><span class="p">,</span> <span class="s">&quot;javascript: $(&#39;#sendmail&#39;).submit()&quot;</span><span class="p">,</span>
                              <span class="n">_</span><span class="p">(</span><span class="s">&#39;send email&#39;</span><span class="p">),</span> <span class="s">&#39;SEND_EMAIL_ICON&#39;</span><span class="p">),</span>
                    <span class="n">ImgButton</span><span class="p">(</span><span class="s">&#39;cancelbutton&#39;</span><span class="p">,</span> <span class="s">&quot;javascript: history.back()&quot;</span><span class="p">,</span>
                              <span class="n">stdmsgs</span><span class="o">.</span><span class="n">BUTTON_CANCEL</span><span class="p">,</span> <span class="s">&#39;CANCEL_EMAIL_ICON&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>Let&#8217;s detail what&#8217;s going on up there. Our form will hold four fields:</p>
<ul class="simple">
<li>a sender field, which is disabled and will simply contains the user&#8217;s name and
email</li>
<li>a recipients field, which will be displayed as a list of users in the context
result set with checkboxes so user can still choose who will receive his mailing
by checking or not the checkboxes. By default all of them will be checked since
field&#8217;s value return a list containing same eids as those returned by the
vocabulary function.</li>
<li>a subject field, limited to 256 characters (hence we know a
<a class="reference internal" href="form.html#cubicweb.web.formwidgets.TextInput" title="cubicweb.web.formwidgets.TextInput"><tt class="xref py py-class docutils literal"><span class="pre">TextInput</span></tt></a> will be used, as explained in
<a class="reference internal" href="form.html#cubicweb.web.formfields.StringField" title="cubicweb.web.formfields.StringField"><tt class="xref py py-class docutils literal"><span class="pre">StringField</span></tt></a>)</li>
<li>a mailbody field. This field use an ajax widget, defined in <cite>cubicweb.widgets.js</cite>,
and whose definition won&#8217;t be shown here. Notice though that we tell this form
need this javascript file by using <cite>needs_js</cite></li>
</ul>
<p>Last but not least, we add two buttons control: one to post the form using
javascript (<cite>$(&#8216;#sendmail&#8217;)</cite> being the jQuery call to get the element with DOM id
set to &#8216;sendmail&#8217;, which is our form DOM id as specified by its <cite>domid</cite>
attribute), another to cancel the form which will go back to the previous page
using another javascript call. Also we specify an image to use as button icon as a
resource identifier (see <a class="reference internal" href="../../tutorials/advanced/part05_ui-advanced.html#uiprops"><em>Step 1: tired of the default look?</em></a>) given as last argument to
<a class="reference internal" href="form.html#cubicweb.web.formwidgets.ImgButton" title="cubicweb.web.formwidgets.ImgButton"><tt class="xref py py-class docutils literal"><span class="pre">cubicweb.web.formwidgets.ImgButton</span></tt></a>.</p>
<p>To see this form, we still have to wrap it in a view. This is pretty simple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MassMailingFormView</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">FormViewMixIn</span><span class="p">,</span> <span class="n">EntityView</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;massmailing&#39;</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="n">is_instance</span><span class="p">(</span><span class="n">IEmailable</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">authenticated_user</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">vreg</span><span class="p">[</span><span class="s">&#39;forms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;massmailing&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="p">,</span>
                                             <span class="n">rset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cw_rset</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
</pre></div>
</div>
<p>As you see, we simply define a view with proper selector so it only apply to a
result set containing <tt class="xref py py-class docutils literal"><span class="pre">IEmailable</span></tt> entities, and so that only users in the
managers or users group can use it. Then in the <cite>call()</cite> method for this view we
simply select the above form and call its <cite>.render()</cite> method with our output
stream as argument.</p>
<p>When this form is submitted, a controller with id &#8216;sendmail&#8217; will be called (as
specified using <cite>action</cite>). This controller will be responsible to actually send
the mail to specified recipients.</p>
<p>Here is what it looks like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SendMailController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;sendmail&#39;</span>
    <span class="n">__select__</span> <span class="o">=</span> <span class="p">(</span><span class="n">authenticated_user</span><span class="p">()</span> <span class="o">&amp;</span>
                  <span class="n">match_form_params</span><span class="p">(</span><span class="s">&#39;recipient&#39;</span><span class="p">,</span> <span class="s">&#39;mailbody&#39;</span><span class="p">,</span> <span class="s">&#39;subject&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;mailbody&#39;</span><span class="p">]</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;subject&#39;</span><span class="p">]</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;recipient&#39;</span><span class="p">]</span>
        <span class="c"># eids may be a string if only one recipient was specified</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eids</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">rset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;Any X WHERE X eid </span><span class="si">%(x)s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="n">eids</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;Any X WHERE X eid in (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">eids</span><span class="p">)))</span>
        <span class="n">recipients</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rset</span><span class="o">.</span><span class="n">entities</span><span class="p">())</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">format_mail</span><span class="p">({</span><span class="s">&#39;email&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_email</span><span class="p">(),</span>
                           <span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">dc_title</span><span class="p">()},</span>
                          <span class="n">recipients</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">vreg</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sendmails</span><span class="p">([(</span><span class="n">msg</span><span class="p">,</span> <span class="n">recipients</span><span class="p">)]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;could not connect to the SMTP server&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;emails successfully sent&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">Redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cw</span><span class="o">.</span><span class="n">build_url</span><span class="p">(</span><span class="n">__message</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>
</pre></div>
</div>
<p>The entry point of a controller is the publish method. In that case we simply get
back post values in request&#8217;s <cite>form</cite> attribute, get user instances according
to eids found in the &#8216;recipient&#8217; form value, and send email after calling
<tt class="xref py py-func docutils literal"><span class="pre">format_mail()</span></tt> to get a proper email message. If we can&#8217;t send email or
if we successfully sent email, we redirect to the index page with proper message
to inform the user.</p>
<p>Also notice that our controller has a selector that deny access to it
to anonymous users (we don&#8217;t want our instance to be used as a spam
relay), but also checks if the expected parameters are specified in
forms. That avoids later defensive programming (though it&#8217;s not enough
to handle all possible error cases).</p>
<p>To conclude our example, suppose we wish a different form layout and that existent
renderers are not satisfying (we would check that first of course :). We would then
have to define our own renderer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MassMailingFormRenderer</span><span class="p">(</span><span class="n">formrenderers</span><span class="o">.</span><span class="n">FormRenderer</span><span class="p">):</span>
    <span class="n">__regid__</span> <span class="o">=</span> <span class="s">&#39;massmailing&#39;</span>

    <span class="k">def</span> <span class="nf">_render_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;table class=&quot;headersform&quot;&gt;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;mailbody&#39;</span><span class="p">:</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;/table&gt;&#39;</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;div id=&quot;toolbar&quot;&gt;&#39;</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;ul&gt;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">form_buttons</span><span class="p">:</span>
                    <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;li&gt;</span><span class="si">%s</span><span class="s">&lt;/li&gt;&#39;</span> <span class="o">%</span> <span class="n">button</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">form</span><span class="p">))</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;/ul&gt;&#39;</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;/div&gt;&#39;</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;div&gt;&#39;</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;/div&gt;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;tr&gt;&#39;</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;td class=&quot;hlabel&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/td&gt;&#39;</span> <span class="o">%</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">render_label</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;td class=&quot;hvalue&quot;&gt;&#39;</span><span class="p">)</span>
                <span class="n">w</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                <span class="n">w</span><span class="p">(</span><span class="s">u&#39;&lt;/td&gt;&lt;/tr&gt;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_buttons</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>We simply override the <cite>_render_fields</cite> and <cite>render_buttons</cite> method of the base form renderer
to arrange fields as we desire it: here we&#8217;ll have first a two columns table with label and
value of the sender, recipients and subject field (form order respected), then form controls,
then a div containing the textarea for the email&#8217;s content.</p>
<p>To bind this renderer to our form, we should add to our form definition above:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">form_renderer_id</span> <span class="o">=</span> <span class="s">&#39;massmailing&#39;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../facets.html" title="The facets system"
             >next</a> |</li>
        <li class="right" >
          <a href="editcontroller.html" title="The edit controller"
             >previous</a> |</li>
        <li><a href="../../index.html">CubicWeb 3.18.3</a> &raquo;</li>
          <li><a href="../index.html" >Web side development</a> &raquo;</li>
          <li><a href="index.html" >Edition control</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2001-2014, Logilab.
      Last updated on Mar 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>