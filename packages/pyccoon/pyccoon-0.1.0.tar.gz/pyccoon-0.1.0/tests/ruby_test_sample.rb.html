<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>tests documentation: ruby_test_sample.rb</title>
  <link rel="stylesheet" href="./pyccoon.css">
</head>
<body>
<div id='container'>
  <a id="top"></a>
  <div id="background"></div>
  <div id="footer">
    <a class="btn" id="project-name" href="./index.html">tests documentation</a>
    <a class="btn" class="source source-1" href="#top">Back to top</a>
    <div class="generation-time">
        Generated at
        <a target="_blank" href="http://ckald.github.io/pyccoon/" title="Pyccoon: side-to-side documentation generator">
            <img id="pyccoon-icon" src="./pyccoon_icon.svg" alt="Pyccoon: side-to-side documentation generator" /></a>
        <code>2014-09-07 16:00:53.363055</code>/
        by a diligent
        <a target="_blank" href="http://ckald.github.io/pyccoon/" title="Pyccoon: side-to-side documentation generator">pyccoon</a>
    </div>
  </div>
  <div class='section'>
    <div class='docs'>
      <h1 id="breadcrumbs">/ <a href="ruby_test_sample.rb.html/../index.html">.</a> / <a href="ruby_test_sample.rb.html">ruby_test_sample.rb</a> </h1>
      <ul id="children"></ul>
    </div>
  </div>
  <div class='clearall'>
  <div class='section'>
    <a id="section-0" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-0'>#</a>
          </div>
          <p>Disclaimer: this is a modified sample of Ruby code that is used for Pyccoon testing.</p>
        </div>
        <div class='code'>
          
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-1" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-1'>#</a>
          </div>
          <p>Title: Jekyll Image Tag
Authors: Rob Wierzbowski : @robwierzbowski</p>
<p>Description: Better images for Jekyll.</p>
<p>Download: <a href="https://github.com/robwierzbowski/jekyll-image-tag">https://github.com/robwierzbowski/jekyll-image-tag</a>
Documentation: <a href="https://github.com/robwierzbowski/jekyll-image-tag/readme.md">https://github.com/robwierzbowski/jekyll-image-tag/readme.md</a>
Issues: <a href="https://github.com/robwierzbowski/jekyll-image-tag/issues">https://github.com/robwierzbowski/jekyll-image-tag/issues</a></p>
<dl>
<dt>Syntax</dt>
<dd>{% image [preset or WxH] path/to/img.jpg [attr="value"] %}</dd>
</dl>
<p>Example: {% image poster.jpg alt="The strange case of Dr. Jekyll" %}
         {% image gallery poster.jpg alt="The strange case of Dr. Jekyll" class="gal-img" data-selected %}
         {% image 350xAUTO poster.jpg alt="The strange case of Dr. Jekyll" class="gal-img" data-selected %}</p>
<p>See the documentation for full configuration and usage instructions.</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;fileutils&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;pathname&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;digest/md5&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;mini_magick&#39;</span>

<span class="o">&lt;&lt;-</span><span class="no">DOC</span>
<span class="sh">Also, you could create a docstring.</span>
<span class="sh">which...</span>
<span class="no">DOC</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-2" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-2'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre><span class="k">module</span> <span class="nn">Jekyll</span>

  <span class="k">class</span> <span class="nc">Image</span> <span class="o">&lt;</span> <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Tag</span>

    <span class="s2">&quot; ..is kinda ugly and creates</span>
<span class="s2">      a String instance, but I know one guy</span>
<span class="s2">      with a Smalltalk background, who</span>
<span class="s2">      does this.&quot;</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-3" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-3'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="n">markup</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
      <span class="vi">@markup</span> <span class="o">=</span> <span class="n">markup</span>
      <span class="k">super</span>
    <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-4" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-4'>#</a>
          </div>
          <p>Render any liquid variables in tag arguments and unescape template code</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

      <span class="n">render_markup</span> <span class="o">=</span> <span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Template</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="vi">@markup</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\\\{\\\{|\\\{\\%/</span><span class="p">,</span> <span class="s1">&#39;\{\{&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;{{&#39;</span><span class="p">,</span> <span class="s1">&#39;\{\%&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;{%&#39;</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-5" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-5'>#</a>
          </div>
          <p>Gather settings</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="n">site</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">registers</span><span class="o">[</span><span class="ss">:site</span><span class="o">]</span>
      <span class="n">settings</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="o">[</span><span class="s1">&#39;image&#39;</span><span class="o">]</span>
      <span class="n">markup</span> <span class="o">=</span> <span class="sr">/^(?:(?&lt;url_only&gt;url)\s+)?(?:(?&lt;preset&gt;[^\s.:\/]+)\s+)?(?&lt;image_src&gt;[^\s]+\.[a-zA-Z0-9]{3,4})\s*(?&lt;html_attr&gt;[\s\S]+)?$/</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">render_markup</span><span class="p">)</span>
      <span class="n">preset</span> <span class="o">=</span> <span class="n">settings</span><span class="o">[</span><span class="s1">&#39;presets&#39;</span><span class="o">][</span> <span class="n">markup</span><span class="o">[</span><span class="ss">:preset</span><span class="o">]</span> <span class="o">]</span>
      <span class="n">url_only</span> <span class="o">=</span> <span class="n">markup</span><span class="o">[</span><span class="ss">:url_only</span><span class="o">]</span>

      <span class="k">raise</span> <span class="s2">&quot;Image Tag can&#39;t read this tag. Try {% image [preset or WxH] path/to/img.jpg [attr=</span><span class="se">\&quot;</span><span class="s2">value</span><span class="se">\&quot;</span><span class="s2">] %}.&quot;</span> <span class="k">unless</span> <span class="n">markup</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-6" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-6'>#</a>
          </div>
          <p>Assign defaults</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="n">settings</span><span class="o">[</span><span class="s1">&#39;source&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;.&#39;</span>
      <span class="n">settings</span><span class="o">[</span><span class="s1">&#39;output&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;generated&#39;</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-7" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-7'>#</a>
          </div>
          <p>Prevent Jekyll from erasing our generated files</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="o">[</span><span class="s1">&#39;keep_files&#39;</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">settings</span><span class="o">[</span><span class="s1">&#39;output&#39;</span><span class="o">]</span> <span class="k">unless</span> <span class="n">site</span><span class="o">.</span><span class="n">config</span><span class="o">[</span><span class="s1">&#39;keep_files&#39;</span><span class="o">].</span><span class="n">include?</span><span class="p">(</span><span class="n">settings</span><span class="o">[</span><span class="s1">&#39;output&#39;</span><span class="o">]</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-8" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-8'>#</a>
          </div>
          <p>Process instance</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="n">instance</span> <span class="o">=</span> <span class="k">if</span> <span class="n">preset</span>
        <span class="p">{</span>
          <span class="ss">:width</span> <span class="o">=&gt;</span> <span class="n">preset</span><span class="o">[</span><span class="s1">&#39;width&#39;</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:height</span> <span class="o">=&gt;</span> <span class="n">preset</span><span class="o">[</span><span class="s1">&#39;height&#39;</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:src</span> <span class="o">=&gt;</span> <span class="n">markup</span><span class="o">[</span><span class="ss">:image_src</span><span class="o">]</span>
        <span class="p">}</span>
      <span class="k">elsif</span> <span class="n">dim</span> <span class="o">=</span> <span class="sr">/^(?:(?&lt;width&gt;\d+)|auto)(?:x)(?:(?&lt;height&gt;\d+)|auto)$/i</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">markup</span><span class="o">[</span><span class="ss">:preset</span><span class="o">]</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="ss">:width</span> <span class="o">=&gt;</span> <span class="n">dim</span><span class="o">[</span><span class="s1">&#39;width&#39;</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:height</span> <span class="o">=&gt;</span> <span class="n">dim</span><span class="o">[</span><span class="s1">&#39;height&#39;</span><span class="o">]</span><span class="p">,</span>
          <span class="ss">:src</span> <span class="o">=&gt;</span> <span class="n">markup</span><span class="o">[</span><span class="ss">:image_src</span><span class="o">]</span>
        <span class="p">}</span>
      <span class="k">else</span>
        <span class="p">{</span> <span class="ss">:src</span> <span class="o">=&gt;</span> <span class="n">markup</span><span class="o">[</span><span class="ss">:image_src</span><span class="o">]</span> <span class="p">}</span>
      <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-9" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-9'>#</a>
          </div>
          <p>Process html attributes</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="n">html_attr</span> <span class="o">=</span> <span class="k">if</span> <span class="n">markup</span><span class="o">[</span><span class="ss">:html_attr</span><span class="o">]</span>
        <span class="no">Hash</span><span class="o">[</span> <span class="o">*</span><span class="n">markup</span><span class="o">[</span><span class="ss">:html_attr</span><span class="o">].</span><span class="n">scan</span><span class="p">(</span><span class="sr">/(?&lt;attr&gt;[^\s=&quot;]+)(?:=&quot;(?&lt;value&gt;[^&quot;]+)&quot;)?\s?/</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span> <span class="o">]</span>
      <span class="k">else</span>
        <span class="p">{}</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">preset</span> <span class="o">&amp;&amp;</span> <span class="n">preset</span><span class="o">[</span><span class="s1">&#39;attr&#39;</span><span class="o">]</span>
        <span class="n">html_attr</span> <span class="o">=</span> <span class="n">preset</span><span class="o">[</span><span class="s1">&#39;attr&#39;</span><span class="o">].</span><span class="n">merge</span><span class="p">(</span><span class="n">html_attr</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">html_attr_string</span> <span class="o">=</span> <span class="n">html_attr</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">string</span><span class="p">,</span> <span class="n">attrs</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
          <span class="n">string</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">attrs</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">=</span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">attrs</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
        <span class="k">else</span>
          <span class="n">string</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">attrs</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">end</span>
      <span class="p">}</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-10" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-10'>#</a>
          </div>
          <p>Raise some exceptions before we start expensive processing</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="k">raise</span> <span class="s2">&quot;Image Tag can&#39;t find the </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">markup</span><span class="o">[</span><span class="ss">:preset</span><span class="o">]</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> preset. Check image: presets in _config.yml for a list of presets.&quot;</span> <span class="k">unless</span> <span class="n">preset</span> <span class="o">||</span> <span class="n">dim</span> <span class="o">||</span>  <span class="n">markup</span><span class="o">[</span><span class="ss">:preset</span><span class="o">].</span><span class="n">nil?</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-11" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-11'>#</a>
          </div>
          <p>Generate resized images</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="n">generated_src</span> <span class="o">=</span> <span class="n">generate_image</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">site</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">settings</span><span class="o">[</span><span class="s1">&#39;source&#39;</span><span class="o">]</span><span class="p">,</span> <span class="n">settings</span><span class="o">[</span><span class="s1">&#39;output&#39;</span><span class="o">]</span><span class="p">)</span>
      <span class="k">unless</span> <span class="n">generated_src</span>
        <span class="k">return</span>
      <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-12" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-12'>#</a>
          </div>
          <p>Return the markup!</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="k">if</span> <span class="n">url_only</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">generated_src</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;img src=</span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">site</span><span class="o">.</span><span class="n">baseurl</span><span class="si">}#{</span><span class="n">generated_src</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2"> </span><span class="si">#{</span><span class="n">html_attr_string</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
      <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-13" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-13'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-14" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-14'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_image</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">site_source</span><span class="p">,</span> <span class="n">site_dest</span><span class="p">,</span> <span class="n">image_source</span><span class="p">,</span> <span class="n">image_dest</span><span class="p">)</span>

      <span class="n">image_source_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">site_source</span><span class="p">,</span> <span class="n">image_source</span><span class="p">,</span> <span class="n">instance</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span><span class="p">)</span>
      <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?image_source_path</span>
        <span class="nb">puts</span> <span class="s2">&quot;Missing: </span><span class="si">#{</span><span class="n">image_source_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="kp">false</span>
      <span class="k">end</span>

      <span class="n">image</span> <span class="o">=</span> <span class="ss">MiniMagick</span><span class="p">:</span><span class="ss">:Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_source_path</span><span class="p">)</span>
      <span class="n">digest</span> <span class="o">=</span> <span class="ss">Digest</span><span class="p">:</span><span class="ss">:MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">to_blob</span><span class="o">.</span><span class="n">slice!</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">10000</span><span class="p">))</span><span class="o">.</span><span class="n">slice!</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span>

      <span class="n">image_dir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">instance</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span><span class="p">)</span>
      <span class="n">ext</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">extname</span><span class="p">(</span><span class="n">instance</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span><span class="p">)</span>
      <span class="n">basename</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">instance</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

      <span class="n">orig_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">[</span><span class="ss">:width</span><span class="o">].</span><span class="n">to_f</span>
      <span class="n">orig_height</span> <span class="o">=</span> <span class="n">image</span><span class="o">[</span><span class="ss">:height</span><span class="o">].</span><span class="n">to_f</span>
      <span class="n">orig_ratio</span> <span class="o">=</span> <span class="n">orig_width</span><span class="o">/</span><span class="n">orig_height</span>

      <span class="n">gen_width</span> <span class="o">=</span> <span class="k">if</span> <span class="n">instance</span><span class="o">[</span><span class="ss">:width</span><span class="o">]</span>
        <span class="n">instance</span><span class="o">[</span><span class="ss">:width</span><span class="o">].</span><span class="n">to_f</span>
      <span class="k">elsif</span> <span class="n">instance</span><span class="o">[</span><span class="ss">:height</span><span class="o">]</span>
        <span class="n">orig_ratio</span> <span class="o">*</span> <span class="n">instance</span><span class="o">[</span><span class="ss">:height</span><span class="o">].</span><span class="n">to_f</span>
      <span class="k">else</span>
        <span class="n">orig_width</span>
      <span class="k">end</span>
      <span class="n">gen_height</span> <span class="o">=</span> <span class="k">if</span> <span class="n">instance</span><span class="o">[</span><span class="ss">:height</span><span class="o">]</span>
        <span class="n">instance</span><span class="o">[</span><span class="ss">:height</span><span class="o">].</span><span class="n">to_f</span>
      <span class="k">elsif</span> <span class="n">instance</span><span class="o">[</span><span class="ss">:width</span><span class="o">]</span>
        <span class="n">instance</span><span class="o">[</span><span class="ss">:width</span><span class="o">].</span><span class="n">to_f</span> <span class="o">/</span> <span class="n">orig_ratio</span>
      <span class="k">else</span>
        <span class="n">orig_height</span>
      <span class="k">end</span>
      <span class="n">gen_ratio</span> <span class="o">=</span> <span class="n">gen_width</span><span class="o">/</span><span class="n">gen_height</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-15" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-15'>#</a>
          </div>
          <p>Don't allow upscaling. If the image is smaller than the requested dimensions, recalculate.</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="k">if</span> <span class="n">orig_width</span> <span class="o">&lt;</span> <span class="n">gen_width</span> <span class="o">||</span> <span class="n">orig_height</span> <span class="o">&lt;</span> <span class="n">gen_height</span>
        <span class="n">undersize</span> <span class="o">=</span> <span class="kp">true</span>
        <span class="n">gen_width</span> <span class="o">=</span> <span class="k">if</span> <span class="n">orig_ratio</span> <span class="o">&lt;</span> <span class="n">gen_ratio</span> <span class="k">then</span> <span class="n">orig_width</span> <span class="k">else</span> <span class="n">orig_height</span> <span class="o">*</span> <span class="n">gen_ratio</span> <span class="k">end</span>
        <span class="n">gen_height</span> <span class="o">=</span> <span class="k">if</span> <span class="n">orig_ratio</span> <span class="o">&gt;</span> <span class="n">gen_ratio</span> <span class="k">then</span> <span class="n">orig_height</span> <span class="k">else</span> <span class="n">orig_width</span><span class="o">/</span><span class="n">gen_ratio</span> <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">gen_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">basename</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">gen_width</span><span class="o">.</span><span class="n">round</span><span class="si">}</span><span class="s2">x</span><span class="si">#{</span><span class="n">gen_height</span><span class="o">.</span><span class="n">round</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">digest</span><span class="si">}#{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">gen_dest_dir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">site_dest</span><span class="p">,</span> <span class="n">image_dest</span><span class="p">,</span> <span class="n">image_dir</span><span class="p">)</span>
      <span class="n">gen_dest_file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gen_dest_dir</span><span class="p">,</span> <span class="n">gen_name</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-16" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-16'>#</a>
          </div>
          <p>Generate resized files</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">gen_dest_file</span><span class="p">)</span>

        <span class="nb">warn</span> <span class="s2">&quot;Warning:&quot;</span><span class="o">.</span><span class="n">yellow</span> <span class="o">+</span> <span class="s2">&quot; </span><span class="si">#{</span><span class="n">instance</span><span class="o">[</span><span class="ss">:src</span><span class="o">]</span><span class="si">}</span><span class="s2"> is smaller than the requested output file. It will be resized without upscaling.&quot;</span> <span class="k">if</span> <span class="n">undersize</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-17" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-17'>#</a>
          </div>
          <p>If the destination directory doesn't exist, create it</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="n">gen_dest_dir</span><span class="p">)</span> <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">gen_dest_dir</span><span class="p">)</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-18" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-18'>#</a>
          </div>
          <p>Let people know their images are being generated</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="nb">puts</span> <span class="s2">&quot;Generating </span><span class="si">#{</span><span class="n">gen_name</span><span class="si">}</span><span class="s2">&quot;</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-19" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-19'>#</a>
          </div>
          <p>Scale and crop</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>        <span class="n">image</span><span class="o">.</span><span class="n">combine_options</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
          <span class="n">i</span><span class="o">.</span><span class="n">resize</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_width</span><span class="si">}</span><span class="s2">x</span><span class="si">#{</span><span class="n">gen_height</span><span class="si">}</span><span class="s2">^&quot;</span>
          <span class="n">i</span><span class="o">.</span><span class="n">gravity</span> <span class="s2">&quot;center&quot;</span>
          <span class="n">i</span><span class="o">.</span><span class="n">crop</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">gen_width</span><span class="si">}</span><span class="s2">x</span><span class="si">#{</span><span class="n">gen_height</span><span class="si">}</span><span class="s2">+0+0&quot;</span>
        <span class="k">end</span>

        <span class="n">image</span><span class="o">.</span><span class="n">write</span> <span class="n">gen_dest_file</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-20" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-20'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-21" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-21'>#</a>
          </div>
          <p>Return path relative to the site root for html</p>
        </div>
        <div class='code'>
          <div class="highlight"><pre>      <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">image_dest</span><span class="p">,</span> <span class="n">image_dir</span><span class="p">,</span> <span class="n">gen_name</span><span class="p">))</span><span class="o">.</span><span class="n">cleanpath</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-22" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-22'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>    <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-23" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-23'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre>  <span class="k">end</span></pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
  <div class='section'>
    <a id="section-24" class="section-anchor"></a>
    <section>
        <div class='docs'>
          <div class='octowrap'>
            <a class='octothorpe' href='#section-24'>#</a>
          </div>
          
        </div>
        <div class='code'>
          <div class="highlight"><pre><span class="k">end</span>

<span class="ss">Liquid</span><span class="p">:</span><span class="ss">:Template</span><span class="o">.</span><span class="n">register_tag</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="ss">Jekyll</span><span class="p">:</span><span class="ss">:Image</span><span class="p">)</span>

<span class="cp">__END__</span>

<span class="cp">But all forgot there is another option.</span>
<span class="cp">Only at the end of a file, of course.</span>

</pre></div>
        </div>
        <div class='clearall'></div>
    </section>
  </div>
</div>
</body>
