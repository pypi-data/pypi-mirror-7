+function($){"use strict";var backdrop=".dropdown-backdrop";var toggle='[data-toggle="dropdown"]';var Dropdown=function(element){$(element).on("click.bs.dropdown",this.toggle)};Dropdown.prototype.toggle=function(e){var $this=$(this);if($this.is(".disabled, :disabled"))return;var $parent=getParent($this);var isActive=$parent.hasClass("open");clearMenus();if(!isActive){if("ontouchstart"in document.documentElement&&!$parent.closest(".navbar-nav").length){$('<div class="dropdown-backdrop"/>').insertAfter($(this)).on("click",clearMenus)}var relatedTarget={relatedTarget:this};$parent.trigger(e=$.Event("show.bs.dropdown",relatedTarget));if(e.isDefaultPrevented())return;$this.trigger("focus");$parent.toggleClass("open").trigger("shown.bs.dropdown",relatedTarget)}return false};Dropdown.prototype.keydown=function(e){if(!/(38|40|27)/.test(e.keyCode))return;var $this=$(this);e.preventDefault();e.stopPropagation();if($this.is(".disabled, :disabled"))return;var $parent=getParent($this);var isActive=$parent.hasClass("open");if(!isActive||isActive&&e.keyCode==27){if(e.which==27)$parent.find(toggle).trigger("focus");return $this.trigger("click")}var desc=" li:not(.divider):visible a";var $items=$parent.find('[role="menu"]'+desc+', [role="listbox"]'+desc);if(!$items.length)return;var index=$items.index($items.filter(":focus"));if(e.keyCode==38&&index>0)index--;if(e.keyCode==40&&index<$items.length-1)index++;if(!~index)index=0;$items.eq(index).trigger("focus")};function clearMenus(e){if(e&&e.which===3)return;$(backdrop).remove();$(toggle).each(function(){var $parent=getParent($(this));var relatedTarget={relatedTarget:this};if(!$parent.hasClass("open"))return;$parent.trigger(e=$.Event("hide.bs.dropdown",relatedTarget));if(e.isDefaultPrevented())return;$parent.removeClass("open").trigger("hidden.bs.dropdown",relatedTarget)})}function getParent($this){var selector=$this.attr("data-target");if(!selector){selector=$this.attr("href");selector=selector&&/#[A-Za-z]/.test(selector)&&selector.replace(/.*(?=#[^\s]*$)/,"")}var $parent=selector&&$(selector);return $parent&&$parent.length?$parent:$this.parent()}function Plugin(option){return this.each(function(){var $this=$(this);var data=$this.data("bs.dropdown");if(!data)$this.data("bs.dropdown",data=new Dropdown(this));if(typeof option=="string")data[option].call($this)})}var old=$.fn.dropdown;$.fn.dropdown=Plugin;$.fn.dropdown.Constructor=Dropdown;$.fn.dropdown.noConflict=function(){$.fn.dropdown=old;return this};$(document).on("click.bs.dropdown.data-api",clearMenus).on("click.bs.dropdown.data-api",".dropdown form",function(e){e.stopPropagation()}).on("click.bs.dropdown.data-api",toggle,Dropdown.prototype.toggle).on("keydown.bs.dropdown.data-api",toggle+', [role="menu"], [role="listbox"]',Dropdown.prototype.keydown)}(jQuery);+function($){"use strict";var Tab=function(element){this.element=$(element)};Tab.prototype.show=function(){var $this=this.element;var $ul=$this.closest("ul:not(.dropdown-menu)");var selector=$this.data("target");if(!selector){selector=$this.attr("href");selector=selector&&selector.replace(/.*(?=#[^\s]*$)/,"")}if($this.parent("li").hasClass("active"))return;var previous=$ul.find(".active:last a")[0];var e=$.Event("show.bs.tab",{relatedTarget:previous});$this.trigger(e);if(e.isDefaultPrevented())return;var $target=$(selector);this.activate($this.parent("li"),$ul);this.activate($target,$target.parent(),function(){$this.trigger({type:"shown.bs.tab",relatedTarget:previous})})};Tab.prototype.activate=function(element,container,callback){var $active=container.find("> .active");var transition=callback&&$.support.transition&&$active.hasClass("fade");function next(){$active.removeClass("active").find("> .dropdown-menu > .active").removeClass("active");element.addClass("active");if(transition){element[0].offsetWidth;element.addClass("in")}else{element.removeClass("fade")}if(element.parent(".dropdown-menu")){element.closest("li.dropdown").addClass("active")}callback&&callback()}transition?$active.one($.support.transition.end,next).emulateTransitionEnd(150):next();$active.removeClass("in")};function Plugin(option){return this.each(function(){var $this=$(this);var data=$this.data("bs.tab");if(!data)$this.data("bs.tab",data=new Tab(this));if(typeof option=="string")data[option]()})}var old=$.fn.tab;$.fn.tab=Plugin;$.fn.tab.Constructor=Tab;$.fn.tab.noConflict=function(){$.fn.tab=old;return this};$(document).on("click.bs.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(e){e.preventDefault();Plugin.call($(this),"show")})}(jQuery);+function($){"use strict";function transitionEnd(){var el=document.createElement("bootstrap");var transEndEventNames={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var name in transEndEventNames){if(el.style[name]!==undefined){return{end:transEndEventNames[name]}}}return false}$.fn.emulateTransitionEnd=function(duration){var called=false,$el=this;$(this).one($.support.transition.end,function(){called=true});var callback=function(){if(!called)$($el).trigger($.support.transition.end)};setTimeout(callback,duration);return this};$(function(){$.support.transition=transitionEnd()})}(jQuery);+function($){"use strict";var Collapse=function(element,options){this.$element=$(element);this.options=$.extend({},Collapse.DEFAULTS,options);this.transitioning=null;if(this.options.parent)this.$parent=$(this.options.parent);if(this.options.toggle)this.toggle()};Collapse.DEFAULTS={toggle:true};Collapse.prototype.dimension=function(){var hasWidth=this.$element.hasClass("width");return hasWidth?"width":"height"};Collapse.prototype.show=function(){if(this.transitioning||this.$element.hasClass("in"))return;var startEvent=$.Event("show.bs.collapse");this.$element.trigger(startEvent);if(startEvent.isDefaultPrevented())return;var actives=this.$parent&&this.$parent.find("> .panel > .in");if(actives&&actives.length){var hasData=actives.data("bs.collapse");if(hasData&&hasData.transitioning)return;Plugin.call(actives,"hide");hasData||actives.data("bs.collapse",null)}var dimension=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[dimension](0);this.transitioning=1;var complete=function(e){if(e&&e.target!=this.$element[0]){this.$element.one($.support.transition.end,$.proxy(complete,this));return}this.$element.removeClass("collapsing").addClass("collapse in")[dimension]("");this.transitioning=0;this.$element.off($.support.transition.end+".bs.collapse").trigger("shown.bs.collapse")};if(!$.support.transition)return complete.call(this);var scrollSize=$.camelCase(["scroll",dimension].join("-"));this.$element.on($.support.transition.end+".bs.collapse",$.proxy(complete,this)).emulateTransitionEnd(350)[dimension](this.$element[0][scrollSize])};Collapse.prototype.hide=function(){if(this.transitioning||!this.$element.hasClass("in"))return;var startEvent=$.Event("hide.bs.collapse");this.$element.trigger(startEvent);if(startEvent.isDefaultPrevented())return;var dimension=this.dimension();this.$element[dimension](this.$element[dimension]())[0].offsetHeight;this.$element.addClass("collapsing").removeClass("collapse").removeClass("in");this.transitioning=1;var complete=function(e){if(e&&e.target!=this.$element[0]){this.$element.one($.support.transition.end,$.proxy(complete,this));return}this.transitioning=0;this.$element.trigger("hidden.bs.collapse").removeClass("collapsing").addClass("collapse")};if(!$.support.transition)return complete.call(this);this.$element[dimension](0).one($.support.transition.end,$.proxy(complete,this)).emulateTransitionEnd(350)};Collapse.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()};function Plugin(option){return this.each(function(){var $this=$(this);var data=$this.data("bs.collapse");var options=$.extend({},Collapse.DEFAULTS,$this.data(),typeof option=="object"&&option);if(!data&&options.toggle&&option=="show")option=!option;if(!data)$this.data("bs.collapse",data=new Collapse(this,options));if(typeof option=="string")data[option]()})}var old=$.fn.collapse;$.fn.collapse=Plugin;$.fn.collapse.Constructor=Collapse;$.fn.collapse.noConflict=function(){$.fn.collapse=old;return this};$(document).on("click.bs.collapse.data-api",'[data-toggle="collapse"]',function(e){var $this=$(this),href;var target=$this.attr("data-target")||e.preventDefault()||(href=$this.attr("href"))&&href.replace(/.*(?=#[^\s]+$)/,"");var $target=$(target);var data=$target.data("bs.collapse");var option=data?"toggle":$this.data();var parent=$this.attr("data-parent");var $parent=parent&&$(parent);if(!data||!data.transitioning){if($parent)$parent.find('[data-toggle="collapse"][data-parent="'+parent+'"]').not($this).addClass("collapsed");$this[$target.hasClass("in")?"addClass":"removeClass"]("collapsed")}Plugin.call($target,option)})}(jQuery);+function($){"use strict";var Tooltip=function(element,options){this.type=this.options=this.enabled=this.timeout=this.hoverState=this.$element=null;this.init("tooltip",element,options)};Tooltip.DEFAULTS={animation:true,placement:"top",selector:false,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:false,container:false,viewport:{selector:"body",padding:0}};Tooltip.prototype.init=function(type,element,options){this.enabled=true;this.type=type;this.$element=$(element);this.options=this.getOptions(options);this.$viewport=this.options.viewport&&$(this.options.viewport.selector||this.options.viewport);var triggers=this.options.trigger.split(" ");for(var i=triggers.length;i--;){var trigger=triggers[i];if(trigger=="click"){this.$element.on("click."+this.type,this.options.selector,$.proxy(this.toggle,this))}else if(trigger!="manual"){var eventIn=trigger=="hover"?"mouseenter":"focusin";var eventOut=trigger=="hover"?"mouseleave":"focusout";this.$element.on(eventIn+"."+this.type,this.options.selector,$.proxy(this.enter,this));this.$element.on(eventOut+"."+this.type,this.options.selector,$.proxy(this.leave,this))}}this.options.selector?this._options=$.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()};Tooltip.prototype.getDefaults=function(){return Tooltip.DEFAULTS};Tooltip.prototype.getOptions=function(options){options=$.extend({},this.getDefaults(),this.$element.data(),options);if(options.delay&&typeof options.delay=="number"){options.delay={show:options.delay,hide:options.delay}}return options};Tooltip.prototype.getDelegateOptions=function(){var options={};var defaults=this.getDefaults();this._options&&$.each(this._options,function(key,value){if(defaults[key]!=value)options[key]=value});return options};Tooltip.prototype.enter=function(obj){var self=obj instanceof this.constructor?obj:$(obj.currentTarget).data("bs."+this.type);if(!self){self=new this.constructor(obj.currentTarget,this.getDelegateOptions());$(obj.currentTarget).data("bs."+this.type,self)}clearTimeout(self.timeout);self.hoverState="in";if(!self.options.delay||!self.options.delay.show)return self.show();self.timeout=setTimeout(function(){if(self.hoverState=="in")self.show()},self.options.delay.show)};Tooltip.prototype.leave=function(obj){var self=obj instanceof this.constructor?obj:$(obj.currentTarget).data("bs."+this.type);if(!self){self=new this.constructor(obj.currentTarget,this.getDelegateOptions());$(obj.currentTarget).data("bs."+this.type,self)}clearTimeout(self.timeout);self.hoverState="out";if(!self.options.delay||!self.options.delay.hide)return self.hide();self.timeout=setTimeout(function(){if(self.hoverState=="out")self.hide()},self.options.delay.hide)};Tooltip.prototype.show=function(){var e=$.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(e);if(e.isDefaultPrevented())return;var that=this;var $tip=this.tip();this.setContent();if(this.options.animation)$tip.addClass("fade");var placement=typeof this.options.placement=="function"?this.options.placement.call(this,$tip[0],this.$element[0]):this.options.placement;var autoToken=/\s?auto?\s?/i;var autoPlace=autoToken.test(placement);if(autoPlace)placement=placement.replace(autoToken,"")||"top";$tip.detach().css({top:0,left:0,display:"block"}).addClass(placement);this.options.container?$tip.appendTo(this.options.container):$tip.insertAfter(this.$element);var pos=this.getPosition();var actualWidth=$tip[0].offsetWidth;var actualHeight=$tip[0].offsetHeight;if(autoPlace){var orgPlacement=placement;var $parent=this.$element.parent();var parentDim=this.getPosition($parent);placement=placement=="bottom"&&pos.top+pos.height+actualHeight-parentDim.scroll>parentDim.height?"top":placement=="top"&&pos.top-parentDim.scroll-actualHeight<0?"bottom":placement=="right"&&pos.right+actualWidth>parentDim.width?"left":placement=="left"&&pos.left-actualWidth<parentDim.left?"right":placement;$tip.removeClass(orgPlacement).addClass(placement)}var calculatedOffset=this.getCalculatedOffset(placement,pos,actualWidth,actualHeight);this.applyPlacement(calculatedOffset,placement);this.hoverState=null;var complete=function(){that.$element.trigger("shown.bs."+that.type)};$.support.transition&&this.$tip.hasClass("fade")?$tip.one($.support.transition.end,complete).emulateTransitionEnd(150):complete()}};Tooltip.prototype.applyPlacement=function(offset,placement){var $tip=this.tip();var width=$tip[0].offsetWidth;var height=$tip[0].offsetHeight;var marginTop=parseInt($tip.css("margin-top"),10);var marginLeft=parseInt($tip.css("margin-left"),10);if(isNaN(marginTop))marginTop=0;if(isNaN(marginLeft))marginLeft=0;offset.top=offset.top+marginTop;offset.left=offset.left+marginLeft;$.offset.setOffset($tip[0],$.extend({using:function(props){$tip.css({top:Math.round(props.top),left:Math.round(props.left)})}},offset),0);$tip.addClass("in");var actualWidth=$tip[0].offsetWidth;var actualHeight=$tip[0].offsetHeight;if(placement=="top"&&actualHeight!=height){offset.top=offset.top+height-actualHeight}var delta=this.getViewportAdjustedDelta(placement,offset,actualWidth,actualHeight);if(delta.left)offset.left+=delta.left;else offset.top+=delta.top;var arrowDelta=delta.left?delta.left*2-width+actualWidth:delta.top*2-height+actualHeight;var arrowPosition=delta.left?"left":"top";var arrowOffsetPosition=delta.left?"offsetWidth":"offsetHeight";$tip.offset(offset);this.replaceArrow(arrowDelta,$tip[0][arrowOffsetPosition],arrowPosition)};Tooltip.prototype.replaceArrow=function(delta,dimension,position){this.arrow().css(position,delta?50*(1-delta/dimension)+"%":"")};Tooltip.prototype.setContent=function(){var $tip=this.tip();var title=this.getTitle();$tip.find(".tooltip-inner")[this.options.html?"html":"text"](title);$tip.removeClass("fade in top bottom left right")};Tooltip.prototype.hide=function(){var that=this;var $tip=this.tip();var e=$.Event("hide.bs."+this.type);function complete(){if(that.hoverState!="in")$tip.detach();that.$element.trigger("hidden.bs."+that.type)}this.$element.trigger(e);if(e.isDefaultPrevented())return;$tip.removeClass("in");$.support.transition&&this.$tip.hasClass("fade")?$tip.one($.support.transition.end,complete).emulateTransitionEnd(150):complete();this.hoverState=null;return this};Tooltip.prototype.fixTitle=function(){var $e=this.$element;if($e.attr("title")||typeof $e.attr("data-original-title")!="string"){$e.attr("data-original-title",$e.attr("title")||"").attr("title","")}};Tooltip.prototype.hasContent=function(){return this.getTitle()};Tooltip.prototype.getPosition=function($element){$element=$element||this.$element;var el=$element[0];var isBody=el.tagName=="BODY";return $.extend({},typeof el.getBoundingClientRect=="function"?el.getBoundingClientRect():null,{scroll:isBody?document.documentElement.scrollTop||document.body.scrollTop:$element.scrollTop(),width:isBody?$(window).width():$element.outerWidth(),height:isBody?$(window).height():$element.outerHeight()},isBody?{top:0,left:0}:$element.offset())};Tooltip.prototype.getCalculatedOffset=function(placement,pos,actualWidth,actualHeight){return placement=="bottom"?{top:pos.top+pos.height,left:pos.left+pos.width/2-actualWidth/2}:placement=="top"?{top:pos.top-actualHeight,left:pos.left+pos.width/2-actualWidth/2}:placement=="left"?{top:pos.top+pos.height/2-actualHeight/2,left:pos.left-actualWidth}:{top:pos.top+pos.height/2-actualHeight/2,left:pos.left+pos.width}};Tooltip.prototype.getViewportAdjustedDelta=function(placement,pos,actualWidth,actualHeight){var delta={top:0,left:0};if(!this.$viewport)return delta;var viewportPadding=this.options.viewport&&this.options.viewport.padding||0;var viewportDimensions=this.getPosition(this.$viewport);if(/right|left/.test(placement)){var topEdgeOffset=pos.top-viewportPadding-viewportDimensions.scroll;var bottomEdgeOffset=pos.top+viewportPadding-viewportDimensions.scroll+actualHeight;if(topEdgeOffset<viewportDimensions.top){delta.top=viewportDimensions.top-topEdgeOffset}else if(bottomEdgeOffset>viewportDimensions.top+viewportDimensions.height){delta.top=viewportDimensions.top+viewportDimensions.height-bottomEdgeOffset}}else{var leftEdgeOffset=pos.left-viewportPadding;var rightEdgeOffset=pos.left+viewportPadding+actualWidth;if(leftEdgeOffset<viewportDimensions.left){delta.left=viewportDimensions.left-leftEdgeOffset}else if(rightEdgeOffset>viewportDimensions.width){delta.left=viewportDimensions.left+viewportDimensions.width-rightEdgeOffset}}return delta};Tooltip.prototype.getTitle=function(){var title;var $e=this.$element;var o=this.options;title=$e.attr("data-original-title")||(typeof o.title=="function"?o.title.call($e[0]):o.title);return title};Tooltip.prototype.tip=function(){return this.$tip=this.$tip||$(this.options.template)};Tooltip.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")};Tooltip.prototype.validate=function(){if(!this.$element[0].parentNode){this.hide();this.$element=null;this.options=null}};Tooltip.prototype.enable=function(){this.enabled=true};Tooltip.prototype.disable=function(){this.enabled=false};Tooltip.prototype.toggleEnabled=function(){this.enabled=!this.enabled};Tooltip.prototype.toggle=function(e){var self=this;if(e){self=$(e.currentTarget).data("bs."+this.type);if(!self){self=new this.constructor(e.currentTarget,this.getDelegateOptions());$(e.currentTarget).data("bs."+this.type,self)}}self.tip().hasClass("in")?self.leave(self):self.enter(self)};Tooltip.prototype.destroy=function(){clearTimeout(this.timeout);this.hide().$element.off("."+this.type).removeData("bs."+this.type)};function Plugin(option){return this.each(function(){var $this=$(this);var data=$this.data("bs.tooltip");var options=typeof option=="object"&&option;if(!data&&option=="destroy")return;if(!data)$this.data("bs.tooltip",data=new Tooltip(this,options));if(typeof option=="string")data[option]()})}var old=$.fn.tooltip;$.fn.tooltip=Plugin;$.fn.tooltip.Constructor=Tooltip;$.fn.tooltip.noConflict=function(){$.fn.tooltip=old;return this}}(jQuery);+function($){"use strict";var Popover=function(element,options){this.init("popover",element,options)};if(!$.fn.tooltip)throw new Error("Popover requires tooltip.js");Popover.DEFAULTS=$.extend({},$.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'});Popover.prototype=$.extend({},$.fn.tooltip.Constructor.prototype);Popover.prototype.constructor=Popover;Popover.prototype.getDefaults=function(){return Popover.DEFAULTS};Popover.prototype.setContent=function(){var $tip=this.tip();var title=this.getTitle();var content=this.getContent();$tip.find(".popover-title")[this.options.html?"html":"text"](title);$tip.find(".popover-content").empty()[this.options.html?typeof content=="string"?"html":"append":"text"](content);$tip.removeClass("fade top bottom left right in");if(!$tip.find(".popover-title").html())$tip.find(".popover-title").hide()};Popover.prototype.hasContent=function(){return this.getTitle()||this.getContent()};Popover.prototype.getContent=function(){var $e=this.$element;var o=this.options;return $e.attr("data-content")||(typeof o.content=="function"?o.content.call($e[0]):o.content)};Popover.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")};Popover.prototype.tip=function(){if(!this.$tip)this.$tip=$(this.options.template);return this.$tip};function Plugin(option){return this.each(function(){var $this=$(this);var data=$this.data("bs.popover");var options=typeof option=="object"&&option;if(!data&&option=="destroy")return;if(!data)$this.data("bs.popover",data=new Popover(this,options));if(typeof option=="string")data[option]()})}var old=$.fn.popover;$.fn.popover=Plugin;$.fn.popover.Constructor=Popover;$.fn.popover.noConflict=function(){$.fn.popover=old;return this}}(jQuery);$("ul#request-action-type li a").click(function(e){var form=$(this).closest("form");form.find("input[name='type_']").attr("value",$(this).attr("id"));form.submit();return false});$("ul#request-modifier-type li a").click(function(e){var form=$(this).closest("form");form.find("input[name='type_']").attr("value",$(this).attr("id"));form.submit();return false});(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var push=ArrayProto.push,slice=ArrayProto.slice,concat=ArrayProto.concat,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){if(obj instanceof _)return obj;if(!(this instanceof _))return new _(obj);this._wrapped=obj};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=_}exports._=_}else{root._=_}_.VERSION="1.6.0";_.each=_.forEach=function(obj,iterator,context){if(obj==null)return obj;if(obj.length===+obj.length){for(var i=0,length=obj.length;i<length;i++){if(iterator.call(context,obj[i],i,obj)===breaker)return}}else{var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){if(iterator.call(context,obj[keys[i]],keys[i],obj)===breaker)return}}return obj};_.map=_.collect=function(obj,iterator,context){var results=[];if(obj==null)return results;_.each(obj,function(value,index,list){results.push(iterator.call(context,value,index,list))});return results};var reduceError="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];_.each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else{memo=iterator.call(context,memo,value,index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){var initial=arguments.length>2;if(obj==null)obj=[];var length=obj.length;if(length!==+length){var keys=_.keys(obj);length=keys.length}_.each(obj,function(value,index,list){index=keys?keys[--length]:--length;if(!initial){memo=obj[index];initial=true}else{memo=iterator.call(context,memo,obj[index],index,list)}});if(!initial)throw new TypeError(reduceError);return memo};_.find=_.detect=function(obj,predicate,context){var result;_.some(obj,function(value,index,list){if(predicate.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,predicate,context){var results=[];if(obj==null)return results;_.each(obj,function(value,index,list){if(predicate.call(context,value,index,list))results.push(value)});return results};_.reject=function(obj,predicate,context){return _.filter(obj,_.negate(predicate),context)};_.every=_.all=function(obj,predicate,context){predicate||(predicate=_.identity);var result=true;if(obj==null)return result;_.each(obj,function(value,index,list){if(!(result=result&&predicate.call(context,value,index,list)))return breaker});return!!result};_.some=_.any=function(obj,predicate,context){predicate||(predicate=_.identity);var result=false;if(obj==null)return result;_.each(obj,function(value,index,list){if(result||(result=predicate.call(context,value,index,list)))return breaker});return!!result};_.contains=_.include=function(obj,target){if(obj==null)return false;if(obj.length===+obj.length)return _.indexOf(obj,target)>=0;return _.some(obj,function(value){return value===target})};_.invoke=function(obj,method){var args=slice.call(arguments,2);var isFunc=_.isFunction(method);return _.map(obj,function(value){return(isFunc?method:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,_.property(key))};_.where=function(obj,attrs){return _.filter(obj,_.matches(attrs))};_.findWhere=function(obj,attrs){return _.find(obj,_.matches(attrs))};_.max=function(obj,iterator,context){var result=-Infinity,lastComputed=-Infinity,value,computed;if(!iterator&&_.isArray(obj)){for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value>result){result=value}}}else{_.each(obj,function(value,index,list){computed=iterator?iterator.call(context,value,index,list):value;if(computed>lastComputed||computed===-Infinity&&result===-Infinity){result=value;lastComputed=computed}})}return result};_.min=function(obj,iterator,context){var result=Infinity,lastComputed=Infinity,value,computed;if(!iterator&&_.isArray(obj)){for(var i=0,length=obj.length;i<length;i++){value=obj[i];if(value<result){result=value}}}else{_.each(obj,function(value,index,list){computed=iterator?iterator.call(context,value,index,list):value;if(computed<lastComputed||computed===Infinity&&result===Infinity){result=value;lastComputed=computed}})}return result};_.shuffle=function(obj){var rand;var index=0;var shuffled=[];_.each(obj,function(value){rand=_.random(index++);shuffled[index-1]=shuffled[rand];shuffled[rand]=value});return shuffled};_.sample=function(obj,n,guard){if(n==null||guard){if(obj.length!==+obj.length)obj=_.values(obj);return obj[_.random(obj.length-1)]}return _.shuffle(obj).slice(0,Math.max(0,n))};var lookupIterator=function(value,context){if(value==null)return _.identity;if(!_.isFunction(value))return _.property(value);if(!context)return value;return function(){return value.apply(context,arguments)}};_.sortBy=function(obj,iterator,context){iterator=lookupIterator(iterator,context);return _.pluck(_.map(obj,function(value,index,list){return{value:value,index:index,criteria:iterator(value,index,list)}}).sort(function(left,right){var a=left.criteria;var b=right.criteria;if(a!==b){if(a>b||a===void 0)return 1;if(a<b||b===void 0)return-1}return left.index-right.index}),"value")};var group=function(behavior){return function(obj,iterator,context){var result={};iterator=lookupIterator(iterator,context);_.each(obj,function(value,index){var key=iterator(value,index,obj);behavior(result,value,key)});return result}};_.groupBy=group(function(result,value,key){_.has(result,key)?result[key].push(value):result[key]=[value]});_.indexBy=group(function(result,value,key){result[key]=value});_.countBy=group(function(result,value,key){_.has(result,key)?result[key]++:result[key]=1});_.sortedIndex=function(array,obj,iterator,context){iterator=lookupIterator(iterator,context);var value=iterator(obj);var low=0,high=array.length;while(low<high){var mid=low+high>>>1;iterator(array[mid])<value?low=mid+1:high=mid}return low};_.toArray=function(obj){if(!obj)return[];if(_.isArray(obj))return slice.call(obj);if(obj.length===+obj.length)return _.map(obj,_.identity);return _.values(obj)};_.size=function(obj){if(obj==null)return 0;return obj.length===+obj.length?obj.length:_.keys(obj).length};_.first=_.head=_.take=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[0];if(n<0)return[];return slice.call(array,0,n)};_.initial=function(array,n,guard){return slice.call(array,0,Math.max(0,array.length-(n==null||guard?1:n)))};_.last=function(array,n,guard){if(array==null)return void 0;if(n==null||guard)return array[array.length-1];return slice.call(array,Math.max(array.length-n,0))};_.rest=_.tail=_.drop=function(array,n,guard){return slice.call(array,n==null||guard?1:n)};_.compact=function(array){return _.filter(array,_.identity)};var flatten=function(input,shallow,strict,output){if(shallow&&_.every(input,_.isArray)){return concat.apply(output,input)}for(var i=0,length=input.length;i<length;i++){var value=input[i];if(!_.isArray(value)&&!_.isArguments(value)){if(!strict)output.push(value)}else if(shallow){push.apply(output,value)}else{flatten(value,shallow,strict,output)}}return output};_.flatten=function(array,shallow){return flatten(array,shallow,false,[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.partition=function(obj,predicate,context){predicate=lookupIterator(predicate,context);var pass=[],fail=[];_.each(obj,function(value,key,obj){(predicate(value,key,obj)?pass:fail).push(value)});return[pass,fail]};_.uniq=_.unique=function(array,isSorted,iterator,context){if(array==null)return[];if(_.isFunction(isSorted)){context=iterator;iterator=isSorted;isSorted=false}var result=[];var seen=[];for(var i=0,length=array.length;i<length;i++){var value=array[i];if(iterator)value=iterator.call(context,value,i,array);if(isSorted?!i||seen!==value:!_.contains(seen,value)){if(isSorted)seen=value;else seen.push(value);result.push(array[i])}}return result};_.union=function(){return _.uniq(flatten(arguments,true,true,[]))};_.intersection=function(array){if(array==null)return[];var result=[];var argsLength=arguments.length;for(var i=0,length=array.length;i<length;i++){var item=array[i];if(_.contains(result,item))continue;for(var j=1;j<argsLength;j++){if(!_.contains(arguments[j],item))break}if(j===argsLength)result.push(item)}return result};_.difference=function(array){var rest=flatten(slice.call(arguments,1),true,true,[]);return _.filter(array,function(value){return!_.contains(rest,value)})};_.zip=function(){var length=_.max(_.pluck(arguments,"length").concat(0));var results=new Array(length);for(var i=0;i<length;i++){results[i]=_.pluck(arguments,""+i)}return results};_.object=function(list,values){if(list==null)return{};var result={};for(var i=0,length=list.length;i<length;i++){if(values){result[list[i]]=values[i]}else{result[list[i][0]]=list[i][1]}}return result};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i=0,length=array.length;if(isSorted){if(typeof isSorted=="number"){i=isSorted<0?Math.max(0,length+isSorted):isSorted}else{i=_.sortedIndex(array,item);return array[i]===item?i:-1}}for(;i<length;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item,from){if(array==null)return-1;var i=from==null?array.length:from;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var length=Math.max(Math.ceil((stop-start)/step),0);var idx=0;var range=new Array(length);while(idx<length){range[idx++]=start;start+=step}return range};var ctor=function(){};_.bind=function(func,context){var args,bound;if(nativeBind&&func.bind===nativeBind)return nativeBind.apply(func,slice.call(arguments,1));if(!_.isFunction(func))throw new TypeError("Bind must be called on a function");args=slice.call(arguments,2);return bound=function(){if(!(this instanceof bound))return func.apply(context,args.concat(slice.call(arguments)));ctor.prototype=func.prototype;var self=new ctor;ctor.prototype=null;var result=func.apply(self,args.concat(slice.call(arguments)));if(Object(result)===result)return result;return self}};_.partial=function(func){var boundArgs=slice.call(arguments,1);return function(){var position=0;var args=boundArgs.slice();for(var i=0,length=args.length;i<length;i++){if(args[i]===_)args[i]=arguments[position++]}while(position<arguments.length)args.push(arguments[position++]);return func.apply(this,args)}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length===0)throw new Error("bindAll must be passed function names");
_.each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return _.has(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(null,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};_.throttle=function(func,wait,options){var context,args,result;var timeout=null;var previous=0;options||(options={});var later=function(){previous=options.leading===false?0:_.now();timeout=null;result=func.apply(context,args);context=args=null};return function(){var now=_.now();if(!previous&&options.leading===false)previous=now;var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0||remaining>wait){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args);context=args=null}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining)}return result}};_.debounce=function(func,wait,immediate){var timeout,args,context,timestamp,result;var later=function(){var last=_.now()-timestamp;if(last<wait&&last>0){timeout=setTimeout(later,wait-last)}else{timeout=null;if(!immediate){result=func.apply(context,args);context=args=null}}};return function(){context=this;args=arguments;timestamp=_.now();var callNow=immediate&&!timeout;if(!timeout){timeout=setTimeout(later,wait)}if(callNow){result=func.apply(context,args);context=args=null}return result}};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;memo=func.apply(this,arguments);func=null;return memo}};_.wrap=function(func,wrapper){return _.partial(wrapper,func)};_.negate=function(predicate){return function(){return!predicate.apply(this,arguments)}};_.compose=function(){var funcs=arguments;return function(){var args=arguments;for(var i=funcs.length-1;i>=0;i--){args=[funcs[i].apply(this,args)]}return args[0]}};_.after=function(times,func){return function(){if(--times<1){return func.apply(this,arguments)}}};_.keys=function(obj){if(!_.isObject(obj))return[];if(nativeKeys)return nativeKeys(obj);var keys=[];for(var key in obj)if(_.has(obj,key))keys.push(key);return keys};_.values=function(obj){var keys=_.keys(obj);var length=keys.length;var values=new Array(length);for(var i=0;i<length;i++){values[i]=obj[keys[i]]}return values};_.pairs=function(obj){var keys=_.keys(obj);var length=keys.length;var pairs=new Array(length);for(var i=0;i<length;i++){pairs[i]=[keys[i],obj[keys[i]]]}return pairs};_.invert=function(obj){var result={};var keys=_.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i]}return result};_.functions=_.methods=function(obj){var names=[];for(var key in obj){if(_.isFunction(obj[key]))names.push(key)}return names.sort()};_.extend=function(obj){if(!_.isObject(obj))return obj;_.each(slice.call(arguments,1),function(source){for(var prop in source){obj[prop]=source[prop]}});return obj};_.pick=function(obj,iterator,context){var result={};if(_.isFunction(iterator)){for(var key in obj){var value=obj[key];if(iterator.call(context,value,key,obj))result[key]=value}}else{var keys=concat.apply([],slice.call(arguments,1));for(var i=0,length=keys.length;i<length;i++){var key=keys[i];if(key in obj)result[key]=obj[key]}}return result};_.omit=function(obj,iterator,context){var keys;if(_.isFunction(iterator)){iterator=_.negate(iterator)}else{keys=_.map(concat.apply([],slice.call(arguments,1)),String);iterator=function(value,key){return!_.contains(keys,key)}}return _.pick(obj,iterator,context)};_.defaults=function(obj){if(!_.isObject(obj))return obj;_.each(slice.call(arguments,1),function(source){for(var prop in source){if(obj[prop]===void 0)obj[prop]=source[prop]}});return obj};_.clone=function(obj){if(!_.isObject(obj))return obj;return _.isArray(obj)?obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};var eq=function(a,b,aStack,bStack){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;if(a instanceof _)a=a._wrapped;if(b instanceof _)b=b._wrapped;var className=toString.call(a);if(className!=toString.call(b))return false;switch(className){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return false;var length=aStack.length;while(length--){if(aStack[length]==a)return bStack[length]==b}var aCtor=a.constructor,bCtor=b.constructor;if(aCtor!==bCtor&&!(_.isFunction(aCtor)&&aCtor instanceof aCtor&&_.isFunction(bCtor)&&bCtor instanceof bCtor)&&("constructor"in a&&"constructor"in b)){return false}aStack.push(a);bStack.push(b);var size=0,result=true;if(className=="[object Array]"){size=a.length;result=size==b.length;if(result){while(size--){if(!(result=eq(a[size],b[size],aStack,bStack)))break}}}else{for(var key in a){if(_.has(a,key)){size++;if(!(result=_.has(b,key)&&eq(a[key],b[key],aStack,bStack)))break}}if(result){for(key in b){if(_.has(b,key)&&!size--)break}result=!size}}aStack.pop();bStack.pop();return result};_.isEqual=function(a,b){return eq(a,b,[],[])};_.isEmpty=function(obj){if(obj==null)return true;if(_.isArray(obj)||_.isString(obj)||_.isArguments(obj))return obj.length===0;for(var key in obj)if(_.has(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&obj.nodeType===1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)=="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};_.each(["Arguments","Function","String","Number","Date","RegExp"],function(name){_["is"+name]=function(obj){return toString.call(obj)=="[object "+name+"]"}});if(!_.isArguments(arguments)){_.isArguments=function(obj){return _.has(obj,"callee")}}if(typeof/./!=="function"){_.isFunction=function(obj){return typeof obj==="function"}}_.isFinite=function(obj){return isFinite(obj)&&!isNaN(parseFloat(obj))};_.isNaN=function(obj){return _.isNumber(obj)&&obj!=+obj};_.isBoolean=function(obj){return obj===true||obj===false||toString.call(obj)=="[object Boolean]"};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.has=function(obj,key){return obj!=null&&hasOwnProperty.call(obj,key)};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.constant=function(value){return function(){return value}};_.noop=function(){};_.property=function(key){return function(obj){return obj[key]}};_.matches=function(attrs){return function(obj){if(obj==null)return _.isEmpty(attrs);if(obj===attrs)return true;for(var key in attrs)if(attrs[key]!==obj[key])return false;return true}};_.times=function(n,iterator,context){var accum=Array(Math.max(0,n));for(var i=0;i<n;i++)accum[i]=iterator.call(context,i);return accum};_.random=function(min,max){if(max==null){max=min;min=0}return min+Math.floor(Math.random()*(max-min+1))};_.now=Date.now||function(){return(new Date).getTime()};var entityMap={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};entityMap.unescape=_.invert(entityMap.escape);var entityRegexes={escape:new RegExp("["+_.keys(entityMap.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(entityMap.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(method){_[method]=function(string){if(string==null)return"";return(""+string).replace(entityRegexes[method],function(match){return entityMap[method][match]})}});_.result=function(object,property){if(object==null)return void 0;var value=object[property];return _.isFunction(value)?object[property]():value};_.mixin=function(obj){_.each(_.functions(obj),function(name){var func=_[name]=obj[name];_.prototype[name]=function(){var args=[this._wrapped];push.apply(args,arguments);return result.call(this,func.apply(_,args))}})};var idCounter=0;_.uniqueId=function(prefix){var id=++idCounter+"";return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var noMatch=/(.)^/;var escapes={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"};var escaper=/\\|'|\r|\n|\u2028|\u2029/g;var escapeChar=function(match){return"\\"+escapes[match]};_.template=function(text,data,settings){settings=_.defaults({},settings,_.templateSettings);var matcher=new RegExp([(settings.escape||noMatch).source,(settings.interpolate||noMatch).source,(settings.evaluate||noMatch).source].join("|")+"|$","g");var index=0;var source="__p+='";text.replace(matcher,function(match,escape,interpolate,evaluate,offset){source+=text.slice(index,offset).replace(escaper,escapeChar);index=offset+match.length;if(escape){source+="'+\n((__t=("+escape+"))==null?'':_.escape(__t))+\n'"}else if(interpolate){source+="'+\n((__t=("+interpolate+"))==null?'':__t)+\n'"}else if(evaluate){source+="';\n"+evaluate+"\n__p+='"}return match});source+="';\n";if(!settings.variable)source="with(obj||{}){\n"+source+"}\n";source="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+source+"return __p;\n";try{var render=new Function(settings.variable||"obj","_",source)}catch(e){e.source=source;throw e}if(data)return render(data,_);var template=function(data){return render.call(this,data,_)};var argument=settings.variable||"obj";template.source="function("+argument+"){\n"+source+"}";return template};_.chain=function(obj){return _(obj).chain()};var result=function(obj){return this._chain?_(obj).chain():obj};_.mixin(_);_.each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){var obj=this._wrapped;method.apply(obj,arguments);if((name=="shift"||name=="splice")&&obj.length===0)delete obj[0];return result.call(this,obj)}});_.each(["concat","join","slice"],function(name){var method=ArrayProto[name];_.prototype[name]=function(){return result.call(this,method.apply(this._wrapped,arguments))}});_.extend(_.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}});if(typeof define==="function"&&define.amd){define("underscore",[],function(){return _})}}).call(this);var PourOver=function(){PourOver={union_sorted:function(a,b){var lowa=0,lowb=0,higha=a.length,highb=b.length,result=[],la,lb;while(higha>lowa||highb>lowb){la=a[lowa];lb=b[lowb];if(_.isUndefined(la))la=Infinity;if(_.isUndefined(lb))lb=Infinity;if(lowa==higha){return result.concat(b.slice(lowb,highb))}if(lowb==highb){return result.concat(a.slice(lowa,higha))}if(la==lb){result.push(la);lowa++;lowb++}else if(la<lb){result.push(la);lowa++}else{result.push(lb);lowb++}}return result},intersect_sorted:function(a,b){var lowa=0,lowb=0,higha=a.length,highb=b.length,result=[],la,lb;while(higha>lowa&&highb>lowb){la=a[lowa];lb=b[lowb];if(la==lb){result.push(la);lowa++;lowb++}else if(la<lb){lowa++}else{lowb++}}return result},subtract_sorted:function(a,b){var lowa=0,lowb=0,higha=a.length,highb=b.length,result=[],la,lb;while(higha>lowa||highb>lowb){la=a[lowa];lb=b[lowb];if(higha==lowa){return result}if(highb==lowb){return result.concat(a.slice(lowa,higha))}if(la==lb){lowa++;lowb++}else if(la<lb){result.push(la);lowa++}else{lowb++}}return result},insert_sorted:function(set,element){var length=set.length,i=0,last_elem=set[length-1];if(element>last_elem){set.push(element);return set}while(i<length){if(element<set[i]){return set.slice(0,i).concat([element]).concat(set.slice(i,length))}else{i++}}set.push(element);return set},build_permutation_array:function(set,sort){var sorted_set=_(set).clone(),perm=[];if(typeof sort==="function"){sorted_set.sort(sort)}else{sorted_set.sort(function(a,b){return sort.fn.call(sort,a,b)})}_(sorted_set).each(function(m,i){perm[m.cid]=i});return perm},permute_from_array:function(collection,perm){var output=[];if(typeof collection[0]==="number"){_(collection).each(function(i){output[perm[i]]=i})}else{_(collection).each(function(i){output[perm[i.cid]]=i})}return _(output).without(undefined)},remove_sorted:function(set,element){var length=set.length,i=0;while(i<length){if(element==set[i]){return set.slice(0,i).concat(set.slice(i+1,length))}else{i++}}return set},cacheMethods:{defaultCache:function(items){var that=this;_(that.possibilities).each(function(p){var matching_items=_(items).filter(function(i){return that.fn(p,i)}),matching_cids=_(matching_items).map(function(i){return i.cid});p.matching_cids=matching_cids})},defaultAddCache:function(items){var that=this;_(that.possibilities).each(function(p){var matching_items=_(items).filter(function(i){return that.fn(p,i)}),matching_cids=_(matching_items).map(function(i){return i.cid});p.matching_cids=PourOver.union_sorted(p.matching_cids,matching_cids)})},exactCache:function(items){var that=this,attr=this.attr||this.name;_(items).each(function(i){var p=that.possibilities[i[attr]];if(p){p.matching_cids=PourOver.insert_sorted(p.matching_cids,i.cid)}})},exactAddCache:function(items){PourOver.cacheMethods.exactCache.call(this,items)},inclusionCache:function(items){var that=this,attr=this.attr||this.name;_(items).each(function(i){_(i[attr]).each(function(v){var p=that.possibilities[v];if(p){p.matching_cids=PourOver.insert_sorted(p.matching_cids,i.cid)}})})},inclusionAddCache:function(items){PourOver.cacheMethods.inclusionCache.call(this,items)}}};var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;var Events=PourOver.Events={on:function(name,callback,context){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments)});once._callback=callback;return this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context){this._events=void 0;return this}names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context){retain.push(ev)}}}if(!retain.length)delete this._events[name]}}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;if(!callback&&typeof name==="object")callback=this;if(obj)(listeningTo={})[obj._listenId]=obj;for(var id in listeningTo){obj=listeningTo[id];obj.off(name,callback,this);if(remove||_.isEmpty(obj._events))delete this._listeningTo[id]}return this}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==="object"){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest))}return false}if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest))}return false}return true};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args);return}};var listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={});var id=obj._listenId||(obj._listenId=_.uniqueId("l"));listeningTo[id]=obj;if(!callback&&typeof name==="object")callback=this;obj[implementation](name,callback,this);return this}});Events.bind=Events.on;Events.unbind=Events.off;_.extend(PourOver,Events);PourOver.Collection=function(items,opts){if(typeof items=="undefined"){items=[]}this.items=[];this.filters={};this.sorts={};this.addItems(items);this.on("change",function(){_(this.filters).each(function(f){if(f.current_query){f.current_query.refresh()}})});this.initialize.apply(this,arguments)};_.extend(PourOver.Collection.prototype,PourOver.Events,{initialize:function(){},refresh:function(){this.trigger("queryChange")},get:function(cids){return PourOver.Collection.prototype.getBy.call(this,"cid",cids,true)},getBy:function(attr_name,vals,sorted){if(!_.isArray(vals)){var vals=[vals]}if(typeof sorted=="undefined"){sorted=false}var low=0,high=this.items.length,lc=0,hc=vals.length,output=[],items=this.items,i;if(sorted==true){while(low<high&&lc<hc){if(vals[lc]==(i=items[low])[attr_name]){output.push(i);low++;lc++}else if(vals[lc]<i[attr_name]){lc++}else{low++}}}else if(sorted=="reverse"){while(low<high&&lc<hc){if(vals[lc]==(i=items[low])[attr_name]){output.push(i);low++;lc++}else if(vals[lc]>i[attr_name]){lc++}else{low++}}}else{while(low<high&&lc<hc){if(_(vals).include((i=items[low])[attr_name])){output.push(i);vals=_(vals).without(i[attr_name]);low++;lc++}else{low++}}}return output},addItems:function(i){this.trigger("will_change");if(!_.isArray(i)){var i=[i]}var last_id=this.items.length>0?_(this.items).last().cid+1:0,new_items;new_items=_(i).map(function(c){var n=PourOver.Item(c);n.cid=last_id++;return n});this.items=this.items.concat(new_items);this.regenerateFilterSets(new_items);this.trigger("change")},removeItems:function(i,isSorted){this.trigger("will_change");if(typeof isSorted==="undefined"){var isSorted=false}if(!_.isArray(i)){var i=[i]}if(isSorted){i=i.sort(function(a,b){return a.cid-b.cid});var new_items=[],old_items=this.items,new_length=i.length,old_length=this.items.length,newi=0,oldi=0;while(oldi<old_length){if(!newi<new_length){new_items=new_items.concat(old_items.slice(oldi));break}else if(old_items[oldi].cid===i[newi].cid){newi++;oldi++}else{new_items.push(old_items[oldi]);oldi++}}}else{var new_items=[],old_items=this.items,old_length=this.items.length,oldi=0,delete_cids=_(i).pluck("cid");while(oldi<old_length&&delete_cids.length>0){if(_(delete_cids).include(old_items[oldi].cid)){}else{new_items.push(old_items[oldi])}oldi++}}this.items=new_items;this.regenerateFilterSets();this.trigger("change")},addFilters:function(f){var that=this,new_filters;if(!_.isArray(f)){var f=[f]}new_filters=_(f).reduce(function(m,i){m[i.name]=_.clone(i);m[i.name].collection=that;return m},{});this.filters=_(this.filters).extend(new_filters);_(new_filters).each(function(f){f.on("queryChange",function(){that.trigger("queryChange")});f.cacheResults(that.items);if(f.associated_attrs){_(f.associated_attrs).each(function(a){that.on("change:"+a,function(objs){f.removeFromCache(objs);f.addCacheResults(objs);if(f.current_query){f.current_query.refresh()}})})}})},regenerateFilterSets:function(new_items){var that=this;if(typeof new_items=="undefined"){_(this.filters).each(function(f){f.cacheResults(that.items)})}else{_(this.filters).each(function(f){f.addCacheResults(new_items)})}},getAllItems:function(){var cids=_(this.items).map(function(i){return i.cid});return new PourOver.MatchSet(cids,this,["all"])},getCurrentFilteredItems:function(filter_name,empty_default){if(typeof empty_default==="undefined"){empty_default=false}if(this.filters[filter_name].current_query&&this.filters[filter_name].current_query.stack.length>0){return this.filters[filter_name].current_query}else{if(empty_default){return new PourOver.MatchSet([],this,[])}else{return this.getAllItems()}}},getFilteredItems:function(filter_name,query){var filter=this.filters[filter_name],possibility;if(_.isUndefined(filter))throw"The filter "+filter_name+" does not exist.";return filter.getFn(query)},addSort:function(sort){var that=this;this.sorts[sort.name]=sort;sort.collection=this;sort.rebuild_sort();this.on("change",function(){sort.rebuild_sort()});if(sort.associated_attrs){_(sort.associated_attrs).each(function(a){that.on("change:"+a,function(objs){sort.rebuild_sort()})})}},addSorts:function(sorts){if(typeof opts==="undefined"){opts={}}if(!_(sorts).isArray()){sorts=[sorts]}var that=this;_(sorts).each(function(s){that.addSort(s)})},getSortedItems:function(sort_name){var s=this.sorts[sort_name],that=this,output;return s.sort(this.items)},getItemValue:function(cid,attribute){var item=_(this.items).find(function(i){return i.cid===Number(cid)});return item[attribute]},updateItem:function(cid,attribute,value){this.trigger("will_incremental_change");var item=_(this.items).find(function(i){return i.cid===Number(cid)});item[attribute]=value;this.trigger("change:"+attribute,[item]);this.trigger("incremental_change",[attribute]);this.trigger("update","updateItem");return item.guid},batchUpdateItems:function(cids,attribute,value){this.trigger("will_incremental_change");var items=this.get(cids,true);_(items).each(function(i){i[attribute]=value});this.trigger("change:"+attribute,items);this.trigger("incremental_change",[attribute]);this.trigger("update","batchUpdate");return _(items).pluck("guid")},updateAttributes:function(cid,updates){this.trigger("will_incremental_change");var item=_(this.items).find(function(i){return i.cid===Number(cid)});var that=this;_(updates).each(function(v,k){item[k]=v;that.trigger("change:"+k,[item])});this.trigger("incremental_change",_(updates).keys());this.trigger("update","updateAttribute");return item.guid},batchUpdateAttributes:function(cids,updates){this.trigger("will_incremental_change");var items=this.get(cids,true);var that=this;_(items).each(function(item){_(updates).each(function(v,k){item[k]=v})});_(updates).each(function(v,k){that.trigger("change:"+k,items)});this.trigger("incremental_change",_(updates).keys());this.trigger("update");this.trigger("batchUpdateAttribute");return _(items).pluck("guid")}});PourOver.Item=function(i){return i},PourOver.Filter=function(name,values,opts){if(typeof opts==="undefined"){opts={}}this.name=name;this.possibilities=this.create_possibilities(values);this.values=_(values).map(function(v){return v.value});_.extend(this,opts);this.initialize.apply(this,arguments)};_.extend(PourOver.Filter.prototype,PourOver.Events,{initialize:function(){},create_possibilities:function(vs){var o={};_(vs).each(function(v){var name=v.name||String(v.value);o[name]=v;o[name].matching_cids=[]});return o},cacheResults:function(items){throw"No cache function has been defined for this filter '"+this.name+"'."},addCacheResults:function(items){throw"No add cache function has been defined for this filter '"+this.name+"'."},makeQueryMatchSet:function(cids,query){return new PourOver.MatchSet(cids,this.getCollection(),[[this,query]])},removeFromCache:function(items){var cids=_(items).map(function(i){return i.cid}).sort(function(a,b){return a-b});_(this.possibilities).each(function(p){p.matching_cids=PourOver.subtract_sorted(p.matching_cids,cids)})},query:function(q,silent){if(typeof silent==="undefined"){var silent=false}var match_set=this.getFn(q);this.setQuery(match_set,silent)},setQuery:function(q,silent){if(typeof silent==="undefined"){var silent=false}this.current_query=q;if(!silent){this.trigger("queryChange")}},clearQuery:function(silent){if(typeof silent==="undefined"){var silent=false}this.current_query=false;if(!silent){this.trigger("queryChange")}},unionQuery:function(q,silent){if(typeof silent==="undefined"){var silent=false}if(typeof q==="string"||typeof q==="number"||_.isArray(q)){var q=this.getFn(q)}if(this.current_query){this.current_query=this.current_query.or(q)}else{this.current_query=q}if(!silent){this.trigger("queryChange")}},intersectQuery:function(q,silent){if(typeof silent==="undefined"){var silent=false}if(typeof q==="string"||typeof q==="number"||_.isArray(q)){var q=this.getFn(q)}if(this.current_query){this.current_query=this.current_query.and(q)}else{this.current_query=q}if(!silent){this.trigger("queryChange")}},subtractQuery:function(q,silent){if(typeof silent==="undefined"){var silent=false}if(typeof q==="string"||typeof q==="number"||_.isArray(q)){var q=this.getFn(q)}if(this.current_query){this.current_query=this.current_query.not(q)}else{this.current_query=q}if(!silent){this.trigger("queryChange")}},removeSingleQuery:function(q,silent){if(!this.current_query){return false}if(typeof silent==="undefined"){var silent=false}if(typeof q==="string"||typeof q==="number"||_.isArray(q)){var q=this.getFn(q)}var s=[],stack=this.current_query.stack,new_stack,is_compound=function(c){return _.isString(c)&&c.match(/^(or|and|not)$/)};new_stack=_(stack).reduce(function(m,i){if(i[1]===q.stack[0][1]){return m}else if(is_compound(i[0])&&i[1][0][1]===q.stack[0][1]){return m}else{m.push(i);return m}},s);if(new_stack[0]&&(new_stack[0][0]=="and"||new_stack[0][0]=="or"||new_stack[0][0]=="not")){new_stack[0]=new_stack[0][1][0]}this.current_query.stack=new_stack;this.current_query.refresh();if(!silent){this.trigger("queryChange")}},getCollection:function(){return this.collection}});PourOver.Sort=function(name,opts){this.name=name;_.extend(this,opts);this.initialize.apply(this,arguments)};_.extend(PourOver.Sort.prototype,PourOver.Events,{initialize:function(){},view:false,sort:function(set){return PourOver.permute_from_array(set,this.permutation_array)},rebuild_sort:function(){if(this.view){var items=this.view.match_set.all()}else{var items=this.collection.items}this.permutation_array=PourOver.build_permutation_array(items,this);this.trigger("resort")}});PourOver.View=function(name,collection,opts){var that=this;this.name=name;if(typeof opts==="undefined"){opts={}}this.collection=collection;this.match_set=new PourOver.MatchSet(_(this.collection.items).map(function(i){return i.cid}),this.collection,["all"]);if(opts.template){this.template=opts.template}this.collection.on("will_change will_incremental_change",function(){that.storeViewPosition()});this.collection.on("change",function(){that.match_set.refresh();that.setNaturalSelection();that.resetPage()});this.collection.on("incremental_change",function(attrs){that.match_set.refresh();that.setNaturalSelection(attrs);that.resetPage()});this.collection.on("update",function(f){that.trigger("update",f)});this.collection.on("queryChange",function(){that.setNaturalSelection();that.trigger("update","query")});this.on("sortChange",function(){this.trigger("update","sort")});this.on("pageChange",function(){this.trigger("update","page")});_.extend(this,opts);this.initialize.apply(this,arguments)};_.extend(PourOver.View.prototype,PourOver.Events,{initialize:function(){},current_page:0,view_sorts:[],page_size:Infinity,current_sort:false,removeSort:function(){if(this.current_sort.off){this.current_sort.off("resort")}this.current_sort=false;this.trigger("sortChange")},setSort:function(sort_name,view_sort){if(typeof view_sort==="undefined"){view_sort=false}var that=this;if(this.current_sort.off){this.current_sort.off("resort")}if(sort_name&&view_sort){this.current_sort=this.view_sorts[sort_name];this.current_sort.on("resort",function(){that.trigger("sortChange")})}else if(sort_name){this.current_sort=this.collection.sorts[sort_name];this.current_sort.on("resort",function(){that.trigger("sortChange")})}else{this.current_sort=false}this.trigger("sortChange")},getSort:function(){if(!this.current_sort){return false}else{return this.current_sort.name}},addViewSorts:function(sorts){if(typeof opts==="undefined"){opts={}}if(!_(sorts).isArray()){sorts=[sorts]}var that=this;_(sorts).each(function(sort){that.view_sorts[sort.name]=sort;sort.collection=that.collection;sort.view=that;sort.rebuild_sort();that.on("selectionChange",function(attrs){if(sort.associated_attrs==undefined){sort.rebuild_sort()}if(sort.associated_attrs&&_.intersection(sort.associated_attrs,attrs).length>0){sort.rebuild_sort()}})})},selectionFn:function(){var collection=this.collection;var output=_(collection.filters).reduce(function(m,i){var q=i.current_query;if(m&&(!q||_.isEmpty(q.stack))){return m}if(!m&&(!q||_.isEmpty(q.stack))){return collection.getAllItems()}if(m){return m.and(q)}else{return q}},false);return output},setSelection:function(match_set,attrs){this.match_set=match_set;this.trigger("selectionChange",attrs)},setNaturalSelection:function(attrs){var selection;selection=this.selectionFn();this.setSelection(selection,attrs)},clearSelection:function(){this.match_set=this.collection.getAllItems()},getCurrentItems:function(page){if(!this.match_set){return[]}if(typeof page==="undefined"){var page=this.current_page}if(this.page_size==Infinity){if(this.current_sort){var items=this.match_set.all_sorted(this.current_sort)}else{var items=this.match_set.all()}}else{if(this.current_sort){var items=this.match_set.all_sorted_cids(this.current_sort);items=items.slice(this.page_size*page,this.page_size*(page+1));var ordered_cids=_(items).clone().sort(function(a,b){return a-b});var unsorted_items=this.collection.get(ordered_cids);items=_(items).map(function(i){return _(unsorted_items).find(function(o){return o.cid===i})})}else{var items=this.match_set.cids;items=items.slice(this.page_size*page,this.page_size*(page+1));items=this.collection.get(items)}}return items},storeViewPosition:function(){var head_item=this.getCurrentItems()[0];if(head_item){this.last_head_cid=head_item.cid}},resetPage:function(){if(this.last_head_cid){if(this.current_sort){this.current_sort.rebuild_sort()}this.pageTo(this.last_head_cid,true)}this.last_head_cid=undefined},page:function(dir){var new_dir=dir+this.current_page;if(new_dir<0)new_dir=0;if(new_dir>Math.ceil(this.match_set.length()/this.page_size-1))new_dir=Math.ceil(this.match_set.length()/this.page_size-1);this.current_page=new_dir;this.trigger("pageChange")},pageTo:function(cid,silent){if(typeof silent=="undefined"){var silent=false}if(this.current_sort){var index=_(this.match_set.all_sorted_cids(this.current_sort)).indexOf(cid),len=this.match_set.cids.length,page=Math.floor(index/this.page_size)}else{var index=_(this.match_set.cids).indexOf(cid),len=this.match_set.cids.length,page=Math.floor(index/this.page_size)}if(index>=0){this.current_page=page;if(!silent){this.trigger("pageChange")}}},setPage:function(page){if(page<0)page=0;if(page>Math.ceil(this.match_set.length()/this.page_size-1))page=Math.ceil(this.match_set.length()/this.page_size-1);this.current_page=page;this.trigger("pageChange")},setPageSize:function(size){this.page_size=size;this.trigger("pageChange")},render:function(){}});PourOver.MatchSet=function(cids,collection,stack){this.cids=cids;this.collection=collection;this.stack=stack;this.initialize.apply(this,arguments)};_.extend(PourOver.MatchSet.prototype,PourOver.Events,{initialize:function(){},refresh:function(s,match_set){if(typeof s==="undefined"){var s=this.stack||[]}if(s.length<1&&match_set){this.cids=match_set.cids;return this}else if(s.length<1){this.cids=false;return this}var step=s[0],operation=step[0],is_compound=function(c){return _.isString(c)&&c.match(/^(or|and|not)$/)};if(typeof operation==="object"){var match_set=operation.getFn(step[1]);return this.refresh(_(s).rest(),match_set)}else if(operation==="all"||step==="all"){var cids=_(this.collection.items).map(function(i){return i.cid});var match_set=new PourOver.MatchSet(cids,this,["all"]);
return this.refresh(_(s).rest(),match_set)}else if(is_compound(operation)){var m=match_set[operation](this.refresh(step[1]))}else{var m=this.refresh(step[1])}return this.refresh(_(s).rest(),m)},and:function(other_matches){if(this.stack.length<1&&other_matches){return other_matches}else if(!other_matches){return this}else{var set=PourOver.intersect_sorted(this.cids,other_matches.cids);return new PourOver.MatchSet(set,this.collection,this.stack.concat([["and",other_matches.stack]]))}},or:function(other_matches){if(this.stack.length<1&&other_matches){return other_matches}else if(!other_matches){return this}else{var set=PourOver.union_sorted(this.cids,other_matches.cids);return new PourOver.MatchSet(set,this.collection,this.stack.concat([["or",other_matches.stack]]))}},not:function(other_matches){if(this.stack.length<1||!other_matches){return this}else{var set=PourOver.subtract_sorted(this.cids,other_matches.cids);return new PourOver.MatchSet(set,this.collection,this.stack.concat([["not",other_matches.stack]]))}},all:function(){return this.collection.get(this.cids)},slice:function(s,e){return this.collection.get(this.cids.slice(s,e))},all_sorted:function(s){var c=this.all();if(s){return s.sort(c)}else{return c}},all_sorted_cids:function(s){var c=this.cids;if(s){return s.sort(c)}else{return c}},length:function(){return this.cids.length}});PourOver.UI={};PourOver.UI.Element=function(opts){if(typeof opts==="undefined"){var opts={}}_.extend(this,opts);this.initialize.apply(this,arguments)};_.extend(PourOver.UI.Element.prototype,PourOver.Events,{initialize:function(){},getMatchSet:function(){throw"No get match set function specified"},getFilterState:function(){throw"No get filter state specified"},template:function(){throw"No template specified"},render:function(){var filter_state=this.getFilterState(),output=this.template({state:filter_state});return output},getSimpleSelectState:function(match_set,s,output){if(typeof match_set==="undefined"||!match_set||!match_set.stack){return false}if(typeof s==="undefined"){var s=match_set.stack}if(typeof output==="undefined"){var output=[]}if(s.length<1){return output}else if(typeof s[0][0]==="object"){output.push(s[0][1]);return this.getSimpleSelectState(match_set,_(s).rest(),output)}else if(s[0][0]==="or"){output=output.concat(this.getSimpleSelectState(match_set,s[0][1]));return this.getSimpleSelectState(match_set,_(s).rest(),output)}else{throw"This does not appear to be a valid, simple selectElement stack."}},getIntersectedSelectState:function(match_set,s,output){if(typeof match_set==="undefined"||!match_set||!match_set.stack){return false}if(typeof s==="undefined"){var s=match_set.stack}if(typeof output==="undefined"){var output=[]}if(s.length<1){return output}else if(typeof s[0][0]==="object"){output.push(s[0][1]);return this.getIntersectedSelectState(match_set,_(s).rest(),output)}else if(s[0][0]==="and"){output=output.concat(this.getIntersectedSelectState(match_set,s[0][1]));return this.getIntersectedSelectState(match_set,_(s).rest(),output)}else{throw"This does not appear to be a valid, simple selectElement stack."}},getSimpleRangeState:function(match_set){if(typeof match_set==="undefined"||!match_set||!match_set.stack){return false}stack=match_set.stack;if(stack.length!==1||stack[0][1].length!==2){throw"The filter specified does not appear to have a simple range stack."}return stack[0][1]}});PourOver.extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&_.has(protoProps,"constructor")){child=protoProps.constructor}else{child=function(){return parent.apply(this,arguments)}}_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate;if(protoProps)_.extend(child.prototype,protoProps);child.__super__=parent.prototype;return child};PourOver.Collection.extend=PourOver.View.extend=PourOver.Filter.extend=PourOver.Sort.extend=PourOver.MatchSet.extend=PourOver.UI.Element.extend=PourOver.extend;PourOver.BufferedCollection=PourOver.Collection.extend({buffered_items:{},stripFutures:function(item){return _(item).reduce(function(m,v,k){if(typeof v!="undefined"){m[k]=v}return m},{})},get:function(cids,raw){if(typeof raw==="undefined"){var raw=false}var items=PourOver.Collection.prototype.get.call(this,cids),that=this;if(raw){return items}return _(items).map(function(i){var guid=i.guid,new_item;if(that.buffered_items.hasOwnProperty(guid)){return _(that.buffered_items[guid]).extend(that.stripFutures(i))}else{return i}})},getBy:function(attr_name,vals,sorted,raw){if(typeof raw==="undefined"){var raw=false}var items=PourOver.Collection.prototype.getBy.call(this,attr_name,vals,sorted),that=this;if(raw){return items}return _(items).map(function(i){var guid=i.guid,new_item;if(that.buffered_items.hasOwnProperty(guid)){return _(that.buffered_items[guid]).extend(that.stripFutures(i))}else{return i}})},getBufferedValue:function(guid,attr){if(this.buffered_items.hasOwnProperty(guid)){return this.buffered_items[guid][attr]||false}else{return false}},clearBufferedItems:function(){var buffered_items=this.buffered_items;for(var p in buffered_items){if(buffered_items.hasOwnProperty(p)){delete buffered_items[p]}}},getBufferUrl:function(guids){throw"You must override getBufferUrl;"},preprocessItem:function(item){return[item["guid"],item]},bufferGuids:function(guids){var that=this,guids=_(guids).select(function(g){return g&&!that.buffered_items.hasOwnProperty(g)}),buffurl=this.getBufferUrl(guids),url=buffurl[0],jsonpCallback=buffurl[1];if(guids.length>0){return $.ajax({url:url,dataType:"jsonp",cache:true}).always(function(d){if(_.isArray(d)){items=_(d).map(_.bind(that.preprocessItem,that));_(items).each(function(i){that.buffered_items[i[0]]=i[1]})}})}else{return $.Deferred().resolve(false)}}});PourOver.BufferedView=PourOver.View.extend({buffer_pages:1,bufferAroundCurrentPage:function(){var current_page=this.current_page,low_bound=current_page-this.buffer_pages>0?current_page-this.buffer_pages:0,high_bound=current_page+this.buffer_pages,range=_.range(low_bound,high_bound+1),that=this;range=_(range).map(function(page){return _(that.getCurrentItems(page)).pluck("guid")});var guids=_.flatten(range);buffer_deferred=this.collection.bufferGuids(guids);buffer_deferred.done(function(d){if(d){that.render()}})},bufferRender:function(){var guids=_(this.getCurrentItems()).pluck("guid"),buffer_deferred=this.collection.bufferGuids(guids);buffer_deferred.done(_(function(){this.render()}).bind(this))},page:function(dir){PourOver.View.prototype.page.call(this,dir);this.bufferAroundCurrentPage()},pageTo:function(cid,silent){if(typeof silent==="undefined"){var silent=false}PourOver.View.prototype.pageTo.call(this,cid,silent);this.bufferAroundCurrentPage()}});PourOver.manualFilter=PourOver.Filter.extend({cacheResults:function(){return false},addCacheResults:function(){return false},getFn:function(query){if(_(query).isArray()){query=query.sort(function(a,b){return a-b});return new PourOver.MatchSet(query,this.getCollection(),[[this,query]])}else if(typeof query==="number"){return new PourOver.MatchSet([query],this.getCollection(),[[this,query]])}else{throw"Manual filters only support querying by one or more cids"}},addItems:function(cids){if(!_(cids).isArray()){cids=[cids]}cids=cids.sort(function(a,b){return a-b});if(this.current_query){var current_query=this.current_query.cids,new_query=PourOver.union_sorted(current_query,cids)}else{var new_query=cids}this.query(new_query)},removeItems:function(cids){if(!_(cids).isArray()){cids=[cids]}cids=cids.sort(function(a,b){return a-b});var current_query=this.current_query.cids,new_query=PourOver.subtract_sorted(current_query,cids);this.query(new_query)}});PourOver.makeManualFilter=function(name){var filter=new PourOver.manualFilter(name,[]);return filter};PourOver.exactFilter=PourOver.Filter.extend({cacheResults:PourOver.cacheMethods.exactCache,addCacheResults:PourOver.cacheMethods.exactAddCache,getFn:function(query){var that=this;if(_(query).isArray()){var match_set=_(query).reduce(function(m,i){if(!m){return that.getFn(i)}else{return m.or(that.getFn(i))}},false);return match_set}else{var possibility=this.possibilities[query];if(_.isUndefined(possibility))throw"The filter "+this.name+" does not have a match for the query '"+query+"'.";return new PourOver.MatchSet(possibility.matching_cids,this.getCollection(),[[this,query]])}}});PourOver.makeExactFilter=function(name,values,opts){if(typeof opts==="undefined"){opts={}}var values=_(values).map(function(i){return{value:i}}),attr=opts.attr||name,opts=_.extend({associated_attrs:[attr]},opts),filter=new PourOver.exactFilter(name,values,opts);return filter};PourOver.inclusionFilter=PourOver.exactFilter.extend({cacheResults:PourOver.cacheMethods.inclusionCache,addCacheResults:PourOver.cacheMethods.inclusionAddCache});PourOver.makeInclusionFilter=function(name,values,opts){if(typeof opts==="undefined"){opts={}}var values=_(values).map(function(i){return{value:i}}),attr=opts.attr||name,opts=_.extend({associated_attrs:[attr]},opts),filter=new PourOver.inclusionFilter(name,values,opts);return filter};PourOver.rangeFilter=PourOver.Filter.extend({cacheResults:PourOver.cacheMethods.defaultCache,addCacheResults:PourOver.cacheMethods.defaultAddCache,fn:function(possibility,item){var attr=this.attr||this.name;return possibility.low<=item[attr]&&possibility.high>=item[attr]},getFn:function(query){var possibility=this.possibilities[query.join("-")];if(_.isUndefined(possibility))throw"The filter "+this.name+" does not have a match for the query '"+query+"'.";return new PourOver.MatchSet(possibility.matching_cids,this.getCollection(),[[this,query]])}});PourOver.makeRangeFilter=function(name,ranges,opts){if(typeof opts==="undefined"){opts={}}var values=_(ranges).map(function(r){return{low:r[0],high:r[1],value:r.join("-")}}),attr=opts.attr||name,newopts=_.extend({associated_attrs:[attr]},opts),filter=new PourOver.rangeFilter(name,values,newopts);return filter};PourOver.dvrangeFilter=PourOver.Filter.extend({cacheResults:PourOver.cacheMethods.exactCache,addCacheResults:PourOver.cacheMethods.exactAddCache,getFn:function(query){if(!query[0]||!query[1]){return new PourOver.MatchSet([],this.getCollection(),[[this,query]])}var li,hi,that,possibilities,cids;li=_(this.values).indexOf(query[0]);hi=_(this.values).indexOf(query[1]);that=this;possibilities=_(this.values.slice(li,hi+1)).map(function(p){return that.possibilities[p]});cids=_(possibilities).reduce(function(m,i){return PourOver.union_sorted(m,i.matching_cids)},[]);return new PourOver.MatchSet(cids,this.getCollection(),[[this,query]])}});PourOver.makeDVrangeFilter=function(name,v,opts){if(typeof opts==="undefined"){opts={}}var values=_(v).map(function(i){return{value:i}}),attr=opts.attr||name,newopts=_.extend({associated_attrs:[attr]},opts),filter=new PourOver.dvrangeFilter(name,values,newopts);return filter};PourOver.explicitSort=PourOver.Sort.extend({fn:function(a,b){var a_index=_(this.order).indexOf(a[this.attr]),b_index=_(this.order).indexOf(b[this.attr]);if(a_index===-1){a_index=1/0}if(b_index===-1){b_index=1/0}return a_index-b_index},reset:function(items){this.order=_(items).pluck(this.attr);this.rebuild_sort()},insert:function(items,index){if(typeof index==="undefined"){var index=this.order.length}if(!_(items).isArray()){items=[items]}var new_order=_(items).pluck(this.attr),args=[index,0].concat(new_order);this.order.splice.apply(this.order,args);this.rebuild_sort()},remove:function(items){if(!_(items).isArray()){items=[items]}var attrs=_(items).pluck(this.attr);this.order=_(this.order).difference(attrs);this.rebuild_sort()},move:function(items,index){if(!_(items).isArray()){items=[items]}var attrs=_(items).pluck(this.attr);this.order=_(this.order).map(function(o){return _(attrs).include(o)?null:o});this.insert(items,index);this.order=_(this.order).compact()}});PourOver.makeExplicitSort=function(name,collection,attr,order,opts){var sort=new PourOver.explicitSort(name,opts);sort.attr=attr;sort.order=order;return sort};PourOver.reverseCidSort=PourOver.Sort.extend({fn:function(a,b){return b.cid-a.cid}});PourOver.makeReverseCidSort=function(name,collection){var sort=new PourOver.reverseCidSort(name);sort.attr="cid";return sort};PourOver.UI.SimpleSelectElement=PourOver.UI.Element.extend({initialize:function(opts){if(!opts.filter){throw"A simple select element must have a filter specified"}this.filter=opts.filter},getMatchSet:function(){return this.filter.current_query},getFilterState:function(){var match_set=this.getMatchSet();return this.getSimpleSelectState(match_set)}});PourOver.UI.SimpleDVRangeElement=PourOver.UI.Element.extend({initialize:function(opts){if(!opts.filter){throw"A simple dv range element must have a filter specified"}this.filter=opts.filter},getMatchSet:function(){return this.filter.current_query},getFilterState:function(){var match_set=this.getMatchSet();return this.getSimpleRangeState(match_set)}});return PourOver}();typeof JSON!="object"&&(JSON={}),function(){"use strict";function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a&&typeof a=="object"&&typeof a.toJSON=="function"&&(a=a.toJSON(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(e){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;typeof JSON.stringify!="function"&&(JSON.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")}),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),function(e,t){"use strict";var n=e.History=e.History||{},r=e.jQuery;if(typeof n.Adapter!="undefined")throw new Error("History.js Adapter has already been loaded...");n.Adapter={bind:function(e,t,n){r(e).bind(t,n)},trigger:function(e,t,n){r(e).trigger(t,n)},extractEventData:function(e,n,r){var i=n&&n.originalEvent&&n.originalEvent[e]||r&&r[e]||t;return i},onDomLoad:function(e){r(e)}},typeof n.init!="undefined"&&n.init()}(window),function(e,t){"use strict";var n=e.document,r=e.setTimeout||r,i=e.clearTimeout||i,s=e.setInterval||s,o=e.History=e.History||{};if(typeof o.initHtml4!="undefined")throw new Error("History.js HTML4 Support has already been loaded...");o.initHtml4=function(){if(typeof o.initHtml4.initialized!="undefined")return!1;o.initHtml4.initialized=!0,o.enabled=!0,o.savedHashes=[],o.isLastHash=function(e){var t=o.getHashByIndex(),n;return n=e===t,n},o.isHashEqual=function(e,t){return e=encodeURIComponent(e).replace(/%25/g,"%"),t=encodeURIComponent(t).replace(/%25/g,"%"),e===t},o.saveHash=function(e){return o.isLastHash(e)?!1:(o.savedHashes.push(e),!0)},o.getHashByIndex=function(e){var t=null;return typeof e=="undefined"?t=o.savedHashes[o.savedHashes.length-1]:e<0?t=o.savedHashes[o.savedHashes.length+e]:t=o.savedHashes[e],t},o.discardedHashes={},o.discardedStates={},o.discardState=function(e,t,n){var r=o.getHashByState(e),i;return i={discardedState:e,backState:n,forwardState:t},o.discardedStates[r]=i,!0},o.discardHash=function(e,t,n){var r={discardedHash:e,backState:n,forwardState:t};return o.discardedHashes[e]=r,!0},o.discardedState=function(e){var t=o.getHashByState(e),n;return n=o.discardedStates[t]||!1,n},o.discardedHash=function(e){var t=o.discardedHashes[e]||!1;return t},o.recycleState=function(e){var t=o.getHashByState(e);return o.discardedState(e)&&delete o.discardedStates[t],!0},o.emulated.hashChange&&(o.hashChangeInit=function(){o.checkerFunction=null;var t="",r,i,u,a,f=Boolean(o.getHash());return o.isInternetExplorer()?(r="historyjs-iframe",i=n.createElement("iframe"),i.setAttribute("id",r),i.setAttribute("src","#"),i.style.display="none",n.body.appendChild(i),i.contentWindow.document.open(),i.contentWindow.document.close(),u="",a=!1,o.checkerFunction=function(){if(a)return!1;a=!0;var n=o.getHash(),r=o.getHash(i.contentWindow.document);return n!==t?(t=n,r!==n&&(u=r=n,i.contentWindow.document.open(),i.contentWindow.document.close(),i.contentWindow.document.location.hash=o.escapeHash(n)),o.Adapter.trigger(e,"hashchange")):r!==u&&(u=r,f&&r===""?o.back():o.setHash(r,!1)),a=!1,!0}):o.checkerFunction=function(){var n=o.getHash()||"";return n!==t&&(t=n,o.Adapter.trigger(e,"hashchange")),!0},o.intervalList.push(s(o.checkerFunction,o.options.hashChangeInterval)),!0},o.Adapter.onDomLoad(o.hashChangeInit)),o.emulated.pushState&&(o.onHashChange=function(t){var n=t&&t.newURL||o.getLocationHref(),r=o.getHashByUrl(n),i=null,s=null,u=null,a;return o.isLastHash(r)?(o.busy(!1),!1):(o.doubleCheckComplete(),o.saveHash(r),r&&o.isTraditionalAnchor(r)?(o.Adapter.trigger(e,"anchorchange"),o.busy(!1),!1):(i=o.extractState(o.getFullUrl(r||o.getLocationHref()),!0),o.isLastSavedState(i)?(o.busy(!1),!1):(s=o.getHashByState(i),a=o.discardedState(i),a?(o.getHashByIndex(-2)===o.getHashByState(a.forwardState)?o.back(!1):o.forward(!1),!1):(o.pushState(i.data,i.title,encodeURI(i.url),!1),!0))))},o.Adapter.bind(e,"hashchange",o.onHashChange),o.pushState=function(t,n,r,i){r=encodeURI(r).replace(/%25/g,"%");if(o.getHashByUrl(r))throw new Error("History.js does not support states with fragment-identifiers (hashes/anchors).");if(i!==!1&&o.busy())return o.pushQueue({scope:o,callback:o.pushState,args:arguments,queue:i}),!1;o.busy(!0);var s=o.createStateObject(t,n,r),u=o.getHashByState(s),a=o.getState(!1),f=o.getHashByState(a),l=o.getHash(),c=o.expectedStateId==s.id;return o.storeState(s),o.expectedStateId=s.id,o.recycleState(s),o.setTitle(s),u===f?(o.busy(!1),!1):(o.saveState(s),c||o.Adapter.trigger(e,"statechange"),!o.isHashEqual(u,l)&&!o.isHashEqual(u,o.getShortUrl(o.getLocationHref()))&&o.setHash(u,!1),o.busy(!1),!0)},o.replaceState=function(t,n,r,i){r=encodeURI(r).replace(/%25/g,"%");if(o.getHashByUrl(r))throw new Error("History.js does not support states with fragment-identifiers (hashes/anchors).");if(i!==!1&&o.busy())return o.pushQueue({scope:o,callback:o.replaceState,args:arguments,queue:i}),!1;o.busy(!0);var s=o.createStateObject(t,n,r),u=o.getHashByState(s),a=o.getState(!1),f=o.getHashByState(a),l=o.getStateByIndex(-2);return o.discardState(a,s,l),u===f?(o.storeState(s),o.expectedStateId=s.id,o.recycleState(s),o.setTitle(s),o.saveState(s),o.Adapter.trigger(e,"statechange"),o.busy(!1)):o.pushState(s.data,s.title,s.url,!1),!0}),o.emulated.pushState&&o.getHash()&&!o.emulated.hashChange&&o.Adapter.onDomLoad(function(){o.Adapter.trigger(e,"hashchange")})},typeof o.init!="undefined"&&o.init()}(window),function(e,t){"use strict";var n=e.console||t,r=e.document,i=e.navigator,s=!1,o=e.setTimeout,u=e.clearTimeout,a=e.setInterval,f=e.clearInterval,l=e.JSON,c=e.alert,h=e.History=e.History||{},p=e.history;try{s=e.sessionStorage,s.setItem("TEST","1"),s.removeItem("TEST")}catch(d){s=!1}l.stringify=l.stringify||l.encode,l.parse=l.parse||l.decode;if(typeof h.init!="undefined")throw new Error("History.js Core has already been loaded...");h.init=function(e){return typeof h.Adapter=="undefined"?!1:(typeof h.initCore!="undefined"&&h.initCore(),typeof h.initHtml4!="undefined"&&h.initHtml4(),!0)},h.initCore=function(d){if(typeof h.initCore.initialized!="undefined")return!1;h.initCore.initialized=!0,h.options=h.options||{},h.options.hashChangeInterval=h.options.hashChangeInterval||100,h.options.safariPollInterval=h.options.safariPollInterval||500,h.options.doubleCheckInterval=h.options.doubleCheckInterval||500,h.options.disableSuid=h.options.disableSuid||!1,h.options.storeInterval=h.options.storeInterval||1e3,h.options.busyDelay=h.options.busyDelay||250,h.options.debug=h.options.debug||!1,h.options.initialTitle=h.options.initialTitle||r.title,h.options.html4Mode=h.options.html4Mode||!1,h.options.delayInit=h.options.delayInit||!1,h.intervalList=[],h.clearAllIntervals=function(){var e,t=h.intervalList;if(typeof t!="undefined"&&t!==null){for(e=0;e<t.length;e++)f(t[e]);h.intervalList=null}},h.debug=function(){(h.options.debug||!1)&&h.log.apply(h,arguments)},h.log=function(){var e=typeof n!="undefined"&&typeof n.log!="undefined"&&typeof n.log.apply!="undefined",t=r.getElementById("log"),i,s,o,u,a;e?(u=Array.prototype.slice.call(arguments),i=u.shift(),typeof n.debug!="undefined"?n.debug.apply(n,[i,u]):n.log.apply(n,[i,u])):i="\n"+arguments[0]+"\n";for(s=1,o=arguments.length;s<o;++s){a=arguments[s];if(typeof a=="object"&&typeof l!="undefined")try{a=l.stringify(a)}catch(f){}i+="\n"+a+"\n"}return t?(t.value+=i+"\n-----\n",t.scrollTop=t.scrollHeight-t.clientHeight):e||c(i),!0},h.getInternetExplorerMajorVersion=function(){var e=h.getInternetExplorerMajorVersion.cached=typeof h.getInternetExplorerMajorVersion.cached!="undefined"?h.getInternetExplorerMajorVersion.cached:function(){var e=3,t=r.createElement("div"),n=t.getElementsByTagName("i");while((t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->")&&n[0]);return e>4?e:!1}();return e},h.isInternetExplorer=function(){var e=h.isInternetExplorer.cached=typeof h.isInternetExplorer.cached!="undefined"?h.isInternetExplorer.cached:Boolean(h.getInternetExplorerMajorVersion());return e},h.options.html4Mode?h.emulated={pushState:!0,hashChange:!0}:h.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(i.userAgent)&&!/AppleWebKit\/5([0-2]|3[0-2])/i.test(i.userAgent)),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in r)||h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8)},h.enabled=!h.emulated.pushState,h.bugs={setHash:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),safariPoll:Boolean(!h.emulated.pushState&&i.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(i.userAgent)),ieDoubleCheck:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<7)},h.isEmptyObject=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},h.cloneObject=function(e){var t,n;return e?(t=l.stringify(e),n=l.parse(t)):n={},n},h.getRootUrl=function(){var e=r.location.protocol+"//"+(r.location.hostname||r.location.host);if(r.location.port||!1)e+=":"+r.location.port;return e+="/",e},h.getBaseHref=function(){var e=r.getElementsByTagName("base"),t=null,n="";return e.length===1&&(t=e[0],n=t.href.replace(/[^\/]+$/,"")),n=n.replace(/\/+$/,""),n&&(n+="/"),n},h.getBaseUrl=function(){var e=h.getBaseHref()||h.getBasePageUrl()||h.getRootUrl();return e},h.getPageUrl=function(){var e=h.getState(!1,!1),t=(e||{}).url||h.getLocationHref(),n;return n=t.replace(/\/+$/,"").replace(/[^\/]+$/,function(e,t,n){return/\./.test(e)?e:e+"/"}),n},h.getBasePageUrl=function(){var e=h.getLocationHref().replace(/[#\?].*/,"").replace(/[^\/]+$/,function(e,t,n){return/[^\/]$/.test(e)?"":e}).replace(/\/+$/,"")+"/";return e},h.getFullUrl=function(e,t){var n=e,r=e.substring(0,1);return t=typeof t=="undefined"?!0:t,/[a-z]+\:\/\//.test(e)||(r==="/"?n=h.getRootUrl()+e.replace(/^\/+/,""):r==="#"?n=h.getPageUrl().replace(/#.*/,"")+e:r==="?"?n=h.getPageUrl().replace(/[\?#].*/,"")+e:t?n=h.getBaseUrl()+e.replace(/^(\.\/)+/,""):n=h.getBasePageUrl()+e.replace(/^(\.\/)+/,"")),n.replace(/\#$/,"")},h.getShortUrl=function(e){var t=e,n=h.getBaseUrl(),r=h.getRootUrl();return h.emulated.pushState&&(t=t.replace(n,"")),t=t.replace(r,"/"),h.isTraditionalAnchor(t)&&(t="./"+t),t=t.replace(/^(\.\/)+/g,"./").replace(/\#$/,""),t},h.getLocationHref=function(e){return e=e||r,e.URL===e.location.href?e.location.href:e.location.href===decodeURIComponent(e.URL)?e.URL:e.location.hash&&decodeURIComponent(e.location.href.replace(/^[^#]+/,""))===e.location.hash?e.location.href:e.URL.indexOf("#")==-1&&e.location.href.indexOf("#")!=-1?e.location.href:e.URL||e.location.href},h.store={},h.idToState=h.idToState||{},h.stateToId=h.stateToId||{},h.urlToId=h.urlToId||{},h.storedStates=h.storedStates||[],h.savedStates=h.savedStates||[],h.normalizeStore=function(){h.store.idToState=h.store.idToState||{},h.store.urlToId=h.store.urlToId||{},h.store.stateToId=h.store.stateToId||{}},h.getState=function(e,t){typeof e=="undefined"&&(e=!0),typeof t=="undefined"&&(t=!0);var n=h.getLastSavedState();return!n&&t&&(n=h.createStateObject()),e&&(n=h.cloneObject(n),n.url=n.cleanUrl||n.url),n},h.getIdByState=function(e){var t=h.extractId(e.url),n;if(!t){n=h.getStateString(e);if(typeof h.stateToId[n]!="undefined")t=h.stateToId[n];else if(typeof h.store.stateToId[n]!="undefined")t=h.store.stateToId[n];else{for(;;){t=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof h.idToState[t]=="undefined"&&typeof h.store.idToState[t]=="undefined")break}h.stateToId[n]=t,h.idToState[t]=e}}return t},h.normalizeState=function(e){var t,n;if(!e||typeof e!="object")e={};if(typeof e.normalized!="undefined")return e;if(!e.data||typeof e.data!="object")e.data={};return t={},t.normalized=!0,t.title=e.title||"",t.url=h.getFullUrl(e.url?e.url:h.getLocationHref()),t.hash=h.getShortUrl(t.url),t.data=h.cloneObject(e.data),t.id=h.getIdByState(t),t.cleanUrl=t.url.replace(/\??\&_suid.*/,""),t.url=t.cleanUrl,n=!h.isEmptyObject(t.data),(t.title||n)&&h.options.disableSuid!==!0&&(t.hash=h.getShortUrl(t.url).replace(/\??\&_suid.*/,""),/\?/.test(t.hash)||(t.hash+="?"),t.hash+="&_suid="+t.id),t.hashedUrl=h.getFullUrl(t.hash),(h.emulated.pushState||h.bugs.safariPoll)&&h.hasUrlDuplicate(t)&&(t.url=t.hashedUrl),t},h.createStateObject=function(e,t,n){var r={data:e,title:t,url:n};return r=h.normalizeState(r),r},h.getStateById=function(e){e=String(e);var n=h.idToState[e]||h.store.idToState[e]||t;return n},h.getStateString=function(e){var t,n,r;return t=h.normalizeState(e),n={data:t.data,title:e.title,url:e.url},r=l.stringify(n),r},h.getStateId=function(e){var t,n;return t=h.normalizeState(e),n=t.id,n},h.getHashByState=function(e){var t,n;return t=h.normalizeState(e),n=t.hash,n},h.extractId=function(e){var t,n,r,i;return e.indexOf("#")!=-1?i=e.split("#")[0]:i=e,n=/(.*)\&_suid=([0-9]+)$/.exec(i),r=n?n[1]||e:e,t=n?String(n[2]||""):"",t||!1},h.isTraditionalAnchor=function(e){var t=!/[\/\?\.]/.test(e);return t},h.extractState=function(e,t){var n=null,r,i;return t=t||!1,r=h.extractId(e),r&&(n=h.getStateById(r)),n||(i=h.getFullUrl(e),r=h.getIdByUrl(i)||!1,r&&(n=h.getStateById(r)),!n&&t&&!h.isTraditionalAnchor(e)&&(n=h.createStateObject(null,null,i))),n},h.getIdByUrl=function(e){var n=h.urlToId[e]||h.store.urlToId[e]||t;return n},h.getLastSavedState=function(){return h.savedStates[h.savedStates.length-1]||t},h.getLastStoredState=function(){return h.storedStates[h.storedStates.length-1]||t},h.hasUrlDuplicate=function(e){var t=!1,n;return n=h.extractState(e.url),t=n&&n.id!==e.id,t},h.storeState=function(e){return h.urlToId[e.url]=e.id,h.storedStates.push(h.cloneObject(e)),e},h.isLastSavedState=function(e){var t=!1,n,r,i;return h.savedStates.length&&(n=e.id,r=h.getLastSavedState(),i=r.id,t=n===i),t},h.saveState=function(e){return h.isLastSavedState(e)?!1:(h.savedStates.push(h.cloneObject(e)),!0)},h.getStateByIndex=function(e){var t=null;return typeof e=="undefined"?t=h.savedStates[h.savedStates.length-1]:e<0?t=h.savedStates[h.savedStates.length+e]:t=h.savedStates[e],t},h.getCurrentIndex=function(){var e=null;return h.savedStates.length<1?e=0:e=h.savedStates.length-1,e},h.getHash=function(e){var t=h.getLocationHref(e),n;return n=h.getHashByUrl(t),n},h.unescapeHash=function(e){var t=h.normalizeHash(e);return t=decodeURIComponent(t),t},h.normalizeHash=function(e){var t=e.replace(/[^#]*#/,"").replace(/#.*/,"");return t},h.setHash=function(e,t){var n,i;return t!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.setHash,args:arguments,queue:t}),!1):(h.busy(!0),n=h.extractState(e,!0),n&&!h.emulated.pushState?h.pushState(n.data,n.title,n.url,!1):h.getHash()!==e&&(h.bugs.setHash?(i=h.getPageUrl(),h.pushState(null,null,i+"#"+e,!1)):r.location.hash=e),h)},h.escapeHash=function(t){var n=h.normalizeHash(t);return n=e.encodeURIComponent(n),h.bugs.hashEscape||(n=n.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")),n},h.getHashByUrl=function(e){var t=String(e).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return t=h.unescapeHash(t),t},h.setTitle=function(e){var t=e.title,n;t||(n=h.getStateByIndex(0),n&&n.url===e.url&&(t=n.title||h.options.initialTitle));try{r.getElementsByTagName("title")[0].innerHTML=t.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(i){}return r.title=t,h},h.queues=[],h.busy=function(e){typeof e!="undefined"?h.busy.flag=e:typeof h.busy.flag=="undefined"&&(h.busy.flag=!1);if(!h.busy.flag){u(h.busy.timeout);var t=function(){var e,n,r;if(h.busy.flag)return;for(e=h.queues.length-1;e>=0;--e){n=h.queues[e];if(n.length===0)continue;r=n.shift(),h.fireQueueItem(r),h.busy.timeout=o(t,h.options.busyDelay)}};h.busy.timeout=o(t,h.options.busyDelay)}return h.busy.flag},h.busy.flag=!1,h.fireQueueItem=function(e){return e.callback.apply(e.scope||h,e.args||[])},h.pushQueue=function(e){return h.queues[e.queue||0]=h.queues[e.queue||0]||[],h.queues[e.queue||0].push(e),h},h.queue=function(e,t){return typeof e=="function"&&(e={callback:e}),typeof t!="undefined"&&(e.queue=t),h.busy()?h.pushQueue(e):h.fireQueueItem(e),h},h.clearQueue=function(){return h.busy.flag=!1,h.queues=[],h},h.stateChanged=!1,h.doubleChecker=!1,h.doubleCheckComplete=function(){return h.stateChanged=!0,h.doubleCheckClear(),h},h.doubleCheckClear=function(){return h.doubleChecker&&(u(h.doubleChecker),h.doubleChecker=!1),h},h.doubleCheck=function(e){return h.stateChanged=!1,h.doubleCheckClear(),h.bugs.ieDoubleCheck&&(h.doubleChecker=o(function(){return h.doubleCheckClear(),h.stateChanged||e(),!0},h.options.doubleCheckInterval)),h
},h.safariStatePoll=function(){var t=h.extractState(h.getLocationHref()),n;if(!h.isLastSavedState(t))return n=t,n||(n=h.createStateObject()),h.Adapter.trigger(e,"popstate"),h;return},h.back=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.back,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.back(!1)}),p.go(-1),!0)},h.forward=function(e){return e!==!1&&h.busy()?(h.pushQueue({scope:h,callback:h.forward,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck(function(){h.forward(!1)}),p.go(1),!0)},h.go=function(e,t){var n;if(e>0)for(n=1;n<=e;++n)h.forward(t);else{if(!(e<0))throw new Error("History.go: History.go requires a positive or negative integer passed.");for(n=-1;n>=e;--n)h.back(t)}return h};if(h.emulated.pushState){var v=function(){};h.pushState=h.pushState||v,h.replaceState=h.replaceState||v}else h.onPopState=function(t,n){var r=!1,i=!1,s,o;return h.doubleCheckComplete(),s=h.getHash(),s?(o=h.extractState(s||h.getLocationHref(),!0),o?h.replaceState(o.data,o.title,o.url,!1):(h.Adapter.trigger(e,"anchorchange"),h.busy(!1)),h.expectedStateId=!1,!1):(r=h.Adapter.extractEventData("state",t,n)||!1,r?i=h.getStateById(r):h.expectedStateId?i=h.getStateById(h.expectedStateId):i=h.extractState(h.getLocationHref()),i||(i=h.createStateObject(null,null,h.getLocationHref())),h.expectedStateId=!1,h.isLastSavedState(i)?(h.busy(!1),!1):(h.storeState(i),h.saveState(i),h.setTitle(i),h.Adapter.trigger(e,"statechange"),h.busy(!1),!0))},h.Adapter.bind(e,"popstate",h.onPopState),h.pushState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.pushState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.pushState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0},h.replaceState=function(t,n,r,i){if(h.getHashByUrl(r)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(i!==!1&&h.busy())return h.pushQueue({scope:h,callback:h.replaceState,args:arguments,queue:i}),!1;h.busy(!0);var s=h.createStateObject(t,n,r);return h.isLastSavedState(s)?h.busy(!1):(h.storeState(s),h.expectedStateId=s.id,p.replaceState(s.id,s.title,s.url),h.Adapter.trigger(e,"popstate")),!0};if(s){try{h.store=l.parse(s.getItem("History.store"))||{}}catch(m){h.store={}}h.normalizeStore()}else h.store={},h.normalizeStore();h.Adapter.bind(e,"unload",h.clearAllIntervals),h.saveState(h.storeState(h.extractState(h.getLocationHref(),!0))),s&&(h.onUnload=function(){var e,t,n;try{e=l.parse(s.getItem("History.store"))||{}}catch(r){e={}}e.idToState=e.idToState||{},e.urlToId=e.urlToId||{},e.stateToId=e.stateToId||{};for(t in h.idToState){if(!h.idToState.hasOwnProperty(t))continue;e.idToState[t]=h.idToState[t]}for(t in h.urlToId){if(!h.urlToId.hasOwnProperty(t))continue;e.urlToId[t]=h.urlToId[t]}for(t in h.stateToId){if(!h.stateToId.hasOwnProperty(t))continue;e.stateToId[t]=h.stateToId[t]}h.store=e,h.normalizeStore(),n=l.stringify(e);try{s.setItem("History.store",n)}catch(i){if(i.code!==DOMException.QUOTA_EXCEEDED_ERR)throw i;s.length&&(s.removeItem("History.store"),s.setItem("History.store",n))}},h.intervalList.push(a(h.onUnload,h.options.storeInterval)),h.Adapter.bind(e,"beforeunload",h.onUnload),h.Adapter.bind(e,"unload",h.onUnload));if(!h.emulated.pushState){h.bugs.safariPoll&&h.intervalList.push(a(h.safariStatePoll,h.options.safariPollInterval));if(i.vendor==="Apple Computer, Inc."||(i.appCodeName||"")==="Mozilla")h.Adapter.bind(e,"hashchange",function(){h.Adapter.trigger(e,"popstate")}),h.getHash()&&h.Adapter.onDomLoad(function(){h.Adapter.trigger(e,"hashchange")})}},(!h.options||!h.options.delayInit)&&h.init()}(window);(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else if(typeof exports==="object"){module.exports=global.window&&global.window.$?factory(global.window.$):function(input){if(!input.$&&!input.fn){throw new Error("Tokenfield requires a window object with jQuery or a jQuery instance")}return factory(input.$||input)}}else{factory(jQuery)}})(function($,window){"use strict";var Tokenfield=function(element,options){var _self=this;this.$element=$(element);this.textDirection=this.$element.css("direction");this.options=$.extend(true,{},$.fn.tokenfield.defaults,{tokens:this.$element.val()},this.$element.data(),options);this._delimiters=typeof this.options.delimiter==="string"?[this.options.delimiter]:this.options.delimiter;this._triggerKeys=$.map(this._delimiters,function(delimiter){return delimiter.charCodeAt(0)});this._firstDelimiter=this._delimiters[0];var whitespace=$.inArray(" ",this._delimiters),dash=$.inArray("-",this._delimiters);if(whitespace>=0)this._delimiters[whitespace]="\\s";if(dash>=0){delete this._delimiters[dash];this._delimiters.unshift("-")}var specialCharacters=["\\","$","[","{","^",".","|","?","*","+","(",")"];$.each(this._delimiters,function(index,char){var pos=$.inArray(char,specialCharacters);if(pos>=0)_self._delimiters[index]="\\"+char});var elRules=window&&typeof window.getMatchedCSSRules==="function"?window.getMatchedCSSRules(element):null,elStyleWidth=element.style.width,elCSSWidth,elWidth=this.$element.width();if(elRules){$.each(elRules,function(i,rule){if(rule.style.width){elCSSWidth=rule.style.width}})}var hidingPosition=$("body").css("direction")==="rtl"?"right":"left",originalStyles={position:this.$element.css("position")};originalStyles[hidingPosition]=this.$element.css(hidingPosition);this.$element.data("original-styles",originalStyles).data("original-tabindex",this.$element.prop("tabindex")).css("position","absolute").css(hidingPosition,"-10000px").prop("tabindex",-1);this.$wrapper=$('<div class="tokenfield form-control" />');if(this.$element.hasClass("input-lg"))this.$wrapper.addClass("input-lg");if(this.$element.hasClass("input-sm"))this.$wrapper.addClass("input-sm");if(this.textDirection==="rtl")this.$wrapper.addClass("rtl");var id=this.$element.prop("id")||(new Date).getTime()+""+Math.floor((1+Math.random())*100);this.$input=$('<input type="text" class="token-input" autocomplete="off" />').appendTo(this.$wrapper).prop("placeholder",this.$element.prop("placeholder")).prop("id",id+"-tokenfield").prop("tabindex",this.$element.data("original-tabindex"));var $label=$('label[for="'+this.$element.prop("id")+'"]');if($label.length){$label.prop("for",this.$input.prop("id"))}this.$copyHelper=$('<input type="text" />').css("position","absolute").css(hidingPosition,"-10000px").prop("tabindex",-1).prependTo(this.$wrapper);if(elStyleWidth){this.$wrapper.css("width",elStyleWidth)}else if(elCSSWidth){this.$wrapper.css("width",elCSSWidth)}else if(this.$element.parents(".form-inline").length){this.$wrapper.width(elWidth)}if(this.$element.prop("disabled")||this.$element.parents("fieldset[disabled]").length){this.disable()}if(this.$element.prop("readonly")){this.readonly()}this.$mirror=$('<span style="position:absolute; top:-999px; left:0; white-space:pre;"/>');this.$input.css("min-width",this.options.minWidth+"px");$.each(["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],function(i,val){_self.$mirror[0].style[val]=_self.$input.css(val)});this.$mirror.appendTo("body");this.$wrapper.insertBefore(this.$element);this.$element.prependTo(this.$wrapper);this.update();this.setTokens(this.options.tokens,false,false);this.listen();if(!$.isEmptyObject(this.options.autocomplete)){var side=this.textDirection==="rtl"?"right":"left",autocompleteOptions=$.extend({minLength:this.options.showAutocompleteOnFocus?0:null,position:{my:side+" top",at:side+" bottom",of:this.$wrapper}},this.options.autocomplete);this.$input.autocomplete(autocompleteOptions)}if(!$.isEmptyObject(this.options.typeahead)){var typeaheadOptions=this.options.typeahead,defaults={minLength:this.options.showAutocompleteOnFocus?0:null},args=$.isArray(typeaheadOptions)?typeaheadOptions:[typeaheadOptions,typeaheadOptions];args[0]=$.extend({},defaults,args[0]);this.$input.typeahead.apply(this.$input,args);this.typeahead=true}this.$element.trigger("tokenfield:initialize")};Tokenfield.prototype={constructor:Tokenfield,createToken:function(attrs,triggerChange){var _self=this;if(typeof attrs==="string"){attrs={value:attrs,label:attrs}}else{attrs=$.extend({},attrs)}if(typeof triggerChange==="undefined"){triggerChange=true}attrs.value=$.trim(attrs.value);attrs.label=attrs.label&&attrs.label.length?$.trim(attrs.label):attrs.value;if(!attrs.value.length||!attrs.label.length||attrs.label.length<=this.options.minLength)return;if(this.options.limit&&this.getTokens().length>=this.options.limit)return;var createEvent=$.Event("tokenfield:createtoken",{attrs:attrs});this.$element.trigger(createEvent);if(!createEvent.attrs||createEvent.isDefaultPrevented())return;var $token=$('<div class="token" />').append('<span class="token-label" />').append('<a href="#" class="close" tabindex="-1">&times;</a>').data("attrs",attrs);if(this.$input.hasClass("tt-input")){this.$input.parent().before($token)}else{this.$input.before($token)}this.$input.css("width",this.options.minWidth+"px");var $tokenLabel=$token.find(".token-label"),$closeButton=$token.find(".close");if(!this.maxTokenWidth){this.maxTokenWidth=this.$wrapper.width()-$closeButton.outerWidth()-parseInt($closeButton.css("margin-left"),10)-parseInt($closeButton.css("margin-right"),10)-parseInt($token.css("border-left-width"),10)-parseInt($token.css("border-right-width"),10)-parseInt($token.css("padding-left"),10)-parseInt($token.css("padding-right"),10);parseInt($tokenLabel.css("border-left-width"),10)-parseInt($tokenLabel.css("border-right-width"),10)-parseInt($tokenLabel.css("padding-left"),10)-parseInt($tokenLabel.css("padding-right"),10);parseInt($tokenLabel.css("margin-left"),10)-parseInt($tokenLabel.css("margin-right"),10)}$tokenLabel.text(attrs.label).css("max-width",this.maxTokenWidth);$token.on("mousedown",function(e){if(_self._disabled||_self._readonly)return false;_self.preventDeactivation=true}).on("click",function(e){if(_self._disabled||_self._readonly)return false;_self.preventDeactivation=false;if(e.ctrlKey||e.metaKey){e.preventDefault();return _self.toggle($token)}_self.activate($token,e.shiftKey,e.shiftKey)}).on("dblclick",function(e){if(_self._disabled||_self._readonly||!_self.options.allowEditing)return false;_self.edit($token)});$closeButton.on("click",$.proxy(this.remove,this));this.$element.trigger($.Event("tokenfield:createdtoken",{attrs:attrs,relatedTarget:$token.get(0)}));if(triggerChange){this.$element.val(this.getTokensList()).trigger($.Event("change",{initiator:"tokenfield"}))}this.update();return this.$element.get(0)},setTokens:function(tokens,add,triggerChange){if(!tokens)return;if(!add)this.$wrapper.find(".token").remove();if(typeof triggerChange==="undefined"){triggerChange=true}if(typeof tokens==="string"){if(this._delimiters.length){tokens=tokens.split(new RegExp("["+this._delimiters.join("")+"]"))}else{tokens=[tokens]}}var _self=this;$.each(tokens,function(i,attrs){_self.createToken(attrs,triggerChange)});return this.$element.get(0)},getTokenData:function($token){var data=$token.map(function(){var $token=$(this);return $token.data("attrs")}).get();if(data.length==1){data=data[0]}return data},getTokens:function(active){var self=this,tokens=[],activeClass=active?".active":"";this.$wrapper.find(".token"+activeClass).each(function(){tokens.push(self.getTokenData($(this)))});return tokens},getTokensList:function(delimiter,beautify,active){delimiter=delimiter||this._firstDelimiter;beautify=typeof beautify!=="undefined"&&beautify!==null?beautify:this.options.beautify;var separator=delimiter+(beautify&&delimiter!==" "?" ":"");return $.map(this.getTokens(active),function(token){return token.value}).join(separator)},getInput:function(){return this.$input.val()},listen:function(){var _self=this;this.$element.on("change",$.proxy(this.change,this));this.$wrapper.on("mousedown",$.proxy(this.focusInput,this));this.$input.on("focus",$.proxy(this.focus,this)).on("blur",$.proxy(this.blur,this)).on("paste",$.proxy(this.paste,this)).on("keydown",$.proxy(this.keydown,this)).on("keypress",$.proxy(this.keypress,this)).on("keyup",$.proxy(this.keyup,this));this.$copyHelper.on("focus",$.proxy(this.focus,this)).on("blur",$.proxy(this.blur,this)).on("keydown",$.proxy(this.keydown,this)).on("keyup",$.proxy(this.keyup,this));this.$input.on("keypress",$.proxy(this.update,this)).on("keyup",$.proxy(this.update,this));this.$input.on("autocompletecreate",function(){var $_menuElement=$(this).data("ui-autocomplete").menu.element;var minWidth=_self.$wrapper.outerWidth()-parseInt($_menuElement.css("border-left-width"),10)-parseInt($_menuElement.css("border-right-width"),10);$_menuElement.css("min-width",minWidth+"px")}).on("autocompleteselect",function(e,ui){if(_self.createToken(ui.item)){_self.$input.val("");if(_self.$input.data("edit")){_self.unedit(true)}}return false}).on("typeahead:selected typeahead:autocompleted",function(e,datum,dataset){datum.value=_self.$input.typeahead("val");if(_self.createToken(datum)){_self.$input.typeahead("val","");if(_self.$input.data("edit")){_self.unedit(true)}}});$(window).on("resize",$.proxy(this.update,this))},keydown:function(e){if(!this.focused)return;var _self=this;switch(e.keyCode){case 8:if(!this.$input.is(document.activeElement))break;this.lastInputValue=this.$input.val();break;case 37:leftRight(this.textDirection==="rtl"?"next":"prev");break;case 38:upDown("prev");break;case 39:leftRight(this.textDirection==="rtl"?"prev":"next");break;case 40:upDown("next");break;case 65:if(this.$input.val().length>0||!(e.ctrlKey||e.metaKey))break;this.activateAll();e.preventDefault();break;case 9:case 13:if(this.$input.data("ui-autocomplete")&&this.$input.data("ui-autocomplete").menu.element.find("li:has(a.ui-state-focus)").length)break;if(this.$input.hasClass("tt-input")&&this.$wrapper.find(".tt-cursor").length)break;if(this.$input.hasClass("tt-input")&&this.$wrapper.find(".tt-hint").val().length)break;if(this.$input.is(document.activeElement)&&this.$input.val().length||this.$input.data("edit")){return this.createTokensFromInput(e,this.$input.data("edit"))}if(e.keyCode===13){if(!this.$copyHelper.is(document.activeElement)||this.$wrapper.find(".token.active").length!==1)break;if(!_self.options.allowEditing)break;this.edit(this.$wrapper.find(".token.active"))}}function leftRight(direction){if(_self.$input.is(document.activeElement)){if(_self.$input.val().length>0)return;direction+="All";var $token=_self.$input.hasClass("tt-input")?_self.$input.parent()[direction](".token:first"):_self.$input[direction](".token:first");if(!$token.length)return;_self.preventInputFocus=true;_self.preventDeactivation=true;_self.activate($token);e.preventDefault()}else{_self[direction](e.shiftKey);e.preventDefault()}}function upDown(direction){if(!e.shiftKey)return;if(_self.$input.is(document.activeElement)){if(_self.$input.val().length>0)return;var $token=_self.$input.hasClass("tt-input")?_self.$input.parent()[direction+"All"](".token:first"):_self.$input[direction+"All"](".token:first");if(!$token.length)return;_self.activate($token)}var opposite=direction==="prev"?"next":"prev",position=direction==="prev"?"first":"last";_self.firstActiveToken[opposite+"All"](".token").each(function(){_self.deactivate($(this))});_self.activate(_self.$wrapper.find(".token:"+position),true,true);e.preventDefault()}this.lastKeyDown=e.keyCode},keypress:function(e){this.lastKeyPressCode=e.keyCode;this.lastKeyPressCharCode=e.charCode;if($.inArray(e.charCode,this._triggerKeys)!==-1&&this.$input.is(document.activeElement)){if(this.$input.val()){this.createTokensFromInput(e)}return false}},keyup:function(e){this.preventInputFocus=false;if(!this.focused)return;switch(e.keyCode){case 8:if(this.$input.is(document.activeElement)){if(this.$input.val().length||this.lastInputValue.length&&this.lastKeyDown===8)break;this.preventDeactivation=true;var $prevToken=this.$input.hasClass("tt-input")?this.$input.parent().prevAll(".token:first"):this.$input.prevAll(".token:first");if(!$prevToken.length)break;this.activate($prevToken)}else{this.remove(e)}break;case 46:this.remove(e,"next");break}this.lastKeyUp=e.keyCode},focus:function(e){this.focused=true;this.$wrapper.addClass("focus");if(this.$input.is(document.activeElement)){this.$wrapper.find(".active").removeClass("active");this.$firstActiveToken=null;if(this.options.showAutocompleteOnFocus){this.search()}}},blur:function(e){this.focused=false;this.$wrapper.removeClass("focus");if(!this.preventDeactivation&&!this.$element.is(document.activeElement)){this.$wrapper.find(".active").removeClass("active");this.$firstActiveToken=null}if(!this.preventCreateTokens&&(this.$input.data("edit")&&!this.$input.is(document.activeElement)||this.options.createTokensOnBlur)){this.createTokensFromInput(e)}this.preventDeactivation=false;this.preventCreateTokens=false},paste:function(e){var _self=this;setTimeout(function(){_self.createTokensFromInput(e)},1)},change:function(e){if(e.initiator==="tokenfield")return;this.setTokens(this.$element.val())},createTokensFromInput:function(e,focus){if(this.$input.val().length<this.options.minLength)return;var tokensBefore=this.getTokensList();this.setTokens(this.$input.val(),true);if(tokensBefore==this.getTokensList()&&this.$input.val().length)return false;if(this.$input.hasClass("tt-input")){this.$input.typeahead("val","")}else{this.$input.val("")}if(this.$input.data("edit")){this.unedit(focus)}return false},next:function(add){if(add){var $firstActiveToken=this.$wrapper.find(".active:first"),deactivate=$firstActiveToken&&this.$firstActiveToken?$firstActiveToken.index()<this.$firstActiveToken.index():false;if(deactivate)return this.deactivate($firstActiveToken)}var $lastActiveToken=this.$wrapper.find(".active:last"),$nextToken=$lastActiveToken.nextAll(".token:first");if(!$nextToken.length){this.$input.focus();return}this.activate($nextToken,add)},prev:function(add){if(add){var $lastActiveToken=this.$wrapper.find(".active:last"),deactivate=$lastActiveToken&&this.$firstActiveToken?$lastActiveToken.index()>this.$firstActiveToken.index():false;if(deactivate)return this.deactivate($lastActiveToken)}var $firstActiveToken=this.$wrapper.find(".active:first"),$prevToken=$firstActiveToken.prevAll(".token:first");if(!$prevToken.length){$prevToken=this.$wrapper.find(".token:first")}if(!$prevToken.length&&!add){this.$input.focus();return}this.activate($prevToken,add)},activate:function($token,add,multi,remember){if(!$token)return;if(typeof remember==="undefined")var remember=true;if(multi)var add=true;this.$copyHelper.focus();if(!add){this.$wrapper.find(".active").removeClass("active");if(remember){this.$firstActiveToken=$token}else{delete this.$firstActiveToken}}if(multi&&this.$firstActiveToken){var i=this.$firstActiveToken.index()-2,a=$token.index()-2,_self=this;this.$wrapper.find(".token").slice(Math.min(i,a)+1,Math.max(i,a)).each(function(){_self.activate($(this),true)})}$token.addClass("active");this.$copyHelper.val(this.getTokensList(null,null,true)).select()},activateAll:function(){var _self=this;this.$wrapper.find(".token").each(function(i){_self.activate($(this),i!==0,false,false)})},deactivate:function($token){if(!$token)return;$token.removeClass("active");this.$copyHelper.val(this.getTokensList(null,null,true)).select()},toggle:function($token){if(!$token)return;$token.toggleClass("active");this.$copyHelper.val(this.getTokensList(null,null,true)).select()},edit:function($token){if(!$token)return;var attrs=$token.data("attrs");var options={attrs:attrs,relatedTarget:$token.get(0)};var editEvent=$.Event("tokenfield:edittoken",options);this.$element.trigger(editEvent);if(editEvent.isDefaultPrevented())return;$token.find(".token-label").text(attrs.value);var tokenWidth=$token.outerWidth();var $_input=this.$input.hasClass("tt-input")?this.$input.parent():this.$input;$token.replaceWith($_input);this.preventCreateTokens=true;this.$input.val(attrs.value).select().data("edit",true).width(tokenWidth);this.update();this.$element.trigger($.Event("tokenfield:editedtoken",options))},unedit:function(focus){var $_input=this.$input.hasClass("tt-input")?this.$input.parent():this.$input;$_input.appendTo(this.$wrapper);this.$input.data("edit",false);this.$mirror.text("");this.update();if(focus){var _self=this;setTimeout(function(){_self.$input.focus()},1)}},remove:function(e,direction){if(this.$input.is(document.activeElement)||this._disabled||this._readonly)return;var $token=e.type==="click"?$(e.target).closest(".token"):this.$wrapper.find(".token.active");if(e.type!=="click"){if(!direction)var direction="prev";this[direction]();if(direction==="prev")var firstToken=$token.first().prevAll(".token:first").length===0}var options={attrs:this.getTokenData($token),relatedTarget:$token.get(0)},removeEvent=$.Event("tokenfield:removetoken",options);this.$element.trigger(removeEvent);if(removeEvent.isDefaultPrevented())return;var removedEvent=$.Event("tokenfield:removedtoken",options),changeEvent=$.Event("change",{initiator:"tokenfield"});$token.remove();this.$element.val(this.getTokensList()).trigger(removedEvent).trigger(changeEvent);if(!this.$wrapper.find(".token").length||e.type==="click"||firstToken)this.$input.focus();this.$input.css("width",this.options.minWidth+"px");this.update();e.preventDefault();e.stopPropagation()},update:function(e){var value=this.$input.val(),inputPaddingLeft=parseInt(this.$input.css("padding-left"),10),inputPaddingRight=parseInt(this.$input.css("padding-right"),10),inputPadding=inputPaddingLeft+inputPaddingRight;if(this.$input.data("edit")){if(!value){value=this.$input.prop("placeholder")}if(value===this.$mirror.text())return;this.$mirror.text(value);var mirrorWidth=this.$mirror.width()+10;if(mirrorWidth>this.$wrapper.width()){return this.$input.width(this.$wrapper.width())}this.$input.width(mirrorWidth)}else{this.$input.css("width",this.options.minWidth+"px");if(this.textDirection==="rtl"){return this.$input.width(this.$input.offset().left+this.$input.outerWidth()-this.$wrapper.offset().left-parseInt(this.$wrapper.css("padding-left"),10)-inputPadding-1)}this.$input.width(this.$wrapper.offset().left+this.$wrapper.width()+parseInt(this.$wrapper.css("padding-left"),10)-this.$input.offset().left-inputPadding)}},focusInput:function(e){if($(e.target).closest(".token").length||$(e.target).closest(".token-input").length||$(e.target).closest(".tt-dropdown-menu").length)return;var _self=this;setTimeout(function(){_self.$input.focus()},0)},search:function(){if(this.$input.data("ui-autocomplete")){this.$input.autocomplete("search")}},disable:function(){this.setProperty("disabled",true)},enable:function(){this.setProperty("disabled",false)},readonly:function(){this.setProperty("readonly",true)},writeable:function(){this.setProperty("readonly",false)},setProperty:function(property,value){this["_"+property]=value;this.$input.prop(property,value);this.$element.prop(property,value);this.$wrapper[value?"addClass":"removeClass"](property)},destroy:function(){this.$element.val(this.getTokensList());this.$element.css(this.$element.data("original-styles"));this.$element.prop("tabindex",this.$element.data("original-tabindex"));var $label=$('label[for="'+this.$input.prop("id")+'"]');if($label.length){$label.prop("for",this.$element.prop("id"))}this.$element.insertBefore(this.$wrapper);this.$element.removeData("original-styles").removeData("original-tabindex").removeData("bs.tokenfield");this.$wrapper.remove();var $_element=this.$element;delete this;return $_element}};var old=$.fn.tokenfield;$.fn.tokenfield=function(option,param){var value,args=[];Array.prototype.push.apply(args,arguments);var elements=this.each(function(){var $this=$(this),data=$this.data("bs.tokenfield"),options=typeof option=="object"&&option;if(typeof option==="string"&&data&&data[option]){args.shift();value=data[option].apply(data,args)}else{if(!data&&typeof option!=="string"&&!param)$this.data("bs.tokenfield",data=new Tokenfield(this,options))}});return typeof value!=="undefined"?value:elements};$.fn.tokenfield.defaults={minWidth:60,minLength:0,allowEditing:true,limit:0,autocomplete:{},typeahead:{},showAutocompleteOnFocus:false,createTokensOnBlur:false,delimiter:",",beautify:true};$.fn.tokenfield.Constructor=Tokenfield;$.fn.tokenfield.noConflict=function(){$.fn.tokenfield=old;return this};return Tokenfield});function month(month_int){switch(month_int){case 0:return"Jan";case 1:return"Feb";case 2:return"Mar";case 3:return"Apr";case 4:return"May";case 5:return"Jun";case 6:return"Jul";case 7:return"Aug";case 8:return"Sep";case 9:return"Oct";case 10:return"Nov";case 11:return"Dec"}}function padNum(num,width){num=num+"";while(num.length<width){num=0+num}return num}function pageNumbers(num_pages,current_page,options){if(options===undefined){options={left_edge:2,left_current:2,right_current:5,right_edge:2}}var pages=[];for(var i=0;i<num_pages;++i){if(i<options.left_edge){pages.push(i)}else if(current_page-options.left_current-1<i&&i<current_page+options.right_current){pages.push(i)}else if(num_pages-options.right_edge-1<i){pages.push(i)}else if(pages[pages.length-1]!==null){pages.push(null)}}return pages}function addRequestSorts(collection){var statusSort=PourOver.makeExplicitSort("status_asc",collection,"status",["evaluating","incomplete","approved","rejected","paid"]);var sorts=[statusSort];var AlphabeticalSort=PourOver.Sort.extend({fn:function(a,b){var a_=a[this["attr"]];var b_=b[this["attr"]];return a_.localeCompare(b_)}});sorts=sorts.concat($.map(["alliance","corporation","pilot","ship","division","system"],function(value){return new AlphabeticalSort(value+"_asc",{attr:value})}));var TimestampSort=PourOver.Sort.extend({fn:function(a,b){var a_=a[this["attr"]].getTime();var b_=b[this["attr"]].getTime();if(a_<b_){return-1}else if(a_>b_){return 1}else{return 0}}});sorts=sorts.concat($.map(["kill_timestamp","submit_timestamp"],function(value){return new TimestampSort(value+"_asc",{attr:value})}));var NumericalSort=PourOver.Sort.extend({fn:function(a,b){var a_=a[this["attr"]];var b_=b[this["attr"]];return a_-b_}});sorts=sorts.concat($.map(["payout","id"],function(value){return new NumericalSort(value+"_asc",{attr:value})}));var ReversedSort=PourOver.Sort.extend({fn:function(a,b){return-1*this["base_sort"]["fn"](a,b)}});sorts=sorts.concat($.map(sorts,function(value){name=value["attr"]+"_dsc";return new ReversedSort(name,{base_sort:value})}));collection.addSorts(sorts)}function modifyToken(ev){function _modify(attr){if(attr.attr===undefined){var data=attr.label.split(":");attr.attr=data[0];if(attr.attr==="status"){attr.real_value=data.slice(1).join(":").toLowerCase()}else{attr.real_value=data.slice(1).join(":")}}attr.label=attr.value}if(ev.attrs instanceof Array){for(var i=0;i<ev.attrs.length;++i){_modify(ev.attrs[i])}}else{_modify(ev.attrs)}}function addedToken(ev){function _add(attr){requests.filters[attr.attr].unionQuery(attr.real_value)}if(ev.attrs instanceof Array){for(var i=0;i<ev.attrs.length;++i){_add(ev.attrs[i])}}else{_add(ev.attrs)}}function removedToken(ev){function _remove(attr){requests.filters[attr.attr].removeSingleQuery(attr.real_value)}if(ev.attrs instanceof Array){for(var i=0;i<ev.attrs.length;++i){_remove(ev.attrs[i])}}else{_remove(ev.attrs)}}function attachTokenfield(bloodhounds){var typeahead_args=[];typeahead_args.push({hint:false,highlight:true});function superBloodhound(query,cb){var category_query=query.split(":");attribute=category_query[0];real_query=category_query.slice(1).join(":");if(real_query===""){real_query=attribute;attribute=""}if(bloodhounds[attribute]!==undefined){bloodhounds[attribute].get(real_query,cb)}else{var results=new Object;for(attr in bloodhounds){bloodhounds[attr].get(real_query,function(matches){results[attr]=matches;var all_back=true;for(attr2 in bloodhounds){if(results[attr2]===undefined){all_back=false;break}}if(all_back){var all_matches=[];$.each(results,function(key){Array.prototype.push.apply(all_matches,results[key])});cb(all_matches)}})}}}typeahead_args.push({name:"all_args",displayKey:function(value){if(value.attr==="status"){var capitalized=value.real_value.substr(0,1).toUpperCase();capitalized=capitalized+value.real_value.slice(1);return value.attr+":"+capitalized}else{return value.attr+":"+value.real_value}},source:superBloodhound});$(".filter-tokenfield").tokenfield({typeahead:typeahead_args}).on("tokenfield:createtoken",modifyToken).on("tokenfield:createdtoken",addedToken).on("tokenfield:removetoken",removedToken)}function addRequestFilters(columns,collection,bloodhound_collection){var supported_columns=["pilot","corporation","alliance","system","constellation","region","ship","status","division"];var filtered_columns=supported_columns.filter(function(val,i){return collection.items[0][val]!==undefined});var column_checkin=new Object;for(var i=0;i<filtered_columns.length;++i){column_checkin[filtered_columns[i]]=false}function addBloodhound(attribute,values){var source=$.map(values,function(v){return{real_value:v,attr:attribute}});bloodhound_collection[attribute]=new Bloodhound({name:attribute,datumTokenizer:function(datum){var tokens=datum.real_value.split(/\s+/);tokens.push(datum.attr+":"+tokens[0]);return tokens},queryTokenizer:Bloodhound.tokenizers.whitespace,local:source});bloodhound_collection[attribute].initialize();column_checkin[attribute]=true;var all_true=true;for(var i=0;i<filtered_columns.length;++i){if(!column_checkin[filtered_columns[i]]){all_true=false;break}}if(all_true){attachTokenfield(bloodhound_collection)}}$.map(filtered_columns,function(attribute){if(attribute==="status"){var statusFilter=PourOver.makeExactFilter("status",["evaluating","approved","rejected","incomplete","paid"]);requests.addFilters(statusFilter);addBloodhound(attribute,statusFilter.values)}else{$.ajax($SCRIPT_ROOT+"/api/filter/"+attribute+"/",{dataType:"json",success:function(data,status,jqXHR){var filter=PourOver.makeExactFilter(attribute,data[attribute]);collection.addFilters(filter);addBloodhound(attribute,data[attribute])}})}})}if($("div#request-list").length){function pager_a_click(ev){if($(this).attr("id")==="prev_page"){request_view.page(-1)}else if($(this).attr("id")=="next_page"){request_view.page(1)}else{var page_num=parseInt($(this).contents()[0].data,10);page_num=page_num-1;request_view.setPage(page_num)}var new_path=window.location.pathname.replace(/\/?(?:\d+\/?)?$/,"");new_path=new_path+"/"+(request_view.current_page+1)+"/";History.pushState({page:request_view.current_page,sort:request_view.getSort()},null,new_path);ev.preventDefault()}function get_columns(rows){var header_row=rows.first();return header_row.find("th").map(function(index,value){return $(value).attr("id").substring(4)})}var RequestsView=PourOver.View.extend({page_size:20,render:function(){var rows=$("table tr").not($(".popover tr"));var rowsParent=rows.parent();var headerRow=rows.first();var columns=get_columns(rows);var oldRows=rows.not(":first");if(oldRows.length!=0){oldRows.remove()}$.each(this.getCurrentItems(),function(index,request){var row=$("<tr></tr>");if(request["status"]==="evaluating"){row.addClass("warning")}else if(request["status"]==="approved"){row.addClass("info")}else if(request["status"]==="paid"){row.addClass("success")}else if(request["status"]==="incomplete"||request["status"]==="rejected"){row.addClass("danger")}$.each(columns,function(index,key){var content;if(key==="id"){content=$("<a></a>",{href:request["href"]}).append(request["id"])}else if(key==="submit_timestamp"){var date=request[key];content=date.getUTCDate()+" "+month(date.getUTCMonth());content=content+" "+date.getUTCFullYear()+" @ ";content=content+date.getUTCHours()+":";content=content+padNum(date.getUTCMinutes(),2)}else if(key==="status"){content=request[key].substr(0,1).toUpperCase();
content=content+request[key].slice(1)}else if(key==="payout"){content=request.payout_str}else{content=request[key]}$("<td></td>").append(content).appendTo(row)});row.appendTo(rowsParent)});var num_pages=Math.ceil(this.match_set.length()/this.page_size-1)+1;var pager=$("ul.pagination");pager.empty();if(num_pages===1){pager.attr("style","display: none;")}else{if(this.current_page===0){pager.append('<li class="disabled"><span>&laquo;</span></li>')}else{pager.append('<li><a id="prev_page" href="#">&laquo;</a></li>')}var page_nums=pageNumbers(num_pages,this.current_page);for(var i=0;i<page_nums.length;++i){if(page_nums[i]!==null){if(page_nums[i]!==this.current_page){pager.append('<li><a href="#">'+(page_nums[i]+1)+"</a></li>")}else{pager.append('<li class="active"><a href="#">'+(page_nums[i]+1)+'<span class="sr-only"> (current)</span></a></li>')}}else{pager.append('<li class="disabled"><span>&hellip;</span></li>')}}if(this.current_page===num_pages-1){pager.append('<li class="disabled"><span>&raquo;</span></li>')}else{pager.append('<li><a id="next_page" href="#">&raquo;</a></li>')}}pager.find("li > a").click(pager_a_click)}});$.ajax($SCRIPT_ROOT+"/api/filter"+window.location.pathname,{dataType:"json",success:function(data){var filteredRequests=$.map(data["requests"],function(value){value["kill_timestamp"]=new Date(value["kill_timestamp"]);value["submit_timestamp"]=new Date(value["submit_timestamp"]);return value});requests=new PourOver.Collection(filteredRequests);column_bloodhounds=new Object;addRequestFilters(get_columns($("tr").not($(".popover tr"))),requests,column_bloodhounds);addRequestSorts(requests);request_view=new RequestsView("requests",requests);request_view.on("update",request_view.render);$("ul.pagination > li > a").click(pager_a_click);$(window).on("statechange",function(ev){var state=History.getState();if(state.data.page!==request_view.current_page){request_view.setPage(state.data.page)}if(state.data.sort!==request_view.getSort()){request_view.setSort(state.data.sort)}})}});$("th a.heading").click(function(e){var colName=$(this).parent("th").attr("id").substring(4);var currentSort=request_view.getSort();var newSort="";if(currentSort!==false){if(currentSort.slice(0,-4)===colName){var direction=currentSort.slice(-3);if(direction==="asc"){newSort=colName+"_dsc"}else if(direction==="dsc"){newsort=colName+"_asc"}}$(this).parent("th").siblings("th").find("i.fa").removeClass()}if(newSort===""){newSort=colName+"_asc"}var direction=newSort.slice(-3);if(direction==="asc"){$(this).children("i").attr("class","fa fa-chevron-down")}else if(direction==="dsc"){$(this).children("i").attr("class","fa fa-chevron-up")}request_view.setSort(newSort)})}(function($){var _={isMsie:function(){return/(msie|trident)/i.test(navigator.userAgent)?navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2]:false},isBlankString:function(str){return!str||/^\s*$/.test(str)},escapeRegExChars:function(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},isString:function(obj){return typeof obj==="string"},isNumber:function(obj){return typeof obj==="number"},isArray:$.isArray,isFunction:$.isFunction,isObject:$.isPlainObject,isUndefined:function(obj){return typeof obj==="undefined"},bind:$.proxy,each:function(collection,cb){$.each(collection,reverseArgs);function reverseArgs(index,value){return cb(value,index)}},map:$.map,filter:$.grep,every:function(obj,test){var result=true;if(!obj){return result}$.each(obj,function(key,val){if(!(result=test.call(null,val,key,obj))){return false}});return!!result},some:function(obj,test){var result=false;if(!obj){return result}$.each(obj,function(key,val){if(result=test.call(null,val,key,obj)){return false}});return!!result},mixin:$.extend,getUniqueId:function(){var counter=0;return function(){return counter++}}(),templatify:function templatify(obj){return $.isFunction(obj)?obj:template;function template(){return String(obj)}},defer:function(fn){setTimeout(fn,0)},debounce:function(func,wait,immediate){var timeout,result;return function(){var context=this,args=arguments,later,callNow;later=function(){timeout=null;if(!immediate){result=func.apply(context,args)}};callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow){result=func.apply(context,args)}return result}},throttle:function(func,wait){var context,args,timeout,result,previous,later;previous=0;later=function(){previous=new Date;timeout=null;result=func.apply(context,args)};return function(){var now=new Date,remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args)}else if(!timeout){timeout=setTimeout(later,remaining)}return result}},noop:function(){}};var VERSION="0.10.2";var tokenizers=function(root){return{nonword:nonword,whitespace:whitespace,obj:{nonword:getObjTokenizer(nonword),whitespace:getObjTokenizer(whitespace)}};function whitespace(s){return s.split(/\s+/)}function nonword(s){return s.split(/\W+/)}function getObjTokenizer(tokenizer){return function setKey(key){return function tokenize(o){return tokenizer(o[key])}}}}();var LruCache=function(){function LruCache(maxSize){this.maxSize=maxSize||100;this.size=0;this.hash={};this.list=new List}_.mixin(LruCache.prototype,{set:function set(key,val){var tailItem=this.list.tail,node;if(this.size>=this.maxSize){this.list.remove(tailItem);delete this.hash[tailItem.key]}if(node=this.hash[key]){node.val=val;this.list.moveToFront(node)}else{node=new Node(key,val);this.list.add(node);this.hash[key]=node;this.size++}},get:function get(key){var node=this.hash[key];if(node){this.list.moveToFront(node);return node.val}}});function List(){this.head=this.tail=null}_.mixin(List.prototype,{add:function add(node){if(this.head){node.next=this.head;this.head.prev=node}this.head=node;this.tail=this.tail||node},remove:function remove(node){node.prev?node.prev.next=node.next:this.head=node.next;node.next?node.next.prev=node.prev:this.tail=node.prev},moveToFront:function(node){this.remove(node);this.add(node)}});function Node(key,val){this.key=key;this.val=val;this.prev=this.next=null}return LruCache}();var PersistentStorage=function(){var ls,methods;try{ls=window.localStorage;ls.setItem("~~~","!");ls.removeItem("~~~")}catch(err){ls=null}function PersistentStorage(namespace){this.prefix=["__",namespace,"__"].join("");this.ttlKey="__ttl__";this.keyMatcher=new RegExp("^"+this.prefix)}if(ls&&window.JSON){methods={_prefix:function(key){return this.prefix+key},_ttlKey:function(key){return this._prefix(key)+this.ttlKey},get:function(key){if(this.isExpired(key)){this.remove(key)}return decode(ls.getItem(this._prefix(key)))},set:function(key,val,ttl){if(_.isNumber(ttl)){ls.setItem(this._ttlKey(key),encode(now()+ttl))}else{ls.removeItem(this._ttlKey(key))}return ls.setItem(this._prefix(key),encode(val))},remove:function(key){ls.removeItem(this._ttlKey(key));ls.removeItem(this._prefix(key));return this},clear:function(){var i,key,keys=[],len=ls.length;for(i=0;i<len;i++){if((key=ls.key(i)).match(this.keyMatcher)){keys.push(key.replace(this.keyMatcher,""))}}for(i=keys.length;i--;){this.remove(keys[i])}return this},isExpired:function(key){var ttl=decode(ls.getItem(this._ttlKey(key)));return _.isNumber(ttl)&&now()>ttl?true:false}}}else{methods={get:_.noop,set:_.noop,remove:_.noop,clear:_.noop,isExpired:_.noop}}_.mixin(PersistentStorage.prototype,methods);return PersistentStorage;function now(){return(new Date).getTime()}function encode(val){return JSON.stringify(_.isUndefined(val)?null:val)}function decode(val){return JSON.parse(val)}}();var Transport=function(){var pendingRequestsCount=0,pendingRequests={},maxPendingRequests=6,requestCache=new LruCache(10);function Transport(o){o=o||{};this._send=o.transport?callbackToDeferred(o.transport):$.ajax;this._get=o.rateLimiter?o.rateLimiter(this._get):this._get}Transport.setMaxPendingRequests=function setMaxPendingRequests(num){maxPendingRequests=num};Transport.resetCache=function clearCache(){requestCache=new LruCache(10)};_.mixin(Transport.prototype,{_get:function(url,o,cb){var that=this,jqXhr;if(jqXhr=pendingRequests[url]){jqXhr.done(done).fail(fail)}else if(pendingRequestsCount<maxPendingRequests){pendingRequestsCount++;pendingRequests[url]=this._send(url,o).done(done).fail(fail).always(always)}else{this.onDeckRequestArgs=[].slice.call(arguments,0)}function done(resp){cb&&cb(null,resp);requestCache.set(url,resp)}function fail(){cb&&cb(true)}function always(){pendingRequestsCount--;delete pendingRequests[url];if(that.onDeckRequestArgs){that._get.apply(that,that.onDeckRequestArgs);that.onDeckRequestArgs=null}}},get:function(url,o,cb){var resp;if(_.isFunction(o)){cb=o;o={}}if(resp=requestCache.get(url)){_.defer(function(){cb&&cb(null,resp)})}else{this._get(url,o,cb)}return!!resp}});return Transport;function callbackToDeferred(fn){return function customSendWrapper(url,o){var deferred=$.Deferred();fn(url,o,onSuccess,onError);return deferred;function onSuccess(resp){_.defer(function(){deferred.resolve(resp)})}function onError(err){_.defer(function(){deferred.reject(err)})}}}}();var SearchIndex=function(){function SearchIndex(o){o=o||{};if(!o.datumTokenizer||!o.queryTokenizer){$.error("datumTokenizer and queryTokenizer are both required")}this.datumTokenizer=o.datumTokenizer;this.queryTokenizer=o.queryTokenizer;this.reset()}_.mixin(SearchIndex.prototype,{bootstrap:function bootstrap(o){this.datums=o.datums;this.trie=o.trie},add:function(data){var that=this;data=_.isArray(data)?data:[data];_.each(data,function(datum){var id,tokens;id=that.datums.push(datum)-1;tokens=normalizeTokens(that.datumTokenizer(datum));_.each(tokens,function(token){var node,chars,ch;node=that.trie;chars=token.split("");while(ch=chars.shift()){node=node.children[ch]||(node.children[ch]=newNode());node.ids.push(id)}})})},get:function get(query){var that=this,tokens,matches;tokens=normalizeTokens(this.queryTokenizer(query));_.each(tokens,function(token){var node,chars,ch,ids;if(matches&&matches.length===0){return false}node=that.trie;chars=token.split("");while(node&&(ch=chars.shift())){node=node.children[ch]}if(node&&chars.length===0){ids=node.ids.slice(0);matches=matches?getIntersection(matches,ids):ids}else{matches=[];return false}});return matches?_.map(unique(matches),function(id){return that.datums[id]}):[]},reset:function reset(){this.datums=[];this.trie=newNode()},serialize:function serialize(){return{datums:this.datums,trie:this.trie}}});return SearchIndex;function normalizeTokens(tokens){tokens=_.filter(tokens,function(token){return!!token});tokens=_.map(tokens,function(token){return token.toLowerCase()});return tokens}function newNode(){return{ids:[],children:{}}}function unique(array){var seen={},uniques=[];for(var i=0;i<array.length;i++){if(!seen[array[i]]){seen[array[i]]=true;uniques.push(array[i])}}return uniques}function getIntersection(arrayA,arrayB){var ai=0,bi=0,intersection=[];arrayA=arrayA.sort(compare);arrayB=arrayB.sort(compare);while(ai<arrayA.length&&bi<arrayB.length){if(arrayA[ai]<arrayB[bi]){ai++}else if(arrayA[ai]>arrayB[bi]){bi++}else{intersection.push(arrayA[ai]);ai++;bi++}}return intersection;function compare(a,b){return a-b}}}();var oParser=function(){return{local:getLocal,prefetch:getPrefetch,remote:getRemote};function getLocal(o){return o.local||null}function getPrefetch(o){var prefetch,defaults;defaults={url:null,thumbprint:"",ttl:24*60*60*1e3,filter:null,ajax:{}};if(prefetch=o.prefetch||null){prefetch=_.isString(prefetch)?{url:prefetch}:prefetch;prefetch=_.mixin(defaults,prefetch);prefetch.thumbprint=VERSION+prefetch.thumbprint;prefetch.ajax.type=prefetch.ajax.type||"GET";prefetch.ajax.dataType=prefetch.ajax.dataType||"json";!prefetch.url&&$.error("prefetch requires url to be set")}return prefetch}function getRemote(o){var remote,defaults;defaults={url:null,wildcard:"%QUERY",replace:null,rateLimitBy:"debounce",rateLimitWait:300,send:null,filter:null,ajax:{}};if(remote=o.remote||null){remote=_.isString(remote)?{url:remote}:remote;remote=_.mixin(defaults,remote);remote.rateLimiter=/^throttle$/i.test(remote.rateLimitBy)?byThrottle(remote.rateLimitWait):byDebounce(remote.rateLimitWait);remote.ajax.type=remote.ajax.type||"GET";remote.ajax.dataType=remote.ajax.dataType||"json";delete remote.rateLimitBy;delete remote.rateLimitWait;!remote.url&&$.error("remote requires url to be set")}return remote;function byDebounce(wait){return function(fn){return _.debounce(fn,wait)}}function byThrottle(wait){return function(fn){return _.throttle(fn,wait)}}}}();(function(root){var old,keys;old=root.Bloodhound;keys={data:"data",protocol:"protocol",thumbprint:"thumbprint"};root.Bloodhound=Bloodhound;function Bloodhound(o){if(!o||!o.local&&!o.prefetch&&!o.remote){$.error("one of local, prefetch, or remote is required")}this.limit=o.limit||5;this.sorter=getSorter(o.sorter);this.dupDetector=o.dupDetector||ignoreDuplicates;this.local=oParser.local(o);this.prefetch=oParser.prefetch(o);this.remote=oParser.remote(o);this.cacheKey=this.prefetch?this.prefetch.cacheKey||this.prefetch.url:null;this.index=new SearchIndex({datumTokenizer:o.datumTokenizer,queryTokenizer:o.queryTokenizer});this.storage=this.cacheKey?new PersistentStorage(this.cacheKey):null}Bloodhound.noConflict=function noConflict(){root.Bloodhound=old;return Bloodhound};Bloodhound.tokenizers=tokenizers;_.mixin(Bloodhound.prototype,{_loadPrefetch:function loadPrefetch(o){var that=this,serialized,deferred;if(serialized=this._readFromStorage(o.thumbprint)){this.index.bootstrap(serialized);deferred=$.Deferred().resolve()}else{deferred=$.ajax(o.url,o.ajax).done(handlePrefetchResponse)}return deferred;function handlePrefetchResponse(resp){that.clear();that.add(o.filter?o.filter(resp):resp);that._saveToStorage(that.index.serialize(),o.thumbprint,o.ttl)}},_getFromRemote:function getFromRemote(query,cb){var that=this,url,uriEncodedQuery;query=query||"";uriEncodedQuery=encodeURIComponent(query);url=this.remote.replace?this.remote.replace(this.remote.url,query):this.remote.url.replace(this.remote.wildcard,uriEncodedQuery);return this.transport.get(url,this.remote.ajax,handleRemoteResponse);function handleRemoteResponse(err,resp){err?cb([]):cb(that.remote.filter?that.remote.filter(resp):resp)}},_saveToStorage:function saveToStorage(data,thumbprint,ttl){if(this.storage){this.storage.set(keys.data,data,ttl);this.storage.set(keys.protocol,location.protocol,ttl);this.storage.set(keys.thumbprint,thumbprint,ttl)}},_readFromStorage:function readFromStorage(thumbprint){var stored={},isExpired;if(this.storage){stored.data=this.storage.get(keys.data);stored.protocol=this.storage.get(keys.protocol);stored.thumbprint=this.storage.get(keys.thumbprint)}isExpired=stored.thumbprint!==thumbprint||stored.protocol!==location.protocol;return stored.data&&!isExpired?stored.data:null},_initialize:function initialize(){var that=this,local=this.local,deferred;deferred=this.prefetch?this._loadPrefetch(this.prefetch):$.Deferred().resolve();local&&deferred.done(addLocalToIndex);this.transport=this.remote?new Transport(this.remote):null;return this.initPromise=deferred.promise();function addLocalToIndex(){that.add(_.isFunction(local)?local():local)}},initialize:function initialize(force){return!this.initPromise||force?this._initialize():this.initPromise},add:function add(data){this.index.add(data)},get:function get(query,cb){var that=this,matches=[],cacheHit=false;matches=this.index.get(query);matches=this.sorter(matches).slice(0,this.limit);if(matches.length<this.limit&&this.transport){cacheHit=this._getFromRemote(query,returnRemoteMatches)}if(!cacheHit){(matches.length>0||!this.transport)&&cb&&cb(matches)}function returnRemoteMatches(remoteMatches){var matchesWithBackfill=matches.slice(0);_.each(remoteMatches,function(remoteMatch){var isDuplicate;isDuplicate=_.some(matchesWithBackfill,function(match){return that.dupDetector(remoteMatch,match)});!isDuplicate&&matchesWithBackfill.push(remoteMatch);return matchesWithBackfill.length<that.limit});cb&&cb(that.sorter(matchesWithBackfill))}},clear:function clear(){this.index.reset()},clearPrefetchCache:function clearPrefetchCache(){this.storage&&this.storage.clear()},clearRemoteCache:function clearRemoteCache(){this.transport&&Transport.resetCache()},ttAdapter:function ttAdapter(){return _.bind(this.get,this)}});return Bloodhound;function getSorter(sortFn){return _.isFunction(sortFn)?sort:noSort;function sort(array){return array.sort(sortFn)}function noSort(array){return array}}function ignoreDuplicates(){return false}})(this);var html={wrapper:'<span class="twitter-typeahead"></span>',dropdown:'<span class="tt-dropdown-menu"></span>',dataset:'<div class="tt-dataset-%CLASS%"></div>',suggestions:'<span class="tt-suggestions"></span>',suggestion:'<div class="tt-suggestion"></div>'};var css={wrapper:{position:"relative",display:"inline-block"},hint:{position:"absolute",top:"0",left:"0",borderColor:"transparent",boxShadow:"none"},input:{position:"relative",verticalAlign:"top",backgroundColor:"transparent"},inputWithNoHint:{position:"relative",verticalAlign:"top"},dropdown:{position:"absolute",top:"100%",left:"0",zIndex:"100",display:"none"},suggestions:{display:"block"},suggestion:{whiteSpace:"nowrap",cursor:"pointer"},suggestionChild:{whiteSpace:"normal"},ltr:{left:"0",right:"auto"},rtl:{left:"auto",right:" 0"}};if(_.isMsie()){_.mixin(css.input,{backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"})}if(_.isMsie()&&_.isMsie()<=7){_.mixin(css.input,{marginTop:"-1px"})}var EventBus=function(){var namespace="typeahead:";function EventBus(o){if(!o||!o.el){$.error("EventBus initialized without el")}this.$el=$(o.el)}_.mixin(EventBus.prototype,{trigger:function(type){var args=[].slice.call(arguments,1);this.$el.trigger(namespace+type,args)}});return EventBus}();var EventEmitter=function(){var splitter=/\s+/,nextTick=getNextTick();return{onSync:onSync,onAsync:onAsync,off:off,trigger:trigger};function on(method,types,cb,context){var type;if(!cb){return this}types=types.split(splitter);cb=context?bindContext(cb,context):cb;this._callbacks=this._callbacks||{};while(type=types.shift()){this._callbacks[type]=this._callbacks[type]||{sync:[],async:[]};this._callbacks[type][method].push(cb)}return this}function onAsync(types,cb,context){return on.call(this,"async",types,cb,context)}function onSync(types,cb,context){return on.call(this,"sync",types,cb,context)}function off(types){var type;if(!this._callbacks){return this}types=types.split(splitter);while(type=types.shift()){delete this._callbacks[type]}return this}function trigger(types){var type,callbacks,args,syncFlush,asyncFlush;if(!this._callbacks){return this}types=types.split(splitter);args=[].slice.call(arguments,1);while((type=types.shift())&&(callbacks=this._callbacks[type])){syncFlush=getFlush(callbacks.sync,this,[type].concat(args));asyncFlush=getFlush(callbacks.async,this,[type].concat(args));syncFlush()&&nextTick(asyncFlush)}return this}function getFlush(callbacks,context,args){return flush;function flush(){var cancelled;for(var i=0;!cancelled&&i<callbacks.length;i+=1){cancelled=callbacks[i].apply(context,args)===false}return!cancelled}}function getNextTick(){var nextTickFn;if(window.setImmediate){nextTickFn=function nextTickSetImmediate(fn){setImmediate(function(){fn()})}}else{nextTickFn=function nextTickSetTimeout(fn){setTimeout(function(){fn()},0)}}return nextTickFn}function bindContext(fn,context){return fn.bind?fn.bind(context):function(){fn.apply(context,[].slice.call(arguments,0))}}}();var highlight=function(doc){var defaults={node:null,pattern:null,tagName:"strong",className:null,wordsOnly:false,caseSensitive:false};return function hightlight(o){var regex;o=_.mixin({},defaults,o);if(!o.node||!o.pattern){return}o.pattern=_.isArray(o.pattern)?o.pattern:[o.pattern];regex=getRegex(o.pattern,o.caseSensitive,o.wordsOnly);traverse(o.node,hightlightTextNode);function hightlightTextNode(textNode){var match,patternNode;if(match=regex.exec(textNode.data)){wrapperNode=doc.createElement(o.tagName);o.className&&(wrapperNode.className=o.className);patternNode=textNode.splitText(match.index);patternNode.splitText(match[0].length);wrapperNode.appendChild(patternNode.cloneNode(true));textNode.parentNode.replaceChild(wrapperNode,patternNode)}return!!match}function traverse(el,hightlightTextNode){var childNode,TEXT_NODE_TYPE=3;for(var i=0;i<el.childNodes.length;i++){childNode=el.childNodes[i];if(childNode.nodeType===TEXT_NODE_TYPE){i+=hightlightTextNode(childNode)?1:0}else{traverse(childNode,hightlightTextNode)}}}};function getRegex(patterns,caseSensitive,wordsOnly){var escapedPatterns=[],regexStr;for(var i=0;i<patterns.length;i++){escapedPatterns.push(_.escapeRegExChars(patterns[i]))}regexStr=wordsOnly?"\\b("+escapedPatterns.join("|")+")\\b":"("+escapedPatterns.join("|")+")";return caseSensitive?new RegExp(regexStr):new RegExp(regexStr,"i")}}(window.document);var Input=function(){var specialKeyCodeMap;specialKeyCodeMap={9:"tab",27:"esc",37:"left",39:"right",13:"enter",38:"up",40:"down"};function Input(o){var that=this,onBlur,onFocus,onKeydown,onInput;o=o||{};if(!o.input){$.error("input is missing")}onBlur=_.bind(this._onBlur,this);onFocus=_.bind(this._onFocus,this);onKeydown=_.bind(this._onKeydown,this);onInput=_.bind(this._onInput,this);this.$hint=$(o.hint);this.$input=$(o.input).on("blur.tt",onBlur).on("focus.tt",onFocus).on("keydown.tt",onKeydown);if(this.$hint.length===0){this.setHint=this.getHint=this.clearHint=this.clearHintIfInvalid=_.noop}if(!_.isMsie()){this.$input.on("input.tt",onInput)}else{this.$input.on("keydown.tt keypress.tt cut.tt paste.tt",function($e){if(specialKeyCodeMap[$e.which||$e.keyCode]){return}_.defer(_.bind(that._onInput,that,$e))})}this.query=this.$input.val();this.$overflowHelper=buildOverflowHelper(this.$input)}Input.normalizeQuery=function(str){return(str||"").replace(/^\s*/g,"").replace(/\s{2,}/g," ")};_.mixin(Input.prototype,EventEmitter,{_onBlur:function onBlur(){this.resetInputValue();this.trigger("blurred")},_onFocus:function onFocus(){this.trigger("focused")},_onKeydown:function onKeydown($e){var keyName=specialKeyCodeMap[$e.which||$e.keyCode];this._managePreventDefault(keyName,$e);if(keyName&&this._shouldTrigger(keyName,$e)){this.trigger(keyName+"Keyed",$e)}},_onInput:function onInput(){this._checkInputValue()},_managePreventDefault:function managePreventDefault(keyName,$e){var preventDefault,hintValue,inputValue;switch(keyName){case"tab":hintValue=this.getHint();inputValue=this.getInputValue();preventDefault=hintValue&&hintValue!==inputValue&&!withModifier($e);break;case"up":case"down":preventDefault=!withModifier($e);break;default:preventDefault=false}preventDefault&&$e.preventDefault()},_shouldTrigger:function shouldTrigger(keyName,$e){var trigger;switch(keyName){case"tab":trigger=!withModifier($e);break;default:trigger=true}return trigger},_checkInputValue:function checkInputValue(){var inputValue,areEquivalent,hasDifferentWhitespace;inputValue=this.getInputValue();areEquivalent=areQueriesEquivalent(inputValue,this.query);hasDifferentWhitespace=areEquivalent?this.query.length!==inputValue.length:false;if(!areEquivalent){this.trigger("queryChanged",this.query=inputValue)}else if(hasDifferentWhitespace){this.trigger("whitespaceChanged",this.query)}},focus:function focus(){this.$input.focus()},blur:function blur(){this.$input.blur()},getQuery:function getQuery(){return this.query},setQuery:function setQuery(query){this.query=query},getInputValue:function getInputValue(){return this.$input.val()},setInputValue:function setInputValue(value,silent){this.$input.val(value);silent?this.clearHint():this._checkInputValue()},resetInputValue:function resetInputValue(){this.setInputValue(this.query,true)},getHint:function getHint(){return this.$hint.val()},setHint:function setHint(value){this.$hint.val(value)},clearHint:function clearHint(){this.setHint("")},clearHintIfInvalid:function clearHintIfInvalid(){var val,hint,valIsPrefixOfHint,isValid;val=this.getInputValue();hint=this.getHint();valIsPrefixOfHint=val!==hint&&hint.indexOf(val)===0;isValid=val!==""&&valIsPrefixOfHint&&!this.hasOverflow();!isValid&&this.clearHint()},getLanguageDirection:function getLanguageDirection(){return(this.$input.css("direction")||"ltr").toLowerCase()},hasOverflow:function hasOverflow(){var constraint=this.$input.width()-2;this.$overflowHelper.text(this.getInputValue());return this.$overflowHelper.width()>=constraint},isCursorAtEnd:function(){var valueLength,selectionStart,range;valueLength=this.$input.val().length;selectionStart=this.$input[0].selectionStart;if(_.isNumber(selectionStart)){return selectionStart===valueLength}else if(document.selection){range=document.selection.createRange();range.moveStart("character",-valueLength);return valueLength===range.text.length}return true},destroy:function destroy(){this.$hint.off(".tt");this.$input.off(".tt");this.$hint=this.$input=this.$overflowHelper=null}});return Input;function buildOverflowHelper($input){return $('<pre aria-hidden="true"></pre>').css({position:"absolute",visibility:"hidden",whiteSpace:"pre",fontFamily:$input.css("font-family"),fontSize:$input.css("font-size"),fontStyle:$input.css("font-style"),fontVariant:$input.css("font-variant"),fontWeight:$input.css("font-weight"),wordSpacing:$input.css("word-spacing"),letterSpacing:$input.css("letter-spacing"),textIndent:$input.css("text-indent"),textRendering:$input.css("text-rendering"),textTransform:$input.css("text-transform")}).insertAfter($input)}function areQueriesEquivalent(a,b){return Input.normalizeQuery(a)===Input.normalizeQuery(b)}function withModifier($e){return $e.altKey||$e.ctrlKey||$e.metaKey||$e.shiftKey}}();var Dataset=function(){var datasetKey="ttDataset",valueKey="ttValue",datumKey="ttDatum";function Dataset(o){o=o||{};o.templates=o.templates||{};if(!o.source){$.error("missing source")}if(o.name&&!isValidName(o.name)){$.error("invalid dataset name: "+o.name)}this.query=null;this.highlight=!!o.highlight;this.name=o.name||_.getUniqueId();this.source=o.source;this.displayFn=getDisplayFn(o.display||o.displayKey);this.templates=getTemplates(o.templates,this.displayFn);this.$el=$(html.dataset.replace("%CLASS%",this.name))}Dataset.extractDatasetName=function extractDatasetName(el){return $(el).data(datasetKey)};Dataset.extractValue=function extractDatum(el){return $(el).data(valueKey)};Dataset.extractDatum=function extractDatum(el){return $(el).data(datumKey)};_.mixin(Dataset.prototype,EventEmitter,{_render:function render(query,suggestions){if(!this.$el){return}var that=this,hasSuggestions;this.$el.empty();hasSuggestions=suggestions&&suggestions.length;if(!hasSuggestions&&this.templates.empty){this.$el.html(getEmptyHtml()).prepend(that.templates.header?getHeaderHtml():null).append(that.templates.footer?getFooterHtml():null)}else if(hasSuggestions){this.$el.html(getSuggestionsHtml()).prepend(that.templates.header?getHeaderHtml():null).append(that.templates.footer?getFooterHtml():null)}this.trigger("rendered");function getEmptyHtml(){return that.templates.empty({query:query,isEmpty:true})}function getSuggestionsHtml(){var $suggestions,nodes;$suggestions=$(html.suggestions).css(css.suggestions);nodes=_.map(suggestions,getSuggestionNode);$suggestions.append.apply($suggestions,nodes);that.highlight&&highlight({node:$suggestions[0],pattern:query});return $suggestions;function getSuggestionNode(suggestion){var $el;$el=$(html.suggestion).append(that.templates.suggestion(suggestion)).data(datasetKey,that.name).data(valueKey,that.displayFn(suggestion)).data(datumKey,suggestion);$el.children().each(function(){$(this).css(css.suggestionChild)});return $el}}function getHeaderHtml(){return that.templates.header({query:query,isEmpty:!hasSuggestions})}function getFooterHtml(){return that.templates.footer({query:query,isEmpty:!hasSuggestions})}},getRoot:function getRoot(){return this.$el},update:function update(query){var that=this;this.query=query;this.canceled=false;this.source(query,render);function render(suggestions){if(!that.canceled&&query===that.query){that._render(query,suggestions)}}},cancel:function cancel(){this.canceled=true},clear:function clear(){this.cancel();this.$el.empty();this.trigger("rendered")},isEmpty:function isEmpty(){return this.$el.is(":empty")},destroy:function destroy(){this.$el=null}});return Dataset;function getDisplayFn(display){display=display||"value";return _.isFunction(display)?display:displayFn;function displayFn(obj){return obj[display]}}function getTemplates(templates,displayFn){return{empty:templates.empty&&_.templatify(templates.empty),header:templates.header&&_.templatify(templates.header),footer:templates.footer&&_.templatify(templates.footer),suggestion:templates.suggestion||suggestionTemplate};function suggestionTemplate(context){return"<p>"+displayFn(context)+"</p>"}}function isValidName(str){return/^[_a-zA-Z0-9-]+$/.test(str)}}();var Dropdown=function(){function Dropdown(o){var that=this,onSuggestionClick,onSuggestionMouseEnter,onSuggestionMouseLeave;o=o||{};if(!o.menu){$.error("menu is required")}this.isOpen=false;this.isEmpty=true;this.datasets=_.map(o.datasets,initializeDataset);onSuggestionClick=_.bind(this._onSuggestionClick,this);onSuggestionMouseEnter=_.bind(this._onSuggestionMouseEnter,this);onSuggestionMouseLeave=_.bind(this._onSuggestionMouseLeave,this);this.$menu=$(o.menu).on("click.tt",".tt-suggestion",onSuggestionClick).on("mouseenter.tt",".tt-suggestion",onSuggestionMouseEnter).on("mouseleave.tt",".tt-suggestion",onSuggestionMouseLeave);_.each(this.datasets,function(dataset){that.$menu.append(dataset.getRoot());dataset.onSync("rendered",that._onRendered,that)})}_.mixin(Dropdown.prototype,EventEmitter,{_onSuggestionClick:function onSuggestionClick($e){this.trigger("suggestionClicked",$($e.currentTarget))},_onSuggestionMouseEnter:function onSuggestionMouseEnter($e){this._removeCursor();this._setCursor($($e.currentTarget),true)},_onSuggestionMouseLeave:function onSuggestionMouseLeave(){this._removeCursor()},_onRendered:function onRendered(){this.isEmpty=_.every(this.datasets,isDatasetEmpty);this.isEmpty?this._hide():this.isOpen&&this._show();this.trigger("datasetRendered");function isDatasetEmpty(dataset){return dataset.isEmpty()}},_hide:function(){this.$menu.hide()},_show:function(){this.$menu.css("display","block")},_getSuggestions:function getSuggestions(){return this.$menu.find(".tt-suggestion")},_getCursor:function getCursor(){return this.$menu.find(".tt-cursor").first()},_setCursor:function setCursor($el,silent){$el.first().addClass("tt-cursor");!silent&&this.trigger("cursorMoved")},_removeCursor:function removeCursor(){this._getCursor().removeClass("tt-cursor")},_moveCursor:function moveCursor(increment){var $suggestions,$oldCursor,newCursorIndex,$newCursor;if(!this.isOpen){return}$oldCursor=this._getCursor();$suggestions=this._getSuggestions();this._removeCursor();newCursorIndex=$suggestions.index($oldCursor)+increment;newCursorIndex=(newCursorIndex+1)%($suggestions.length+1)-1;if(newCursorIndex===-1){this.trigger("cursorRemoved");return}else if(newCursorIndex<-1){newCursorIndex=$suggestions.length-1}this._setCursor($newCursor=$suggestions.eq(newCursorIndex));this._ensureVisible($newCursor)},_ensureVisible:function ensureVisible($el){var elTop,elBottom,menuScrollTop,menuHeight;elTop=$el.position().top;elBottom=elTop+$el.outerHeight(true);menuScrollTop=this.$menu.scrollTop();menuHeight=this.$menu.height()+parseInt(this.$menu.css("paddingTop"),10)+parseInt(this.$menu.css("paddingBottom"),10);if(elTop<0){this.$menu.scrollTop(menuScrollTop+elTop)}else if(menuHeight<elBottom){this.$menu.scrollTop(menuScrollTop+(elBottom-menuHeight))}},close:function close(){if(this.isOpen){this.isOpen=false;this._removeCursor();this._hide();this.trigger("closed")}},open:function open(){if(!this.isOpen){this.isOpen=true;!this.isEmpty&&this._show();this.trigger("opened")}},setLanguageDirection:function setLanguageDirection(dir){this.$menu.css(dir==="ltr"?css.ltr:css.rtl)
},moveCursorUp:function moveCursorUp(){this._moveCursor(-1)},moveCursorDown:function moveCursorDown(){this._moveCursor(+1)},getDatumForSuggestion:function getDatumForSuggestion($el){var datum=null;if($el.length){datum={raw:Dataset.extractDatum($el),value:Dataset.extractValue($el),datasetName:Dataset.extractDatasetName($el)}}return datum},getDatumForCursor:function getDatumForCursor(){return this.getDatumForSuggestion(this._getCursor().first())},getDatumForTopSuggestion:function getDatumForTopSuggestion(){return this.getDatumForSuggestion(this._getSuggestions().first())},update:function update(query){_.each(this.datasets,updateDataset);function updateDataset(dataset){dataset.update(query)}},empty:function empty(){_.each(this.datasets,clearDataset);this.isEmpty=true;function clearDataset(dataset){dataset.clear()}},isVisible:function isVisible(){return this.isOpen&&!this.isEmpty},destroy:function destroy(){this.$menu.off(".tt");this.$menu=null;_.each(this.datasets,destroyDataset);function destroyDataset(dataset){dataset.destroy()}}});return Dropdown;function initializeDataset(oDataset){return new Dataset(oDataset)}}();var Typeahead=function(){var attrsKey="ttAttrs";function Typeahead(o){var $menu,$input,$hint;o=o||{};if(!o.input){$.error("missing input")}this.isActivated=false;this.autoselect=!!o.autoselect;this.minLength=_.isNumber(o.minLength)?o.minLength:1;this.$node=buildDomStructure(o.input,o.withHint);$menu=this.$node.find(".tt-dropdown-menu");$input=this.$node.find(".tt-input");$hint=this.$node.find(".tt-hint");$input.on("blur.tt",function($e){var active,isActive,hasActive;active=document.activeElement;isActive=$menu.is(active);hasActive=$menu.has(active).length>0;if(_.isMsie()&&(isActive||hasActive)){$e.preventDefault();$e.stopImmediatePropagation();_.defer(function(){$input.focus()})}});$menu.on("mousedown.tt",function($e){$e.preventDefault()});this.eventBus=o.eventBus||new EventBus({el:$input});this.dropdown=new Dropdown({menu:$menu,datasets:o.datasets}).onSync("suggestionClicked",this._onSuggestionClicked,this).onSync("cursorMoved",this._onCursorMoved,this).onSync("cursorRemoved",this._onCursorRemoved,this).onSync("opened",this._onOpened,this).onSync("closed",this._onClosed,this).onAsync("datasetRendered",this._onDatasetRendered,this);this.input=new Input({input:$input,hint:$hint}).onSync("focused",this._onFocused,this).onSync("blurred",this._onBlurred,this).onSync("enterKeyed",this._onEnterKeyed,this).onSync("tabKeyed",this._onTabKeyed,this).onSync("escKeyed",this._onEscKeyed,this).onSync("upKeyed",this._onUpKeyed,this).onSync("downKeyed",this._onDownKeyed,this).onSync("leftKeyed",this._onLeftKeyed,this).onSync("rightKeyed",this._onRightKeyed,this).onSync("queryChanged",this._onQueryChanged,this).onSync("whitespaceChanged",this._onWhitespaceChanged,this);this._setLanguageDirection()}_.mixin(Typeahead.prototype,{_onSuggestionClicked:function onSuggestionClicked(type,$el){var datum;if(datum=this.dropdown.getDatumForSuggestion($el)){this._select(datum)}},_onCursorMoved:function onCursorMoved(){var datum=this.dropdown.getDatumForCursor();this.input.setInputValue(datum.value,true);this.eventBus.trigger("cursorchanged",datum.raw,datum.datasetName)},_onCursorRemoved:function onCursorRemoved(){this.input.resetInputValue();this._updateHint()},_onDatasetRendered:function onDatasetRendered(){this._updateHint()},_onOpened:function onOpened(){this._updateHint();this.eventBus.trigger("opened")},_onClosed:function onClosed(){this.input.clearHint();this.eventBus.trigger("closed")},_onFocused:function onFocused(){this.isActivated=true;this.dropdown.open()},_onBlurred:function onBlurred(){this.isActivated=false;this.dropdown.empty();this.dropdown.close()},_onEnterKeyed:function onEnterKeyed(type,$e){var cursorDatum,topSuggestionDatum;cursorDatum=this.dropdown.getDatumForCursor();topSuggestionDatum=this.dropdown.getDatumForTopSuggestion();if(cursorDatum){this._select(cursorDatum);$e.preventDefault()}else if(this.autoselect&&topSuggestionDatum){this._select(topSuggestionDatum);$e.preventDefault()}},_onTabKeyed:function onTabKeyed(type,$e){var datum;if(datum=this.dropdown.getDatumForCursor()){this._select(datum);$e.preventDefault()}else{this._autocomplete(true)}},_onEscKeyed:function onEscKeyed(){this.dropdown.close();this.input.resetInputValue()},_onUpKeyed:function onUpKeyed(){var query=this.input.getQuery();this.dropdown.isEmpty&&query.length>=this.minLength?this.dropdown.update(query):this.dropdown.moveCursorUp();this.dropdown.open()},_onDownKeyed:function onDownKeyed(){var query=this.input.getQuery();this.dropdown.isEmpty&&query.length>=this.minLength?this.dropdown.update(query):this.dropdown.moveCursorDown();this.dropdown.open()},_onLeftKeyed:function onLeftKeyed(){this.dir==="rtl"&&this._autocomplete()},_onRightKeyed:function onRightKeyed(){this.dir==="ltr"&&this._autocomplete()},_onQueryChanged:function onQueryChanged(e,query){this.input.clearHintIfInvalid();query.length>=this.minLength?this.dropdown.update(query):this.dropdown.empty();this.dropdown.open();this._setLanguageDirection()},_onWhitespaceChanged:function onWhitespaceChanged(){this._updateHint();this.dropdown.open()},_setLanguageDirection:function setLanguageDirection(){var dir;if(this.dir!==(dir=this.input.getLanguageDirection())){this.dir=dir;this.$node.css("direction",dir);this.dropdown.setLanguageDirection(dir)}},_updateHint:function updateHint(){var datum,val,query,escapedQuery,frontMatchRegEx,match;datum=this.dropdown.getDatumForTopSuggestion();if(datum&&this.dropdown.isVisible()&&!this.input.hasOverflow()){val=this.input.getInputValue();query=Input.normalizeQuery(val);escapedQuery=_.escapeRegExChars(query);frontMatchRegEx=new RegExp("^(?:"+escapedQuery+")(.+$)","i");match=frontMatchRegEx.exec(datum.value);match?this.input.setHint(val+match[1]):this.input.clearHint()}else{this.input.clearHint()}},_autocomplete:function autocomplete(laxCursor){var hint,query,isCursorAtEnd,datum;hint=this.input.getHint();query=this.input.getQuery();isCursorAtEnd=laxCursor||this.input.isCursorAtEnd();if(hint&&query!==hint&&isCursorAtEnd){datum=this.dropdown.getDatumForTopSuggestion();datum&&this.input.setInputValue(datum.value);this.eventBus.trigger("autocompleted",datum.raw,datum.datasetName)}},_select:function select(datum){this.input.setQuery(datum.value);this.input.setInputValue(datum.value,true);this._setLanguageDirection();this.eventBus.trigger("selected",datum.raw,datum.datasetName);this.dropdown.close();_.defer(_.bind(this.dropdown.empty,this.dropdown))},open:function open(){this.dropdown.open()},close:function close(){this.dropdown.close()},setVal:function setVal(val){if(this.isActivated){this.input.setInputValue(val)}else{this.input.setQuery(val);this.input.setInputValue(val,true)}this._setLanguageDirection()},getVal:function getVal(){return this.input.getQuery()},destroy:function destroy(){this.input.destroy();this.dropdown.destroy();destroyDomStructure(this.$node);this.$node=null}});return Typeahead;function buildDomStructure(input,withHint){var $input,$wrapper,$dropdown,$hint;$input=$(input);$wrapper=$(html.wrapper).css(css.wrapper);$dropdown=$(html.dropdown).css(css.dropdown);$hint=$input.clone().css(css.hint).css(getBackgroundStyles($input));$hint.val("").removeData().addClass("tt-hint").removeAttr("id name placeholder").prop("disabled",true).attr({autocomplete:"off",spellcheck:"false"});$input.data(attrsKey,{dir:$input.attr("dir"),autocomplete:$input.attr("autocomplete"),spellcheck:$input.attr("spellcheck"),style:$input.attr("style")});$input.addClass("tt-input").attr({autocomplete:"off",spellcheck:false}).css(withHint?css.input:css.inputWithNoHint);try{!$input.attr("dir")&&$input.attr("dir","auto")}catch(e){}return $input.wrap($wrapper).parent().prepend(withHint?$hint:null).append($dropdown)}function getBackgroundStyles($el){return{backgroundAttachment:$el.css("background-attachment"),backgroundClip:$el.css("background-clip"),backgroundColor:$el.css("background-color"),backgroundImage:$el.css("background-image"),backgroundOrigin:$el.css("background-origin"),backgroundPosition:$el.css("background-position"),backgroundRepeat:$el.css("background-repeat"),backgroundSize:$el.css("background-size")}}function destroyDomStructure($node){var $input=$node.find(".tt-input");_.each($input.data(attrsKey),function(val,key){_.isUndefined(val)?$input.removeAttr(key):$input.attr(key,val)});$input.detach().removeData(attrsKey).removeClass("tt-input").insertAfter($node);$node.remove()}}();(function(){var old,typeaheadKey,methods;old=$.fn.typeahead;typeaheadKey="ttTypeahead";methods={initialize:function initialize(o,datasets){datasets=_.isArray(datasets)?datasets:[].slice.call(arguments,1);o=o||{};return this.each(attach);function attach(){var $input=$(this),eventBus,typeahead;_.each(datasets,function(d){d.highlight=!!o.highlight});typeahead=new Typeahead({input:$input,eventBus:eventBus=new EventBus({el:$input}),withHint:_.isUndefined(o.hint)?true:!!o.hint,minLength:o.minLength,autoselect:o.autoselect,datasets:datasets});$input.data(typeaheadKey,typeahead)}},open:function open(){return this.each(openTypeahead);function openTypeahead(){var $input=$(this),typeahead;if(typeahead=$input.data(typeaheadKey)){typeahead.open()}}},close:function close(){return this.each(closeTypeahead);function closeTypeahead(){var $input=$(this),typeahead;if(typeahead=$input.data(typeaheadKey)){typeahead.close()}}},val:function val(newVal){return!arguments.length?getVal(this.first()):this.each(setVal);function setVal(){var $input=$(this),typeahead;if(typeahead=$input.data(typeaheadKey)){typeahead.setVal(newVal)}}function getVal($input){var typeahead,query;if(typeahead=$input.data(typeaheadKey)){query=typeahead.getVal()}return query}},destroy:function destroy(){return this.each(unattach);function unattach(){var $input=$(this),typeahead;if(typeahead=$input.data(typeaheadKey)){typeahead.destroy();$input.removeData(typeaheadKey)}}}};$.fn.typeahead=function(method){if(methods[method]){return methods[method].apply(this,[].slice.call(arguments,1))}else{return methods.initialize.apply(this,arguments)}};$.fn.typeahead.noConflict=function noConflict(){$.fn.typeahead=old;return this}})()})(window.jQuery);if($(".entity-typeahead").length){function setEntityID(ev,datum,dataset){$(this).closest("form").find("input[name='id_']").attr("value",datum["id"])}var users=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.nonword("name"),queryTokenizer:Bloodhound.tokenizers.nonword,prefetch:{url:$SCRIPT_ROOT+"/api/user/",filter:function(list){return list["users"]}}});var groups=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.nonword("name"),queryTokenizer:Bloodhound.tokenizers.nonword,prefetch:{url:$SCRIPT_ROOT+"/api/group/",filter:function(list){return list["groups"]}}});groups.initialize();users.initialize();$(".entity-typeahead").typeahead({hint:true,highlight:true},{name:"users",displayKey:"name",source:users.ttAdapter(),templates:{suggestion:function(obj){return"<p>"+obj["name"]+' <small class="text-muted">User</small></p>'}}},{name:"groups",displayKey:"name",source:groups.ttAdapter(),templates:{suggestion:function(obj){return"<p>"+obj["name"]+' <small class="text-muted">Group</small></p>'}}}).on("typeahead:autocompleted",setEntityID).on("typeahead:selected",setEntityID).on("typeahead:cursorchanged",setEntityID)}
//# sourceMappingURL=evesrp.min.js.map