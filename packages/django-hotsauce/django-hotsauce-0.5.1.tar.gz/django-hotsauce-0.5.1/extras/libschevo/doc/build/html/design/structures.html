

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Schevo Internal Database Structures &mdash; libschevo 3.2.4 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.2.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="libschevo 3.2.4 documentation" href="../index.html" />
    <link rel="up" title="Schevo Design" href="index.html" />
    <link rel="prev" title="Schevo" href="principles.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="principles.html" title="Schevo"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">libschevo 3.2.4 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Schevo Design</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="schevo-internal-database-structures">
<h1>Schevo Internal Database Structures<a class="headerlink" href="#schevo-internal-database-structures" title="Permalink to this headline">¶</a></h1>
<p>This document explains the data structures a Schevo database uses
internally.</p>
<div class="section" id="structural-overview">
<h2>Structural overview<a class="headerlink" href="#structural-overview" title="Permalink to this headline">¶</a></h2>
<p>At the root of the Durus connection a key called &#8216;SCHEVO&#8217; contains the
following structures:</p>
<div class="highlight-python"><pre>'SCHEVO': PersistentDict{
    'label': &lt;db-label&gt;,          [*]
    'format': &lt;db-format&gt;,
    'version': &lt;schema-version&gt;,
    'schema_source': &lt;schema-module-source&gt;,
    'extent_name_id': PersistentDict{
        &lt;extent-name&gt;: &lt;extent-id&gt;,
        ...,
        },
    'extents': PersistentDict{
        &lt;extent-id&gt;: PersistentDict{
            'entities': BTree{
                &lt;entity-oid&gt;: PersistentDict{
                    'rev': &lt;entity-rev&gt;,
                    'fields': PersistentDict{
                        &lt;field-id&gt;: &lt;stored-value&gt;,
                        ...,
                        },
                    'link_count': &lt;count-of-links&gt;,
                    'links': PersistentDict{
                        (&lt;referrer-extent-id&gt;, &lt;referrer-field-id&gt;): BTree{
                            &lt;referrer-oid&gt;: None,
                            ...,
                            },
                        },
                    'related_entities': PersistentDict{       [**]
                        &lt;field-id&gt;: &lt;related-entity-set&gt;,
                        ...,
                        },
                    },
                ...,
                },
            'entity_field_ids': (&lt;field-id&gt;, ...),
            'field_id_name': PersistentDict{
                &lt;field-id&gt;: &lt;field-name&gt;,
                ...,
                },
            'field_name_id': PersistentDict{
                &lt;field-name&gt;: &lt;field-id&gt;,
                ...,
                },
            'id': &lt;id-of-extent&gt;,
            'indices': &lt;indices&gt;,
            'index_map': &lt;index-map&gt;,
            'len': &lt;length-of-extent&gt;,
            'name': &lt;name-of-extent&gt;,
            'normalized_index_map': &lt;normalized-index-map&gt;,
            'next_oid': &lt;next-oid-of-extent&gt;,
            },
        ...,
        },
    }</pre>
</div>
<p><tt class="docutils literal"><span class="pre">[*]</span></tt>: Labels are not present in older databases, and a default
label is assumed if a persistent label is not assigned.</p>
<p><tt class="docutils literal"><span class="pre">[**]</span></tt>: The related entities structure is only present in databases
of format 2 or higher.</p>
</div>
<div class="section" id="indices">
<h2>Indices<a class="headerlink" href="#indices" title="Permalink to this headline">¶</a></h2>
<div class="section" id="specification-in-schema">
<h3>Specification in schema<a class="headerlink" href="#specification-in-schema" title="Permalink to this headline">¶</a></h3>
<p>The distinction between a &#8220;key&#8221; and an &#8220;index&#8221; is that a key is the
minimal amount of information that will uniquely identify an entity,
whereas an index is a structure used to increase the efficiency of
lookup and sorting operations.</p>
<p>Implementation-wise, the specification of a key results in a unique
index.</p>
<p>Keys are specified in the same way as they always have been, using the
following syntax:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">_key</span><span class="p">(</span><span class="n">field1</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">fieldn</span><span class="p">])</span>
</pre></div>
</div>
<p>Indices are specified in a similar manner, using the following
syntax to create a non-unique index:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">_index</span><span class="p">(</span><span class="n">field1</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">fieldn</span><span class="p">])</span>
</pre></div>
</div>
<p>Of note is that the field order now becomes important, since each type
of index will also be used for obtaining ordered lists of entity OIDs,
not just for find operations and key collision checking.  Therefore,
the following becomes valid and creates two separate index structures,
although for key collision checking in effect either one may be used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">_key</span><span class="p">(</span><span class="n">field1</span><span class="p">,</span> <span class="n">field2</span><span class="p">)</span>
<span class="n">_index</span><span class="p">(</span><span class="n">field2</span><span class="p">,</span> <span class="n">field1</span><span class="p">)</span>
</pre></div>
</div>
<p>If an index is specified that is a superset of a key, it becomes
unique.  Therefore, in the above example, the index specified is a
unique index.</p>
<p>Additionally, the index specified in this example becomes a unique
index:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">_key</span><span class="p">(</span><span class="n">field1</span><span class="p">,</span> <span class="n">field2</span><span class="p">)</span>
<span class="n">_index</span><span class="p">(</span><span class="n">field3</span><span class="p">,</span> <span class="n">field2</span><span class="p">,</span> <span class="n">field1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="internal-structures">
<h3>Internal structures<a class="headerlink" href="#internal-structures" title="Permalink to this headline">¶</a></h3>
<p>The main top-level structure of an extent index is <cite>indices</cite>, which
is structured as follows:</p>
<div class="highlight-python"><pre>dict{
  index-spec: (unique, index-tree),
  ...,
  }</pre>
</div>
<p><cite>unique</cite> is a boolean that is True if each leaf in the index must have
only zero or one <cite>oid</cite> keys as described below.</p>
<p><cite>index-spec</cite> is a tuple of field IDs in the order given by the
<cite>_key</cite> and <cite>_index</cite> specifications in the schema.</p>
<p><cite>index-tree</cite> is the following structure, where <cite>field-value</cite> are the
values of the first field specified in the <cite>index-spec</cite>:</p>
<div class="highlight-python"><pre>BTree{
  field-value: index-tree | oid-tree,
}</pre>
</div>
<p>If the <cite>index-tree</cite> itself is a branch, then for each <cite>field-value</cite>
there will be another <cite>index-tree</cite> for the next field in the index
spec.</p>
<p>If the <cite>index-tree</cite> is instead a leaf, then for each <cite>field-value</cite>
there will be an <cite>oid-tree</cite>, which is the following structure:</p>
<div class="highlight-python"><pre>BTree{
  oid: None,
  ...,
  }</pre>
</div>
<p>Each <cite>oid</cite> in the <cite>oid-tree</cite> corresponds to an entity whose fields
specified in the <cite>index-spec</cite> have values that match all of the
<cite>field-value</cite> keys in each traversed <cite>index-tree</cite>.</p>
<p>The next top-level structure of an extent index is <cite>index-map</cite>, which
maps several <cite>partial-index-spec</cite> to lists of actual <cite>index-spec</cite> that
are stored in <cite>indices</cite>:</p>
<div class="highlight-python"><pre>dict{
  partial-index-spec: [index-spec-1, ..., index-spec-n],
}</pre>
</div>
<p><cite>partial-index-spec</cite> is a tuple of field IDs, sorted by the order
defined in its corresponding <cite>index-spec</cite>.  For instance, if you have
two <cite>index-spec</cite> of (123, 456, 789) and (123, 456, 234), then a
<cite>partial-index-spec</cite> of (123, 456) would map to both of those
<cite>index-spec</cite>.</p>
<p>Of note is that <cite>partial-index-spec</cite> could actually be a full
<cite>index-spec</cite> that exists in <cite>indices</cite>.  For instance, given two
<cite>index-spec</cite> of (123, 456, 789) and (123, 456), a <cite>partial-index-spec</cite>
of (123, 456) would map to both of those <cite>index-spec</cite>.</p>
<p>The final top-level structure of an extent index is
<cite>normalized-index-map</cite>, which is the same as <cite>index-map</cite> except that
each <cite>partial-index-spec</cite> is normalized by sorting by field ID.</p>
</div>
<div class="section" id="traversal-of-indices-find-method">
<h3>Traversal of indices (<cite>find</cite> method)<a class="headerlink" href="#traversal-of-indices-find-method" title="Permalink to this headline">¶</a></h3>
<p>If no arguments, just return a list of all OIDs.</p>
<p>The arguments to a <cite>find</cite> operation are a dictionary of field name and
field value.</p>
<p>Transform those arguments by converting field names to field IDs.</p>
<p>Sort a tuple of field IDs.  This becomes the normalized
<cite>partial-index-spec</cite>.</p>
<p>Get the most specific <cite>index-spec</cite> from <cite>normalized-index-map</cite> using
that <cite>partial-index-spec</cite> as the key.</p>
<p>If <cite>partial-index-spec</cite> was not found, revert to brute-force find. An
optimization of this would be to trim that <cite>partial-index-spec</cite> in
some way and look for an index that matches that.  In this manner, you
can use the index to obtain a subset of entities in which to perform a
brute-force find.</p>
<p>Access the top-level <cite>index-tree</cite> from <cite>indices</cite>.</p>
<p>In a loop:</p>
<blockquote>
<div><p>Pop the first field ID off of the <cite>index-spec</cite>.  Pop the value for
that field off of the arguments to <cite>find</cite>.</p>
<p>Look up that field value in the current <cite>index-tree</cite>; if there are
no more field IDs in <cite>index-spec</cite> this will be an <cite>oid-tree</cite>,
otherwise it will be another <cite>index-tree</cite>.</p>
<p>If not found, return an empty list as the result of <cite>find</cite>.</p>
<p>If there are more arguments to <cite>find</cite>, continue the loop.</p>
<p>If there are no more arguments to <cite>find</cite>, and there are no more
fields in <cite>index-spec</cite>, we are at a leaf; return the keys of the
<cite>oid-tree</cite> as the result of <cite>find</cite>.</p>
<p>If there are no more arguments to <cite>find</cite>, but there are more fields
in <cite>index-spec</cite>, we are at a branch; traverse each branch
recursively until leaves are reached.  Return the resulting set of
matching OIDs.</p>
</div></blockquote>
</div>
<div class="section" id="obtaining-ordered-oid-lists-by-method">
<h3>Obtaining ordered OID lists (<cite>by</cite> method)<a class="headerlink" href="#obtaining-ordered-oid-lists-by-method" title="Permalink to this headline">¶</a></h3>
<p>The arguments to a <cite>by</cite> operation are a list of field names,
optionally with a hyphen prefix to indicate reverse sort order.</p>
<p>Transform the field names to field IDs, ignoring sort order for the
time being.</p>
<p>Create an <cite>index-spec</cite> based on these field IDs.</p>
<p>Access the appropriate <cite>index-tree</cite> in <cite>indices</cite>:</p>
<blockquote>
<div><p>First, look for a direct match in <cite>indices</cite> for the <cite>index-spec</cite>.</p>
<p>If that fails, look for <cite>index-spec</cite> in <cite>index-map</cite>.  If no match is
found, raise an <cite>IndexNotFound</cite> exception.  Otherwise, use the first
spec in the resulting list as <cite>index-spec</cite> and use that to get the
<cite>index-tree</cite>.</p>
</div></blockquote>
<p>Create an empty list to store results.</p>
<p>Recursively, starting with the first field:</p>
<blockquote>
<div><p>If we are at a branch (more fields need to be traversed):</p>
<blockquote>
<div><p>If the current field being traversed is to be sorted ascending,
iterate over the keys of the <cite>index-tree</cite> and recurse to the next
level.</p>
<p>If the current field being traversed is to be sorted descending,
iterate over the keys of the <cite>index-tree</cite> in reverse order and
recurse to the next level.</p>
</div></blockquote>
<p>If we are at a leaf (no more fields to traverse):</p>
<blockquote>
<div>Get the list of keys in the <cite>oid-tree</cite>.  Append those to the
results list.</div></blockquote>
</div></blockquote>
<p>Return the results list.</p>
</div>
<div class="section" id="temporarily-relaxing-uniqueness-constraints">
<h3>Temporarily relaxing uniqueness constraints<a class="headerlink" href="#temporarily-relaxing-uniqueness-constraints" title="Permalink to this headline">¶</a></h3>
<p>A transaction can relax the uniqueness constraint of a unique index by
calling <cite>db.relax_index(*spec)</cite>.</p>
<p>While a unique index is relaxed, the database will keep track of
changes made to that index by the transaction and its subtransactions.</p>
<p>When the transaction calls the corresponding
<cite>db.enforce_index(*spec)</cite>, the database will look at all the changes
made to that index.  If any non-unique values are found as a result of
those changes, the transaction will fail with an <cite>KeyCollision</cite>
exception and the changes made by that transaction will be rolled
back.</p>
<p>If a transaction calls <cite>relax_index</cite> without later explicitly calling
<cite>enforce_index</cite>, the database will automatically call <cite>enforce_index</cite>
at the end of the transaction that called <cite>relax_index</cite>.</p>
<p>If a transaction calls <cite>relax_index</cite> on an index, and a subtransaction
calls <cite>relax_index</cite> on the same index, the call to <cite>enforce_index</cite>
will be a no-op in the subtransaction as the outer transaction still
expects the index to be relaxed.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Schevo Internal Database Structures</a><ul>
<li><a class="reference internal" href="#structural-overview">Structural overview</a></li>
<li><a class="reference internal" href="#indices">Indices</a><ul>
<li><a class="reference internal" href="#specification-in-schema">Specification in schema</a></li>
<li><a class="reference internal" href="#internal-structures">Internal structures</a></li>
<li><a class="reference internal" href="#traversal-of-indices-find-method">Traversal of indices (<cite>find</cite> method)</a></li>
<li><a class="reference internal" href="#obtaining-ordered-oid-lists-by-method">Obtaining ordered OID lists (<cite>by</cite> method)</a></li>
<li><a class="reference internal" href="#temporarily-relaxing-uniqueness-constraints">Temporarily relaxing uniqueness constraints</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="principles.html"
                        title="previous chapter">Schevo</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/design/structures.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="principles.html" title="Schevo"
             >previous</a> |</li>
        <li><a href="../index.html">libschevo 3.2.4 documentation</a> &raquo;</li>
          <li><a href="index.html" >Schevo Design</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Etienne Robillard.
      Last updated on Nov 17, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>