<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chapter 11: Manage concurrency for a specific task with @jobs_limit &mdash; ruffus 2.5 documentation</title>
    
    <link rel="stylesheet" href="../../_static/ruffus.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="ruffus 2.5 documentation" href="../../index.html" />
    <link rel="next" title="Chapter 12: Checking dependencies to run tasks in order" href="dependencies.html" />
    <link rel="prev" title="Chapter 10: Signal the completion of each stage of our pipeline with @posttask" href="posttask.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="dependencies.html" title="Chapter 12: Checking dependencies to run tasks in order"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="posttask.html" title="Chapter 10: Signal the completion of each stage of our pipeline with @posttask"
             accesskey="P">previous</a> |</li>
        Ruffus v. 2.5
            <li><a href="../../index.html">Home</a> | </li>
            <li><a href="../../contents.html">Contents</a> | </li>
            <li><a href="../../installation.html">Install</a>  | </li>
            <li><a href="../new_tutorial/introduction.html">Manual</a>  / </li>
            <li><a href="../new_tutorial/manual_contents.html">(TOC)</a>  | </li>
            <li><a href="../../faq.html">FAQ</a>  | </li>
            <li><a href="../../cheatsheet.html">Cheat sheet</a> | </li>
            <li><a href="../new_tutorial/command_line.html">Command Line</a> | </li>
            <li><a href="../../gallery.html">Gallery</a> |  </li>
            <li><a href="../../history.html">Latest Changes</a> &raquo; </li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="manual-jobs-limit-chapter-num-manage-concurrency-for-a-specific-task-with-jobs-limit">
<span id="manual-jobs-limit"></span><h1><strong>Chapter 11</strong>: <cite>Manage concurrency for a specific task with</cite> <strong>&#64;jobs_limit</strong><a class="headerlink" href="#manual-jobs-limit-chapter-num-manage-concurrency-for-a-specific-task-with-jobs-limit" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><table class="hlist"><tr><td><ul class="simple">
<li><a class="reference internal" href="manual_contents.html#manual"><em>Manual overview</em></a></li>
</ul>
</td><td><ul class="simple">
<li><a class="reference internal" href="../../decorators/jobs_limit.html#decorators-jobs-limit"><em>&#64;jobs_limit</em></a> syntax in detail</li>
</ul>
</td></tr></table>
</div></blockquote>
<div class="section" id="jobs-limit">
<span id="index-0"></span><h2><strong>&#64;jobs_limit</strong><a class="headerlink" href="#jobs-limit" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Calling <a class="reference internal" href="../../pipeline_functions.html#pipeline-functions-pipeline-run"><em>pipeline_run(multiprocess = NNN)</em></a> allows
multiple jobs (from multiple independent tasks) to be run in parallel. However, there
are some operations which consume so many resources that we might want them to run
with less or no concurrency.</p>
<p>For example, we might want to download some files via FTP but the server restricts
requests from each IP address. Even if the rest of the pipeline is running 100 jobs in
parallel, the FTP downloading must be restricted to 2 files at a time. We would really
like to keep the pipeline running as is, but let this one operation run either serially,
or with little concurrency.</p>
<p>If setting <tt class="docutils literal"><span class="pre">multiprocess</span> <span class="pre">=</span> <span class="pre">NNN</span></tt> sets the pipeline-wide concurrency to <tt class="docutils literal"><span class="pre">NNN</span></tt>, then
<tt class="docutils literal"><span class="pre">&#64;jobs_limit(MMM)</span></tt> sets concurrency at a much finer level, at <tt class="docutils literal"><span class="pre">MMM</span></tt> just for jobs
in the indicated task.</p>
<p>The optional name (e.g. <tt class="docutils literal"><span class="pre">&#64;jobs_limit(3,</span> <span class="pre">&quot;ftp_download_limit&quot;)</span></tt>) allows the same limit to
be shared across multiple tasks. To be pedantic: a limit of <tt class="docutils literal"><span class="pre">3</span></tt> jobs at a time would be applied
across all tasks which have a <tt class="docutils literal"><span class="pre">&#64;jobs_limit</span></tt> named <tt class="docutils literal"><span class="pre">&quot;ftp_download_limit&quot;</span></tt>:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">ruffus</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c"># make list of 10 files</span>
<span class="nd">@split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&quot;*stage1&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">make_files</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_files</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">.small_stage1&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">.big_stage1&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

<span class="nd">@jobs_limit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ftp_download_limit&quot;</span><span class="p">)</span>
<span class="nd">@transform</span><span class="p">(</span><span class="n">make_files</span><span class="p">,</span> <span class="n">suffix</span><span class="p">(</span><span class="s">&quot;.small_stage1&quot;</span><span class="p">),</span> <span class="s">&quot;.stage2&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stage1_small</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

<span class="nd">@jobs_limit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ftp_download_limit&quot;</span><span class="p">)</span>
<span class="nd">@transform</span><span class="p">(</span><span class="n">make_files</span><span class="p">,</span> <span class="n">suffix</span><span class="p">(</span><span class="s">&quot;.big_stage1&quot;</span><span class="p">),</span> <span class="s">&quot;.stage2&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stage1_big</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

<span class="nd">@jobs_limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nd">@transform</span><span class="p">([</span><span class="n">stage1_small</span><span class="p">,</span> <span class="n">stage1_big</span><span class="p">],</span> <span class="n">suffix</span><span class="p">(</span><span class="s">&quot;.stage2&quot;</span><span class="p">),</span> <span class="s">&quot;.stage3&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stage2</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">):</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

<span class="n">pipeline_run</span><span class="p">([</span><span class="n">stage2</span><span class="p">],</span> <span class="n">multiprocess</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>will run the 10 jobs of <tt class="docutils literal"><span class="pre">stage1_big</span></tt> and <tt class="docutils literal"><span class="pre">stage1_small</span></tt> 3 at a time (highlighted in blue),
a limit shared across the two tasks. <tt class="docutils literal"><span class="pre">stage2</span></tt> jobs run 5 at a time (in red).
These limits override the numbers set in <tt class="docutils literal"><span class="pre">pipeline_run</span></tt> (<tt class="docutils literal"><span class="pre">multiprocess</span> <span class="pre">=</span> <span class="pre">10</span></tt>):</p>
<blockquote>
<div><img alt="../../_images/jobs_limit2.png" src="../../_images/jobs_limit2.png" />
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#"><strong>Chapter 11</strong>: <cite>Manage concurrency for a specific task with</cite> <strong>&#64;jobs_limit</strong></a><ul>
<li><a class="reference internal" href="#jobs-limit"><strong>&#64;jobs_limit</strong></a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="posttask.html"
                        title="previous chapter"><strong>Chapter 10</strong>: <cite>Signal the completion of each stage of our pipeline with</cite> <strong>&#64;posttask</strong></a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="dependencies.html"
                        title="next chapter"><strong>Chapter 12</strong>: <cite>Checking dependencies to run tasks in order</cite></a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/tutorials/manual/jobs_limit.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
    
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
    <h3> Quick Reference:</h3>
    <ul>
        <h4><a href="../../decorators/decorators.html#core">Core:</a></h4>   
        <ul>
            <li><a href="../../decorators/originate.html">@originate</a>                           </li>
            <li><a href="../../decorators/split.html">@split</a>                                   </li>
            <li><a href="../../decorators/transform.html">@transform</a>                           </li>
            <li><a href="../../decorators/merge.html">@merge</a>                                   </li>
        </ul>

        <h4><a href="../../decorators/decorators.html#advanced">Advanced</a></h4>   
        <ul>
            <li><a href="../../decorators/subdivide.html">@subdivide</a>                           </li>
            <li><a href="../../decorators/transform_ex.html">@transform (add_inputs) </a>          </li>
            <li><a href="../../decorators/collate.html">@collate</a>                               </li>
            <li><a href="../../decorators/collate_ex.html">@collate (add_inputs)</a>               </li>
            <li><a href="../../decorators/graphviz.html">@graphviz</a>                             </li>
            <li><a href="../../decorators/mkdir.html">@mkdir</a>                                   </li>
            <li><a href="../../decorators/follows.html">@follows / mkdir</a>                       </li>
            <li><a href="../../decorators/posttask.html">@posttask touch_file</a>                  </li>
            <li><a href="../../decorators/active_if.html">@active_if</a>                           </li>
            <li><a href="../../decorators/jobs_limit.html">@jobs_limit</a>                         </li>
        </ul>
    
        <h4><a href="../../decorators/decorators.html#combinatorics">Combinatorial:</a></h4>   
        <ul>
            <li><a href="../../decorators/product.html">@product </a>                              </li>
            <li><a href="../../decorators/permutations.html">@permutations </a>                    </li>
            <li><a href="../../decorators/combinations.html">@combinations </a>                    </li>
            <li><a href="../../decorators/combinations_with_replacement.html">@combinations_ _with_replacement </a>                    </li>
        </ul>

                        
        <h4><a href="../../decorators/decorators.html#esoteric">Esoteric</a></h4>   
        <ul>
            <li><a href="../../decorators/files_ex.html">@files (on the fly)</a>                   </li>
            <li><a href="../../decorators/parallel.html">@parallel</a>                             </li>
            <li><a href="../../decorators/check_if_uptodate.html">@check_if_uptodate</a>           </li>
        </ul>


        <h4 ><a href="../../decorators/indicator_objects.html">Indicator objects</a></h4>
        <h4 >Pipeline functions</h4>
        <ul>
            <li><a href="../../pipeline_functions.html#pipeline-functions-pipeline-run">pipeline_run</a>                       </li>
            <li><a href="../../pipeline_functions.html#pipeline-functions-pipeline-printout">pipeline_printout</a>                      </li>
            <li><a href="../../pipeline_functions.html#pipeline-functions-pipeline-printout-graph">pipeline_printout_graph</a>          </li>
            <li><a href="../../pipeline_functions.html#pipeline-functions-pipeline-get-task-names">pipeline_get_task_names</a>          </li>
            <li><a href="../../drmaa_wrapper_functions.html#drmaa-wrapper-functions-drmaa_wrapper-run_job">drmaa_wrapper.run_job</a>          </li>
        </ul>

         <a href="../../todo.html">Future plans</a>
    </ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="dependencies.html" title="Chapter 12: Checking dependencies to run tasks in order"
             >next</a> |</li>
        <li class="right" >
          <a href="posttask.html" title="Chapter 10: Signal the completion of each stage of our pipeline with @posttask"
             >previous</a> |</li>
        Ruffus v. 2.5
            <li><a href="../../index.html">Home</a> | </li>
            <li><a href="../../contents.html">Contents</a> | </li>
            <li><a href="../../installation.html">Install</a>  | </li>
            <li><a href="../new_tutorial/introduction.html">Manual</a>  / </li>
            <li><a href="../new_tutorial/manual_contents.html">(TOC)</a>  | </li>
            <li><a href="../../faq.html">FAQ</a>  | </li>
            <li><a href="../../cheatsheet.html">Cheat sheet</a> | </li>
            <li><a href="../new_tutorial/command_line.html">Command Line</a> | </li>
            <li><a href="../../gallery.html">Gallery</a> |  </li>
            <li><a href="../../history.html">Latest Changes</a> &raquo; </li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2009-2013 Leo Goodstadt.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>