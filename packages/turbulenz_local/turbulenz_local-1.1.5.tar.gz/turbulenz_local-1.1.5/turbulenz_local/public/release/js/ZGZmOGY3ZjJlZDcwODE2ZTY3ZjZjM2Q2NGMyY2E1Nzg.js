// Copyright (c) 2011-2013 Turbulenz Limited
/*global Backbone*//*global TurbulenzStore*//*global TurbulenzGameNotifications*//*global TurbulenzBridge*//*global LocalMessageView*//*global LocalPlayView*//*global CarouselView*//*global LocalMetricsView*//*global LocalListView*//*global LocalUserdataView*//*global LocalDeployView*//*global LocalEditView*//*jshint nomen: false*//*global _*//*global $*//*jshint nomen: true*//*exported LocalApplicationController*/var LocalApplicationController=Backbone.Controller.extend({routes:{"":"home","add-game":"create",":slug/?":"game","/play/:slug/?":"play_versions","/play/:slug/:version":"play","/edit/:slug/?":"edit","/metrics/:slug/?":"metrics","/list/:type/:slug/?":"list","/list/:type/:slug/*directory":"list","/userdata/:slug":"userdata","/userdata/:slug/*directory":"userdata"},initialize:function(t){this.pluginInfo=t.pluginInfo,this.sdkUrl=t.sdkUrl,this.router=t.router,this.viewerEnabled=t.viewer_enabled,_.bindAll(this,"home","game","play"),this.messageView=new LocalMessageView({engine:this.pluginInfo,sdk:this.sdkUrl}),this.playView=new LocalPlayView({app:this,engine:this.pluginInfo}),this.carousel=new CarouselView({app:this}),this.metrics=new LocalMetricsView({app:this}),this.list=new LocalListView({app:this}),this.userdata=new LocalUserdataView({app:this}),this.deploy=new LocalDeployView({app:this}),this.editView=new LocalEditView({app:this}),this.messageView.render(),this.deploy.render(),this.turbulenzBridge=TurbulenzBridge.create(this),this.store=TurbulenzStore.create(this),this.gameNotifications=TurbulenzGameNotifications.create(this),this.playingGameSlug=null;var n=this;return this.bind("game:play",function(e){n.playingGameSlug=e}),this.bind("game:stop",function(){n.playingGameSlug=null}),this},route:function(t,n,r){Backbone.history||(Backbone.history=new Backbone.History),_.isRegExp(t)||(t=this._routeToRegExp(t)),Backbone.history.route(t,_.bind(function(e){if(!this.preLeave())return;this.currentView=null;var i=this._extractParameters(t,e);r.apply(this,i),this.trigger.apply(this,["route:"+n].concat(i))},this))},home:function(){this.trigger("carousel:refresh"),this.trigger("carousel:collapse"),this.trigger("game:stop")},create:function(){this.carousel.addGame("add-game")},game:function(t,n){this.trigger("game:stop"),n||this.trigger("carousel:refresh"),$("#carousel").find("#"+t).length===0?this.trigger("carousel:collapse"):($("#actionspacer").empty(),this.carousel.expand("#"+t),$("#details").empty())},preLeave:function(){return this.currentView&&this.currentView.preLeave&&!this.currentView.preLeave()?(window.location.hash!==this.currentHash&&(window.location.hash=this.currentHash),!1):!0},prepareAction:function(t,n){var r=$("#"+t);!r.hasClass("selected")&&!r.hasClass("Temporary")&&this.trigger("carousel:collapse"),$("#carousel").length===0&&this.trigger("carousel:refresh");var i=$("#"+n+"-button");i.hasClass("selected")||i.addClass("selected").parent().siblings().children().removeClass("selected"),this.currentView=null},setCurrentView:function(e){this.currentView=e,this.currentHash=window.location.hash},play_versions:function(e){this.game(e,!0),this.prepareAction(e,"play"),this.trigger("game:versions",e)},play:function(t,n){this.trigger("game:play",t,n),this.currentView=undefined},edit:function(t){this.game(t,!0),this.prepareAction(t,"edit"),this.trigger("game:edit",t)},metrics:function(t){this.game(t,!0),this.prepareAction(t,"metrics"),this.trigger("game:metrics",t)},list:function(t,n,r){this.game(n,!0),this.prepareAction(n,"list"),this.trigger("assets:list",t,n,r)},userdata:function(t,n){this.game(t,!0),this.prepareAction(t,"userdata"),this.trigger("game:userdata",t,n)}});