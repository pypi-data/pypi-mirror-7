// Copyright (c) 2012 Turbulenz Limited
/*jshint nomen: false*//*global EventEmitter*//*global Turbulenz*//*global TurbulenzBridge*//*global $*//*exported turbulenzFlashBridgeGetData*//*exported turbulenzFlashBridgeEmit*//*exported turbulenzFlashBridgeOn*/function TurbulenzBridge(){}function turbulenzFlashBridgeGetData(){return Turbulenz.Data}function turbulenzFlashBridgeEmit(){var e=Turbulenz.Services.bridge;e.emit.apply(e,arguments)}function turbulenzFlashBridgeOn(e){var t="turbulenz_event_"+e,n=Turbulenz.Services.bridge;n.addListener(e,function(){var e=document.getElementById("turbulenz_game_engine_object");if(e){var n=e[t];n&&n.apply(e,arguments)}})}TurbulenzBridge.prototype={addStatusMessageListeners:function(){function p(){l-=1,l===0?a!==null?(clearTimeout(a),a=null):u===null&&(u=setTimeout(function(){u=null,f!==null&&(clearTimeout(f),f=null),s.animate({top:"-30px"},50,function(){s.hide()})},250)):l<0&&(l=0)}function d(e,t){t||(l+=1);if(l===1||t)u!==null?(clearTimeout(u),u=null,f!==null&&(clearTimeout(f),f=null)):a===null&&(a=setTimeout(function(){a=null,o.text(e?e:i),s.appendTo(r).show().css({top:"0px"});var t=window.location.hash;(function n(){window.location.hash!==t?p():f=setTimeout(n,250)})()},100))}function v(e){d("Loading...",e)}function m(e){d("Saving...",e)}function y(e,t){if(c!==t){c=t;if(!t)return;s.hide(),o.text(t),s.appendTo(r).show().css({top:"0px"}),h&&clearTimeout(h),h=setTimeout(g,3e3)}}function b(){s.appendTo(r).show().css({top:"0px"}),o.html('Confirm payment? <a id="confirmYes">Yes</a>, <a id="confirmNo">No</a>'),h&&clearTimeout(h),$("#confirmYes").click(function(){t.app.store.confirmPurchase(),g()}),$("#confirmNo").click(function(){t.app.store.rejectPurchase(),g()})}var t=this,n=Turbulenz.Services.bridge,r="body",i="Loading...",s=$('<div id="osd_message_outer_wrapper" style="position: absolute; display: none; width: 100%; top: -30px; z-index: 9999; text-align: center;">\n    <span class="message-container-outer">\n        <span id="osd_message_content" class="message-container">\n            <span id="osd_message" class="message-span"></span>\n        </span>\n    </span>\n</div>');$("body").append(s);var o=$("#osd_message"),u=null,a=null,f=null,l=0,c=null,h=null,g=function(){s.animate({top:"-30px"},50,function(){s.hide()})};$(document).bind("ajaxStart",function(){v()}),$(document).bind("ajaxStop",function(){p()}),n.addListener("status.loading.start",v),n.addListener("status.loading.stop",p),n.addListener("status.saving.start",m),n.addListener("status.saving.stop",p),n.addListener("game.session.status",y),n.addListener("purchase.show.confirm",b)}},TurbulenzBridge.create=function(t){function s(){r.addListener.apply(r,arguments)}if(Turbulenz.Services.bridge)throw"Only one TurbulenzBridge object can be created";var n=new TurbulenzBridge;n.app=t;var r=new EventEmitter,i=new EventEmitter;return n.siteEventEmitter=r,n.gameEventEmitter=i,Turbulenz.Classes.EventEmitter=EventEmitter,Turbulenz.Services.bridge={emit:function(){r.emit.apply(r,arguments),i.emit.apply(i,arguments)},gameListenerOn:function(){i.addListener.apply(i,arguments)},gameListenerOff:function(){i.removeListener.apply(i,arguments)},addListener:s,setListener:s,removeAllListeners:function(t){r.removeAllListeners(t),i.removeAllListeners(t)},removeAllGamesListeners:function(t){i.removeAllListeners(t)}},n.addStatusMessageListeners(),n};