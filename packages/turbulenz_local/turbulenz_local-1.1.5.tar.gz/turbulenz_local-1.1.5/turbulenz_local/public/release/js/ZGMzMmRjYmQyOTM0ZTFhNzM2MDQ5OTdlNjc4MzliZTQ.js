// Copyright (c) 2011-2012,2014 Turbulenz Limited
/*global $*//*global JsLocalStore*//*global Turbulenz*/// TODO: replace this with https://github.com/jquery/globalize.git
// this is just to keep things simple for now
function Currency(){}function Money(){}function TurbulenzStore(){}Currency.create=function(t,n,r,i){var s=new Currency;return s.currencyName=i,s.alphabeticCode=t,s.numericCode=n,s.minorUnitPrecision=r,s.toMinorUnit=Math.pow(10,r),s.toMajorUnit=Math.pow(10,-r),s},Money.prototype={toMajorUnit:function(){return(this.minorAmount*this.currency.toMajorUnit).toFixed(this.currency.minorUnitPrecision)},multiply:function(t){return Money.create(this.currency,this.minorAmount*t)},add:function(t){if(this.currency!==t.currency)throw"Can not add Money quantities of different currencies";return Money.create(this.currency,this.minorAmount+t.minorAmount)}},Money.create=function(t,n){var r=new Money;return r.currency=t,r.minorAmount=n,r},TurbulenzStore.prototype={confirmPurchase:function(){function c(){$.ajax({url:"/api/v1/store/transactions/read-status/"+r,type:"GET",success:function(n){n.data.status==="completed"?(t.updateBasket(s,{}),Turbulenz.Services.bridge.emit("basket.site.update",JSON.stringify({currency:t.currency,total:Money.create(t.currency,0).toMajorUnit(),items:{}})),Turbulenz.Services.bridge.emit("purchase.confirmed")):setTimeout(c,500)}})}var t=this,n=this.calculateBasket(),r,i=n.items,s=n.game,o={},u,a=0,f=this.offerings[s];if(!f)return;for(u in i)if(i.hasOwnProperty(u)&&f[u]){var l=i[u];a+=1,o[u]={amount:l.amount,price:l.price.minorAmount,output:f[u].output}}if(!a)return;$.ajax({url:"/api/v1/store/transactions/checkout",type:"POST",data:{basket:JSON.stringify(o),gameSlug:s},success:function(t){r=t.data.transactionId,$.ajax({url:"/api/v1/store/transactions/pay/"+r,type:"POST",success:function(){setTimeout(c,500)}})}})},rejectPurchase:function(){Turbulenz.Services.bridge.emit("purchase.rejected")},getStoreMeta:function(t,n){function r(){var e=this,r=this.offerings[t],i=this.resources[t];if(r&&i&&n){n.call(e,r,i);return}var s;if(n){s=this.metaObservers[t];if(s){s.push(n);return}s=this.metaObservers[t]=[n]}$.ajax({url:"/api/v1/store/items/read/"+t,type:"GET",success:function(r){var i=r.data.items||r.data.offerings,o=r.data.resources,u;for(u in i)if(i.hasOwnProperty(u)){var a=i[u],f=a.prices,l;for(l in f)if(f.hasOwnProperty(l)){var c=Money.create(e.currencyList[l],f[l]);f[l]=c}}e.offerings[t]=i,e.resources[t]=o;var h,p=s.length;for(h=0;h<p;h+=1)s[h].call(e,i,o)}})}this.getCurrencyList(r)},getStoreUserItems:function(t,n){var r=this;$.ajax({url:"/api/v1/store/user/items/read/"+t,type:"GET",success:function(t){var i=t.data.userItems;r.userItems=i,n&&n.call(r,i)}})},calculateBasket:function(t){function o(e){var t,n=e.output;for(t in n)if(n.hasOwnProperty(t)&&s[t].type!=="own")return!1;return!0}var n=this.basket,r=n.items;t=t||n.game;var i=this.offerings[t],s=this.resources[t];if(n.game===t){var u=Money.create(this.currency,0),a={},f=this.currency.alphabeticCode,l;for(l in r)if(r.hasOwnProperty(l)){var c=r[l],h=i[l];if(h&&h.available){var p=o(h),d=c.amount;p&&d>1&&(d=1),d>999&&(d=999);var v=h.prices[f],m=v.multiply(d);a[l]={amount:d,price:v,lineTotal:m},u=u.add(m)}}return this.updateBasket(t,a),{items:a,total:u,game:t}}return{items:{},total:Money.create(this.currency,0)}},updateBasket:function(t,n){this.basket={items:n,game:t},JsLocalStore.set("basket",this.basket)},getCurrencyList:function(t){var n=this;if(this.currencyList){t.call(n);return}var r=this.currencyListObservers;if(r){r.push(t);return}r=this.currencyListObservers=[t],$.ajax({url:"/api/v1/store/currency-list",type:"GET",success:function(t){var i=t.data,s;for(s in i)if(i.hasOwnProperty(s)){var o=i[s];i[s]=Currency.create(s,o.numericCode,o.minorUnitPrecision,o.currencyName)}n.currencyList=i,n.currency=i[n.currencyCode];var u,a=r.length;for(u=0;u<a;u+=1)r[u].call(n)}})}},TurbulenzStore.create=function(t){function i(){var e=this,t=this.app.playingGameSlug;this.getStoreMeta(t,function(t,n){var r={},i;for(i in t)if(t.hasOwnProperty(i)){var s=t[i],o,u=r[i]={};for(o in s)s.hasOwnProperty(o)&&o!=="prices"&&(u[o]=s[o]);u.price=s.prices[e.currency.alphabeticCode].toMajorUnit()}Turbulenz.Services.bridge.emit("store.meta.v2",JSON.stringify({currency:e.currency,items:r,offerings:r,resources:n}))})}function s(e){var t=this,n=this.app.playingGameSlug;this.getStoreMeta(n,function(){e&&this.updateBasket(n,JSON.parse(e));var r=this.calculateBasket(n),i=r.items,s={},o;for(o in i)if(i.hasOwnProperty(o)){var u=i[o];s[o]={amount:u.amount,price:u.price.toMajorUnit(),lineTotal:u.lineTotal.toMajorUnit()}}Turbulenz.Services.bridge.emit("basket.site.update",JSON.stringify({currency:t.currency,total:r.total.toMajorUnit(),items:s}))})}function o(e){var t=this,n=this.app.playingGameSlug;this.getStoreMeta(n,function(){var r=null;if(e){var i=JSON.parse(e);this.updateBasket(n,i.basketItems),r=i.token}var s=this.calculateBasket(n),o=s.items,u={},a;for(a in o)if(o.hasOwnProperty(a)){var f=o[a];u[a]={amount:f.amount,price:f.price.toMajorUnit(),lineTotal:f.lineTotal.toMajorUnit()}}Turbulenz.Services.bridge.emit("basket.site.update",JSON.stringify({currency:t.currency,total:s.total.toMajorUnit(),items:u,token:r}))})}var n=new TurbulenzStore;n.app=t,n.basket=JsLocalStore.get("basket")||{items:{}},n.currencyCode="USD",n.defaultCurrencyCode="USD",n.currencyList=null,n.currency=null,n.currencyListObservers=null,n.offerings={},n.resources={},n.metaObservers={};var r=Turbulenz.Services.bridge;return r.addListener("fetch.store.meta",i,n),r.addListener("basket.game.update",s,n),r.addListener("basket.game.update.v2",o,n),r.addListener("basket.test.confirm",n.confirmPurchase,n),n};