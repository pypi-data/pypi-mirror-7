// Copyright (c) 2011-2013 Turbulenz Limited
/*global Turbulenz*//*global $*/function TurbulenzGameNotifications(){}TurbulenzGameNotifications.prototype={pollingCallback:function(){},pollingInterval:null,defaultInterval:5,sendInstantNotification:function(e){var t=e.token;$.ajax({url:"/api/v1/game-notifications/send-instant/"+e.session.gameSlug,type:"POST",data:{data:JSON.stringify({recipient:e.recipient,key:e.key,msg:e.msg})},success:function(e){Turbulenz.Services.bridge.emit("notifications.ingame.sent",{token:t,id:e.id})},error:function(e){var n=e.responseText?JSON.parse(e.responseText).msg:e.statusText;Turbulenz.Services.bridge.emit("notifications.ingame.sent",{token:t,status:e.status,error:n})}})},sendDelayedNotification:function(e){var t=e.token;$.ajax({url:"/api/v1/game-notifications/send-delayed/"+e.session.gameSlug,type:"POST",data:{data:JSON.stringify({key:e.key,time:e.delay,msg:e.msg})},success:function(e){Turbulenz.Services.bridge.emit("notifications.ingame.sent",{token:t,id:e.id})},error:function(e){var n=e.responseText?JSON.parse(e.responseText).msg:e.statusText;Turbulenz.Services.bridge.emit("notifications.ingame.sent",{token:t,status:e.status,error:n})}})},cancelNotificationByID:function(e){$.ajax({url:"/api/v1/game-notifications/cancel-by-id/"+e.session.gameSlug,type:"POST",data:{id:e.id}})},cancelNotificationsByKey:function(e){$.ajax({url:"/api/v1/game-notifications/cancel-by-key/"+e.session.gameSlug,type:"POST",data:{key:e.key}})},cancelAllNotifications:function(e){$.ajax({url:"/api/v1/game-notifications/cancel-all/"+e.session.gameSlug,type:"POST"})},doPolling:function(e){$.ajax({url:"/api/v1/game-notifications/poll/"+e,type:"GET",success:function(e){e=e.data||[];var t=Turbulenz.Services.bridge.emit;for(var n=0,r=e.length;n<r;n+=1)t("notifications.ingame.receive",e[n])}})},isPolling:function(){return!!this.pollingInterval},startPolling:function(e,t,n){this.pollingCallback=t,this.stopPolling(),this.intervalTime=(n||this.defaultInterval)*1e3;var r=this;this.pollingInterval=setInterval(function(){r.doPolling.call(r,e)},this.intervalTime)},stopPolling:function(){clearInterval(this.pollingInterval),this.pollingInterval=null},getNotificationKeys:function(e,t){$.get("/api/v1/game-notifications/keys/read/"+e,function(e){t(e.data?e.data.keys:{})})},onInitManager:function(e){$.post("/api/v1/game-notifications/init-manager/"+e.session.gameSlug)}},TurbulenzGameNotifications.create=function(t){var n=new TurbulenzGameNotifications;n.app=t;var r=Turbulenz.Services.bridge;return r.addListener("notifications.ingame.sendInstant",function(t){n.sendInstantNotification(JSON.parse(t))},n),r.addListener("notifications.ingame.sendDelayed",function(t){n.sendDelayedNotification(JSON.parse(t))},n),r.addListener("notifications.ingame.cancelByID",function(t){n.cancelNotificationByID(JSON.parse(t))},n),r.addListener("notifications.ingame.cancelByKey",function(t){n.cancelNotificationsByKey(JSON.parse(t))},n),r.addListener("notifications.ingame.cancelAll",function(t){n.cancelAllNotifications(JSON.parse(t))},n),r.addListener("notifications.ingame.initNotificationManager",function(t){n.onInitManager(JSON.parse(t))},n),n};