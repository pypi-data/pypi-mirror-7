// Copyright (c) 2011-2012 Turbulenz Limited
/*global Backbone*//*global Templates*//*global window*//*global $*//*jshint nomen: false*//*global _*//*jshint nomen: true*//*exported LocalDeployView*/var LocalDeployView=Backbone.View.extend({el:"body",initialize:function(){return this.app=this.options.app,this.login_template=Templates.local_deploy_login_template,this.select_template=Templates.local_deploy_select_template,this.upload_template=Templates.local_deploy_upload_template,_.bindAll(this,"render","initialiseDeployForms"),this.app.bind("deploy:set",this.setDialogs).bind("deploy:initialise",this.initialiseDeployForms),this},render:function(){return $(this.el).jqoteapp(this.login_template).jqoteapp(this.select_template).jqoteapp(this.upload_template),this},setDialogs:function(){$("#deploy_login_dialog_id").dialog({autoOpen:!1,height:250,width:400,modal:!0,close:function(){$("#deploy_login_id").val("").removeClass("ui-state-error"),$("#deploy_password_id").val("").removeClass("ui-state-error")}}),$("#deploy_select_dialog_id").dialog({autoOpen:!1,height:340,width:500,modal:!0,close:function(){$("#deploy_select_project_id")[0].options.length=0,$("#deploy_new_version_number_id").val("").removeClass("ui-state-error"),$("#deploy_select_version_id").removeAttr("disabled")[0].options.length=0,$("#deploy_new_version_name_id").val("")}}),$("#deploy_upload_dialog_id").dialog({autoOpen:!1,height:150,width:800,modal:!0}),$("#deploy_upload_bar_id").progressbar({value:0})},initialiseDeployForms:function(e){function m(e){var t=[];e=e.toString();while(3<e.length)t.unshift(e.substr(e.length-3)),e=e.substr(0,e.length-3);return 0<e.length&&t.unshift(e),t.join(",")}function g(e){function y(){if(t){clearTimeout(t),t=undefined;var e=c.progressbar("option","value");return e<100?window.confirm("Do you want to cancel the deploy?")?($.ajax({async:!1,type:"POST",data:g,url:u}),!0):(t=setTimeout(n,v),!1):!0}return!1}function b(){if(t){clearTimeout(t),t=undefined;var e=c.progressbar("option","value");return e<100?(window.alert("Cannot interrupt Post-upload processing"),t=setTimeout(r,v),!1):!0}return!1}function w(e){var i=e.data,s=i.uploaded_files,o=i.uploaded_bytes,u=i.total_files,a=i.num_files,f=i.num_bytes,d;u?s?s<u?(d=100*(o/f),h.text("Uploading modified files: "+s+"/"+u),p.text("Uploading bytes: "+m(o)+"/"+m(f))):(d=100,h.text("Uploading finished."),p.text("")):(d=100*(a/u),h.text("Scanning and compressing files: "+a+"/"+u),p.text("Total bytes: "+m(f))):d=0,c.progressbar("option","value",d),d>=100?(h.text(""),p.text(""),clearTimeout(t),t=undefined,$("#deploy_upload_cancel_id").hide(),l.unbind().bind("dialogbeforeclose",b),t=setTimeout(r,500)):u>1e3?t=setTimeout(n,5*v):t=setTimeout(n,v)}function E(e,t){if("timeout"===t)window.alert("The connection to local.turbulenz timed out.");else{var n=JSON.parse(e.responseText),r=n?n.msg:"unknown",i=e.status;500===i?window.alert("Local.turbulenz failed.\n"+r):window.alert("Hub uploading failed.\n"+r)}l.unbind("dialogbeforeclose",y),l.dialog("close")}function S(e){var n=e.data,i=n.processed,s=n.total,o;s?i<s?(o=100*(i/s),h.text("Post-upload processing progress: "+i+"/"+s),p.text("")):(o=100,h.text("Processing finished."),p.text("")):o=0,c.progressbar("option","value",o);if(o>=100){try{window.alert("Deployment complete"+(n.msg?":\n\n"+n.msg:""))}catch(u){window.alert("Deployment complete")}h.text(""),p.text(""),l.unbind("dialogbeforeclose",b),l.dialog("close"),$("#deploy_upload_cancel_id").show()}else s>1e3?t=setTimeout(r,5*v):t=setTimeout(r,v)}function x(e,t){if("timeout"===t)window.alert("The connection to local.turbulenz timed out.");else{var n=JSON.parse(e.responseText),r=n?n.msg:"unknown",i=e.status;500===i?window.alert("Hub failed.\n"+r):window.alert("Hub post-processing failed.\n"+r)}l.unbind("dialogbeforeclose",b),l.dialog("close")}function T(){l.unbind("dialogbeforeclose",y),l.dialog("close")}function N(){return y()&&(h.text(""),p.text(""),l.unbind("dialogbeforeclose",y),l.dialog("close")),!1}function C(e){a.dialog("close");var r=e.data;r&&(g=r,h.text("Scanning files..."),p.text(""),c.progressbar("option","value",0),f.unbind(),$("#deploy_upload_cancel_id").unbind().click(N),l.unbind().dialog("open").bind("dialogbeforeclose",y),t=setTimeout(n,500))}function k(e,t){if("timeout"===t)window.alert("The connection to the Hub timed out.");else{var n=JSON.parse(e.responseText),r=n?n.msg:"unknown",i=e.status;500===i?window.alert("Local.turbulenz is not setup correctly.\n"+r):window.alert("Hub log in details are incorrect.\n"+r)}}var t,n,r,d,g;d="local="+e.local+"&"+e.cookie+"&project="+e.project+"&version="+e.version,e.versiontitle&&(d+="&versiontitle="+e.versiontitle),n=function(){$.ajax({async:!1,type:"POST",data:g,url:s,success:w,error:E})},r=function(){$.ajax({async:!1,type:"POST",data:g,url:o,success:S,error:x})},f.unbind(),f.submit(T),$.ajax({async:!1,timeout:1e4,type:"POST",url:i,data:d,success:C,error:k})}function y(r){function y(){a.dialog("close"),localStorage.removeItem(t),localStorage.removeItem(n)}function b(e){return $("<div/>").html(e).text()}function x(){function e(e,t){var n=e.version.split("."),r=t.version.split(".");for(var i=0;n[i]&&r[i];i+=1){var s=n[i],o=r[i];if(s!==o){var u=Number(s),a=Number(o);return isNaN(u)||isNaN(a)?n[i]<r[i]?1:-1:a-u}}return r.length-n.length}m.length=0;var t=h.find("option:selected").index();o=i[t];var n=o.versions,r,s,u,a;if(n){r=n.length,1<r&&n.sort(e);for(a=0;a<r;a+=1)s=n[a],u=s.version,p.append($("<option></option>").attr("value",u).attr("title",s.title||"").text(u))}var f=o.locked_versions;if(f){r=f.length,1<r&&f.sort(e);for(a=0;a<r;a+=1)s=f[a],u=s.version,p.append($("<option></option>").attr("disabled","disabled").attr("value",u).text(u+" (locked)"))}p.prepend($("<option></option>").attr("value","").text("Create new version"))}function T(){var e=p.find("option:selected");e.val()?(u.css({opacity:"0.5"}),f.val("").attr("disabled",!0),c.val(e.attr("title")).attr("disabled",!0)):(u.css({opacity:"1"}),f.val("").removeAttr("disabled"),c.val("").removeAttr("disabled"))}var i=r.projects,s=i?i.length:0,o=null,u=$(".deploy_new_version"),f=$("#deploy_new_version_number_id"),c=$("#deploy_new_version_name_id"),h=$("#deploy_select_project_id"),p=$("#deploy_select_version_id"),v=h[0].options,m=p[0].options;if(s<1){window.alert("This user has no projects on Hub that you can deploy to."),y();return}s>1&&(i[0].modified?i.sort(function(e,t){return t.modified-e.modified}):i.sort(function(e,t){return t.created-e.created}));for(var w=0;w<s;w+=1){var E=i[w],S=new Option(b(E.title),E.slug);v[v.length]=S,w===0&&p.val(E.slug)}x(),T(),h.unbind().change(x),p.unbind().change(T),a.dialog("open"),$("#deploy_select_form_id").unbind().submit(function(t){t.preventDefault(),f.removeClass("ui-state-error"),c.removeClass("ui-state-error");var r=$.trim(f.val());if(r){if(!d.test(r))return f.addClass("ui-state-error"),!1;var i=o.locked_versions,s,u;for(s=0,u=i.length;s<u;s+=1)if(i[s].version===r)return window.alert("The selected version "+r+" already exists on this project and is locked"),!1;i=o.versions;for(s=0,u=i.length;s<u;s+=1)if(i[s].version===r&&!window.confirm("The selected version "+r+" already exists on this project.\n"+"Do you really want to overwrite it?"))return!1}else{r=p.val();if(!r)return f.addClass("ui-state-error"),!1}return l.dialog("option","title","Deploying "+e+" to "+r),g({version:r,versiontitle:$.trim(c.val()),project:o.slug,cookie:localStorage.getItem(n),local:e}),!1}),$("#logout_button_id").unbind().click(y),$("#hub_username").text(r.user)}function b(){var e=$("#deploy_login_dialog_id").dialog("open");e.unbind().submit(function(i){i.preventDefault();var s=$("#deploy_login_id").removeClass("ui-state-error"),o=$("#deploy_password_id").removeClass("ui-state-error"),u=$("#login_error").hide(),a=$.trim(s.val()),f=$.trim(o.val()),l=!!$("#rememberme").attr("checked"),c=!0;a||(s.addClass("ui-state-error"),c=!1),f||(o.addClass("ui-state-error"),c=!1);if(c){var h=$("body").css("cursor","wait");$.ajax({type:"POST",url:r.get("deploy-login"),data:{login:a,password:f,rememberme:l},success:function(r){localStorage.setItem(n,r.cookie),l?localStorage.setItem(t,!0):localStorage.removeItem(t),y(r),e.dialog("close")},error:function(t,n){n==="timeout"?window.alert("The connection to the Hub timed out."):t.status===500?window.alert("Connection to the Hub failed. Please try again later"):(s.addClass("ui-state-error"),o.addClass("ui-state-error"),u.show())},complete:function(){h.css("cursor","auto")}})}return!1})}function w(){var e=$("body").css("cursor","wait");$.ajax({type:"POST",url:r.get("deploy-try-login"),data:{cookie:localStorage.getItem(n)},success:y,error:function(e,n){n==="timeout"?window.alert("The connection to the Hub timed out."):e.status===500?window.alert("Connection to the Hub failed. Please try again later"):(localStorage.removeItem(t),b())},complete:function(){e.css("cursor","auto")}})}var t="deployrememberme",n="hubcookie",r=this.app.router;localStorage.getItem(t)||localStorage.removeItem(n);var i=r.get("deploy-start"),s=r.get("deploy-progress"),o=r.get("deploy-postupload-progress"),u=r.get("deploy-cancel"),a=$("#deploy_select_dialog_id"),f=$("#deploy_upload_form_id"),l=$("#deploy_upload_dialog_id"),c=$("#deploy_upload_bar_id"),h=$("#deploy_upload_files_counter_id"),p=$("#deploy_upload_bytes_counter_id"),d=new RegExp("^[a-z0-9]+[a-z0-9-\\.]*$"),v=100;localStorage.getItem(t)?w():b()}});