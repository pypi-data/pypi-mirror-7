// Copyright (c) 2011-2012 Turbulenz Limited
/*global Backbone*//*global Templates*//*global window*//*global alert*//*jshint nomen: false*//*global _*//*global $*//*jshint nomen: true*//*exported LocalUserdataView*/var LocalUserdataView=Backbone.View.extend({el:"#details",userData:[],users:[],lastSortKey:null,lastSortReverse:!0,urls:{},slug:"",initialize:function(){return this.app=this.options.app,this.template=Templates.local_userdata_template,_.bindAll(this,"render"),this.app.bind("game:userdata",this.render),this.skeyPattern=new RegExp("sort-([a-zA-Z-]+)"),this},render:function(t,n){var r=this.app.router,i=r.get("userdata-overview",{slug:t}),s=this;return $.get(i,function(e){var t=e.data;$(s.el).jqotesub(s.template,t);if(t.userdata){s.slug=t.slug,$("#users\\:").nextAll().remove();if(n){var o=r.get("userdata-keys",{slug:s.slug,username:n});s.getData(o,n)}else s.getData(i,"")}$("#userdata-form .directoryPaths").unbind("click").bind("click",function(){$(this).nextAll().remove();var e=document.location.hash,t=e.split("/"),n=t[1],r=t[2],i=$(this).attr("id");i=i.substring("users:".length).replace(/:/g,"/");var s=i.length;return i=i.slice(0,s-1),i?document.location.hash="/"+n+"/"+r+"/"+i:document.location.hash="/"+n+"/"+r,!1}),$("#userdata-form .text-file").unbind("click").bind("click",function(){var e=$(this).attr("href");return window.open(e,"_parent"),!1})}),this},shortenName:function(t){return t.length>30?"..."+t.substring(t.length-30):t},sortData:function(t,n,r){var i=function(e,t){return t=t?-1:1,function(n,r){return n=n[e],r=r[e],n<r?t*-1:n>r?t*1:0}};return t.sort(i(n,r))},getSizeStr:function(t){var n=1048576,r=1024;if(t>=n){var i=t/n-.05;return i.toFixed(1)+"MB"}if(t>=r){var s=t/r-.05;return s.toFixed(1)+"KB"}return t+"B"},returnAssetList:function(t,n){var r=this.app.router,i=this,s,o="";if(n){var u="",a=n.split("/"),f=$(".session-header ul:first");$("#users\\:").nextAll().remove();var l="users:";for(s=0;s<a.length;s+=1)l+=a[s]+":",u+='<li class="button left directoryPaths" id="'+l+'"><div class="right">',u+='<div class="middle">'+a[s]+"</div></div></li>";f.append(u)}for(s=0;s<t.length;s+=1){var c=t[s],h=c.assetName,p=r.get("userdata-as-text",{slug:i.slug,username:n,key:h});o+="<tr><td>",o+='<a href="'+p+'" class="text-file">'+i.shortenName(h)+"</a>",o+="</td><td>"+i.getSizeStr(c.size)+"</td><td>";if(c.isJson){var d=r.get("disassemble-app",{slug:i.slug,asset:n+"/"+h});o+='<a href="'+d+'?userdata=1">Disassemble</a>'}else o+="-";o+="</td></tr>"}return o},returnUserList:function(t){var n=this,r=t,i=r.length,s,o="";for(s=0;s<i;s+=1){var u=r[s],a=n.shortenName(u);o+="<tr><td>",o+='<a title="'+u+'" class="directory" id="'+u+'">'+a+"</a>",o+="</td><td>-</td><td>-</td></tr>"}return o},displayData:function(t){var n=$("tbody"),r;t?r=this.returnAssetList(this.userData,t):r=this.returnUserList(this.users),n.html(r),$(".details-table").find("tr:even").addClass("stripe"),$("#userdata-form .directory").unbind("click").bind("click",function(){var e=$(this).attr("id");return document.location.hash=document.location.hash+"/"+e,!1})},getData:function(t,n){var r=this;$.ajax({url:t,dataType:"json",async:!1,success:function(e){var t;if(n){t=[];var i=e.data;for(var s in i)i.hasOwnProperty(s)&&t.push(i[s]);r.userData=t}else t=e.data.users,r.users=t;r.lastSortKey&&r.sortData(t,r.lastSortKey,r.lastSortReverse),r.displayData(n),$(".sort-controller th").unbind("click"),$(".button").unbind("hover"),$(".sort-controller th").click(function(){var e=$(this).attr("class");e&&(e=e.match(r.skeyPattern)[1],r.lastSortKey=e);var i=$(this).find("span");i.hasClass("active")?(r.sortData(t,e,!0),r.displayData(n),r.lastSortReverse=!0,i.removeClass("active").addClass("active-reverse")):(r.sortData(t,e,!1),r.displayData(n),r.lastSortReverse=!1,$(this).siblings().find("span").removeClass("active").removeClass("active-reverse"),i.removeClass("active-reverse").addClass("active"))}),$(".button").hover(function(){$(this).addClass("hover-target")},function(){$(this).removeClass("hover-target")})},error:function(e){if(e.status!==200){var t=e.responseText;alert(t)}}})}});