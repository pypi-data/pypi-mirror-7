// Copyright (c) 2011-2012 Turbulenz Limited
/*global Backbone*//*global Templates*//*global window*//*jshint nomen: false*//*global _*//*global $*//*global alert*//*jshint nomen: true*//*exported LocalEditView*/var LocalEditView=Backbone.View.extend({el:"#details",globalUrls:{},initialize:function(){return this.app=this.options.app,this.template=Templates.local_edit_game_template,this.directory_options_template=Templates.local_directory_options_template,_.bindAll(this,"render"),this.app.bind("game:edit",this.render),this.SLUG_PATTERN=new RegExp("^[a-z0-9]+[a-z0-9-]*$"),this.ENGINE_VERSION_PATTERN=new RegExp("^(\\d+\\.)(\\d+)$"),this.ASPECT_RATIO_PATTERN=new RegExp("^(?=.*[1-9])\\d+(\\.\\d+)?:(?=.*[1-9])\\d+(\\.\\d+)?$"),this},setUrls:function(t){var n=this.app.router,r=this.globalUrls;r.url=n.get("edit-overview",{slug:t}),r.saveGameUrl=n.get("edit-save",{slug:t}),r.deleteGameUrl=n.get("edit-delete",{slug:t}),r.loadGameUrl=n.get("edit-load",{slug:t}),r.dirOptionsUrl=n.get("edit-directory-options",{slug:t}),r.createSlugUrl=n.get("edit-create-slug",{slug:t})},render:function(t){this.app.setCurrentView(this),this.setUrls(t);var n=this.globalUrls,r=this;return $.get(n.url,function(e){$(r.el).jqotesub(r.template,{data:e.data,saveUrl:n.saveGameUrl,deleteUrl:n.deleteGameUrl}),r.setPage(t)}),this},preLeave:function(){if(!this.edited)return!0;var t=window.location.hash.split("/");return t.length>1&&t[1]==="edit"?!1:window.confirm("This page contains unsaved changes. Are you sure you want to discard them?")?(this.edited=!1,!0):!1},getDeployFilesString:function(){var t="";return $("#deploy_files_id option").each(function(){t+=$.trim($(this).val())}),t},resetOldValues:function(){$(".validate").each(function(){$(this)[0].oldValue=$.trim($(this).val())}),$("#deploy_files_id")[0].oldValue=this.getDeployFilesString()},sanitize:function(t){var n=0;t=$.trim(t);while(t.slice(-1)==="/"||t.slice(-1)==="\\"){t=$.trim(t.slice(0,-1));if(n>1e3)break}return t},delayed:function(t,n){typeof n=="undefined"&&(n=1e3);var r=0;return function(e){clearTimeout(r),r=setTimeout(function(){t(e)},n)}},slugHasCorrectFormat:function(){return this.SLUG_PATTERN.test($("#slug_id").val())},updateSlugField:function(t){var n=this.globalUrls.createSlugUrl,r=this,i={title:t};$.get(n,i,function(e){$("#slug_id").val(e.data),$("#slug_message").html("* Note: slug has been automatically updated."),$("#slug_error").html(e.message),r.finishFieldChange()})},engineVersionHasCorrectFormat:function(){return this.ENGINE_VERSION_PATTERN.test($("#engine_version_id").val())},aspectRatioHasCorrectFormat:function(){return this.ASPECT_RATIO_PATTERN.test($("#aspect_ratio_id").val())},showBusyIcon:function(t){$(t).closest(".field").find(".status-icon").addClass("busy")},hideStatusIcon:function(t){$(t).closest(".field").removeClass("complete").removeClass("incorrect")},hideBusyIcon:function(t){$(t).closest(".field").find(".status-icon").removeClass("busy")},markFieldCorrect:function(t){$(t).closest(".field").removeClass("incorrect").addClass("correct")},markFieldError:function(t){$(t).closest(".field").removeClass("complete").addClass("incorrect")},hideDirectoryOptions:function(t){var n=$("#directory-options");n.empty(),n.removeClass("enabled"),t&&($("#path_id").removeClass("unlocked").attr("disabled","disabled"),$("#lock_id").removeClass("unlocked").attr("value","locked"))},showFieldsets:function(t){t?$("#edit-form fieldset").not("#directory-fieldset").addClass("enabled"):$("#edit-form fieldset").not("#directory-fieldset").removeClass("enabled")},checkPath:function(){var t=this;$("#path_error").remove();var n=$("#path_id").val();if(this.sanitize(n)===""||n===$("#path_id")[0].oldValue)t.hideDirectoryOptions(!1),t.hideBusyIcon($("#path_id"));else{var r=this.globalUrls.dirOptionsUrl,i={dir:n};$.get(r,i,function(e){var n=$("#directory-options");$("#directory-options").jqotesub(t.directory_options_template,e),$("#directory-fieldset").addClass("complete"),$("#confirm-path").click(function(){return t.saveGame(),!1}),$("#use-data").click(function(){return t.loadGame(),!1}),$("#overwrite-data").click(function(){return t.saveGame(),!1}),$("#create-path").click(function(){return t.saveGame(),!1}),n.addClass("enabled")})}},startFieldChange:function(t){var n=this;this.hideStatusIcon(t),$(t).attr("id")==="path_id"?n.checkPath():$(t).attr("id")==="title_id"?$.trim($(t).val())!==$.trim($(t)[0].oldValue)?$("#slug_id").hasClass("edited")||(n.updateSlugField($(t).val()),n.hideBusyIcon($(t))):($("#slug_id").val($("#slug_id")[0].oldValue),n.hideBusyIcon($("#slug_id"))):$(t).attr("id")==="slug_id"&&($("#slug_id").addClass("edited"),$("#slug_message").empty()),this.finishFieldChange(),this.hideBusyIcon(t)},finishFieldChange:function(){var t=!1,n=this;this.sanitize($("#slug_id").val())!==""&&this.slugHasCorrectFormat()?$(".validate").each(function(){var e=$(this),r;e.attr("id")==="deploy_files_id"?r=n.getDeployFilesString():r=e.val(),r!==e[0].oldValue&&(t=!0,n.hideStatusIcon(e),n.markFieldCorrect(e))}):(n.markFieldError("#slug_id"),$("#slug_id").removeClass("edited")),this.engineVersionHasCorrectFormat()||(n.markFieldError($("#engine_version_id")),t=!1),this.aspectRatioHasCorrectFormat()||(n.markFieldError($("#aspect_ratio_id")),t=!1),this.setEdited(t)},updatePage:function(t){if(t.ok){var n=$("#slug_id")[0].oldValue,r=t.data.slug;$("#"+n).attr("id",r),$("#"+r).removeClass("Temporary"),$("#"+r+" > div.game-box > h2").html(t.data.title),this.app.trigger("game:refresh","#"+r),this.resetOldValues()}else window.alert("Page could not be updated: \n")},saveGame:function(){var t=this;$("#deploy_files_id option").attr("selected","selected");var n={path:this.sanitize($("#path_id").val()),title:this.sanitize($("#title_id").val()),slug:this.sanitize($("#slug_id").val()),plugin_main:$("#plugin_main_text").val(),canvas_main:$("#canvas_main_text").val(),mapping_table:$("#mapping_table_text").val(),deploy_files:$("#deploy_files_id").val(),engine_version:$("#engine_version_id").val(),is_multiplayer:$("#is_multiplayer_id").val(),aspect_ratio:$("#aspect_ratio_id").val()};n.deploy_files&&(n.deploy_files=n.deploy_files.join("\n"));var r=n.slug;r!==""?$.ajax({url:t.globalUrls.saveGameUrl,data:n,type:"POST",success:function(n){if(n.ok){$("#directory-fieldset").hasClass("complete")&&(t.hideDirectoryOptions(!0),t.showFieldsets(!0),t.setEdited(!1));var r=n.data.slug;t.app.carousel.setActionButtons(r),document.location.hash="/edit/"+r,t.updatePage(n)}else window.alert(n.msg)},error:function(t){if(t.status!==200){var n=t.responseText,r=JSON.parse(n);alert(r.msg)}}}):window.alert("Slug cannot be empty!")},loadGame:function(){var t=this,n={path:t.sanitize($("#path_id").val())};$.get(this.globalUrls.loadGameUrl,n,function(e){$("#directory-fieldset").hasClass("complete")&&(t.hideDirectoryOptions(!0),t.showFieldsets(!0),t.setEdited(!1));var n=e.data.slug;t.app.carousel.setActionButtons(n),document.location.hash="/edit/"+n,t.updatePage(e)})},deleteGame:function(t,n,r){var i=this,s;return n?s=this.app.router.get("edit-delete",{slug:n}):s=this.globalUrls.deleteGameUrl,t===undefined&&(t=!0),(!t||window.confirm("This deletes the game from the games-list. \n\nLocal game files still need to be removed manually.\n\nDo you want to proceed?","xyz"))&&$.ajax({url:s,async:!1,type:"GET",success:function(){r||(i.app.trigger("carousel:make"),i.app.trigger("carousel:refresh"),i.app.trigger("carousel:collapse"))}}),!1},setSaveButton:function(t){t?$(".save").addClass("enabled"):$(".save").removeClass("enabled")},setEdited:function(t){t===null&&(t=!1),this.edited=t,this.setSaveButton(t)},setPage:function(){var t=this;try{$("#path_id").focus()}catch(n){}this.resetOldValues(),$(".validate").keyup(function(){t.showBusyIcon(this)}),$(".validate").keyup(this.delayed(function(e){t.startFieldChange($(e.target))},1e3)),$(".save").click(function(){return $(this).hasClass("enabled")&&t.saveGame(),!1}),$(".delete").click(function(){return t.deleteGame(),!1}),$("#lock_id").click(function(){$(this).val()==="locked"&&($(this).val("unlocked"),$(this).addClass("unlocked"),$("#path_id").addClass("unlocked"),$("#path_id").removeAttr("disabled"))}),this.setEdited(!1),$("#plugin_main_id").change(function(){var e=$(this).val().split("\\"),n=e[e.length-1];$("#plugin_main_text").val(n),$("#plugin_main_opt").replaceWith('<option id="plugin_main_opt" value="'+n+'">'+n+"</option>"),t.finishFieldChange()}),$("#plugin_main_text").change(function(){$("#plugin_main_opt").replaceWith('<option id="plugin_main_opt" value="'+$(this).val()+'">'+$(this).val()+"</option>"),t.finishFieldChange()}),$("#canvas_main_id").change(function(){var e=$(this).val().split("\\"),n=e[e.length-1];$("#canvas_main_text").val(n),$("#canvas_main_opt").replaceWith('<option id="canvas_main_opt" value="'+n+'">'+n+"</option>"),t.finishFieldChange()}),$("#canvas_main_text").change(function(){$("#canvas_main_opt").replaceWith('<option id="canvas_main_opt" value="'+$(this).val()+'">'+$(this).val()+"</option>"),t.finishFieldChange()}),$("#mapping_table_id").change(function(){var e=$(this).val().split("\\"),n=e[e.length-1];$("#mapping_table_text").val(n),$("#mapping_table_opt").replaceWith('<option id="mapping_table_opt" value="'+n+'">'+n+"</option>"),t.finishFieldChange()}),$("#mapping_table_text").change(function(){$("#mapping_table_opt").replaceWith('<option id="mapping_table_opt" value="'+$(this).val()+'">'+$(this).val()+"</option>"),t.finishFieldChange()});var r=$("#deploy_file_pattern_id"),i=null;r.keyup(function(e){i=e.keyCode?e.keyCode:e.which;if(i===13||i===10){var t=!1;$("#deploy_files_id option").each(function(){$(this).val()===r.val()&&(t=!0)}),r.val()!==""&&t===!1&&($("#deploy_files_id").append('<option value="'+r.val()+'">'+r.val()+"</option>"),e.preventDefault(),$("#deploy_file_pattern_id").val(""))}}),$("#deploy_files_id").keyup(function(e){i=e.keyCode?e.keyCode:e.which;var t=$("#deploy_files_id option:selected"),n=t.val()!==$("#plugin_main_text").val(),r=t.val()!==$("#canvas_main_text").val(),s=t.val()!==$("#mapping_table_text").val();i===46&&n&&r&&s&&($("#deploy_files_id option:selected").remove(),e.preventDefault())}),$("#is_multiplayer_id").change(function(){t.finishFieldChange()}),this.engineVersionHasCorrectFormat()||t.markFieldError($("#engine_version_id")),this.aspectRatioHasCorrectFormat()||t.markFieldError($("#aspect_ratio_id"))}});