// Copyright (c) 2010-2012 Turbulenz Limited
/*global Backbone*//*global Templates*//*global ResourceCategory*//*global SummaryBar*//*jshint nomen: false*//*global _*//*global $*//*jshint nomen: true*//*exported LocalMetricsView*/var LocalMetricsView=Backbone.View.extend({el:"#details",mimetypeData:{},inverseMapping:{},sessionData:{},staticFileUrl:"",slug:"",initialize:function(){return this.app=this.options.app,this.template=Templates.local_metrics_template,this.files_header_template=Templates.local_metrics_files_header_template,this.files_details_template=Templates.local_metrics_files_details_template,this.assets_header_template=Templates.local_metrics_assets_header_template,this.assets_details_template=Templates.local_metrics_assets_details_template,this.mimetypes_header_template=Templates.local_metrics_mimetypes_header_template,this.mimetypes_details_template=Templates.local_metrics_mimetypes_details_template,_.bindAll(this,"render","initializePage","getDetails"),this.app.bind("game:metrics",this.render),this.skeyPattern=new RegExp("sort-([a-zA-Z-]+)"),this},render:function(e){var t=this.app.router.get("metrics-overview",{slug:e}),n=this;return this.slug=e,$.get(t,function(t){t=t.data,t.sessions.length>1e3&&(t.sessions=t.sessions.slice(0,1e3),t.warning="+1000 metrics-sessions found. Please delete some sessions from localdata/metrics/"+e+" folder."),$(n.el).jqotesub(n.template,t);var r="play/"+e+"/"+t.mappingTable;n.initializePage(r),$("#metrics-form>ul>li.session:first>.session-header>.session-title").click()}),this},sortData:function(t,n,r){var i=function(e,t){return t=t?-1:1,function(n,r){return n=n[e]===undefined?n.data[e]:n[e],r=r[e]===undefined?r.data[e]:r[e],n<r?t*-1:n>r?t*1:0}};return t.sort(i(n,r))},isEmpty:function(t){for(var n in t)if(t.hasOwnProperty(n))return!1;return!0},getSizeStr:function(t){var n;return t>1024?n=((t-t%1024)/1024).toString()+"KB":n=t.toString()+"B",n},groupData:function(t){var n=this.sortData(t,"assetName",!1),r=[];r[0]={data:n[0]},r[0].numRequest=1;var i=0;for(var s=1;s<n.length;s+=1)n[s].assetName===r[i].data.assetName?r[i].numRequest+=1:(i+=1,r[i]={data:n[s]},r[i].numRequest=1);return r},groupByType:function(t){var n=this.sortData(t,"type",!1),r=[],i={data:n[0]};r[0]=i,i.numFiles=1,i.totalSize=n[0].size,i.numRequest=1;var s=0;for(var o=1;o<n.length;o+=1){var u=n[o];u.type===i.data.type?(i.numFiles+=1,i.numRequest+=1,i.totalSize+=u.size):(s+=1,i={data:u},r[s]=i,i.numFiles=1,i.numRequest=1,i.totalSize=u.size)}for(o=0;o<r.length;o+=1)r[o].totalSizeStr=this.getSizeStr(r[o].totalSize);return r},getDetails:function(t,n,r){var i=this.sessionData,s=this,o=this.slug,u=this.app.router.get("metrics-details",{slug:o,timestamp:n});$.getJSON(u,{},function(e){var o=e.data.entries;for(var u=0;u<o.length;u+=1){var a=o[u];a.size=parseInt(a.size,10),a.sizeStr=s.getSizeStr(a.size);var f=a.file.replace("staticmax/","");a.assetName=s.inverseMapping[f]||a.file}i[n]=s.groupData(o),s.mimetypeData[n]=s.groupByType(o),r.call(s,t,!0,!1,n)})},resourceCategories:{".html":new ResourceCategory("html","HTML","#800080"),".css":new ResourceCategory("css","Stylesheets","#ffff00"),".js":new ResourceCategory("js","Scripts","#800000"),".tzjs":new ResourceCategory("tzjs","Application","#ff0000"),".json":new ResourceCategory("json","JSON","#808080"),".cgfx":new ResourceCategory("cgfx","Shaders","#00ff00"),".tar":new ResourceCategory("tar","Archives","#808000"),".dae":new ResourceCategory("dae","COLLADA","#c0c0c0"),".png":new ResourceCategory("png","PNG","#008000"),".jpg":new ResourceCategory("jpg","JPEG","#00ffff"),".tga":new ResourceCategory("tga","TGA","#008080"),".dds":new ResourceCategory("dds","DDS","#0000ff"),".ktx":new ResourceCategory("ktx","KTX","#0000ff"),".ogg":new ResourceCategory("ogg","OGG","#000080"),".wav":new ResourceCategory("wav","WAV","#ff00ff"),other:new ResourceCategory("other","Other","#ffffff"),unknown:new ResourceCategory("unknown","Unknown","rgb(0,0,0)")},createAssetSummary:function(t,n){var r=this,i=function(e){var t=0,n={},i=e.length;for(var s=0;s<i;s+=1){var o=e[s],u=o.value;if(typeof u=="undefined")continue;o.name in n||(o.name in r.resourceCategories?n[o.name]=0:(o.name="other","other"in n||(n.other=0))),n[o.name]+=u,t+=u}return{categoryValues:n,total:t}},s=function(e){return Number.bytesToString(e)},o=[];for(var u=0;u<t.length;u+=1)o[u]={name:t[u].data.ext,value:t[u].totalSize};var a=new SummaryBar(this.resourceCategories);a.element.id="resources-summary";var f=document.getElementById("summary-container-"+n);f.appendChild(a.element),a.update(o,i,s)},displayData:function(t,n,r,i){var s=this.skeyPattern,o=$(t).parent().parent().find("div.details-table"),u=$(t).attr("class").match(s)[1],a=this.mimetypeData[i],f=this.sessionData[i],l=this,c=this.slug;if($(t).hasClass("active")&&!n)$(t).removeClass("active"),o.empty();else{$(t).siblings().removeClass("active"),$(t).addClass("active");var h=this.sortData(f,u,r),p=this.sortData(a,u,r),d=i.replace(".","\\.");$(t).hasClass("files-header")?(o.jqotesub(l.files_header_template),$("#"+d+" ~ .details-table").children("table").children("tbody").jqoteapp(l.files_details_template,{sessionDataDict:h,slug:c,timestamp:i})):$(t).hasClass("assets-header")?(o.jqotesub(l.assets_header_template,i),$("#"+d+" ~ .details-table").children("table").children("tbody").jqoteapp(l.assets_details_template,p)):$(t).hasClass("mimetypes-header")&&(o.jqotesub(l.mimetypes_header_template),$("#"+d+" ~ .details-table").children("table").children("tbody").jqoteapp(l.mimetypes_details_template,p)),o.find("tr:even").addClass("stripe");var v=$(t).parent().parent().find(".sort-controller");r?v.find("span").filter(function(){return $(this).parent().attr("class").match(s)[1]===u}).addClass("active-reverse"):v.find("span").filter(function(){return $(this).parent().attr("class").match(s)[1]===u}).addClass("active"),v.find("th").click(function(){var e=$(t).attr("class").split(" "),n=e.length;for(var r=0;r<n;r+=1)e[r].indexOf("sort-")===0&&$(t).removeClass(e[r]);$(t).addClass($(this).attr("class").match(s)[0]),$(this).find("span").hasClass("active")?l.displayData(t,!0,!0,i):l.displayData(t,!0,!1,i),$(t).hasClass("assets-header")&&l.createAssetSummary(p,i)})}},initializePage:function(t){function i(e,t,n,i){r.displayData(e,t,n,i),$(e).hasClass("active")&&r.createAssetSummary(r.mimetypeData[i],i)}var n=this.sessionData,r=this;$.get(t,function(e){var t=r.inverseMapping;if(r.isEmpty(t)&&e){var n=e.urnmapping||e.urnremapping||{};for(var i in n)n.hasOwnProperty(i)&&(t[r.staticFileUrl+n[i]]=i)}}),$(".session-title").unbind("click").bind("click",function(){var e=$(this).parents(".session");return $(this).hasClass("active")?(e.removeClass("active"),e.find(".active").removeClass("active"),e.find(".details-table").empty()):(e.addClass("active"),$(this).addClass("active")),!1}),$(".files-header").unbind("click").bind("click",function(){var e=$(this).parent().attr("id");return n[e]?r.displayData(this,!1,!1,e):r.getDetails(this,e,r.displayData),!1}),$(".assets-header").unbind("click").bind("click",function(){var e=$(this).parent().attr("id"),t=r.mimetypeData[e];return t?i(this,!1,!1,e):r.getDetails(this,e,i),!1}),$(".mimetypes-header").unbind("click").bind("click",function(){var e=$(this).parent().attr("id"),t=r.mimetypeData[e];return t?r.displayData(this,!1,!1,e):r.getDetails(this,e,r.displayData),!1}),$(".button.delete").unbind("click").bind("click",function(){var e=$(this).parent().parent().parent(),t=$(this).find("a").attr("href");return $.get(t,function(){e.remove(),$(".session").length===0&&($(".empty").show(),$("#delete-all, .cap").hide())}),!1}),$(".button").hover(function(){$(this).addClass("hover-target")},function(){$(this).removeClass("hover-target")}),$("#delete-all").unbind("click").bind("click",function(){return $(".session").each(function(){var e=$(this).find(".delete a").attr("href"),t=$(this);$.get(e,function(){t.remove(),$(".session").length===0&&($(".empty").show(),$("#delete-all, .cap").hide())})}),!1})}});