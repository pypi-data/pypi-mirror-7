// Copyright (c) 2011-2013 Turbulenz Limited
/*global Backbone*//*global Templates*//*global PluginDetection*//*global Turbulenz*//*global TurbulenzEngine: true*//*global window*//*global console*//*jshint nomen: false*//*global $*//*global _*//*jshint nomen: true*//*exported LocalPlayView*/var LocalPlayView=Backbone.View.extend({el:"#details",initialize:function(){this.app=this.options.app,this.engine=this.options.engine,this.template=Templates.local_play_template,this.no_plugin_template=Templates.local_no_plugin_template,this.versions=null,_.bindAll(this,"render","playOn");var e=this;return this.app.bind("game:play",e.playOn),this.app.bind("game:stop",function(){e.playOff()}),this.app.bind("game:versions",function(t){e.render(t)}),this},getVersions:function(e,t){var n=this,r=this.app.router.get("play-versions",{slug:e});$.get(r,function(e){var r={};n.versions=r,$.each(e.data.versions,function(e,t){r[t.title]=t}),t(e)})},render:function(e){var t=this;return this.getVersions(e,function(e){$(t.el).jqotesub(t.template,e.data),$("#playable-versions").find("tr:odd").addClass("stripe")}),this},tearDownPlugin:function(){var e=$("#game_player_frame").contents(),t=$("#turbulenz_game_loader_object",e);0===t.length&&(t=$("embed[name=plugin]",e));if(t.length>0){var n=t[0];try{n.unloadEngine()}catch(r){}}var i;window.game&&window.game.TurbulenzEngine?i=window.game.TurbulenzEngine:i=window.TurbulenzEngine,i&&i.unload&&(i.unload(),window.TurbulenzEngine=null,window.WebGLTurbulenzEngine=null),window.game=null,window.gameSlug=null,Turbulenz.Data.mode=null},playFlashGame:function(e,t,n){window.gameSlug=e,Turbulenz.Data.mode="flash";var r=this.versions[t].flash,i=r?r.vars:null;i||(i={}),i.useragent=navigator.userAgent,i.uid=(new Date).getTime().toString(16),i.sessionVersion=i.uid,i.gameSlug=e;var s=r?r.params:null;s||(s={}),$('<script type="text/javascript">var swfVersionStr = "11.0";var xiSwfUrlStr = "/static/flash/playerProductInstall.swf";var flashvars = '+JSON.stringify(i)+";"+"var params = "+JSON.stringify(s)+";"+"var attributes = {"+'id: "turbulenz_game_engine_object"'+"};"+'swfobject.embedSWF("'+n+'",'+'"turbulenz_game_flash_container",'+'"100%", "100%",'+"swfVersionStr, xiSwfUrlStr,"+"flashvars, params, attributes);"+"</script>"+'<div id="turbulenz_game_flash_container"></div>').appendTo("#game_player");var o=this;$(function(){var e=$("#turbulenz_game_engine_object")[0];window.game=e,window.TurbulenzEngine=e,window.onbeforeunload=o.tearDownPlugin})},playOn:function(e,t){var n=this,r=this.app,i=document.location.hash,s=i.slice(1);$("#header").hide(),$("#content").hide(),$("#game_player").show();var o=PluginDetection.getPlugins();if(navigator.appName==="Microsoft Internet Explorer"&&t.search(/\.tzjs/)>0){window.alert("Sorry, but tzjs files do not run in Internet Explorer on the local server.");return}var u=navigator.userAgent;if(-1!==u.indexOf("Android")&&t.search(/\.tzjs/)>0){window.location.href="/play/"+e+"/"+t;return}if(-1!==u.indexOf("Safari/")&&-1!==u.indexOf("Mobile/")&&t.search(/\.tzjs/)>0){window.location.href="tblz://"+window.location.host+"/play/"+e+"/"+t;return}if($("#game_player_frame").length||window.game!==null)this.tearDownPlugin(),$("#game_player_frame").remove();if(t.search(/\.swf/)>0)this.versions?this.playFlashGame(e,t,s):this.getVersions(e,function(){n.playFlashGame(e,t,s)});else if(t.search(/\.canvas/)<0&&!o.turbulenz.supported)$("#game_player").jqoteapp(this.no_plugin_template,{engine:this.engine});else if(t.search(/\.canvas\.js/)>0)$(function(){window.gameSlug=e,Turbulenz.Data.mode="canvas",$('<div style="overflow: hidden; height: 100%;"><canvas id="turbulenz_game_engine_canvas" moz-opaque="true" tabindex="1">Sorry, but your browser does not support WebGL or does not have it enabled.To get a WebGL-enabled browser, please see:<br/><a href="http://www.khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" target="_blank">Getting a WebGL Implementation</a></canvas></div>').appendTo("#game_player");var t=["webgl","experimental-webgl"],r=null,i=document.createElement("canvas");document.body.appendChild(i);for(var o=0;o<t.length;o+=1){try{r=i.getContext(t[o])}catch(u){}if(r)break}r||window.alert("Sorry, but your browser does not support WebGL or does not have it enabled."),document.body.removeChild(i);var a=$("#turbulenz_game_engine_canvas")[0];if(r&&a){window.TurbulenzEngine={};var f=function(){if(a.getContext&&window.WebGLTurbulenzEngine&&TurbulenzEngine){var t=TurbulenzEngine.onload,n=TurbulenzEngine.onunload;if(!t){window.alert("TurbulenzEngine.onload has not been set");return}TurbulenzEngine=window.WebGLTurbulenzEngine.create({canvas:a,fillParent:!0});if(!TurbulenzEngine){window.alert("Failed to init TurbulenzEngine (canvas)");return}TurbulenzEngine.onload=t,TurbulenzEngine.onunload=n,t()}},l=document.createElement("script");l.type="text/javascript",l.src=s,l.addEventListener?l.addEventListener("load",f,!1):l.readyState&&(l.onreadystatechange=function(){(this.readyState==="loaded"||this.readyState==="complete")&&f()}),document.getElementById("game_player").appendChild(l)}window.game=a,window.onbeforeunload=n.tearDownPlugin});else{var a=$("<iframe />",{id:"game_player_frame",src:s,style:"width: 100%; height: 100%; display: block; border: none;",allowfullscreen:"true",mozallowfullscreen:"true",webkitallowfullscreen:"true"});a.appendTo("#game_player"),$(function(){var t=$("#game_player_frame")[0],r=t.contentWindow||t.contentDocument.defaultView;r.gameSlug=e,window.game=r,window.onbeforeunload=n.tearDownPlugin})}var f=r.router.get("games-details",{slug:e});$.get(f,function(t){if(t.data.has_notifications){var r=n.app.gameNotifications;r.getNotificationKeys(e,function(t){r.startPolling(e,function(e){var n=(new Date).toTimeString().substring(0,8),r=t[e.key];console.log(n+" - "+r.title+" received: ",e.message)})})}})},playOff:function(){this.app.gameNotifications.stopPolling(),Turbulenz.Services.bridge.removeAllGamesListeners(),this.tearDownPlugin(),window.setTimeout(function(){$("#game_player").empty().hide(),$("#header").show(),$("#content").show(),window.game=null},0)}});