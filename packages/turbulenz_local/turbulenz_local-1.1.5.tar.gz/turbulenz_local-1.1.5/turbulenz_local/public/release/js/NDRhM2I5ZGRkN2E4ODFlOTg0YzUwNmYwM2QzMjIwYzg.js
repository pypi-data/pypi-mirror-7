// Copyright (c) 2011-2012 Turbulenz Limited
/*global Backbone*//*global Templates*//*jshint nomen: false*//*global _*//*global $*//*jshint nomen: true*//*global window*//*exported CarouselView*/var CarouselView=Backbone.View.extend({el:"#content",events:{},initialize:function(){this.app=this.options.app,this.template=Templates.local_application_template,this.game_panel_template=Templates.local_game_panel_template,this.game_progress_panel_template=Templates.local_progress_panel_template,this.action_buttons_template=Templates.local_action_buttons_template,_.bindAll(this,"render","expand","makeCarousel","moveToFocus","collapse","getActionButtons","setActionspacerListeners","onLogin","onLoginKeyUp","onUsernameChange"),this.app.bind("carousel:make",this.makeCarousel),this.app.bind("carousel:collapse",this.collapse),this.app.bind("slug:change",this.setActionButtons),this.app.bind("carousel:refresh",this.render),this.username=$.cookie("local");if(!this.username){var t=this;$.ajax({url:"/local/v1/user/get",async:!1,type:"GET",success:function(n){t.username=n.data.username;var r=$("#local-login");if(r){var i=r.find(".local-login-text");i.text("Currently logged in as "+t.username)}}})}return this.carouselGlobals={indexPattern:new RegExp("index([0-9]+)"),itemsInView:5},this.router=this.app.router,this},render:function(){$(this.el).jqotesub(this.template);var t=$("#local-login");this.username&&t.find(".local-login-text").text("Currently logged in as "+this.username),t.find(".local-login-button").on("click",this.onLogin),t.find(".local-login-input").on("keyup",this.onLoginKeyUp);var n=this,r=this.router.get("games-list");return $.ajax({url:r,async:!1,type:"GET",success:function(t){function s(e){if(e==="Never")return null;try{var t=e.split(" | "),n=t[0],r=t[1],i=r.split("/"),s=n.split(":");return new Date(i[2],i[1],i[0],s[0],s[1],0,0)}catch(o){return null}}var r=t.data,i=$("#carousel"),o=[];for(var u in r)r.hasOwnProperty(u)&&o.push(r[u]);o.sort(function(e,t){return s(t.modified)-s(e.modified)});var a=o.length,f;for(f=0;f<a;f+=1)i.jqoteapp(n.game_panel_template,{game:o[f],loop_index:f});n.app.trigger("carousel:make")}}),this},onLogin:function(){var t=$("#local-login"),n=t.find(".local-login-input"),r=n.val().toLowerCase(),i=this;$.ajax({url:"/local/v1/user/login",data:{username:r},async:!1,type:"POST",success:function(){t.find(".local-login-text").text("Currently logged in as "+r),i.username=r},error:function(t,r){if(r==="error"&&t.status===400){var i=JSON.parse(t.responseText).msg;window.alert(i),n.val("")}}})},onLoginKeyUp:function(t){t.keyCode===13&&this.onLogin()},setActionspacerListeners:function(){$("#actionspacer a").unbind("click").bind("click",function(){return document.location.hash=$(this).attr("href"),!1})},setActionButtons:function(t){$("#actionspacer").jqotesub(this.action_buttons_template,t),$("#actionspacer").show(),this.setActionspacerListeners()},clipRect:function(t){var n=t.match(/\d+/g);return{top:parseInt(n[0],10),right:parseInt(n[1],10),bottom:parseInt(n[2],10),left:parseInt(n[3],10),toString:function(){return"rect("+this.top+"px "+this.right+"px "+this.bottom+"px "+this.left+"px)"}}},getClip:function(t){var n=$(t),r=n.css("clip");if(!r){var i=n[0].currentStyle;i&&(r="rect("+i.clipTop+" "+i.clipRight+" "+i.clipBottom+" "+i.clipLeft+")")}return r},format_deploy_check_response:function(t){var n="";for(var r in t)if(t[r]!==undefined){n+="Issues in "+r+":\n";var i=t[r];for(var s in i)if(i[s]!==undefined){s=i[s],n+="  - "+s[0]+":\n";var o=s[1];for(var u in o)if(o[u]!==undefined&&o[u].length>0){var a=o[u];n+="    - "+u+":\n";for(var f in a)a[f]!==undefined&&(n+="      - "+a[f]+"\n")}n+="\n"}n+="\n"}return n},populateProgress:function(t,n){var r=this,i=$("."+t+".step-list>li.complete").length,s=$("."+t+".step-list>li").length,o=i/s*100;$("."+t+".progress-percentage>span").html(Math.floor(o)),$("#deploy_button_id"+n).click(function(){$.ajax({type:"get",url:r.router.get("deploy-check",{slug:t}),success:function(n){if(!n.ok){var i=r.format_deploy_check_response(n.msg);i+="If you want to continue, these attributes will be set to default values.";if(!window.confirm(i))return!1}return r.app.trigger("deploy:set"),r.app.trigger("deploy:initialise",t),!0},error:function(t){var n=JSON.parse(t.responseText);return t.status===400?window.alert(r.format_deploy_check_response(n.msg)):window.alert(n.msg),!1}})}),$("a#deploy_button_id"+n).hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})},expand:function(t){var n="#carousel",r=this;$(t).addClass("selected");var i=$(t).attr("id");$(t).width(960),$(n)[0].expanded=!0;var s=$(t).attr("class").match(this.carouselGlobals.indexPattern)[1],o=this.router.get("edit-overview",{slug:i});return $.get(o,function(e){$("li#"+i).removeClass("index").addClass("index"+s).addClass("selected"),$("ul#carousel>li#slug").jqotesub(r.game_panel_template,{game:i,loop_index:s}),$(t).find(".progress-panel").show(),$(t+">div.progress-panel").jqotesub(r.game_progress_panel_template,{game:e,loop_index:s}),$(".step-list>li").css({"float":"none"});var n=e.data.deployable;r.populateProgress(i,s,n)}),this.moveToFocus(n,s),$("#actionspacer>li").length===0&&r.setActionButtons(i),!1},removeTemporaryGame:function(){var t=this,n=$("#carousel>li.Temporary");return n.length>0?(n.remove(),t.app.editView.deleteGame(!1,n.attr("id"),!0),!1):!0},displayButtons:function(t){var n=$(t),r=n[0],i=parseInt(r.index,10),s=parseInt(r.numItems,10),o=parseInt(r.itemsInView,10),u;r.expanded?u=s-1:s>o?u=s-o:u=0;var a=n.parent(".viewport");return i<u?a.siblings(".carousel-btn.next").show():a.siblings(".carousel-btn.next").hide(),i>0?a.siblings(".carousel-btn.prev").show():a.siblings(".carousel-btn.prev").hide(),!1},setGameboxListeners:function(t){$(t).find(".game-box").unbind("click").bind("click",function(){var e=$(this).parent("li");return e.hasClass("selected")?document.location.hash="":document.location.hash=$(this).parent().attr("id"),!1})},makeCarousel:function(){var t="#carousel",n=this;if($(t).length!==0){var r=$(t),i=r.parent(".viewport"),s=i.width(),o=this.carouselGlobals.itemsInView,u=r.find(">li").length,a=s/o;r.find(">li").width(a);var f=r[0];f.numItems=u,f.itemsInView=o,f.itemWidth=a,f.index=0,f.expanded=!1,i.siblings(".carousel-btn.next").unbind().click(function(){n.scrollRight(t)}),i.siblings(".carousel-btn.prev").unbind().click(function(){n.scrollLeft(t)}),this.displayButtons(t),this.setGameboxListeners(t)}return!1},moveToFocus:function(t,n){var r=$(t),i=r[0],s=i.numItems;n=parseInt(n,10),n<0?n=0:s&&n>=s&&(n=s-1),i.index=n;var o=$(t).find("li.index"+n),u,a;if(!o.hasClass("selected")){var f=n+this.carouselGlobals.itemsInView;for(u=0;u<s;u+=1)a=r.find("li.index"+u),u>=n&&u<f?a.show():a.hide()}else for(u=0;u<s;u+=1)a=r.find("li.index"+u),u===n?a.show():a.hide();return this.displayButtons(t),!1},collapse:function(){var t="#carousel",n=$(t);if(n.length!==0){this.removeTemporaryGame(),$("#details").empty(),$("#actionspacer").empty().hide(),$(".progress-panel").hide(),$("#games .game-panel").stop().width(n[0].itemWidth).find(".selected").removeClass("selected");var r=n[0];r.expanded=!1;var i=r.numItems,s=r.itemsInView,o=r.index;i<s?this.moveToFocus(t,0):o>i-s?this.moveToFocus(t,i-s):this.moveToFocus(t,o),document.location.hash=""}return!1},executeScrolling:function(t,n){var r=this;if($(t)[0].expanded){if(n>=0&&n<$(t)[0].numItems){var i=$("li.index"+n).attr("id"),s=$("#actionspacer>li>a.selected");if(s.length>0){var o=s.attr("href"),u=o.split("/"),a;s.attr("id")==="list-button"?a=u[1]+"/"+u[2]:a=u[1],document.location.hash="/"+a+"/"+i}else document.location.hash=i;return!1}}else r.moveToFocus(t,n);return r.displayButtons(t),!1},scrollRight:function(t){var n=parseInt($(t)[0].index,10)+1;return this.executeScrolling(t,n),!1},scrollLeft:function(t){var n=parseInt($(t)[0].index,10)-1;return this.executeScrolling(t,n),!1},addGame:function(){var t=this;return $("#carousel .Temporary").length===0&&$.ajax({type:"get",url:this.router.get("games-new"),success:function(){t.render(),t.app.trigger("carousel:make"),document.location.hash="/edit/"+$("#carousel .Temporary").attr("id")},error:function(){window.alert("Game could not be created.")}}),!1}});