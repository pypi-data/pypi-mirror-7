// Copyright (c) 2010-2013 Turbulenz Limited
/*global Backbone*//*global Templates*//*jshint nomen: false*//*global _*//*global $*//*jshint nomen: true*//*exported LocalListView*/var LocalListView=Backbone.View.extend({el:"#details",assetData:{},mappingTableUrl:"",staticFileUrl:"",hasMappingTable:"",inverseMapping:{},viewType:"",slug:"",lastSortKey:null,lastSortReverse:!0,initialize:function(){return this.app=this.options.app,this.templates={assets:Templates.local_list_asset_template,files:Templates.local_list_files_template},_.bindAll(this,"render","initializePage","getMappingTable","showDirectory"),this.app.bind("assets:list",this.render),this.skeyPattern=new RegExp("sort-([a-zA-Z-]+)"),this},render:function(t,n,r){this.viewType=t;var i=this,s=this.app.router.get("list-overview",{slug:n});return $.get(s,function(e){e=e.data,i.mappingTableUrl="play/"+n+"/"+e.mappingTable,i.staticFileUrl=e.staticFilePrefix,i.slug=e.slug,$(i.el).jqotesub(i.templates[i.viewType],e),i.showDirectory(n,r)}),this},sortData:function(t,n,r){var i=function(e,t){return e[t]===!0?1:0},s=function(e,t){return t=t?-1:1,function(n,r){return n.isDirectory!==r.isDirectory?-1:(e==="canView"||e==="canDisassemble"?(n=i(n,e),r=i(r,e)):(n=n.isDirectory?n.assetName:n[e],r=r.isDirectory?r.assetName:r[e]),n&&n.toLowerCase&&(n=n.toLowerCase()),r&&r.toLowerCase&&(r=r.toLowerCase()),n<r?t*-1:n>r?t*1:0)}};return t.sort(s(n,r))},shortenName:function(t){return t.length>30?"..."+t.substring(t.length-30):t},returnAssetList:function(t,n,r){var i=this.app.router,s=this,o=t.items,u=t.items.length,a="",f=this.app.viewerEnabled;for(var l=0;l<u;l+=1){var c=o[l],h=c.assetName,p=c.requestName,d=s.slug,v,m;r?(v=n+"/"+h,m=this.staticFileUrl+"/"+p):(v=p,m=p,n&&(v=n+"/"+v,m=n+"/"+m));var g=i.get("viewer-app",{slug:d,asset:v}),y=i.get("disassemble-app",{slug:d,asset:m});c.isDirectory?(a+="<tr><td>",a+='<a title="'+h+'" class="directory" id="'+h+'">'+s.shortenName(h)+"</a>",a+="</td><td>",a+="-"):r?(a+="<tr><td>",a+="<span title="+h+">"+s.shortenName(h)+"</span>",a+="</td><td>",a+="<span title="+p+">"+p+"</span>"):h==="-"?(a+="<tr><td>",a+="<span title="+p+">"+p+"</span>",a+="</td><td>",a+="-"):(a+='<tr class="highlighted"><td>',a+="<span title="+p+">"+p+"</span>",a+="</td><td>",a+="<span title="+h+">"+s.shortenName(h)+"</span>"),a+="</td><td>",c.canView?f?a+="<a href="+g+">View</a>":a+="View":a+="-",a+="</td><td>",c.canDisassemble?a+="<a href="+y+">Disassemble</a>":a+="-",a+="</td></tr>"}return a},displayData:function(t){var n=this,r=$("tbody"),i=this.viewType==="assets",s=this.returnAssetList(this.assetData,t,i);r.html(s),$(".details-table").find("tr:even").addClass("stripe"),n.hasMappingTable===!1&&i&&$("div.details-table tbody").html("<tr><td>No mapping table. Switch to File System View please.</td></tr>"),n.initializePage()},getData:function(t,n,r){var i=this;$.ajax({url:t,dataType:"json",async:!1,success:function(e){i.assetData=e.data,i.hasMappingTable=e.data.mappingTable;if(i.viewType==="files"&&i.inverseMapping){var t=i.assetData.items;for(var n=0;n<t.length;n+=1)if(!t[n].isDirectory){var s=t[n].requestName,o=i.inverseMapping[s];o||(o="-"),t[n].assetName=o}}i.lastSortKey&&i.sortData(i.assetData.items,i.lastSortKey,i.lastSortReverse),i.displayData(r),$(".sort-controller th").unbind("click").click(function(){var t=$(this),n=t.attr("class");n&&(n=n.match(i.skeyPattern)[1],i.lastSortKey=n);var s=t.find("span");s.hasClass("active")?(i.sortData(i.assetData.items,n,!0),i.displayData(r),i.lastSortReverse=!0,s.removeClass("active").addClass("active-reverse")):(i.sortData(i.assetData.items,n,!1),i.displayData(r),i.lastSortReverse=!1,$(this).siblings().find("span").removeClass("active").removeClass("active-reverse"),s.removeClass("active-reverse").addClass("active"))}),$(".session-header .button").unbind("mouseenter mouseleave").bind("mouseenter",function(){$(this).addClass("hover-target")}).bind("mouseleave",function(){$(this).removeClass("hover-target")})}})},showDirectory:function(t,n){var r=$(".session-header ul:first");$("#asset\\:").nextAll().remove();var i="",s="asset:";if(n){var o=n.split("/");for(var u=0;u<o.length;u+=1)o[u]!==""&&(s+=o[u]+":",i+='<li class="button left directoryPaths" id="'+s+'"><div class="right">',i+='<div class="middle">'+o[u]+"</div></div></li>")}r.append(i);var a,f=this.app.router;this.viewType==="files"?a=f.get("list-files",{slug:t,path:n}):a=f.get("list-assets",{slug:t,path:n}),this.getData(a,document.location.hash,n)},initializePage:function(){var t=this;$("#list-form .directoryPaths").unbind().bind("click",function(){$(this).nextAll().remove();var e=document.location.hash,t=e.split("/"),n=t[1],r=t[2],i=t[3],s=$(this).attr("id");s=s.substring("asset:".length).replace(/:/g,"/");var o=s.length;return s=s.slice(0,o-1),s?document.location.hash="/"+n+"/"+r+"/"+i+"/"+s:document.location.hash="/"+n+"/"+r+"/"+i,!1}),$("#list-form .directory").unbind().bind("click",function(){var e=$(this).attr("id"),t=document.location.hash;return document.location.hash=t+"/"+e,!1}),$("#list-form #toggle-asset-view").unbind("click").bind("click",function(){t.viewType==="files"?(t.viewType="assets",document.location.hash="/list/assets/"+t.slug):(t.viewType="files",document.location.hash="/list/files/"+t.slug)}),this.getMappingTable()},getMappingTable:function(){var t=this;$.ajax({url:t.mappingTableUrl,dataType:"json",async:!1,success:function(e){var n=e.urnmapping||e.urnremapping||{},r=t.inverseMapping;for(var i in n)n.hasOwnProperty(i)&&(r[n[i]]=i)}})}});