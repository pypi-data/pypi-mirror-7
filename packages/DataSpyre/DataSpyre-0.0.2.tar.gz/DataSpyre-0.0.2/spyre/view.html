<!DOCTYPE html>
<html>
	<head>
		<!-- load styles -->
		<style>{{d3css}}</style>
		<style>{{css}}</style>

		<!-- load javascript -->
		<script type='text/javascript'>{{js}}</script>


		<script type='text/javascript'>

			{{d3js}}

			function updateSharedParameters(){
				shared_params = "";
				{% for field in shared_fields %}
					var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
					shared_params = shared_params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&";
					console.log(shared_params)
				{% endfor %}
			}

			{% for control in controls %}
				function {{control['control_name']}}(){
					{% for output in outputs %}
						{% if output['control_name']==control['control_name'] %}
							{% if output['output_type']=='image' %}
								// load image
								$("#{{output['output_id']}}").empty();
								updateSharedParameters()
								var  params = "";
								{% for field in control['text_fields'] %}
									var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
									params = params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&"
								{% endfor %}
								params = params+shared_params;
								console.log(params);
								var plot = $("<img />").attr('src', "/plot?"+params)
								$("#{{output['output_id']}}").append(plot);
							{% endif %}

							{% if output['output_type']=='html' %}
								// load custom html
								updateSharedParameters()
								var  params = "";
								{% for field in control['text_fields'] %}
									var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
									params = params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&"
								{% endfor %}
								params = params+shared_params;
								$.ajax({
									url : "/html?"+params,
									success: function(response, textStatus, jqXHR){
										$("#{{output['output_id']}}").html(response);
									}
								});
							{% endif %}

							{% if output['output_type']=='table' %}
									updateSharedParameters()
									var  params = "";
									{% for field in control['text_fields'] %}
										var {{field['variable_name']}} = $("#{{field['variable_name']}}").val();
										params = params+"{{field['variable_name']}}="+{{field['variable_name']}}+"&"
									{% endfor %}
									params = params+shared_params;
									$.ajax({
										url : "/table?"+params,
										success: function(response, textStatus, jqXHR){
											$("#{{output['output_id']}}").html(response);
											initTable("sortable");
										}
									});
							{% endif %}
					{% endif %}
				{% endfor %}
				}
			{% endfor %}

			function show_d3_plot(){
				$("#chart").empty();
				updateSharedParameters()
				params = shared_params;
				$.ajax({
					url : "/data?"+params,
					success: function(response, textStatus, jqXHR)
					{
						var data = response.data;
						console.log(data);
						draw(data);
					}
				});
			};
			
			$(document).ready(function() {
				// jquery for tabs
				jQuery('.tabs .tab-links a').on('click', function(e)  {
					var currentAttrValue = jQuery(this).attr('href');

					// Show/Hide Tabs
					jQuery('.tabs ' + currentAttrValue).show().siblings().hide();

					// Change/remove current tab to active
					jQuery(this).parent('li').addClass('active').siblings().removeClass('active');

					e.preventDefault();
    			});

				{% for output in outputs %}
					{% if output['output_type']!='d3' %}
						// connect output to button
						$("#{{output['control_name']}}").click(function(e) {
							{{output['control_name']}}()
						});

						// if on_page_load is true, load when page loads
						{% if output['on_page_load']=='true' %}
							{{output['control_name']}}()
						{% endif %}
					{% endif %}


					{% if output['output_type']=='d3' %}
						// connect output to button
						$("#{{output['control_name']}}").click(function(e) {
							show_d3_plot()
						});

						// if on_page_load is true, load when page loads
						{% if output['on_page_load']=='true' %}
							show_d3_plot()
						{% endif %}
					{% endif %}

				{% endfor %}
			});
		</script>
	</head>

	<body>
		<div class="outer">

		<!-- control panel -->
		<div class="left-panel">
			<h1>{{title}}</h1>
			<hr>
			{% for field in shared_fields %}
				{{field['label']}}: <input type="{{field['input_type']}}" value="{{field['value']}}" id="{{field['variable_name']}}" /><br>
			{% endfor %}

			{% for control in controls %}
				{% for field in control['text_fields'] %}
					{{field['label']}}: <input type="{{field['input_type']}}" value="{{field['value']}}" id="{{field['variable_name']}}" /><br>
				{% endfor %}

				<!-- buttons -->
				{% if control['control_type']=="button" %}
					<div class="button" id="{{control['control_name']}}" onclick="{{control['control_name']}}()">{{control['button_label']}}</div><br>
				{% endif %}
			{% endfor %}
		</div>

		<!-- output -->
		<div class="right-panel">
			{% if tabs is defined %}
				<div class="tabs">
					<ul class="tab-links">
						{% for tab in tabs %}
							{% if loop.index == 1 %}
								<li class="active"><a href="#{{tab}}">{{tab}}</a></li>
							{% else %}
								<li><a href="#{{tab}}">{{tab}}</a></li>
							{% endif %}
						{% endfor %}
					</ul>

					<div class="tab-content">
						{% for tab in tabs %}
							{% if loop.index == 1 %}
								<div id="{{tab}}" class="tab active">
							{% else %}
								<div id="{{tab}}" class="tab">
							{% endif %}
							{% for output in outputs %}
								{% if output['tab'] == tab %}
									<!-- images, custom html, tables, anything not d3 -->
									{% if output['output_type'] != "d3" %}
										<div id="{{output['output_id']}}"></div>
									{% endif %}

									<!-- d3 figs go here -->
									{% if output['output_type'] == "d3" %}
										<div id="chart"></div>
									{% endif %}
								{% endif %}

							{% endfor %}
							</div>
						{% endfor %}

					</div>
				</div>
			{% else %}	

				{% for output in outputs %}
					<!-- images, custom html, tables, anything not d3 -->
					{% if output['output_type'] != "d3" %}
						<div id="{{output['output_id']}}"></div>
					{% endif %}

					<!-- d3 figs go here -->
					{% if output['output_type'] == "d3" %}
						<div id="chart"></div>
					{% endif %}
				{% endfor %}

			{% endif %}
		</div>
		</div>
		
	</body>
</html>

