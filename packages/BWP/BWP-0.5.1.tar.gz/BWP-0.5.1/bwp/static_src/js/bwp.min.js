var NEWOBJECTKEY="newObject",FIELD=null,delay=null,ACTION_WAIT=null,FILTER_TYPES=[["exact","Равно",1],["gt","Больше",1],["gte","Больше или равно",1],["lt","Меньше",1],["lte","Меньше или равно",1],["range","Диапазон",2],["in","Список",99],["icontains","Содержит",1],["istartswith","Начинается",1],["iendswith","Заканчивается",1],["isnull","Пусто",0],["blank","Пустая строка",0],];window.TEMPLATES={};window.REGISTER={};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{\%(.+?)\%\}/g,};_.mixin(_.str.exports());function isEmpty(b){for(var a in b){return false}return true}delay=(function(){if(DEBUG){console.log("function:delay")}var a=0;return function(c,b){clearTimeout(a);a=setTimeout(c,b)}})();function generatorID(d,g){if(DEBUG){console.log("function:generatorID")}var b=[],e="i",a=1000,f=9999,c=Math.floor(Math.random()*(f-a+1))+a;e+=$.now()+String(c);if(d){b.push(d)}b.push(e);if(g){b.push(g)}return validatorID(b)}function validatorID(a){if($.type(a)==="array"){a=a.join("_")}if(DEBUG){console.log("function:validatorID")}return a.replace(/[\.,\:,\/, ,\(,\),=,?]/g,"-")}function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close");$("#alert-place").css("z-index","-1000")}function handlerShowAlert(c,a,d,b){if(DEBUG){console.log("function:handlerShowAlert")}b=b||5000;console.log(c);if(!a){a="alert-error"}html=TEMPLATES.alert({msg:c,type:a});$("#alert-place").css("z-index","1000").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,b)}else{delay(handlerHideAlert,b)}return false}function jsonAPI(a,f,d,b,c){if(DEBUG){console.log("function:jsonAPI")}if(!a){a={method:"get_settings"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!b,timeout:c||AJAX_TIMEOUT,url:BWP_API_URL,data:{jsonData:$.toJSON(a)},dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location);console.log("1:"+i.getResponseHeader("Location"))}else{console.log("ERROR:"+i.responseText);if(i.responseText){handlerShowAlert(_(i.responseText).truncate(255),"alert-error")}}}).done(function(h,g,i){if(d){if(DEBUG){console.log(d)}}if((h.status>=300)&&(h.status<400)&&(h.data.Location!=undefined)){redirect=function(){location=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location)};if(h.message){handlerShowAlert(h.message,"alert-error",redirect)}else{redirect()}}else{if(h.status>=400){handlerShowAlert(h.message,"alert-error")}else{if(DEBUG){console.log($.toJSON(h.message))}return f(h,g,i)}}});return e}function classSettings(a){this.meta={};self=this;if((typeof localStorage=="undefined")||(typeof $.evalJSON=="undefined")){return{}}_unique_key=SETTINGS_UNIQUE_KEY;_server={};_local={tabs:[],filters:{},};_values={server:_server,local:_local};_values_is_set=false;_responseServer=null;this.__defineGetter__("ready",function(){return _values_is_set});_callback=a;_run_callback=function(){if(_callback==="function"){_callback();if(!_callback.__not_reset_after__){_callback=a}}};this.callback=_callback;_last_set_server=null;this.last_set=_last_set_server;_last_get_server=null;this.last_get=_last_get_server;_init=function(b){if(b){_callback=b}_values_is_set=false;_local=$.evalJSON(localStorage.getItem(_unique_key))||_local;_get_server();return self};this.init=_init;this.reload=_init;_check_init=function(){if(!_values_is_set){_init()}return self};this.__defineGetter__("all",function(){_check_init();return _values});this.__defineGetter__("server",function(){_check_init();return _server});this.__defineGetter__("local",function(){_check_init();return _local});this.save=function(c,b){if(c){_callback=c}if(b!="local"){_set_server()}if(b!="server"){localStorage.setItem(_unique_key,$.toJSON(self.local))}_run_callback();return self};this.save_server=function(b){return self.save(b,"server")};this.save_local=function(b){return self.save(b,"local")};_set_server=function(){sync=false;_responseServer=null;args={method:"set_settings",settings:self.server};cb=function(c,b,d){if(!c.data){handlerShowAlert(c.message)}else{_last_set_server=new Date();_responseServer=c}};jqxhr=new jsonAPI(args,cb,"SETTINGS.set_server() call jsonAPI()",sync);return[_last_set_server,_responseServer,jqxhr]};_get_server=function(){sync=true;_responseServer=null;args={method:"get_settings"};cb=function(c,b,d){_server=c.data;_last_get_server=new Date();_responseServer=c;_values_is_set=true;_run_callback()};jqxhr=new jsonAPI(args,cb,"SETTINGS.get_server() call jsonAPI()",sync);return[_last_get_server,_responseServer,jqxhr]};this.cleanTabs=function(){_tabs=[];$.each(_local.tabs,function(b,c){if(c){_tabs.push(c)}});_local.tabs=_tabs;return self}}function classApp(a){this.has_module_perms=a.has_module_perms;this.name=a.name;this.id=validatorID(this.name);this.label=a.label;this.title="Приложение:"+this.label;_models=[];this.models=_models;app=this;$.each(a.models,function(b,c){_models.push(new classModel(app,c))});REGISTER[this.id]=this}function classModel(b,a){this.template=TEMPLATES.layoutModel;this.app=b;this.perms=a.perms;this.meta=a.meta;this.name=a.name;this.model=this.name;this.id=validatorID(this.model);this.label=a.label;this.title=this.app.label+": "+this.label;this.query=null;this.fix={};this.paginator=null;_collection_reports=[];this.collection_reports=_collection_reports;_object_reports=[];this.object_reports=_object_reports;_composes={};this.composes=_composes;_actions={};this.actions=_actions;model=this;if(a.meta.compositions){$.each(a.meta.compositions,function(c,d){_composes[d.meta.related_name]=d})}if(a.meta.reports){$.each(a.meta.reports,function(c,d){if(d.for_object){_object_reports.push(d)}else{_collection_reports.push(d)}});if(this.collection_reports.length<1){this.collection_reports=null}if(this.object_reports.length<1){this.object_reports=null}}if((!this.meta)||(!this.meta.list_display)){console.log("Модель не может быть зарегистрирована.")}else{REGISTER[this.id]=this}}function classSelector(b,a){$.extend(true,this,b);this.id=validatorID([this.id,"selector"]);this.template=TEMPLATES.layoutSelector;this.perms={"delete":false,add:false,change:false};this.actions=null;this.meta.list_display=this.meta.list_display;this.meta.list_per_page=5;this.multiple=a?true:false;selector=this;REGISTER[this.id]=this;this.get_checked_items=function(){_checkboxes=$("#collection_"+this.id+" tbody td:nth-child(1) input[type=checkbox]:checked");return _checkboxes}}function classCompose(a,b){this.template=TEMPLATES.layoutCompose;this.object=a;this.editable=Boolean(this.object.pk);this.perms=b.perms;this.name=b.name;this.meta=b.meta;this.compose=this.meta.related_name;this.model=this.meta.related_model;this.is_m2m=this.meta.is_many_to_many;this.id=validatorID([this.object.id,this.name,this.compose]);this.label=b.label;this.title=this.object.label+": "+this.label;this.query=null;this.fix={};this.m2m_fix=[];this.m2m_fixaction=null;this.paginator=null;_actions={};this.actions=_actions;compose=this;REGISTER[this.id]=this}function classObject(a){this.template=TEMPLATES.layoutObject;this.model=REGISTER[validatorID(a.model)];this.pk=a.pk;this.id=this.pk?validatorID(a.model+"."+this.pk):generatorID(NEWOBJECTKEY);this.__unicode__=this.pk?a.__unicode__:"Новый объект ("+this.model.label+")";this.label=this.__unicode__;this.title=this.model.label+": "+this.label;_properties=a.properties;this.properties=_properties;_fields=a.fields;this.fields=_fields;this.get_fields=function(){L={};$.each(this.model.meta.fields,function(b,c){L[c]=_fields[c]});return L};this.get_column_value=function(b){if(b in _fields){return _fields[b]}else{if(b in _properties){return _properties[b]}}return""};_composes=[];this.composes=_composes;this.widgets=this.model.meta.widgets;this.actions=this.model.actions;this.fix={};this.fixaction=null;object=this;if(this.model.composes){$.each(this.model.composes,function(b,c){_composes.push(new classCompose(object,c))})}REGISTER[this.id]=this}function handlerCommitInstance(a,b){if(DEBUG){console.log("function:handlerCommitInstance")}_objects=[];_model=a.model;appendObject=function(c){$.extend(true,c.fields,c.fix);_objects.push({pk:c.pk,fields:c.fields,model:c.model.name,action:c.fixaction,fix:c.fix,})};if((a instanceof classModel)||(a instanceof classCompose)){_model=a;$.each(a.fix,function(c,d){appendObject(d)})}else{appendObject(a)}args={method:"commit",objects:_objects,};cb=function(d,c,e){handlerCollectionGet(_model);if(b){b()}};jqxhr=new jsonAPI(args,cb,"handlerCommitInstance(instance) call jsonAPI()",true,300000);return jqxhr}function handlerCommitComposeM2M(b,a){if(DEBUG){console.log("function:handlerCommitComposeM2M")}args={method:"m2m_commit",model:b.object.model.name,pk:b.object.pk,compose:b.compose,action:b.m2m_fixaction,objects:b.m2m_fix,};cb=function(d,c,e){handlerCollectionGet(b);if(a){a()}};jqxhr=new jsonAPI(args,cb,"handlerCommitComposeM2M(compose, done) call jsonAPI()");return jqxhr}function handlerLayoutRender(a,b){if(DEBUG){console.log("function:handlerLayoutRender")}html=a.template({data:a});if(!b){$("#layout_"+a.id).html(html);if(a instanceof classObject){$("#layout_"+a.id+" button[data-loading=true]").one("click",eventLayoutLoad)}}return html}function handlerLayoutLoad(a){if(DEBUG){console.log("function:handlerLayoutLoad")}html=handlerLayoutRender(a);if((a instanceof classModel)||(a instanceof classCompose)){jqxhr=handlerCollectionGet(a)}}function eventLayoutLoad(){if(DEBUG){console.log("function:eventLayoutLoad")}data=$(this).data();instance=REGISTER[data.id];handlerLayoutLoad(instance);$(this).removeAttr("data-loading");return true}function handlerSelectAllToggle(){$table=$(this).parents("table");$inputs=$table.find("tbody td:nth-child(1) input[type=checkbox]");checked=this.checked;$.each($inputs,function(a,b){b.checked=checked})}function eventRowClick(){if(DEBUG){console.log("function:eventRowClick")}$this=$(this);$this.addClass("info").siblings("tr").removeClass("info");return true}function handlerCollectionRender(a,b){if(DEBUG){console.log("function:handlerCollectionRender")}if(a instanceof classObject){return""}html=TEMPLATES.collection({data:a});if(!b){$("#collection_"+a.id).html(html)}return html}function handlerCollectionGet(a){if(DEBUG){console.log("function:handlerCollectionGet")}var b=[];if(a.filters){$.each(a.filters,function(c,d){b.push({active:d.active,field:d.field,type:d.type,inverse:d.inverse,values:d.values,field_title:d.field_title,type_title:d.type_title,})})}args={method:"get_collection",model:a.model,compose:a.compose||null,ordering:a.meta.ordering||null,fields:a.meta.search_fields||null,filters:b,};args[a.meta.search_key]=a.query||null;if(a.object){args.pk=a.object.pk||0}if(a.paginator){args.page=a.paginator.page||1;args.per_page=a.paginator.per_page||null}cb=function(d,c,e){a.paginator=d.data;html=handlerCollectionRender(a)};jqxhr=new jsonAPI(args,cb,"handlerCollectionGet() call jsonAPI()");return jqxhr}function eventCollectionSearch(){if(DEBUG){console.log("function:eventCollectionSearch")}search=this;data=$(search).data();instance=REGISTER[data.id];instance.query=$(search).val()||null;wrap=function(){return handlerCollectionGet(instance)};jqxhr=delay(wrap,500);return jqxhr}function eventCollectionSearchRefresh(){if(DEBUG){console.log("function:eventCollectionSearchRefresh")}search=$(this).siblings("input[data-action=collection_search][data-id="+$(this).data().id+"]");data=$(search).data();instance=REGISTER[data.id];instance.query=$(search).val()||null;jqxhr=handlerCollectionGet(instance);return jqxhr}function eventCollectionCount(){if(DEBUG){console.log("function:eventCollectionCount")}data=$(this).data();instance=REGISTER[data.id];if(instance.paginator){instance.paginator.page=1;instance.paginator.per_page=$(this).val()||$(this).data()["count"]||instance.meta.list_per_page;$("[data-placeholder=collection_count][data-id="+instance.id+"]").text(instance.paginator.per_page)}jqxhr=handlerCollectionGet(instance);return jqxhr}function eventCollectionPage(){if(DEBUG){console.log("function:eventCollectionPage")}data=$(this).data();instance=REGISTER[data.id];if(instance.paginator){instance.paginator.page=$(this).val()||$(this).data()["page"]||1}jqxhr=handlerCollectionGet(instance);return jqxhr}function eventCollectionSorted(d){if(DEBUG){console.log("function:eventCollectionSorted")}var e=$(this).data(),b=REGISTER[e.id],a=b.meta.ordering||[],c=$.inArray(e.column,a);if(c>-1){console.log(1,c,e.column);a[c]="-"+e.column}else{console.log(2,c,e.column);c=$.inArray("-"+e.column,a);if(c>-1){console.log(3,c,"-"+e.column);a=a.slice(0,c).concat(a.slice(c+1))}}if(c==-1){console.log(4,c,e.column);a.push(e.column)}b.meta.ordering=a;jqxhr=handlerCollectionGet(b);return jqxhr}function handlerObjectAdd(a){if(DEBUG){console.log("function:handlerObjectAdd")}args={method:"get_object",model:a.name,pk:null,filler:{},};console.log(a);if(a instanceof classCompose){args.filler[a.meta.related_field]=a.object.pk}cb=function(c,b,d){object=new classObject(c.data);object.fixaction="add";object.model.fix[object.id]=object;handlerTabOpen(object)};jqxhr=new jsonAPI(args,cb,"handlerObjectAdd(model) call jsonAPI()");return jqxhr}function handlerTempUploadFile(a,d){if(DEBUG){console.log("function:handlerTempUploadFile")}var c=new FormData(),b=d.files[0],e=new XMLHttpRequest();if(!b){a.fix[d.name]=0;return true}else{c.append("file",b);e.open("POST","upload/"+a.model.name+"/",true);e.onload=function(f){json=JSON.parse(this.response);a.fix[d.name]=json.data;$(d).siblings("button[name]").text(b.name).attr("title",b.name)};e.send(c);return true}}function handlerObjectChange(b,d){if(DEBUG){console.log("function:handlerObjectChange")}var a=d.attr("name"),c=d.attr("type"),e=d.val();if(c){c=c.toLowerCase()}if(c in {file:0,image:0}){handlerTempUploadFile(b,d[0])}else{if(c==="datetime-local"){e=$.dateParser(e,true)||e}else{if($.type(b.fields[a])==="array"){e=[e,d.text()]}else{if($.type(b.fields[a])==="boolean"){e=d.is(":checked")}}}}b.fix[a]=e;b.fixaction=b.fixaction||"change";b.model.fix[b.id]=b}function handlerObjectCopy(a,b){if(DEBUG){console.log("function:handlerObjectCopy")}if(a.id){object=REGISTER[a.id];a={};a.model=object.model.name;a.pk=object.pk}args={method:"get_object",model:a.model,pk:a.pk,copy:true,clone:b,};cb=function(d,c,e){object=new classObject(d.data);object.fixaction="add";object.model.fix[object.id]=object;handlerTabOpen(object)};jqxhr=new jsonAPI(args,cb,"handlerObjectCopy(data, clone) call jsonAPI()")}function handlerObjectDelete(b,a){if(DEBUG){console.log("function:handlerObjectDelete")}args={method:"commit",objects:[{pk:b.pk,fields:{},model:b.model,action:"delete"}],};cb=function(d,c,e){handlerCollectionGet(REGISTER[validatorID(b.model)]);if(a){a()}};jqxhr=new jsonAPI(args,cb,"handlerObjectDelete(data, done) call jsonAPI()",true,180000)}function handlerObjectRowMuted(a){if(DEBUG){console.log("function:handlerObjectRowMuted")}$('tr[data-model="'+a.model.name+'"][data-pk="'+a.pk+'"]').addClass("muted")}function handlerObjectRowUnmuted(a){if(DEBUG){console.log("function:handlerObjectRowUnmuted")}$('tr[data-model="'+a.model.name+'"][data-pk="'+a.pk+'"]').removeClass("muted")}function eventObjectOpen(){if(DEBUG){console.log("function:eventObjectOpen")}$this=$(this);data=$this.data();if(!data.model){return false}object=REGISTER[data.id];if(object){handlerTabOpen(object);return null}args={method:"get_object",model:data.model,pk:data.pk||null,};cb=function(b,a,c){object=new classObject(b.data);$this.data("id",object.id);handlerTabOpen(object)};jqxhr=new jsonAPI(args,cb,"eventObjectOpen() call jsonAPI()");return jqxhr}function eventObjectAdd(c){if(DEBUG){console.log("function:eventObjectAdd")}var e=$(this),d=e.data(),a=REGISTER[d.id],b=a.is_m2m?a:null;if((b)&&(c)&&(c.data)&&(c.data.m2m)){handlerM2MSelect(b);return true}handlerObjectAdd(a);return true}function eventObjectCopy(){if(DEBUG){console.log("function:eventObjectCopy")}$this=$(this);data=$this.data();handlerObjectCopy(data);return true}function eventObjectClone(){if(DEBUG){console.log("function:eventObjectClone")}$this=$(this);data=$this.data();handlerObjectCopy(data,true);return true}function eventObjectDelete(a){if(DEBUG){console.log("function:eventObjectDelete")}done=undefined;$this=$(this);data=$this.data();if((a)&&(a.data)&&(a.data.m2m)){compose=REGISTER[data.id];compose.m2m_fix=[data.pk];compose.m2m_fixaction="delete";handlerCommitComposeM2M(compose);return true}object=REGISTER[data.id];if(object instanceof classObject){data.model=object.model.name;data.pk=object.pk;done=function(){handlerTabClose(object)}}text="<b>Вы действительно желаете удалить этот объект?</b><br><i>Удаление невозможно обратить, если этот объект не рассчитан на перемещение в корзину.</i>";handlerModalShowSubmit(text,handlerObjectDelete,data,done);return true}function eventObjectChange(){if(DEBUG){console.log("function:eventObjectChange")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerObjectChange(object,$this);return true}function eventObjectReset(){if(DEBUG){console.log("function:eventObjectReset")}$this=$(this);data=$this.data();object=REGISTER[data.id];object.fix={};handlerLayoutRender(object);return true}function eventObjectSave(){if(DEBUG){console.log("function:eventObjectSave")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerCommitInstance(object,function(){handlerTabClose(object)});return true}function eventObjectSelect(){if(DEBUG){console.log("function:eventObjectSelect")}$this=$(this);data=$this.data();FIELD.val(data.pk).text(data.unicode).attr("title",data.unicode).change().siblings("button[disabled]").removeAttr("disabled");$("#modal").modal("hide");return true}function handlerM2MSelect(c){if(DEBUG){console.log("function:handlerM2MSelect")}model=REGISTER[validatorID(c.name)];var a=new classSelector(model,true),g="Выберите требуемые объекты",b=handlerLayoutRender(a,true),f=null,e={},d=[{model:model,action:"object_add",label:"Новый",css:"btn-warning"},{model:null,action:"modal_close",label:"Закрыть",css:""},{model:c,action:"selector_append",label:"Добавить",css:"btn-info"},{model:c,action:"selector_submit",label:"Выбрать",css:"btn-primary"},];e={buttons:d,selector:a};f=TEMPLATES.modalFooter({mfoot:e,});handlerModalShow(g,b,f,function(){handlerCollectionGet(a)})}function handlerFieldSelect(a){if(DEBUG){console.log("function:handlerFieldSelect")}FIELD=a;data=a.data();object=REGISTER[data.id];model=REGISTER[validatorID(data.model)];selector=new classSelector(model);mhead="Выберите требуемый объект";mbody=handlerLayoutRender(selector,true);mfoot=null;handlerModalShow(mhead,mbody,mfoot,function(){handlerCollectionGet(selector)})}function handlerSelectorSubmit(b,a){if(DEBUG){console.log("function:handlerSelectorSubmit")}_objects=[];checked=a.get_checked_items();$.each(checked,function(c,d){data=$(d).data();_objects.push(data.pk)});b.m2m_fix=_objects;b.m2m_fixaction="add";handlerCommitComposeM2M(b)}function eventFieldClear(a){if(DEBUG){console.log("function:eventFieldClear")}$this=$(this);$this.attr("disabled","disabled");if((a)&&(a.data)&&(a.data.file)){$field=$this.siblings("input[name]");$field.val(null).change()}$this.siblings("button[name]").val(null).html("&nbsp;").attr("title","").change();return true}function eventFieldSelect(a){if(DEBUG){console.log("function:eventFieldSelect")}$this=$(this);if((a)&&(a.data)&&(a.data.file)){$this.siblings("input[name]").click()}else{$field=$this.siblings("button[name]");handlerFieldSelect($field)}return true}function eventSelectorSubmit(a){if(DEBUG){console.log("function:eventSelectorSubmit")}$this=$(this);data=$this.data();compose=REGISTER[data.id];selector=REGISTER[validatorID([compose.name,"selector"])];handlerSelectorSubmit(compose,selector);if(a.data.close){handlerModalHide()}return true}function handlerModalShowSubmit(i,f,h,g,e,d){if(DEBUG){console.log("function:handlerModalShowSubmit")}var b="Подтверждение",a=i,c=TEMPLATES.modalFooter({mfoot:{}});ACTION_WAIT=function(){f(h,g,e,d)};handlerModalShow(b,a,c)}function handlerModalShow(d,b,c,a){if(DEBUG){console.log("function:handlerModalShow")}$modal=$("#modal");modal={};modal.mhead=d;modal.mbody=b;modal.mfoot=c;html=TEMPLATES.modal({modal:modal});$modal.html(html).modal("show");if(a){a()}}function handlerModalHide(a){if(DEBUG){console.log("function:handlerModalHide")}$modal=$("#modal");$modal.modal("hide");if(a){a()}}function handlerMenuAppLoad(){if(DEBUG){console.log("function:handlerMenuAppLoad")}sync=true;args={method:"get_apps"};cb=function(b,a,c){apps=[];$.each(b.data,function(d,e){apps.push(new classApp(e))});html=TEMPLATES.menuApp({data:apps});$("#menu-app ul[role=menu]").html(html);$("#menu-app").show()};jqxhr=new jsonAPI(args,cb,"handlerMenuAppLoad() call jsonAPI()",sync);return jqxhr}function handlerTabOpen(a){if(DEBUG){console.log("function:handlerTabOpen")}handlerObjectRowMuted(a);tab=$("#main-tab #tab_"+a.id);if(tab.length>0){tab.find("a").tab("show")}else{html=TEMPLATES.layoutDefault({data:a});$("#main-tab-content").append(html);html=TEMPLATES.tab({data:a});$("#main-tab").append(html);delay(function(){$("#main-tab a:last").tab("show").click()},1);if((a.id.indexOf(NEWOBJECTKEY)==-1)&&($.inArray(a.id,SETTINGS.local.tabs)<0)&&($("#menu-app li[class!=disabled] a[data-id="+a.id+"]").size()>0)){SETTINGS.local.tabs.push(a.id);SETTINGS.save_local()}$("#tab_"+a.id+" a").one("click",eventLayoutLoad)}return true}function handlerTabClose(a){if(DEBUG){console.log("function:handlerTabClose")}id=a?a.id:null;$("#tab_"+id).remove();$("#layout_"+id).remove();instance=REGISTER[id];if(instance){handlerObjectRowUnmuted(instance);if(instance instanceof classObject){$.each(instance.composes,function(b,c){delete REGISTER[c.id]});delete REGISTER[id]}}num=$.inArray(id,SETTINGS.local.tabs);if(num>-1){delete SETTINGS.local.tabs[num];SETTINGS.cleanTabs().save_local()}$("#main-tab a:last").click()}function handlerTabRestore(){if(DEBUG){console.log("function:handlerTabRestore")}$.each(SETTINGS.local.tabs,function(a,b){$("#menu-app li[class!=disabled] a[data-id="+b+"]").click()})}function eventTabOpen(){if(DEBUG){console.log("function:eventTabOpen")}data=$(this).data();data=REGISTER[data.id]||data;handlerTabOpen(data);return true}function eventTabClose(){if(DEBUG){console.log("function:eventTabClose")}data=$(this).data();data=REGISTER[data.id]||data;handlerTabClose(data);return true}function handlerFiltersFromSettings(){if(DEBUG){console.log("function:handlerFiltersFromSettings")}if(!SETTINGS.local.filters){return false}$.each(SETTINGS.local.filters,function(b,c){var a=REGISTER[b];if(a){a.filters=c}});return true}function handlerFiltersRender(a){if(DEBUG){console.log("function:handlerFiltersRender")}if(a instanceof classObject){return false}html=TEMPLATES.filters({data:a});$("#collection_filters_"+a.id).html(html);return html}function eventFilters(){if(DEBUG){console.log("function:eventFilters")}var c=$(this).data(),a=REGISTER[c.id];if($("#collection_filters_"+c.id+" table").size()>0){$("#collection_filters_"+c.id).html("");var b=[];$.each(a.filters,function(d,e){if(e.field&&e.type&&e.values){b.push(e)}});a.filters=b}else{handlerFiltersRender(a)}return true}function handlerFilterAppend(a){if(DEBUG){console.log("function:handlerFilterAppend")}if(a instanceof classObject){return false}firstfield=a.meta.filters[0]?a.meta.filters[0].field:null;if(!firstfield){handlerShowAlert("Не установлены поля для фильтров.");return false}newfilter={type:null,inverse:false,active:false,field:null,values:null,field_title:null,type_title:null,};if(!a.filters){a.filters=[]}a.filters.push(newfilter);html=TEMPLATES.filter({data:a,item:newfilter});$("#collection_filters_"+a.id+" table tbody").append(html);return html}function eventFilterAppend(){if(DEBUG){console.log("function:eventFilterAppend")}var b=$(this).data(),a=REGISTER[b.id];handlerFilterAppend(a);return true}function eventFilterRemove(){if(DEBUG){console.log("function:eventFilterRemove")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index;a.filters.splice(b,b+1);$("#collection_filters_"+a.id+" tr[data-filter_index="+b+"]").remove();handlerCollectionGet(a);if(!SETTINGS.local.filters){SETTINGS.local.filters={}}SETTINGS.local.filters[a.id]=a.filters;SETTINGS.save(null,"local");return true}function eventFilterChangeField(){if(DEBUG){console.log("function:eventFilterChangeField")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index,d=$(this).val();text=$(this).find("[value="+d+"]").text();a.filters[b].field=d;a.filters[b].field_title=text;handlerFilterChangeActive(a,b,false);$("#collection_filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]").html("");if(!d){$("#collection_filters_"+a.id+" [data-action=filter_change_active][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-action=filter_change_inverse][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]").html("");return true}$("#collection_filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").removeAttr("disabled");return true}function eventFilterChangeType(){if(DEBUG){console.log("function:eventFilterChangeType")}var e=$(this).data(),a=REGISTER[e.id],b=e.filter_index,f=$(this).val();text=$(this).find("[value="+f+"]").text();a.filters[b].type=f;a.filters[b].type_title=text;handlerFilterChangeActive(a,b,false);if(!f){$("#collection_filters_"+a.id+" [data-action=filter_change_active][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-action=filter_change_inverse][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]").html("");handlerCollectionGet(a);return true}$("#collection_filters_"+a.id+" [data-action=filter_change_active][data-filter_index="+b+"]").removeAttr("disabled");$("#collection_filters_"+a.id+" [data-action=filter_change_inverse][data-filter_index="+b+"]").removeAttr("disabled");var c=TEMPLATES.filter_values({data:a,index:b}),d=$("#collection_filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]");if(a.filters[b].type!="blank"){d.html(c);if(a.filters[b].type=="range"){d.append(c)}}return true}function handlerFilterChangeActive(a,b,c){if(DEBUG){console.log("function:handlerFilterChangeActive")}a.filters[b].active=c;return true}function eventFilterChangeActive(){if(DEBUG){console.log("function:eventFilterChangeActive")}var d=$(this).data(),a=REGISTER[d.id],b=d.filter_index,c=!$(this).hasClass("active");handlerFilterChangeValues(a,b);handlerFilterChangeActive(a,b,c);if(c){$("#collection_filters_"+a.id+" [data-action=filter_change_field][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").attr("disabled","disabled")}else{$("#collection_filters_"+a.id+" [data-action=filter_change_field][data-filter_index="+b+"]").removeAttr("disabled");$("#collection_filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").removeAttr("disabled")}handlerCollectionGet(a);return true}function handlerFilterChangeInverse(a,c,b){if(DEBUG){console.log("function:handlerFilterChangeInverse")}a.filters[c].inverse=b;return true}function eventFilterChangeInverse(){if(DEBUG){console.log("function:eventFilterChangeInverse")}var d=$(this).data(),a=REGISTER[d.id],b=d.filter_index,c=!$(this).hasClass("active");handlerFilterChangeInverse(a,b,c);if(a.filters[b].active){handlerCollectionGet(a)}return true}function handlerFilterChangeValues(a,b){if(DEBUG){console.log("function:handlerFilterChangeValues")}var d=$("#collection_filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]"),c=d.find("[data-action=filter_change_values]");a.filters[b].values=[];a.filters[b].values_html=d.html();if(!SETTINGS.local.filters){SETTINGS.local.filters={}}SETTINGS.local.filters[a.id]=a.filters;SETTINGS.save(null,"local");$.each(c,function(e,f){a.filters[b].values.push($(f).val())});return true}function eventFilterChangeValues(){if(DEBUG){console.log("function:eventFilterChangeValues")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index,d=$(this).val();if(d){$(this).attr("value",d)}handlerFilterChangeActive(a,b,false);handlerFilterChangeValues(a,b);if(a.filters[b].active){handlerCollectionGet(a)}return true}function handlerFilterAppendValue(a,b){if(DEBUG){console.log("function:handlerFilterAppendValue")}var c=TEMPLATES.filter_values({data:a,index:b}),d=$("#collection_filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]");d.append(c);return true}function eventFilterAppendValue(){if(DEBUG){console.log("function:eventFilterAppendValue")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index;handlerFilterAppendValue(a,b);$(this).remove();return true}function eventCollectionPrint(){if(DEBUG){console.log("function:eventCollectionPrint")}var e=$(this).data(),b=REGISTER[e.id],d=true,c={method:"get_collection_report_url",report:e.report,model:b.model,query:b.query,order_by:b.order_by,fields:b.fields,filters:b.filters,},a=function(h,f,i){var g=h.data;window.open(g,"_blank")};jqxhr=new jsonAPI(c,a,"eventCollectionPrint() call jsonAPI()",d);return true}function eventObjectPrint(){if(DEBUG){console.log("function:eventObjectPrint")}var c=$(this).data(),a=REGISTER[c.id],b=true;args={method:"get_object_report_url",model:c.model,pk:c.pk,report:c.report,};cb=function(f,d,g){var e=f.data;window.open(e,"_blank")};jqxhr=new jsonAPI(args,cb,"eventObjectPrint() call jsonAPI()",b);return true}function eventWaitCancel(){if(DEBUG){console.log("function:eventWaitCancel")}ACTION_WAIT=null;return true}function eventWaitSubmit(){if(DEBUG){console.log("function:eventWaitSubmit")}ACTION_WAIT();ACTION_WAIT=null;return true}function handlerTemplates(){if(DEBUG){console.log("function:handlerTemplates")}TEMPLATES.alert=_.template($("#underscore-alert").html());TEMPLATES.menuApp=_.template($("#underscore-menu-app").html());TEMPLATES.collection=_.template($("#underscore-collection").html());TEMPLATES.layoutModel=_.template($("#underscore-layout-model").html());TEMPLATES.layoutSelector=_.template($("#underscore-layout-selector").html());TEMPLATES.layoutCompose=_.template($("#underscore-layout-compose").html());TEMPLATES.layoutObject=_.template($("#underscore-layout-object").html());TEMPLATES.layoutDefault=_.template($("#underscore-layout-default").html());TEMPLATES.tab=_.template($("#underscore-tab").html());TEMPLATES.modal=_.template($("#underscore-modal").html());TEMPLATES.modalFooter=_.template($("#underscore-modal-footer").html());TEMPLATES.filter=_.template($("#underscore-filter").html());TEMPLATES.filters=_.template($("#underscore-filters").html());TEMPLATES.filter_values=_.template($("#underscore-filter-values").html());return true}function handlerBindinds(){if(DEBUG){console.log("function:handlerBindinds")}$("body").on("click",'button.close[data-dismiss="alert"]',function(){$("#alert-place").css("z-index","-1000")});$("body").on("click","tr[data-pk]",eventRowClick);$("#menu-app li[class!=disabled]").on("click","a",eventTabOpen);$("#main-tab").on("click","button.close[data-id]",eventTabClose);handlerTabRestore();$("body").on("keyup","[data-action=collection_search]",eventCollectionSearch);$("body").on("change","[data-action=collection_search]",eventCollectionSearch);$("body").on("click","[data-action=collection_search_refresh]",eventCollectionSearchRefresh);$("body").on("click","[data-action=collection_count]",eventCollectionCount);$("body").on("change","[data-action=collection_page]",eventCollectionPage);$("body").on("click","[data-action=collection_page]",eventCollectionPage);$("body").on("click","th.sorted",eventCollectionSorted);$("body").on("click","[data-action=object_open]",eventObjectOpen);$("body").on("click","[data-action=object_copy]",eventObjectCopy);$("body").on("click","[data-action=object_clone]",eventObjectClone);$("body").on("click","[data-action=object_add]",eventObjectAdd);$("body").on("click","[data-action=object_add_m2m]",{m2m:true},eventObjectAdd);$("body").on("click","[data-action=object_delete]",eventObjectDelete);$("body").on("click","[data-action=object_delete_m2m]",{m2m:true},eventObjectDelete);$("body").on("keyup","[data-action=object_change]",eventObjectChange);$("body").on("change","[data-action=object_change]",eventObjectChange);$("body").on("click","[data-action=object_reset]",eventObjectReset);$("body").on("click","[data-action=object_save]",eventObjectSave);$("body").on("click","[data-action=object_select]",eventObjectSelect);$("#modal").on("click","[data-action=selector_append]",{close:false},eventSelectorSubmit);$("#modal").on("click","[data-action=selector_submit]",{close:true},eventSelectorSubmit);$("#modal").on("click","[data-action=wait_cancel]",eventWaitCancel);$("#modal").on("click","[data-action=wait_submit]",eventWaitSubmit);$("body").on("click","[data-action=field_clear]",eventFieldClear);$("body").on("click","[data-action=file_field_clear]",{file:true},eventFieldClear);$("body").on("click","[data-action=field_select]",eventFieldSelect);$("body").on("click","[data-action=file_field_select]",{file:true},eventFieldSelect);$("body").on("click","[data-toggle=checkboxes]",handlerSelectAllToggle);$("body").on("click","[data-action=collection_filters]",eventFilters);$("body").on("click","[data-action=filter_append]",eventFilterAppend);$("body").on("click","[data-action=filter_remove]",eventFilterRemove);$("body").on("click","[data-action=filter_change_field]",eventFilterChangeField);$("body").on("click","[data-action=filter_change_type]",eventFilterChangeType);$("body").on("click","[data-action=filter_change_inverse]",eventFilterChangeInverse);$("body").on("click","[data-action=filter_change_active]",eventFilterChangeActive);$("body").on("click","[data-action=filter_change_values]",eventFilterChangeValues);$("body").on("change","[data-action=filter_change_values]",eventFilterChangeValues);$("body").on("click","[data-action=filter_append_value]",eventFilterAppendValue);$("body").on("click","[data-action=collection_print]",eventCollectionPrint);$("body").on("click","[data-action=object_print]",eventObjectPrint);return true}function datetimeLocale(b){var a=$.dateParser(b);if(a){addzero=function(c){if(c<10){return"0"+c}return c};console.log(a);year=a.getFullYear();month=addzero(a.getMonth()+1);day=addzero(a.getDate());hours=addzero(a.getHours());minutes=addzero(a.getMinutes());seconds=addzero(a.getSeconds());return year+"-"+month+"-"+day+"T"+hours+":"+minutes+":"+seconds}return b}$(document).ready(function(a){if(DEBUG){console.log("function:$(document).ready")}handlerTemplates();a("#menu-app").hide();a("#menu-func").hide();handlerMenuAppLoad();window.SETTINGS=new classSettings();a("alert").alert();a(".dropdown-toggle").dropdown();if(SETTINGS.init().ready){a("#search").focus();handlerBindinds();handlerFiltersFromSettings()}else{console.log("ОШИБКА! Загрузка настроек не удалась.")}moment.lang(a("html").attr("lang"))});