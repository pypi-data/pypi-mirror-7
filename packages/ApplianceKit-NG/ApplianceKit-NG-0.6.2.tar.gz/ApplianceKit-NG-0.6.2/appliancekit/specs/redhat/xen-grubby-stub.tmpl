#!/bin/sh
#
# File: xen-grubby-stub
# Purpose: Build a grub configuration using grubby (and a stub file) in pre-image phase.
#
# Copyright (c) 2012, 2013 TortoiseLabs LLC
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# This software is provided 'as is' and without any warranty, express or
# implied. In no event shall the authors be liable for any damages arising
# from the use of this software.
#

# Strict error handling.
set +e

OS_REL=`cat /etc/redhat-release`
echo "OS release: $OS_REL"

for kernel in `ls /boot/vmlinuz-*`; do
	bn=`basename $kernel`
	ver=`echo $bn | cut -d- -f2-`

	echo "Found kernel version: $ver"

	echo "title $OS_REL ($ver)" >> /boot/grub/menu.lst
	echo "	root (hd0)" >> /boot/grub/menu.lst
	echo "	kernel /boot/vmlinuz-$ver root=/dev/xvda1 ro" >> /boot/grub/menu.lst
	echo "	initrd /boot/initramfs-$ver.img" >> /boot/grub/menu.lst
done
