

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Theory of Operation &mdash; Manuel Documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Manuel Documentation" href="index.html" />
    <link rel="next" title="FIT Table Example" href="table-example.html" />
    <link rel="prev" title="Manuel" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="table-example.html" title="FIT Table Example"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Manuel"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Manuel Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="theory-of-operation">
<span id="id1"></span><h1>Theory of Operation<a class="headerlink" href="#theory-of-operation" title="Permalink to this headline">¶</a></h1>
<p>Manuel parses documents (tests), evaluates their contents, then formats the
result of the evaluation.  The functionality is accessed via the <tt class="xref py py-mod docutils literal"><span class="pre">manuel</span></tt>
package.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">manuel</span>
</pre></div>
</div>
<div class="section" id="parsing">
<h2>Parsing<a class="headerlink" href="#parsing" title="Permalink to this headline">¶</a></h2>
<p>Manuel operates on Documents.  Each Document is created from a string
containing one or more lines.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">source</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">This is our document, it has several lines.</span>
<span class="gp">... </span><span class="s">one: 1, 2, 3</span>
<span class="gp">... </span><span class="s">two: 4, 5, 7</span>
<span class="gp">... </span><span class="s">three: 3, 5, 1</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
<p>For example purposes we will create a type of test that consists of a sequence
of numbers. Lets create a NumbersTest object to represent the parsed list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">NumbersTest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">numbers</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span> <span class="o">=</span> <span class="n">numbers</span>
</pre></div>
</div>
<p>The Document is divided into one or more regions.  Each region is a distinct
&#8220;chunk&#8221; of the document and will be acted uppon in later (post-parsing) phases.
Initially the Document is made up of a single element, the source string.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">source</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">]</span>
<span class="go">[&#39;This is our document, it has several lines.\none: 1, 2, 3\ntwo: 4, 5, 7\nthree: 3, 5, 1\n&#39;]</span>
</pre></div>
</div>
<p>The Document offers a &#8220;find_regions&#8221; method to assist in locating the portions
of the document a particular parser is interested in.  Given a regular
expression (either as a string, or compiled), it will return &#8220;region&#8221; objects
that contain the matched source text, the line number (1 based) the region
begins at, as well as the associated re.Match object.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">re</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">numbers_test_finder</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s">r&#39;^(?P&lt;description&gt;.*?): (?P&lt;numbers&gt;(\d+,?[ ]?)+)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">regions</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">find_regions</span><span class="p">(</span><span class="n">numbers_test_finder</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">regions</span>
<span class="go">[&lt;manuel.Region object at 0x...&gt;,</span>
<span class="go"> &lt;manuel.Region object at 0x...&gt;,</span>
<span class="go"> &lt;manuel.Region object at 0x...&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span>
<span class="go">&#39;one: 1, 2, 3\n&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">)</span>
<span class="go">&#39;one&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;numbers&#39;</span><span class="p">)</span>
<span class="go">&#39;1, 2, 3&#39;</span>
</pre></div>
</div>
<p>If given two regular expressions find_regions will use the first to identify
the begining of a region and the second to identify the end.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">region</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">find_regions</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^one:.*$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^three:.*$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">region</span><span class="o">.</span><span class="n">lineno</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
<span class="go">one: 1, 2, 3</span>
<span class="go">two: 4, 5, 7</span>
<span class="go">three: 3, 5, 1</span>
</pre></div>
</div>
<p>Also, instead of just a &#8220;start_match&#8221; attribute, the region will have
start_match and end_match attributes.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">region</span><span class="o">.</span><span class="n">start_match</span>
<span class="go">&lt;_sre.SRE_Match object...&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">region</span><span class="o">.</span><span class="n">end_match</span>
<span class="go">&lt;_sre.SRE_Match object...&gt;</span>
</pre></div>
</div>
<p>Regions must always consist of whole lines.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">find_regions</span><span class="p">(</span><span class="s">&#39;1, 2, 3&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
    <span class="o">...</span>
<span class="gr">ValueError</span>: <span class="n">Regions must start at the begining of a line.</span>
</pre></div>
</div>
<p>Now we can register a parser that will identify the regions we&#8217;re interested in
and create NumbersTest objects from the source text.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">find_regions</span><span class="p">(</span><span class="n">numbers_test_finder</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">description</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">start_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">numbers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
<span class="gp">... </span>            <span class="nb">int</span><span class="p">,</span> <span class="n">region</span><span class="o">.</span><span class="n">start_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;numbers&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)))</span>
<span class="gp">... </span>        <span class="n">test</span> <span class="o">=</span> <span class="n">NumbersTest</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">numbers</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">document</span><span class="o">.</span><span class="n">claim_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">region</span><span class="o">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">test</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">parse</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">source</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">]</span>
<span class="go">[&#39;This is our document, it has several lines.\n&#39;,</span>
<span class="go"> &#39;one: 1, 2, 3\n&#39;,</span>
<span class="go"> &#39;two: 4, 5, 7\n&#39;,</span>
<span class="go"> &#39;three: 3, 5, 1\n&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">parsed</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">]</span>
<span class="go">[None,</span>
<span class="go"> &lt;NumbersTest object at 0x...&gt;,</span>
<span class="go"> &lt;NumbersTest object at 0x...&gt;,</span>
<span class="go"> &lt;NumbersTest object at 0x...&gt;]</span>
</pre></div>
</div>
</div>
<div class="section" id="evaluation">
<h2>Evaluation<a class="headerlink" href="#evaluation" title="Permalink to this headline">¶</a></h2>
<p>After a document has been parsed the resulting tests are evaluated.  Unlike
parsing and formatting, evaluation is done one region at a time, in the order
that the regions appear in the document.  Lets define a function to evaluate
NumberTests.  The function determines whether or not the numbers are in sorted
order and records the result along with the description of the list of numbers.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">NumbersResult</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">passed</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passed</span> <span class="o">=</span> <span class="n">passed</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">globs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">parsed</span><span class="p">,</span> <span class="n">NumbersTest</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">parsed</span>
    <span class="n">passed</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">numbers</span><span class="p">)</span> <span class="o">==</span> <span class="n">test</span><span class="o">.</span><span class="n">numbers</span>
    <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span> <span class="o">=</span> <span class="n">NumbersResult</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">passed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="formatting">
<h2>Formatting<a class="headerlink" href="#formatting" title="Permalink to this headline">¶</a></h2>
<p>Once the evaluation phase is completed the results are formatted.  You guessed
it: Manuel provides a method for formatting results.  We&#8217;ll build one to format
a message about whether or not our lists of numbers are sorted properly.  A
formatting function returns None when it has no output, or a string otherwise.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">evaluated</span><span class="p">,</span> <span class="n">NumbersResult</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">passed</span><span class="p">:</span>
            <span class="n">region</span><span class="o">.</span><span class="n">formatted</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&quot;the numbers aren&#39;t in sorted order: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">numbers</span><span class="p">)))</span>
</pre></div>
</div>
<p>Since one of the test cases failed we get an appropriate message out of the
formatter.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">format</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">formatted</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">]</span>
<span class="go">[None, None, None, &quot;the numbers aren&#39;t in sorted order: 3, 5, 1\n&quot;]</span>
</pre></div>
</div>
</div>
<div class="section" id="manuel-objects">
<h2>Manuel Objects<a class="headerlink" href="#manuel-objects" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ll want to use these parse, evaluate, and format functions later, so we
bundle them together into a Manuel object.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">sorted_numbers_manuel</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Manuel</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">parsers</span><span class="o">=</span><span class="p">[</span><span class="n">parse</span><span class="p">],</span> <span class="n">evaluaters</span><span class="o">=</span><span class="p">[</span><span class="n">evaluate</span><span class="p">],</span> <span class="n">formatters</span><span class="o">=</span><span class="p">[</span><span class="n">format</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="doctests">
<h2>Doctests<a class="headerlink" href="#doctests" title="Permalink to this headline">¶</a></h2>
<p>We can use Manuel to run doctests.  Let&#8217;s create a simple doctest to
demonstrate with.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">source</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;This is my</span>
<span class="gp">... </span><span class="s">doctest.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; 1 + 1</span>
<span class="gp">... </span><span class="s">    2</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="xref py py-mod docutils literal"><span class="pre">manuel.doctest</span></tt> module has handlers for the various phases.  First
we&#8217;ll look at parsing.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">manuel.doctest</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">doctest</span><span class="o">.</span><span class="n">Manuel</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">parse_with</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">((</span><span class="n">region</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">region</span><span class="o">.</span><span class="n">parsed</span> <span class="ow">or</span> <span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
<span class="go">(1, &#39;This is my\ndoctest.\n\n&#39;)</span>
<span class="go">(4, &lt;doctest.Example ...&gt;)</span>
</pre></div>
</div>
<p>Now we can evaluate the examples.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">evaluate_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">((</span><span class="n">region</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span> <span class="ow">or</span> <span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
<span class="go">(1, &#39;This is my\ndoctest.\n\n&#39;)</span>
<span class="go">(4, &lt;manuel.doctest.DocTestResult ...&gt;)</span>
</pre></div>
</div>
<p>And format the results.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">format_with</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">()</span>
<span class="go">&#39;&#39;</span>
</pre></div>
</div>
<p>Oh, we didn&#8217;t have any failing tests, so we got no output.  Let&#8217;s try again
with a failing test.  This time we&#8217;ll use the &#8220;process_with&#8221; function to
simplify things.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;This is my</span>
<span class="gp">... </span><span class="s">doctest.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; 1 + 1</span>
<span class="gp">... </span><span class="s">    42</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="go">File &quot;&lt;memory&gt;&quot;, line 4, in &lt;memory&gt;</span>
<span class="go">Failed example:</span>
<span class="go">    1 + 1</span>
<span class="go">Expected:</span>
<span class="go">    42</span>
<span class="go">Got:</span>
<span class="go">    2</span>
</pre></div>
</div>
<div class="section" id="alternate-doctest-parsers">
<h3>Alternate doctest parsers<a class="headerlink" href="#alternate-doctest-parsers" title="Permalink to this headline">¶</a></h3>
<p>You can pass an alternate doctest parser to manuel.doctest.Manuel to
customize how examples are parsed.  Here&#8217;s an example that changes the
example start string from &#8220;&gt;&gt;&gt;&#8221; to &#8220;py&gt;&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">doctest</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">DocTestPyParser</span><span class="p">(</span><span class="n">doctest</span><span class="o">.</span><span class="n">DocTestParser</span><span class="p">):</span>
<span class="gp">... </span>   <span class="n">_EXAMPLE_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;&#39;&#39;</span>
<span class="gp">... </span><span class="s">       (?P&lt;source&gt;</span>
<span class="gp">... </span><span class="s">            (?:^(?P&lt;indent&gt; [ ]*) py&gt;    .*)    # PS1 line</span>
<span class="gp">... </span><span class="s">           (?:\n           [ ]*  \.\.\. .*)*)  # PS2 lines</span>
<span class="gp">... </span><span class="s">       \n?</span>
<span class="gp">... </span><span class="s">       (?P&lt;want&gt; (?:(?![ ]*$)    # Not a blank line</span>
<span class="gp">... </span><span class="s">                    (?![ ]*py&gt;)  # Not a line starting with PS1</span>
<span class="gp">... </span><span class="s">                    .*$\n?       # But any other line</span>
<span class="gp">... </span><span class="s">                 )*)</span>
<span class="gp">... </span><span class="s">       &#39;&#39;&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">doctest</span><span class="o">.</span><span class="n">Manuel</span><span class="p">(</span><span class="n">parser</span><span class="o">=</span><span class="n">DocTestPyParser</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;This is my</span>
<span class="gp">... </span><span class="s">doctest.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    py&gt; 1 + 1</span>
<span class="gp">... </span><span class="s">    42</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="go">File &quot;&lt;memory&gt;&quot;, line 4, in &lt;memory&gt;</span>
<span class="go">Failed example:</span>
<span class="go">    1 + 1</span>
<span class="go">Expected:</span>
<span class="go">    42</span>
<span class="go">Got:</span>
<span class="go">    2</span>
</pre></div>
</div>
</div>
<div class="section" id="multiple-doctest-parsers">
<h3>Multiple doctest parsers<a class="headerlink" href="#multiple-doctest-parsers" title="Permalink to this headline">¶</a></h3>
<p>You may use several doctest parsers in the same session, for example,
to support shell commands and Python code in the same document.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">manuel</span><span class="o">.</span><span class="n">doctest</span><span class="o">.</span><span class="n">Manuel</span><span class="p">(</span><span class="n">parser</span><span class="o">=</span><span class="n">DocTestPyParser</span><span class="p">())</span> <span class="o">+</span>
<span class="gp">... </span>     <span class="n">manuel</span><span class="o">.</span><span class="n">doctest</span><span class="o">.</span><span class="n">Manuel</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    py&gt; i = 0</span>
<span class="gp">... </span><span class="s">    py&gt; i += 1</span>
<span class="gp">... </span><span class="s">    py&gt; i</span>
<span class="gp">... </span><span class="s">    1</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; j = 0</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; j += 1</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; j</span>
<span class="gp">... </span><span class="s">    1</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="globals">
<h2>Globals<a class="headerlink" href="#globals" title="Permalink to this headline">¶</a></h2>
<p>Even though each region is parsed into its own object, state is still shared
between them.  Each region of the document is executed in order so state
changes made by earlier evaluaters are available to the current evaluator.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; x = 1</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">A little prose to separate the examples.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; x</span>
<span class="gp">... </span><span class="s">    1</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Imported modules are added to the global namespace as well.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; import string</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">A little prose to separate the examples.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; string.digits</span>
<span class="gp">... </span><span class="s">    &#39;0123456789&#39;</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="combining-test-types">
<h2>Combining Test Types<a class="headerlink" href="#combining-test-types" title="Permalink to this headline">¶</a></h2>
<p>Now that we have both doctests and the silly &#8220;sorted numbers&#8221; tests, let&#8217;s
create a single document that has both.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">We can have a list of numbers...</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    a very nice list: 3, 6, 2</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">... and we can test Python.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; 1 + 1</span>
<span class="gp">... </span><span class="s">    42</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Obviously both of those tests will fail, but first we have to configure Manuel
to understand both test types.  We&#8217;ll start with a doctest configuration and add
the number list testing on top.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">doctest</span><span class="o">.</span><span class="n">Manuel</span><span class="p">()</span>
</pre></div>
</div>
<p>Since we already have a Manuel instance configured for our &#8220;sorted numbers&#8221;
tests, we can extend the built-in doctest configuration with it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">+=</span> <span class="n">sorted_numbers_manuel</span>
</pre></div>
</div>
<p>Now we can process our source that combines both types of tests and see what
we get.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
</pre></div>
</div>
<p>The document was parsed and has a mixture of prose and parsed doctests and
number tests.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span><span class="p">((</span><span class="n">region</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">region</span><span class="o">.</span><span class="n">parsed</span> <span class="ow">or</span> <span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
<span class="go">(1, &#39;\nWe can have a list of numbers...\n\n&#39;)</span>
<span class="go">(4, &lt;NumbersTest object at 0x...&gt;)</span>
<span class="go">(5, &#39;\n... and we can test Python.\n\n&#39;)</span>
<span class="go">(8, &lt;doctest.Example ...&gt;)</span>
<span class="go">(10, &#39;\n&#39;)</span>
</pre></div>
</div>
<p>We can look at the formatted output to see that each of the two tests failed.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">formatted</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
<span class="gp">... </span>        <span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">formatted</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="go">----------------------------------------------------------------------</span>
<span class="go">the numbers aren&#39;t in sorted order: 3, 6, 2</span>
<span class="go">----------------------------------------------------------------------</span>
<span class="go">File &quot;&lt;memory&gt;&quot;, line 8, in &lt;memory&gt;</span>
<span class="go">Failed example:</span>
<span class="go">    1 + 1</span>
<span class="go">Expected:</span>
<span class="go">    42</span>
<span class="go">Got:</span>
<span class="go">    2</span>
</pre></div>
</div>
</div>
<div class="section" id="priorities">
<h2>Priorities<a class="headerlink" href="#priorities" title="Permalink to this headline">¶</a></h2>
<p>Some functionality requires that code be called early or late in a phase.  The
&#8220;timing&#8221; decorator allows either EARLY or LATE to be specified.</p>
<p>Early functions are run first (in arbitrary order), then functions with no
specified timing, then the late functions are called (again in arbitrary
order).  This function also demonstrates the &#8220;copy&#8221; method of Region objects
and the &#8220;insert_region_before&#8221; and &#8220;insert_region_after&#8221; methods of Documents.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nd">@manuel.timing</span><span class="p">(</span><span class="n">manuel</span><span class="o">.</span><span class="n">LATE</span><span class="p">)</span>
<span class="gp">... </span><span class="k">def</span> <span class="nf">cloning_parser</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">to_be_cloned</span> <span class="o">=</span> <span class="bp">None</span>
<span class="gp">... </span>    <span class="c"># find the region to clone</span>
<span class="gp">... </span>    <span class="n">document_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document_iter</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">parsed</span><span class="p">:</span>
<span class="gp">... </span>            <span class="k">continue</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;my clone:&#39;</span><span class="p">):</span>
<span class="gp">... </span>            <span class="n">to_be_cloned</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">advance_iterator</span><span class="p">(</span><span class="n">document_iter</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="gp">... </span>            <span class="k">break</span>
<span class="gp">... </span>    <span class="c"># if we found the region to cloned, do so</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">to_be_cloned</span><span class="p">:</span>
<span class="gp">... </span>        <span class="c"># make a copy since we&#39;ll be mutating the document</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">parsed</span><span class="p">:</span>
<span class="gp">... </span>                <span class="k">continue</span>
<span class="gp">... </span>            <span class="k">if</span> <span class="s">&#39;clone before *here*&#39;</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
<span class="gp">... </span>                <span class="n">clone</span> <span class="o">=</span> <span class="n">to_be_cloned</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="gp">... </span>                <span class="n">clone</span><span class="o">.</span><span class="n">provenance</span> <span class="o">=</span> <span class="s">&#39;cloned to go before&#39;</span>
<span class="gp">... </span>                <span class="n">document</span><span class="o">.</span><span class="n">insert_region_before</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span>
<span class="gp">... </span>            <span class="k">if</span> <span class="s">&#39;clone after *here*&#39;</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
<span class="gp">... </span>                <span class="n">clone</span> <span class="o">=</span> <span class="n">to_be_cloned</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="gp">... </span>                <span class="n">clone</span><span class="o">.</span><span class="n">provenance</span> <span class="o">=</span> <span class="s">&#39;cloned to go after&#39;</span>
<span class="gp">... </span>                <span class="n">document</span><span class="o">.</span><span class="n">insert_region_after</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="n">cloning_parser</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">source</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">This is my clone:</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">clone: 1, 2, 3</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">I want some copies of my clone.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">For example, I&#39;d like a clone before *here*.</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">I&#39;d also like a clone after *here*.</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">[(</span><span class="n">r</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">provenance</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">document</span><span class="p">]</span>
<span class="go">[(&#39;This is my clone:\n\n&#39;, None),</span>
<span class="go"> (&#39;clone: 1, 2, 3\n&#39;, None),</span>
<span class="go"> (&#39;clone: 1, 2, 3\n&#39;, &#39;cloned to go before&#39;),</span>
<span class="go"> (&quot;\nI want some copies of my clone.\n\nFor example, I&#39;d like a clone before *here*.\n\nI&#39;d also like a clone after *here*.\n&quot;, None),</span>
<span class="go"> (&#39;clone: 1, 2, 3\n&#39;, &#39;cloned to go after&#39;)]</span>
</pre></div>
</div>
</div>
<div class="section" id="enhancing-existing-manuels">
<h2>Enhancing Existing Manuels<a class="headerlink" href="#enhancing-existing-manuels" title="Permalink to this headline">¶</a></h2>
<p>Lets say that you&#8217;d like failed doctest examples to give more information about
what went wrong.</p>
<p>First we&#8217;ll create an evaluater that includes pertinant variable binding
information on failures.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">doctest</span>

<span class="k">def</span> <span class="nf">informative_evaluater</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">globs</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">parsed</span><span class="p">,</span> <span class="n">doctest</span><span class="o">.</span><span class="n">Example</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">getvalue</span><span class="p">():</span>
        <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">globs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">region</span><span class="o">.</span><span class="n">parsed</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">globs</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Additional Information:&#39;</span><span class="p">)</span>
            <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>To do that we&#8217;ll start with an instance of <tt class="xref py py-mod docutils literal"><span class="pre">manuel.doctest.Manuel</span></tt> and add
in our additional functionality.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">doctest</span><span class="o">.</span><span class="n">Manuel</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">add_evaluater</span><span class="p">(</span><span class="n">informative_evaluater</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we&#8217;ll create a document that includes a failing test.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">Set up some variable bindings:</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; a = 1</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; b = 2</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; c = 3</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">Make an assertion:</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; a + b</span>
<span class="gp">... </span><span class="s">    5</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When we run the document through our Manuel instance, we see the additional
information.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="go">File &quot;&lt;memory&gt;&quot;, line 10, in &lt;memory&gt;</span>
<span class="go">Failed example:</span>
<span class="go">    a + b</span>
<span class="go">Expected:</span>
<span class="go">    5</span>
<span class="go">Got:</span>
<span class="go">    3</span>
<span class="go">Additional Information:</span>
<span class="go">    a = 1</span>
<span class="go">    b = 2</span>
</pre></div>
</div>
<p>Note how only the referenced variable bindings are displayed (i.e., &#8220;c&#8221; is not
listed).  That&#8217;s pretty nice, but the way interesting variables are identified
is a bit of a hack.  For example, if a variable&#8217;s name just happens to appear
in the source (in a comment for example), it will be included in the output:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s">Set up some variable bindings:</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; a = 1</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; b = 2</span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; c = 3</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">Make an assertion:</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">    &gt;&gt;&gt; a + b # doesn&#39;t mention &quot;c&quot;</span>
<span class="gp">... </span><span class="s">    5</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="go">File &quot;&lt;memory&gt;&quot;, line 10, in &lt;memory&gt;</span>
<span class="go">Failed example:</span>
<span class="go">    a + b # doesn&#39;t mention &quot;c&quot;</span>
<span class="go">Expected:</span>
<span class="go">    5</span>
<span class="go">Got:</span>
<span class="go">    3</span>
<span class="go">Additional Information:</span>
<span class="go">    a = 1</span>
<span class="go">    b = 2</span>
<span class="go">    c = 3</span>
</pre></div>
</div>
<p>Instead of a text-based apprach, let&#8217;s use the built-in tokenize module to more
robustly identify referenced variables.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">token</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">tokenize</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">informative_evaluater_2</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">globs</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">parsed</span><span class="p">,</span> <span class="n">doctest</span><span class="o">.</span><span class="n">Example</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">getvalue</span><span class="p">():</span>
<span class="gp">... </span>        <span class="nb">vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="gp">... </span>        <span class="n">reader</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">ttype</span><span class="p">,</span> <span class="n">tval</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">NAME</span><span class="p">:</span>
<span class="gp">... </span>                <span class="nb">vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tval</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">globs</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
<span class="gp">... </span>                <span class="n">info</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">globs</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
<span class="gp">...</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
<span class="gp">... </span>            <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Additional Information:&#39;</span><span class="p">)</span>
<span class="gp">... </span>            <span class="n">region</span><span class="o">.</span><span class="n">evaluated</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">m</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">doctest</span><span class="o">.</span><span class="n">Manuel</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">m</span><span class="o">.</span><span class="n">add_evaluater</span><span class="p">(</span><span class="n">informative_evaluater_2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now when we have a failure, only the genuinely referenced variables will be
included in the debugging information.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">document</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">Document</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">document</span><span class="o">.</span><span class="n">process_with</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="p">{})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">six</span><span class="o">.</span><span class="n">print_</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">formatted</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="go">File &quot;&lt;memory&gt;&quot;, line 10, in &lt;memory&gt;</span>
<span class="go">Failed example:</span>
<span class="go">    a + b # doesn&#39;t mention &quot;c&quot;</span>
<span class="go">Expected:</span>
<span class="go">    5</span>
<span class="go">Got:</span>
<span class="go">    3</span>
<span class="go">Additional Information:</span>
<span class="go">    a = 1</span>
<span class="go">    b = 2</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-test-cases">
<h2>Defining Test Cases<a class="headerlink" href="#defining-test-cases" title="Permalink to this headline">¶</a></h2>
<p>If you want parts of a document to be accessable individually as test cases (to
be able to run just a particular part of a document, for example), a parser can
create a region that marks the beginning of a new test case.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">new_test_case_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^.. new-test-case: \w+&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">find_regions</span><span class="p">(</span><span class="n">new_test_case_regex</span><span class="p">):</span>
        <span class="n">document</span><span class="o">.</span><span class="n">claim_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">start_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">region</span><span class="o">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="n">manuel</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">TestCaseMarker</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>
<p>XXX finish this section</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Theory of Operation</a><ul>
<li><a class="reference internal" href="#parsing">Parsing</a></li>
<li><a class="reference internal" href="#evaluation">Evaluation</a></li>
<li><a class="reference internal" href="#formatting">Formatting</a></li>
<li><a class="reference internal" href="#manuel-objects">Manuel Objects</a></li>
<li><a class="reference internal" href="#doctests">Doctests</a><ul>
<li><a class="reference internal" href="#alternate-doctest-parsers">Alternate doctest parsers</a></li>
<li><a class="reference internal" href="#multiple-doctest-parsers">Multiple doctest parsers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#globals">Globals</a></li>
<li><a class="reference internal" href="#combining-test-types">Combining Test Types</a></li>
<li><a class="reference internal" href="#priorities">Priorities</a></li>
<li><a class="reference internal" href="#enhancing-existing-manuels">Enhancing Existing Manuels</a></li>
<li><a class="reference internal" href="#defining-test-cases">Defining Test Cases</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Manuel</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="table-example.html"
                        title="next chapter">FIT Table Example</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/README.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="table-example.html" title="FIT Table Example"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Manuel"
             >previous</a> |</li>
        <li><a href="index.html">Manuel Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright Benji York.
      Last updated on 2014-07-15.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>