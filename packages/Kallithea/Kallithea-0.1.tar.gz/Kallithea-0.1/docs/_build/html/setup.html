<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Setup &mdash; Kallithea 0 documentation</title>

    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Kallithea 0 documentation" href="index.html" />
    <link rel="next" title="Upgrade" href="upgrade.html" />
    <link rel="prev" title="Step by step Installation for Windows" href="installation_win.html" />
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="upgrade.html" title="Upgrade"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="installation_win.html" title="Step by step Installation for Windows"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Kallithea 0 documentation</a> &raquo;</li>
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">

  <div class="section" id="setup">
<span id="id1"></span><h1>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setting-up-kallithea">
<h2>Setting up Kallithea<a class="headerlink" href="#setting-up-kallithea" title="Permalink to this headline">¶</a></h2>
<p>First, you will need to create a Kallithea configuration file. Run the
following command to do this:</p>
<div class="highlight-python"><div class="highlight"><pre>paster make-config Kallithea production.ini
</pre></div>
</div>
<ul class="simple">
<li>This will create the file <cite>production.ini</cite> in the current directory. This
configuration file contains the various settings for Kallithea, e.g proxy
port, email settings, usage of static files, cache, celery settings and
logging.</li>
</ul>
<p>Next, you need to create the databases used by Kallithea. I recommend that you
use postgresql or sqlite (default). If you choose a database other than the
default ensure you properly adjust the db url in your production.ini
configuration file to use this other database. Kallithea currently supports
postgresql, sqlite and mysql databases. Create the database by running
the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>paster setup-db production.ini
</pre></div>
</div>
<p>This will prompt you for a &#8220;root&#8221; path. This &#8220;root&#8221; path is the location where
Kallithea will store all of its repositories on the current machine. After
entering this &#8220;root&#8221; path <tt class="docutils literal"><span class="pre">setup-db</span></tt> will also prompt you for a username
and password for the initial admin account which <tt class="docutils literal"><span class="pre">setup-db</span></tt> sets
up for you.</p>
<p>setup process can be fully automated, example for lazy:</p>
<div class="highlight-python"><div class="highlight"><pre>paster setup-db production.ini --user=nn --password=secret --email=nn@your.kallithea.server --repos=/home/nn/my_repos
</pre></div>
</div>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">setup-db</span></tt> command will create all of the needed tables and an
admin account. When choosing a root path you can either use a new empty
location, or a location which already contains existing repositories. If you
choose a location which contains existing repositories Kallithea will simply
add all of the repositories at the chosen location to it&#8217;s database.
(Note: make sure you specify the correct path to the root).</li>
<li>Note: the given path for <a class="reference external" href="http://mercurial.selenic.com/">mercurial</a> repositories <strong>must</strong> be write accessible
for the application. It&#8217;s very important since the Kallithea web interface
will work without write access, but when trying to do a push it will
eventually fail with permission denied errors unless it has write access.</li>
</ul>
<p>You are now ready to use Kallithea, to run it simply execute:</p>
<div class="highlight-python"><div class="highlight"><pre>paster serve production.ini
</pre></div>
</div>
<ul class="simple">
<li>This command runs the Kallithea server. The web app should be available at the
127.0.0.1:5000. This ip and port is configurable via the production.ini
file created in previous step</li>
<li>Use the admin account you created above when running <tt class="docutils literal"><span class="pre">setup-db</span></tt>
to login to the web app.</li>
<li>The default permissions on each repository is read, and the owner is admin.
Remember to update these if needed.</li>
<li>In the admin panel you can toggle ldap, anonymous, permissions settings. As
well as edit more advanced options on users and repositories</li>
</ul>
<p>Optionally users can create <cite>rcextensions</cite> package that extends Kallithea
functionality. To do this simply execute:</p>
<div class="highlight-python"><div class="highlight"><pre>paster make-rcext production.ini
</pre></div>
</div>
<p>This will create <cite>rcextensions</cite> package in the same place that your <cite>ini</cite> file
lives. With <cite>rcextensions</cite> it&#8217;s possible to add additional mapping for whoosh,
stats and add additional code into the push/pull/create/delete repo hooks.
For example for sending signals to build-bots such as jenkins.
Please see the <cite>__init__.py</cite> file inside <cite>rcextensions</cite> package
for more details.</p>
</div>
<div class="section" id="using-kallithea-with-ssh">
<h2>Using Kallithea with SSH<a class="headerlink" href="#using-kallithea-with-ssh" title="Permalink to this headline">¶</a></h2>
<p>Kallithea currently only hosts repositories using http and https. (The addition
of ssh hosting is a planned future feature.) However you can easily use ssh in
parallel with Kallithea. (Repository access via ssh is a standard &#8220;out of
the box&#8221; feature of <a class="reference external" href="http://mercurial.selenic.com/">mercurial</a> and you can use this to access any of the
repositories that Kallithea is hosting. See <a class="reference external" href="http://mercurial.selenic.com/wiki/PublishingRepositories">PublishingRepositories</a>)</p>
<p>Kallithea repository structures are kept in directories with the same name
as the project. When using repository groups, each group is a subdirectory.
This allows you to easily use ssh for accessing repositories.</p>
<p>In order to use ssh you need to make sure that your web-server and the users
login accounts have the correct permissions set on the appropriate directories.
(Note that these permissions are independent of any permissions you have set up
using the Kallithea web interface.)</p>
<p>If your main directory (the same as set in Kallithea settings) is for example
set to <strong>/home/hg</strong> and the repository you are using is named <cite>kallithea</cite>, then
to clone via ssh you should run:</p>
<div class="highlight-python"><div class="highlight"><pre>hg clone ssh://user@server.com/home/hg/kallithea
</pre></div>
</div>
<p>Using other external tools such as <a class="reference external" href="http://www.lshift.net/mercurial-server.html">mercurial-server</a> or using ssh key based
authentication is fully supported.</p>
<p>Note: In an advanced setup, in order for your ssh access to use the same
permissions as set up via the Kallithea web interface, you can create an
authentication hook to connect to the Kallithea db and runs check functions for
permissions against that.</p>
</div>
<div class="section" id="setting-up-whoosh-full-text-search">
<h2>Setting up Whoosh full text search<a class="headerlink" href="#setting-up-whoosh-full-text-search" title="Permalink to this headline">¶</a></h2>
<p>Starting from version 1.1 the whoosh index can be build by using the paster
command <tt class="docutils literal"><span class="pre">make-index</span></tt>. To use <tt class="docutils literal"><span class="pre">make-index</span></tt> you must specify the configuration
file that stores the location of the index. You may specify the location of the
repositories (<cite>&#8211;repo-location</cite>).  If not specified, this value is retrieved
from the Kallithea database.  This was required prior to 1.2.  Starting from
version 1.2 it is also possible to specify a comma separated list of
repositories (<cite>&#8211;index-only</cite>) to build index only on chooses repositories
skipping any other found in repos location</p>
<p>You may optionally pass the option <cite>-f</cite> to enable a full index rebuild. Without
the <cite>-f</cite> option, indexing will run always in &#8220;incremental&#8221; mode.</p>
<p>For an incremental index build use:</p>
<div class="highlight-python"><div class="highlight"><pre>paster make-index production.ini
</pre></div>
</div>
<p>For a full index rebuild use:</p>
<div class="highlight-python"><div class="highlight"><pre>paster make-index production.ini -f
</pre></div>
</div>
<p>building index just for chosen repositories is possible with such command:</p>
<div class="highlight-python"><div class="highlight"><pre>paster make-index production.ini --index-only=vcs,kallithea
</pre></div>
</div>
<p>In order to do periodical index builds and keep your index always up to date.
It&#8217;s recommended to do a crontab entry for incremental indexing.
An example entry might look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>/path/to/python/bin/paster make-index /path/to/kallithea/production.ini
</pre></div>
</div>
<p>When using incremental mode (the default) whoosh will check the last
modification date of each file and add it to be reindexed if a newer file is
available. The indexing daemon checks for any removed files and removes them
from index.</p>
<p>If you want to rebuild index from scratch, you can use the <cite>-f</cite> flag as above,
or in the admin panel you can check <cite>build from scratch</cite> flag.</p>
</div>
<div class="section" id="setting-up-ldap-support">
<h2>Setting up LDAP support<a class="headerlink" href="#setting-up-ldap-support" title="Permalink to this headline">¶</a></h2>
<p>Kallithea starting from version 1.1 supports ldap authentication. In order
to use LDAP, you have to install the <a class="reference external" href="http://www.python-ldap.org/">python-ldap</a> package. This package is
available via pypi, so you can install it by running</p>
<p>using easy_install:</p>
<div class="highlight-python"><div class="highlight"><pre>easy_install python-ldap
</pre></div>
</div>
<p>using pip:</p>
<div class="highlight-python"><div class="highlight"><pre>pip install python-ldap
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">python-ldap requires some certain libs on your system, so before installing
it check that you have at least <cite>openldap</cite>, and <cite>sasl</cite> libraries.</p>
</div>
<p>LDAP settings are located in admin-&gt;ldap section,</p>
<p>Here&#8217;s a typical ldap setup:</p>
<div class="highlight-python"><div class="highlight"><pre>Connection settings
Enable LDAP          = checked
Host                 = host.example.org
Port                 = 389
Account              = &lt;account&gt;
Password             = &lt;password&gt;
Connection Security  = LDAPS connection
Certificate Checks   = DEMAND

Search settings
Base DN              = CN=users,DC=host,DC=example,DC=org
LDAP Filter          = (&amp;(objectClass=user)(!(objectClass=computer)))
LDAP Search Scope    = SUBTREE

Attribute mappings
Login Attribute      = uid
First Name Attribute = firstName
Last Name Attribute  = lastName
E-mail Attribute     = mail
</pre></div>
</div>
<p>If your user groups are placed in a Organisation Unit (OU) structure the Search Settings configuration differs:</p>
<div class="highlight-python"><div class="highlight"><pre>Search settings
Base DN              = DC=host,DC=example,DC=org
LDAP Filter          = (&amp;(memberOf=CN=your user group,OU=subunit,OU=unit,DC=host,DC=example,DC=org)(objectClass=user))
LDAP Search Scope    = SUBTREE
</pre></div>
</div>
<dl class="docutils" id="enable-ldap">
<dt>Enable LDAP <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd>Whether to use LDAP for authenticating users.</dd>
</dl>
<dl class="docutils" id="ldap-host">
<dt>Host <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd>LDAP server hostname or IP address. Can be also a comma separated
list of servers to support LDAP fail-over.</dd>
</dl>
<dl class="docutils" id="port">
<dt>Port <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd>389 for un-encrypted LDAP, 636 for SSL-encrypted LDAP.</dd>
</dl>
<dl class="docutils" id="ldap-account">
<dt>Account <span class="classifier-delimiter">:</span> <span class="classifier">optional</span></dt>
<dd>Only required if the LDAP server does not allow anonymous browsing of
records.  This should be a special account for record browsing.  This
will require <a class="reference internal" href="#ldap-password">LDAP Password</a> below.</dd>
</dl>
<dl class="docutils" id="ldap-password">
<dt>Password <span class="classifier-delimiter">:</span> <span class="classifier">optional</span></dt>
<dd>Only required if the LDAP server does not allow anonymous browsing of
records.</dd>
</dl>
<dl class="docutils" id="enable-ldaps">
<dt>Connection Security <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd><p class="first">Defines the connection to LDAP server</p>
<dl class="last docutils">
<dt>No encryption</dt>
<dd>Plain non encrypted connection</dd>
<dt>LDAPS connection</dt>
<dd>Enable ldaps connection. It will likely require <a class="reference internal" href="#port">Port</a> to be set to
a different value (standard LDAPS port is 636). When LDAPS is enabled
then <a class="reference internal" href="#certificate-checks">Certificate Checks</a> is required.</dd>
<dt>START_TLS on LDAP connection</dt>
<dd>START TLS connection</dd>
</dl>
</dd>
</dl>
<dl class="docutils" id="certificate-checks">
<dt>Certificate Checks <span class="classifier-delimiter">:</span> <span class="classifier">optional</span></dt>
<dd><p class="first">How SSL certificates verification is handled - this is only useful when
<a class="reference internal" href="#enable-ldaps">Enable LDAPS</a> is enabled.  Only DEMAND or HARD offer full SSL security
while the other options are susceptible to man-in-the-middle attacks.  SSL
certificates can be installed to /etc/openldap/cacerts so that the
DEMAND or HARD options can be used with self-signed certificates or
certificates that do not have traceable certificates of authority.</p>
<dl class="last docutils">
<dt>NEVER</dt>
<dd>A serve certificate will never be requested or checked.</dd>
<dt>ALLOW</dt>
<dd>A server certificate is requested.  Failure to provide a
certificate or providing a bad certificate will not terminate the
session.</dd>
<dt>TRY</dt>
<dd>A server certificate is requested.  Failure to provide a
certificate does not halt the session; providing a bad certificate
halts the session.</dd>
<dt>DEMAND</dt>
<dd>A server certificate is requested and must be provided and
authenticated for the session to proceed.</dd>
<dt>HARD</dt>
<dd>The same as DEMAND.</dd>
</dl>
</dd>
</dl>
<dl class="docutils" id="base-dn">
<dt>Base DN <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd>The Distinguished Name (DN) where searches for users will be performed.
Searches can be controlled by <a class="reference internal" href="#ldap-filter">LDAP Filter</a> and <a class="reference internal" href="#ldap-search-scope">LDAP Search Scope</a>.</dd>
</dl>
<dl class="docutils" id="ldap-filter">
<dt>LDAP Filter <span class="classifier-delimiter">:</span> <span class="classifier">optional</span></dt>
<dd>A LDAP filter defined by RFC 2254.  This is more useful when <a class="reference internal" href="#ldap-search-scope">LDAP
Search Scope</a> is set to SUBTREE.  The filter is useful for limiting
which LDAP objects are identified as representing Users for
authentication.  The filter is augmented by <a class="reference internal" href="#login-attribute">Login Attribute</a> below.
This can commonly be left blank.</dd>
</dl>
<dl class="docutils" id="ldap-search-scope">
<dt>LDAP Search Scope <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd><p class="first">This limits how far LDAP will search for a matching object.</p>
<dl class="last docutils">
<dt>BASE</dt>
<dd>Only allows searching of <a class="reference internal" href="#base-dn">Base DN</a> and is usually not what you
want.</dd>
<dt>ONELEVEL</dt>
<dd>Searches all entries under <a class="reference internal" href="#base-dn">Base DN</a>, but not Base DN itself.</dd>
<dt>SUBTREE</dt>
<dd>Searches all entries below <a class="reference internal" href="#base-dn">Base DN</a>, but not Base DN itself.
When using SUBTREE <a class="reference internal" href="#ldap-filter">LDAP Filter</a> is useful to limit object
location.</dd>
</dl>
</dd>
</dl>
<dl class="docutils" id="login-attribute">
<dt>Login Attribute <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd><p class="first">The LDAP record attribute that will be matched as the USERNAME or
ACCOUNT used to connect to Kallithea.  This will be added to <a class="reference internal" href="#ldap-filter">LDAP
Filter</a> for locating the User object.  If <a class="reference internal" href="#ldap-filter">LDAP Filter</a> is specified as
&#8220;LDAPFILTER&#8221;, <a class="reference internal" href="#login-attribute">Login Attribute</a> is specified as &#8220;uid&#8221; and the user has
connected as &#8220;jsmith&#8221; then the <a class="reference internal" href="#ldap-filter">LDAP Filter</a> will be augmented as below</p>
<div class="last highlight-python"><div class="highlight"><pre>(&amp;(LDAPFILTER)(uid=jsmith))
</pre></div>
</div>
</dd>
</dl>
<dl class="docutils" id="ldap-attr-firstname">
<dt>First Name Attribute <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd>The LDAP record attribute which represents the user&#8217;s first name.</dd>
</dl>
<dl class="docutils" id="ldap-attr-lastname">
<dt>Last Name Attribute <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd>The LDAP record attribute which represents the user&#8217;s last name.</dd>
</dl>
<dl class="docutils" id="ldap-attr-email">
<dt>Email Attribute <span class="classifier-delimiter">:</span> <span class="classifier">required</span></dt>
<dd>The LDAP record attribute which represents the user&#8217;s email address.</dd>
</dl>
<p>If all data are entered correctly, and <a class="reference external" href="http://www.python-ldap.org/">python-ldap</a> is properly installed
users should be granted access to Kallithea with ldap accounts.  At this
time user information is copied from LDAP into the Kallithea user database.
This means that updates of an LDAP user object may not be reflected as a
user update in Kallithea.</p>
<p>If You have problems with LDAP access and believe You entered correct
information check out the Kallithea logs, any error messages sent from LDAP
will be saved there.</p>
<div class="section" id="active-directory">
<h3>Active Directory<a class="headerlink" href="#active-directory" title="Permalink to this headline">¶</a></h3>
<p>Kallithea can use Microsoft Active Directory for user authentication.  This
is done through an LDAP or LDAPS connection to Active Directory.  The
following LDAP configuration settings are typical for using Active
Directory</p>
<div class="highlight-python"><div class="highlight"><pre>Base DN              = OU=SBSUsers,OU=Users,OU=MyBusiness,DC=v3sys,DC=local
Login Attribute      = sAMAccountName
First Name Attribute = givenName
Last Name Attribute  = sn
E-mail Attribute     = mail
</pre></div>
</div>
<p>All other LDAP settings will likely be site-specific and should be
appropriately configured.</p>
</div>
</div>
<div class="section" id="authentication-by-container-or-reverse-proxy">
<h2>Authentication by container or reverse-proxy<a class="headerlink" href="#authentication-by-container-or-reverse-proxy" title="Permalink to this headline">¶</a></h2>
<p>Starting with version 1.3, Kallithea supports delegating the authentication
of users to its WSGI container, or to a reverse-proxy server through which all
clients access the application.</p>
<p>When these authentication methods are enabled in Kallithea, it uses the
username that the container/proxy (Apache/Nginx/etc) authenticated and doesn&#8217;t
perform the authentication itself. The authorization, however, is still done by
Kallithea according to its settings.</p>
<p>When a user logs in for the first time using these authentication methods,
a matching user account is created in Kallithea with default permissions. An
administrator can then modify it using Kallithea&#8217;s admin interface.
It&#8217;s also possible for an administrator to create accounts and configure their
permissions before the user logs in for the first time.</p>
<div class="section" id="container-based-authentication">
<h3>Container-based authentication<a class="headerlink" href="#container-based-authentication" title="Permalink to this headline">¶</a></h3>
<p>In a container-based authentication setup, Kallithea reads the user name from
the <tt class="docutils literal"><span class="pre">REMOTE_USER</span></tt> server variable provided by the WSGI container.</p>
<p>After setting up your container (see <a class="reference internal" href="#apache-s-wsgi-config">Apache&#8217;s WSGI config</a>), you&#8217;d need
to configure it to require authentication on the location configured for
Kallithea.</p>
<p>In order for Kallithea to start using the provided username, you should set the
following in the [app:main] section of your .ini file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">container_auth_enabled</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
</div>
<div class="section" id="proxy-pass-through-authentication">
<h3>Proxy pass-through authentication<a class="headerlink" href="#proxy-pass-through-authentication" title="Permalink to this headline">¶</a></h3>
<p>In a proxy pass-through authentication setup, Kallithea reads the user name
from the <tt class="docutils literal"><span class="pre">X-Forwarded-User</span></tt> request header, which should be configured to be
sent by the reverse-proxy server.</p>
<p>After setting up your proxy solution (see <a class="reference internal" href="#apache-virtual-host-reverse-proxy-example">Apache virtual host reverse proxy example</a>,
<a class="reference internal" href="#apache-as-subdirectory">Apache as subdirectory</a> or <a class="reference internal" href="#nginx-virtual-host-example">Nginx virtual host example</a>), you&#8217;d need to
configure the authentication and add the username in a request header named
<tt class="docutils literal"><span class="pre">X-Forwarded-User</span></tt>.</p>
<p>For example, the following config section for Apache sets a subdirectory in a
reverse-proxy setup with basic auth:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;Location /&lt;someprefix&gt; &gt;
  ProxyPass http://127.0.0.1:5000/&lt;someprefix&gt;
  ProxyPassReverse http://127.0.0.1:5000/&lt;someprefix&gt;
  SetEnvIf X-Url-Scheme https HTTPS=1

  AuthType Basic
  AuthName &quot;Kallithea authentication&quot;
  AuthUserFile /home/web/kallithea/.htpasswd
  require valid-user

  RequestHeader unset X-Forwarded-User

  RewriteEngine On
  RewriteCond %{LA-U:REMOTE_USER} (.+)
  RewriteRule .* - [E=RU:%1]
  RequestHeader set X-Forwarded-User %{RU}e
&lt;/Location&gt;
</pre></div>
</div>
<p>In order for Kallithea to start using the forwarded username, you should set
the following in the [app:main] section of your .ini file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">proxypass_auth_enabled</span> <span class="o">=</span> <span class="n">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you enable proxy pass-through authentication, make sure your server is
only accessible through the proxy. Otherwise, any client would be able to
forge the authentication header and could effectively become authenticated
using any account of their liking.</p>
</div>
</div>
</div>
<div class="section" id="integration-with-issue-trackers">
<h2>Integration with Issue trackers<a class="headerlink" href="#integration-with-issue-trackers" title="Permalink to this headline">¶</a></h2>
<p>Kallithea provides a simple integration with issue trackers. It&#8217;s possible
to define a regular expression that will fetch issue id stored in commit
messages and replace that with an url to this issue. To enable this simply
uncomment following variables in the ini file:</p>
<div class="highlight-python"><div class="highlight"><pre>issue_pat = (?:^#|\s#)(\w+)
issue_server_link = https://myissueserver.com/{repo}/issue/{id}
issue_prefix = #
</pre></div>
</div>
<p><cite>issue_pat</cite> is the regular expression that will fetch issues from commit messages.
Default regex will match issues in format of #&lt;number&gt; eg. #300.</p>
<p>Matched issues will be replace with the link specified as <cite>issue_server_link</cite>
{id} will be replaced with issue id, and {repo} with repository name.
Since the # is striped <cite>issue_prefix</cite> is added as a prefix to url.
<cite>issue_prefix</cite> can be something different than # if you pass
ISSUE- as issue prefix this will generate an url in format:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;a href=&quot;https://myissueserver.com/example_repo/issue/300&quot;&gt;ISSUE-300&lt;/a&gt;
</pre></div>
</div>
</div>
<div class="section" id="hook-management">
<h2>Hook management<a class="headerlink" href="#hook-management" title="Permalink to this headline">¶</a></h2>
<p>Hooks can be managed in similar way to this used in .hgrc files.
To access hooks setting click <cite>advanced setup</cite> on Hooks section of Mercurial
Settings in Admin.</p>
<p>There are 4 built in hooks that cannot be changed (only enable/disable by
checkboxes on previos section).
To add another custom hook simply fill in first section with
&lt;name&gt;.&lt;hook_type&gt; and the second one with hook path. Example hooks
can be found at <em>kallithea.lib.hooks</em>.</p>
</div>
<div class="section" id="changing-default-encoding">
<h2>Changing default encoding<a class="headerlink" href="#changing-default-encoding" title="Permalink to this headline">¶</a></h2>
<p>By default Kallithea uses utf8 encoding, starting from 1.3 series this
can be changed, simply edit default_encoding in .ini file to desired one.
This affects many parts in Kallithea including committers names, filenames,
encoding of commit messages. In addition Kallithea can detect if <cite>chardet</cite>
library is installed. If <cite>chardet</cite> is detected Kallithea will fallback to it
when there are encode/decode errors.</p>
</div>
<div class="section" id="setting-up-celery">
<h2>Setting Up Celery<a class="headerlink" href="#setting-up-celery" title="Permalink to this headline">¶</a></h2>
<p>Since version 1.1 celery is configured by the Kallithea ini configuration files.
Simply set use_celery=true in the ini file then add / change the configuration
variables inside the ini file.</p>
<p>Remember that the ini files use the format with &#8216;.&#8217; not with &#8216;_&#8217; like celery.
So for example setting <cite>BROKER_HOST</cite> in celery means setting <cite>broker.host</cite> in
the config file.</p>
<p>In order to start using celery run:</p>
<div class="highlight-python"><div class="highlight"><pre>paster celeryd &lt;configfile.ini&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure you run this command from the same virtualenv, and with the same
user that Kallithea runs.</p>
</div>
</div>
<div class="section" id="https-support">
<h2>HTTPS support<a class="headerlink" href="#https-support" title="Permalink to this headline">¶</a></h2>
<p>There are two ways to enable https:</p>
<ul class="simple">
<li>Set HTTP_X_URL_SCHEME in your http server headers, than Kallithea will
recognize this headers and make proper https redirections</li>
<li>Alternatively, change the <cite>force_https = true</cite> flag in the ini configuration
to force using https, no headers are needed than to enable https</li>
</ul>
</div>
<div class="section" id="nginx-virtual-host-example">
<h2>Nginx virtual host example<a class="headerlink" href="#nginx-virtual-host-example" title="Permalink to this headline">¶</a></h2>
<p>Sample config for nginx using proxy:</p>
<div class="highlight-python"><div class="highlight"><pre>upstream rc {
    server 127.0.0.1:5000;
    # add more instances for load balancing
    #server 127.0.0.1:5001;
    #server 127.0.0.1:5002;
}

## gist alias
server {
   listen          443;
   server_name     gist.myserver.com;
   access_log      /var/log/nginx/gist.access.log;
   error_log       /var/log/nginx/gist.error.log;

   ssl on;
   ssl_certificate     gist.your.kallithea.server.crt;
   ssl_certificate_key gist.your.kallithea.server.key;

   ssl_session_timeout 5m;

   ssl_protocols SSLv3 TLSv1;
   ssl_ciphers DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:EDH-RSA-DES-CBC3-SHA:AES256-SHA:DES-CBC3-SHA:AES128-SHA:RC4-SHA:RC4-MD5;
   ssl_prefer_server_ciphers on;

   rewrite ^/(.+)$ https://your.kallithea.server/_admin/gists/$1;
   rewrite (.*)    https://your.kallithea.server/_admin/gists;
}

server {
   listen          443;
   server_name     your.kallithea.server;
   access_log      /var/log/nginx/kallithea.access.log;
   error_log       /var/log/nginx/kallithea.error.log;

   ssl on;
   ssl_certificate     your.kallithea.server.crt;
   ssl_certificate_key your.kallithea.server.key;

   ssl_session_timeout 5m;

   ssl_protocols SSLv3 TLSv1;
   ssl_ciphers DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:EDH-RSA-DES-CBC3-SHA:AES256-SHA:DES-CBC3-SHA:AES128-SHA:RC4-SHA:RC4-MD5;
   ssl_prefer_server_ciphers on;

   ## uncomment root directive if you want to serve static files by nginx
   ## requires static_files = false in .ini file
   #root /path/to/installation/kallithea/public;
   include         /etc/nginx/proxy.conf;
   location / {
        try_files $uri @rhode;
   }

   location @rhode {
        proxy_pass      http://rc;
   }

}
</pre></div>
</div>
<p>Here&#8217;s the proxy.conf. It&#8217;s tuned so it will not timeout on long
pushes or large pushes:</p>
<div class="highlight-python"><div class="highlight"><pre>proxy_redirect              off;
proxy_set_header            Host $host;
## needed for container auth
#proxy_set_header            REMOTE_USER $remote_user;
#proxy_set_header            X-Forwarded-User $remote_user;
proxy_set_header            X-Url-Scheme $scheme;
proxy_set_header            X-Host $http_host;
proxy_set_header            X-Real-IP $remote_addr;
proxy_set_header            X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header            Proxy-host $proxy_host;
proxy_buffering             off;
proxy_connect_timeout       7200;
proxy_send_timeout          7200;
proxy_read_timeout          7200;
proxy_buffers               8 32k;
client_max_body_size        1024m;
client_body_buffer_size     128k;
large_client_header_buffers 8 64k;
</pre></div>
</div>
</div>
<div class="section" id="apache-virtual-host-reverse-proxy-example">
<h2>Apache virtual host reverse proxy example<a class="headerlink" href="#apache-virtual-host-reverse-proxy-example" title="Permalink to this headline">¶</a></h2>
<p>Here is a sample configuration file for apache using proxy:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;VirtualHost *:80&gt;
        ServerName hg.myserver.com
        ServerAlias hg.myserver.com

        &lt;Proxy *&gt;
          Order allow,deny
          Allow from all
        &lt;/Proxy&gt;

        #important !
        #Directive to properly generate url (clone url) for pylons
        ProxyPreserveHost On

        #kallithea instance
        ProxyPass / http://127.0.0.1:5000/
        ProxyPassReverse / http://127.0.0.1:5000/

        #to enable https use line below
        #SetEnvIf X-Url-Scheme https HTTPS=1

&lt;/VirtualHost&gt;
</pre></div>
</div>
<p>Additional tutorial
<a class="reference external" href="http://wiki.pylonshq.com/display/pylonscookbook/Apache+as+a+reverse+proxy+for+Pylons">http://wiki.pylonshq.com/display/pylonscookbook/Apache+as+a+reverse+proxy+for+Pylons</a></p>
</div>
<div class="section" id="apache-as-subdirectory">
<h2>Apache as subdirectory<a class="headerlink" href="#apache-as-subdirectory" title="Permalink to this headline">¶</a></h2>
<p>Apache subdirectory part:</p>
<div class="highlight-python"><div class="highlight"><pre>&lt;Location /&lt;someprefix&gt; &gt;
  ProxyPass http://127.0.0.1:5000/&lt;someprefix&gt;
  ProxyPassReverse http://127.0.0.1:5000/&lt;someprefix&gt;
  SetEnvIf X-Url-Scheme https HTTPS=1
&lt;/Location&gt;
</pre></div>
</div>
<p>Besides the regular apache setup you will need to add the following line
into [app:main] section of your .ini file:</p>
<div class="highlight-python"><div class="highlight"><pre>filter-with = proxy-prefix
</pre></div>
</div>
<p>Add the following at the end of the .ini file:</p>
<div class="highlight-python"><div class="highlight"><pre>[filter:proxy-prefix]
use = egg:PasteDeploy#prefix
prefix = /&lt;someprefix&gt;
</pre></div>
</div>
<p>then change &lt;someprefix&gt; into your chosen prefix</p>
</div>
<div class="section" id="apache-s-wsgi-config">
<h2>Apache&#8217;s WSGI config<a class="headerlink" href="#apache-s-wsgi-config" title="Permalink to this headline">¶</a></h2>
<p>Alternatively, Kallithea can be set up with Apache under mod_wsgi. For
that, you&#8217;ll need to:</p>
<ul>
<li><p class="first">Install mod_wsgi. If using a Debian-based distro, you can install
the package libapache2-mod-wsgi:</p>
<div class="highlight-python"><div class="highlight"><pre>aptitude install libapache2-mod-wsgi
</pre></div>
</div>
</li>
<li><p class="first">Enable mod_wsgi:</p>
<div class="highlight-python"><div class="highlight"><pre>a2enmod wsgi
</pre></div>
</div>
</li>
<li><p class="first">Create a wsgi dispatch script, like the one below. Make sure you
check the paths correctly point to where you installed Kallithea
and its Python Virtual Environment.</p>
</li>
<li><p class="first">Enable the WSGIScriptAlias directive for the wsgi dispatch script,
as in the following example. Once again, check the paths are
correctly specified.</p>
</li>
</ul>
<p>Here is a sample excerpt from an Apache Virtual Host configuration file:</p>
<div class="highlight-python"><div class="highlight"><pre>WSGIDaemonProcess pylons \
    threads=4 \
    python-path=/home/web/kallithea/pyenv/lib/python2.6/site-packages
WSGIScriptAlias / /home/web/kallithea/dispatch.wsgi
WSGIPassAuthorization On
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">when running apache as root please add: <cite>user=www-data group=www-data</cite>
into above configuration</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Running Kallithea in multiprocess mode in apache is not supported,
make sure you don&#8217;t specify <cite>processes=num</cite> directive in the config</p>
</div>
<p>Example wsgi dispatch script:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;HGENCODING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;UTF-8&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PYTHON_EGG_CACHE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;/home/web/kallithea/.egg-cache&#39;</span>

<span class="c"># sometimes it&#39;s needed to set the curent dir</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s">&#39;/home/web/kallithea/&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">site</span>
<span class="n">site</span><span class="o">.</span><span class="n">addsitedir</span><span class="p">(</span><span class="s">&quot;/home/web/kallithea/pyenv/lib/python2.6/site-packages&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">paste.deploy</span> <span class="kn">import</span> <span class="n">loadapp</span>
<span class="kn">from</span> <span class="nn">paste.script.util.logging_config</span> <span class="kn">import</span> <span class="n">fileConfig</span>

<span class="n">fileConfig</span><span class="p">(</span><span class="s">&#39;/home/web/kallithea/production.ini&#39;</span><span class="p">)</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">loadapp</span><span class="p">(</span><span class="s">&#39;config:/home/web/kallithea/production.ini&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: when using mod_wsgi you&#8217;ll need to install the same version of
Mercurial that&#8217;s inside Kallithea&#8217;s virtualenv also on the system&#8217;s Python
environment.</p>
</div>
<div class="section" id="other-configuration-files">
<h2>Other configuration files<a class="headerlink" href="#other-configuration-files" title="Permalink to this headline">¶</a></h2>
<p>Some example init.d scripts can be found in init.d directory:</p>
<div class="highlight-python"><div class="highlight"><pre>https://kallithea-scm.org/repos/kallithea/files/tip/init.d/
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<h3>Support Kallithea development</h3>
<div style="text-align:center">
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="EYXFS3SQPHYUL">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
</form>
    <div style="padding:5px">
     <a href="https://flattr.com/thing/922714/Donate-to-Software-Freedom-Conservancy" target="_blank">
     <img src="http://api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" /></a>
    </div>
</div>

  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Setup</a><ul>
<li><a class="reference internal" href="#setting-up-kallithea">Setting up Kallithea</a></li>
<li><a class="reference internal" href="#using-kallithea-with-ssh">Using Kallithea with SSH</a></li>
<li><a class="reference internal" href="#setting-up-whoosh-full-text-search">Setting up Whoosh full text search</a></li>
<li><a class="reference internal" href="#setting-up-ldap-support">Setting up LDAP support</a><ul>
<li><a class="reference internal" href="#active-directory">Active Directory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authentication-by-container-or-reverse-proxy">Authentication by container or reverse-proxy</a><ul>
<li><a class="reference internal" href="#container-based-authentication">Container-based authentication</a></li>
<li><a class="reference internal" href="#proxy-pass-through-authentication">Proxy pass-through authentication</a></li>
</ul>
</li>
<li><a class="reference internal" href="#integration-with-issue-trackers">Integration with Issue trackers</a></li>
<li><a class="reference internal" href="#hook-management">Hook management</a></li>
<li><a class="reference internal" href="#changing-default-encoding">Changing default encoding</a></li>
<li><a class="reference internal" href="#setting-up-celery">Setting Up Celery</a></li>
<li><a class="reference internal" href="#https-support">HTTPS support</a></li>
<li><a class="reference internal" href="#nginx-virtual-host-example">Nginx virtual host example</a></li>
<li><a class="reference internal" href="#apache-virtual-host-reverse-proxy-example">Apache virtual host reverse proxy example</a></li>
<li><a class="reference internal" href="#apache-as-subdirectory">Apache as subdirectory</a></li>
<li><a class="reference internal" href="#apache-s-wsgi-config">Apache&#8217;s WSGI config</a></li>
<li><a class="reference internal" href="#other-configuration-files">Other configuration files</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="installation_win.html"
                        title="previous chapter">Step by step Installation for Windows</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="upgrade.html"
                        title="next chapter">Upgrade</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/setup.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="upgrade.html" title="Upgrade"
             >next</a> |</li>
        <li class="right" >
          <a href="installation_win.html" title="Step by step Installation for Windows"
             >previous</a> |</li>
        <li><a href="index.html">Kallithea 0 documentation</a> &raquo;</li>
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010-2014 by various authors, licensed as GPLv3..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>